<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAWI v7.0 - Sistema Lukers</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            --primary:#6366f1;--primary-dark:#4f46e5;--primary-light:#818cf8;
            --success:#10b981;--warning:#f59e0b;--danger:#ef4444;--info:#3b82f6;--purple:#a855f7;
            --bg-main:#0f172a;--bg-card:#fff;--bg-hover:#f1f5f9;
            --text-primary:#0f172a;--text-secondary:#64748b;--text-light:#94a3b8;--text-white:#fff;
            --border:#e2e8f0;--shadow:0 4px 6px -1px rgba(0,0,0,0.1);--shadow-lg:0 20px 25px -5px rgba(0,0,0,0.1)
        }
        body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh}
        
        /* AUTH TABS */
        .auth-tabs{
            display:flex;
            gap:0.5rem;
            margin-bottom:1.5rem;
            border-bottom:2px solid var(--border);
        }
        .auth-tab{
            flex:1;
            padding:0.75rem;
            border:none;
            background:transparent;
            font-weight:600;
            font-size:0.9rem;
            color:var(--text-secondary);
            cursor:pointer;
            border-bottom:3px solid transparent;
            transition:all 0.2s;
        }
        .auth-tab:hover{color:var(--primary)}
        .auth-tab.active{
            color:var(--primary);
            border-bottom-color:var(--primary);
        }
        .auth-tab-content{display:none}
        .auth-tab-content.active{display:block}
        
        /* LOGIN */
        .login-container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem}
        .login-card{background:#fff;padding:3rem;border-radius:20px;box-shadow:0 25px 50px -12px rgba(0,0,0,0.25);max-width:420px;width:100%}
        .login-logo{width:70px;height:70px;background:linear-gradient(135deg,var(--primary),#818cf8);border-radius:16px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:2rem;margin:0 auto 1.5rem}
        .login-title{font-size:2rem;font-weight:800;text-align:center;margin-bottom:0.5rem}
        .login-subtitle{text-align:center;color:var(--text-secondary);margin-bottom:2rem}
        
        /* FORMS */
        .form-group{margin-bottom:1.25rem}
        .form-label{display:block;font-weight:600;margin-bottom:0.5rem;font-size:0.875rem}
        .form-input,.form-select,.form-textarea{width:100%;padding:0.75rem 1rem;border:2px solid var(--border);border-radius:10px;font-size:0.9rem;transition:all 0.2s;font-family:inherit}
        .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(99,102,241,0.1)}
        .form-input-sm{padding:0.5rem 0.75rem;font-size:0.8rem}
        .form-textarea{min-height:80px;resize:vertical}
        .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem}
        .form-help{font-size:0.75rem;color:var(--text-secondary);margin-top:0.5rem}
        .form-check{display:flex;align-items:center;gap:0.5rem;cursor:pointer}
        .form-check input{width:16px;height:16px;cursor:pointer}
        
        /* BUTTONS */
        .btn{padding:0.6rem 1rem;border:none;border-radius:8px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:0.4rem;transition:all 0.2s;font-size:0.8rem}
        .btn-sm{padding:0.4rem 0.75rem;font-size:0.75rem}
        .btn-lg{padding:0.875rem 1.5rem;font-size:0.9rem}
        .btn-primary{background:var(--primary);color:#fff}
        .btn-primary:hover{background:var(--primary-dark);transform:translateY(-2px)}
        .btn-success{background:var(--success);color:#fff}
        .btn-warning{background:var(--warning);color:#fff}
        .btn-danger{background:var(--danger);color:#fff}
        .btn-info{background:var(--info);color:#fff}
        .btn-purple{background:var(--purple);color:#fff}
        .btn-outline{background:#fff;color:var(--primary);border:2px solid var(--primary)}
        .btn-outline:hover{background:var(--primary);color:#fff}
        .btn-ghost{background:transparent;color:var(--text-secondary)}
        .btn-ghost:hover{background:var(--bg-hover)}
        .btn-full{width:100%;justify-content:center}
        .btn-link{
            background:none;
            border:none;
            color:var(--primary);
            cursor:pointer;
            font-weight:600;
            font-size:0.85rem;
            padding:0.25rem;
            text-decoration:none;
        }
        .btn-link:hover{text-decoration:underline}
        .btn-icon{width:32px;height:32px;padding:0;justify-content:center}
        .btn:disabled{opacity:0.5;cursor:not-allowed}
        
        /* LAYOUT */
        .app-container{display:none;height:100vh;overflow:hidden}
        .sidebar{width:260px;background:var(--bg-main);display:flex;flex-direction:column}
        .sidebar-header{padding:1.25rem;border-bottom:1px solid rgba(255,255,255,0.1)}
        .logo-container{display:flex;align-items:center;gap:0.75rem}
        .logo-icon{width:42px;height:42px;background:linear-gradient(135deg,var(--primary),#818cf8);border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:1.2rem}
        .logo-title{font-size:1.2rem;font-weight:700;color:#fff}
        .logo-subtitle{font-size:0.65rem;color:#94a3b8}
        
        .nav-menu{flex:1;padding:1rem;overflow-y:auto}
        .nav-section{margin-bottom:1.5rem}
        .nav-section-title{font-size:0.65rem;font-weight:600;text-transform:uppercase;color:#94a3b8;padding:0 0.75rem;margin-bottom:0.5rem;letter-spacing:0.05em}
        .nav-item{display:flex;align-items:center;gap:0.6rem;padding:0.65rem 0.75rem;border-radius:8px;cursor:pointer;color:#94a3b8;transition:all 0.2s;margin-bottom:0.25rem;font-size:0.85rem}
        .nav-item:hover{background:rgba(255,255,255,0.05);color:#fff}
        .nav-item.active{background:var(--primary);color:#fff}
        .nav-item i{width:18px;height:18px}
        .nav-badge{margin-left:auto;background:var(--danger);color:#fff;font-size:0.65rem;padding:0.15rem 0.5rem;border-radius:10px;font-weight:600}
        
        .user-profile{padding:1rem;border-top:1px solid rgba(255,255,255,0.1)}
        .user-info{display:flex;align-items:center;gap:0.6rem;padding:0.6rem;background:rgba(255,255,255,0.05);border-radius:8px;cursor:pointer}
        .user-avatar{width:36px;height:36px;background:linear-gradient(135deg,var(--primary),#818cf8);border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:0.9rem}
        .user-name{color:#fff;font-weight:600;font-size:0.85rem}
        .user-role{color:#94a3b8;font-size:0.7rem}
        
        .main-content{flex:1;display:flex;flex-direction:column;overflow:hidden;background:#f8fafc}
        .header{background:#fff;padding:1rem 1.5rem;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:0.75rem}
        .header-left{display:flex;flex-direction:column}
        .header-title{font-size:1.35rem;font-weight:700}
        .header-breadcrumb{font-size:0.75rem;color:var(--text-secondary);display:flex;align-items:center;gap:0.4rem}
        .header-actions{display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap}
        .content-area{flex:1;overflow-y:auto;padding:1.5rem}
        
        /* STATS */
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1.25rem;margin-bottom:1.5rem}
        .stat-card{background:#fff;padding:1.25rem;border-radius:14px;box-shadow:var(--shadow);transition:transform 0.2s}
        .stat-card:hover{transform:translateY(-3px)}
        .stat-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.75rem}
        .stat-icon{width:46px;height:46px;border-radius:12px;display:flex;align-items:center;justify-content:center}
        .stat-icon.blue{background:rgba(99,102,241,0.1);color:var(--primary)}
        .stat-icon.green{background:rgba(16,185,129,0.1);color:var(--success)}
        .stat-icon.orange{background:rgba(245,158,11,0.1);color:var(--warning)}
        .stat-icon.red{background:rgba(239,68,68,0.1);color:var(--danger)}
        .stat-icon.purple{background:rgba(168,85,247,0.1);color:var(--purple)}
        .stat-value{font-size:1.85rem;font-weight:800;margin-bottom:0.25rem}
        .stat-label{color:var(--text-secondary);font-size:0.8rem}
        .stat-footer{margin-top:0.75rem;padding-top:0.75rem;border-top:1px solid var(--border);display:flex;justify-content:space-between;font-size:0.7rem}
        .stat-footer-label{color:var(--text-secondary)}
        .stat-footer-value{font-weight:600}
        
        /* FILTERS */
        .filters-bar{background:#fff;padding:1rem 1.25rem;border-radius:12px;margin-bottom:1.25rem;display:flex;gap:1rem;align-items:center;flex-wrap:wrap;box-shadow:var(--shadow)}
        .filter-group{display:flex;align-items:center;gap:0.5rem}
        .filter-label{font-size:0.75rem;font-weight:600;color:var(--text-secondary)}
        
        /* CHARTS */
        .charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:1.25rem;margin-bottom:1.5rem}
        .chart-card{background:#fff;padding:1.25rem;border-radius:14px;box-shadow:var(--shadow)}
        .chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
        .chart-title{font-size:0.95rem;font-weight:600;display:flex;align-items:center;gap:0.5rem}
        .chart-wrapper{height:280px;position:relative}
        
        /* CARDS */
        .card{background:#fff;border-radius:14px;padding:1.25rem;box-shadow:var(--shadow);margin-bottom:1.25rem}
        .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem;padding-bottom:1rem;border-bottom:2px solid var(--border);flex-wrap:wrap;gap:0.75rem}
        .card-title{font-size:1.05rem;font-weight:700;display:flex;align-items:center;gap:0.5rem}
        .card-actions{display:flex;gap:0.5rem;flex-wrap:wrap}
        
        /* TABLES */
        .table-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:0.75rem}
        .table-container{overflow-x:auto}
        table{width:100%;border-collapse:collapse;font-size:0.8rem}
        th,td{padding:0.7rem 0.6rem;text-align:left;border-bottom:1px solid var(--border)}
        th{background:var(--bg-hover);font-weight:600;font-size:0.7rem;text-transform:uppercase;color:var(--text-secondary);white-space:nowrap;position:sticky;top:0}
        tr:hover{background:var(--bg-hover)}
        td{white-space:nowrap}
        .td-wrap{white-space:normal;max-width:220px;font-size:0.75rem;line-height:1.4}
        
        /* BADGES */
        .badge{padding:0.25rem 0.6rem;border-radius:9999px;font-size:0.7rem;font-weight:600;display:inline-flex;align-items:center;gap:0.25rem}
        .badge-primary{background:rgba(99,102,241,0.1);color:var(--primary)}
        .badge-success{background:rgba(16,185,129,0.1);color:var(--success)}
        .badge-warning{background:rgba(245,158,11,0.1);color:var(--warning)}
        .badge-danger{background:rgba(239,68,68,0.1);color:var(--danger)}
        .badge-info{background:rgba(59,130,246,0.1);color:var(--info)}
        .badge-purple{background:rgba(168,85,247,0.1);color:var(--purple)}
        
        /* SEARCH */
        .search-box{display:flex;align-items:center;gap:0.4rem;background:var(--bg-hover);padding:0.5rem 0.875rem;border-radius:8px;min-width:240px}
        .search-box input{border:none;background:transparent;outline:none;flex:1;font-size:0.85rem}
        
        /* PAGINATION */
        .pagination{display:flex;justify-content:center;align-items:center;gap:0.5rem;margin-top:1.25rem;flex-wrap:wrap}
        .pagination button{padding:0.5rem 1rem;border:1px solid var(--border);background:#fff;border-radius:6px;cursor:pointer;font-weight:500;font-size:0.8rem;transition:all 0.2s}
        .pagination button:hover:not(:disabled){background:var(--primary);color:#fff;border-color:var(--primary)}
        .pagination button:disabled{opacity:0.5;cursor:not-allowed}
        .pagination-info{font-size:0.8rem;color:var(--text-secondary)}
        
        /* ALERTS */
        .alert{padding:1rem;border-radius:10px;margin-bottom:1rem;display:flex;align-items:flex-start;gap:0.75rem;border-left:4px solid;font-size:0.85rem}
        .alert-warning{background:rgba(245,158,11,0.1);border-color:var(--warning);color:#92400e}
        .alert-danger{background:rgba(239,68,68,0.1);border-color:var(--danger);color:#991b1b}
        .alert-info{background:rgba(59,130,246,0.1);border-color:var(--info);color:#1e40af}
        .alert-success{background:rgba(16,185,129,0.1);border-color:var(--success);color:#065f46}
        
        /* MODALS */
        .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;align-items:center;justify-content:center;padding:1rem}
        .modal.active{display:flex}
        .modal-content{background:#fff;border-radius:16px;max-width:600px;width:100%;max-height:90vh;overflow-y:auto;animation:modalIn 0.2s ease}
        .modal-content.large{max-width:900px}
        .modal-content.xl{max-width:1100px}
        .modal-header{padding:1.25rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:#fff;z-index:10}
        .modal-title{font-size:1.15rem;font-weight:700;display:flex;align-items:center;gap:0.5rem}
        .modal-close{width:32px;height:32px;border:none;background:var(--bg-hover);border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
        .modal-close:hover{background:var(--danger);color:#fff}
        .modal-body{padding:1.25rem}
        .modal-footer{padding:1.25rem;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:0.75rem;position:sticky;bottom:0;background:#fff}
        @keyframes modalIn{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}
        
        /* FILE UPLOAD */
        .file-upload-container{position:relative}
        .file-upload-btn{display:inline-flex;align-items:center;gap:0.5rem;padding:0.75rem 1.5rem;background:var(--bg-hover);border:2px dashed var(--border);border-radius:10px;cursor:pointer;font-weight:600;font-size:0.85rem;transition:all 0.2s}
        .file-upload-btn:hover{background:var(--primary);color:#fff;border-color:var(--primary)}
        .form-file{display:none}
        .file-selected{display:none;align-items:center;gap:0.5rem;margin-top:0.75rem;padding:0.75rem;background:rgba(16,185,129,0.1);border:2px solid var(--success);border-radius:10px;color:#065f46}
        .file-selected.show{display:flex}
        .file-selected-icon{width:28px;height:28px;background:var(--success);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;flex-shrink:0}
        .file-selected-name{flex:1;font-weight:600;font-size:0.85rem;word-break:break-all}
        .file-selected-remove{background:none;border:none;color:var(--danger);cursor:pointer;padding:0.25rem}
        
        /* DROPDOWN */
        .dropdown{position:relative;display:inline-block}
        .dropdown-menu{position:absolute;top:100%;right:0;margin-top:0.5rem;background:#fff;border-radius:10px;box-shadow:var(--shadow-lg);min-width:200px;z-index:100;opacity:0;visibility:hidden;transform:translateY(-10px);transition:all 0.2s}
        .dropdown-menu.active{opacity:1;visibility:visible;transform:translateY(0)}
        .dropdown-item{padding:0.7rem 1rem;display:flex;align-items:center;gap:0.6rem;cursor:pointer;transition:background 0.2s;font-size:0.85rem}
        .dropdown-item:hover{background:var(--bg-hover)}
        .dropdown-item:first-child{border-radius:10px 10px 0 0}
        .dropdown-item:last-child{border-radius:0 0 10px 10px}
        .dropdown-divider{height:1px;background:var(--border);margin:0.25rem 0}
        
        /* LOADING */
        .loading-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;align-items:center;justify-content:center}
        .loading-overlay.active{display:flex}
        .loading-content{text-align:center;color:#fff}
        .spinner{width:50px;height:50px;border:4px solid rgba(255,255,255,0.2);border-top-color:#fff;border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 1rem}
        @keyframes spin{to{transform:rotate(360deg)}}
        .progress-bar{width:220px;height:6px;background:rgba(255,255,255,0.2);border-radius:3px;overflow:hidden;margin:1rem auto 0}
        .progress-fill{height:100%;background:var(--primary);width:0%;transition:width 0.3s}
        
        /* TOAST */
        .toast-container{position:fixed;top:1rem;right:1rem;z-index:10000;display:flex;flex-direction:column;gap:0.5rem}
        .toast{background:#fff;padding:1rem 1.25rem;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,0.2);display:flex;align-items:center;gap:0.75rem;animation:slideIn 0.3s ease;border-left:4px solid;font-size:0.85rem;max-width:400px}
        .toast.success{border-color:var(--success)}
        .toast.error{border-color:var(--danger)}
        .toast.warning{border-color:var(--warning)}
        .toast.info{border-color:var(--info)}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        
        /* VIEWS */
        .vista{display:none}
        .vista.active{display:block}
        .empty-state{text-align:center;padding:3rem;color:var(--text-secondary)}
        .empty-state i{width:48px;height:48px;margin-bottom:1rem;opacity:0.5}
        
        /* DETAIL GRID */
        .detail-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem}
        .detail-item{background:var(--bg-hover);padding:1rem;border-radius:10px}
        .detail-label{font-size:0.7rem;color:var(--text-secondary);text-transform:uppercase;margin-bottom:0.3rem;font-weight:600}
        .detail-value{font-weight:600;font-size:0.95rem}
        
        /* TIMELINE */
        .timeline{position:relative;padding-left:2rem}
        .timeline::before{content:'';position:absolute;left:0.5rem;top:0;bottom:0;width:2px;background:var(--border)}
        .timeline-item{position:relative;padding-bottom:1.5rem}
        .timeline-item::before{content:'';position:absolute;left:-1.5rem;top:0.25rem;width:12px;height:12px;border-radius:50%;background:var(--primary);border:2px solid #fff;box-shadow:0 0 0 2px var(--primary)}
        .timeline-item.success::before{background:var(--success);box-shadow:0 0 0 2px var(--success)}
        .timeline-item.warning::before{background:var(--warning);box-shadow:0 0 0 2px var(--warning)}
        .timeline-item.danger::before{background:var(--danger);box-shadow:0 0 0 2px var(--danger)}
        .timeline-date{font-size:0.7rem;color:var(--text-secondary);margin-bottom:0.25rem}
        .timeline-title{font-weight:600;font-size:0.85rem;margin-bottom:0.25rem}
        .timeline-desc{font-size:0.8rem;color:var(--text-secondary)}
        
        /* TABS */
        .tabs{display:flex;gap:0.25rem;background:var(--bg-hover);padding:0.25rem;border-radius:10px;margin-bottom:1.25rem}
        .tab{padding:0.6rem 1.25rem;border-radius:8px;cursor:pointer;font-weight:600;font-size:0.85rem;color:var(--text-secondary);transition:all 0.2s}
        .tab:hover{color:var(--text-primary)}
        .tab.active{background:#fff;color:var(--primary);box-shadow:var(--shadow)}
        
        /* CHIPS */
        .chips{display:flex;flex-wrap:wrap;gap:0.5rem}
        .chip{display:inline-flex;align-items:center;gap:0.4rem;padding:0.4rem 0.75rem;background:var(--bg-hover);border-radius:20px;font-size:0.8rem}
        .chip-remove{background:none;border:none;cursor:pointer;color:var(--text-secondary);padding:0;display:flex}
        .chip-remove:hover{color:var(--danger)}
        
        /* AI ASSISTANT */
        
        /* SCROLLBAR DISCRETO Y PROFESIONAL */
        *::-webkit-scrollbar{width:8px;height:8px}
        *::-webkit-scrollbar-track{background:transparent}
        *::-webkit-scrollbar-thumb{background:rgba(0,0,0,0.15);border-radius:10px;transition:background 0.3s}
        *::-webkit-scrollbar-thumb:hover{background:rgba(0,0,0,0.25)}
        *{scrollbar-width:thin;scrollbar-color:rgba(0,0,0,0.15) transparent}
        
        /* FILTROS COMPACTOS Y PROFESIONALES */
        .filters-bar{
            display:flex !important;
            flex-wrap:wrap;
            gap:0.75rem !important;
            padding:0.875rem 1rem !important;
            background:white;
            border-radius:10px;
            box-shadow:0 1px 3px rgba(0,0,0,0.05) !important;
            margin-bottom:1.25rem;
            align-items:center
        }
        .filter-group{
            display:flex;
            align-items:center;
            gap:0.5rem;
            margin:0 !important
        }
        .filter-label{
            font-size:0.8rem;
            font-weight:600;
            color:var(--text-secondary);
            white-space:nowrap;
            margin:0
        }
        .filter-group select,
        .filter-group input[type="date"]{
            min-width:110px;
            font-size:0.85rem;
            padding:0.45rem 0.65rem;
            border:1.5px solid #e5e7eb;
            border-radius:7px;
            background:white;
            transition:all 0.2s;
            cursor:pointer
        }
        .filter-group select:hover,
        .filter-group input[type="date"]:hover{
            border-color:var(--primary-light)
        }
        .filter-group select:focus,
        .filter-group input[type="date"]:focus{
            outline:none;
            border-color:var(--primary);
            box-shadow:0 0 0 3px rgba(99,102,241,0.08)
        }
        
        /* RESPONSIVE */
        @media(max-width:768px){
            .sidebar{display:none}
            .stats-grid,.charts-grid{grid-template-columns:1fr}
            .card-header{flex-direction:column;align-items:stretch}
            .card-actions{justify-content:flex-start}
            .ai-panel{width:100%}
        }
        
        /* FILTROS PERSONALIZADOS CON CHECKBOXES */
        .multi-select-filter{position:relative;display:inline-block}
        .multi-select-trigger{
            background:var(--bg-secondary);
            border:1px solid var(--border);
            padding:0.5rem 2.5rem 0.5rem 0.75rem;
            border-radius:8px;
            cursor:pointer;
            font-size:0.85rem;
            min-width:180px;
            display:flex;
            align-items:center;
            gap:0.5rem;
            transition:all 0.2s;
            position:relative;
        }
        .multi-select-trigger:hover{background:var(--bg-hover);border-color:var(--primary)}
        .multi-select-trigger::after{
            content:'‚ñº';
            position:absolute;
            right:0.75rem;
            font-size:0.65rem;
            color:var(--text-secondary);
            transition:transform 0.2s;
        }
        .multi-select-trigger.open::after{transform:rotate(180deg)}
        .multi-select-count{
            background:var(--primary);
            color:#fff;
            padding:0.1rem 0.5rem;
            border-radius:12px;
            font-size:0.7rem;
            font-weight:600;
            min-width:20px;
            text-align:center;
        }
        .multi-select-dropdown{
            position:absolute;
            top:calc(100% + 4px);
            left:0;
            background:#fff;
            border:1px solid var(--border);
            border-radius:10px;
            box-shadow:0 8px 24px rgba(0,0,0,0.12);
            min-width:250px;
            max-height:350px;
            overflow-y:auto;
            z-index:1000;
            display:none;
        }
        .multi-select-dropdown.open{display:block}
        .multi-select-search{
            padding:0.75rem;
            border-bottom:1px solid var(--border);
            position:sticky;
            top:0;
            background:#fff;
            z-index:1;
        }
        .multi-select-search input{
            width:100%;
            padding:0.5rem 0.75rem;
            border:1px solid var(--border);
            border-radius:6px;
            font-size:0.85rem;
        }
        .multi-select-search input:focus{outline:none;border-color:var(--primary)}
        .multi-select-options{padding:0.5rem}
        .multi-select-option{
            display:flex;
            align-items:center;
            gap:0.75rem;
            padding:0.6rem 0.75rem;
            border-radius:6px;
            cursor:pointer;
            transition:background 0.15s;
            font-size:0.85rem;
        }
        .multi-select-option:hover{background:var(--bg-hover)}
        .multi-select-option input[type="checkbox"]{
            width:16px;
            height:16px;
            cursor:pointer;
            accent-color:var(--primary);
        }
        .multi-select-option-text{flex:1}
        .multi-select-option-count{
            font-size:0.75rem;
            color:var(--text-secondary);
            padding:0.1rem 0.5rem;
            background:var(--bg-secondary);
            border-radius:10px;
        }
        .multi-select-option.disabled{
            opacity:0.4;
            pointer-events:none;
        }
        .multi-select-actions{
            padding:0.75rem;
            border-top:1px solid var(--border);
            display:flex;
            gap:0.5rem;
            background:var(--bg-secondary);
            position:sticky;
            bottom:0;
        }
        .multi-select-actions button{
            flex:1;
            padding:0.5rem;
            border:none;
            border-radius:6px;
            font-size:0.75rem;
            cursor:pointer;
            font-weight:600;
            transition:all 0.2s;
        }
        .multi-select-actions .btn-clear{
            background:transparent;
            color:var(--text-secondary);
        }
        .multi-select-actions .btn-clear:hover{background:var(--bg-hover)}
        .multi-select-actions .btn-apply{
            background:var(--primary);
            color:#fff;
        }
        .multi-select-actions .btn-apply:hover{opacity:0.9}
        
        .config-section{display:none}
        .config-section:first-of-type{display:block}
        
        /* Animaci√≥n para notificaciones */
        @keyframes slideInUp {
            from {
                transform: translateY(100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div id="loadingText">Cargando...</div>
            <div id="loadingSubtext" style="font-size:0.85rem;opacity:0.8;margin-top:0.5rem"></div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        </div>
    </div>

    <!-- LOGIN / REGISTRO -->
    <div class="login-container" id="loginSection">
        <div class="login-card">
            <div class="login-logo">M</div>
            <h1 class="login-title">MAWI v7.0</h1>
            <p class="login-subtitle">Sistema de Gesti√≥n Lukers</p>
            
            <!-- Tabs -->
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="cambiarAuthTab('login')">Iniciar Sesi√≥n</button>
                <button class="auth-tab" onclick="cambiarAuthTab('registro')">Registrarse</button>
            </div>
            
            <!-- Tab Login -->
            <div id="tabLogin" class="auth-tab-content active">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="loginEmail" class="form-input" placeholder="correo@lukers.pe">
                </div>
                <div class="form-group">
                    <label class="form-label">Contrase√±a</label>
                    <input type="password" id="loginPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button class="btn btn-primary btn-full btn-lg" onclick="iniciarSesion()">Iniciar Sesi√≥n</button>
            </div>
            
            <!-- Tab Registro -->
            <div id="tabRegistro" class="auth-tab-content">
                <div class="form-group">
                    <label class="form-label">Nombre Completo</label>
                    <input type="text" id="registroNombre" class="form-input" placeholder="Ej: Juan P√©rez Garc√≠a">
                </div>
                <div class="form-group">
                    <label class="form-label">Email Corporativo</label>
                    <input type="email" id="registroEmail" class="form-input" placeholder="usuario@lukers.pe">
                    <p class="form-help">Debe ser un correo con dominio @lukers.pe</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Rol</label>
                    <select id="registroRol" class="form-select">
                        <option value="">Selecciona tu rol</option>
                        <option value="Coordinador">Coordinador</option>
                        <option value="Supervisor">Supervisor</option>
                        <option value="Producto">Producto</option>
                        <option value="Jefe">Jefe</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">C√≥digo de Invitaci√≥n</label>
                    <input type="text" id="registroCodigo" class="form-input" placeholder="COO-XXXXXXXX" style="text-transform:uppercase" maxlength="12">
                    <p class="form-help">Solicita tu c√≥digo al administrador seg√∫n tu rol</p>
                </div>
                <div class="form-group">
                    <label class="form-label">Contrase√±a</label>
                    <input type="password" id="registroPassword" class="form-input" placeholder="M√≠nimo 8 caracteres">
                </div>
                <div class="form-group">
                    <label class="form-label">Confirmar Contrase√±a</label>
                    <input type="password" id="registroPasswordConfirm" class="form-input" placeholder="Repite tu contrase√±a">
                </div>
                <button class="btn btn-success btn-full btn-lg" onclick="enviarCodigoVerificacion()">Crear Cuenta</button>
                <div style="text-align:center;margin-top:1rem;font-size:0.85rem;color:var(--text-secondary)">
                    ¬øNo tienes c√≥digo? Contacta al administrador
                </div>
            </div>
        </div>
    </div>

    <!-- APP -->
    <div class="app-container" id="appSection">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <div class="logo-icon">M</div>
                    <div>
                        <div class="logo-title">MAWI</div>
                        <div class="logo-subtitle">v7.0 Sistema Lukers</div>
                    </div>
                </div>
            </div>
            <nav class="nav-menu">
                <div class="nav-section">
                    <div class="nav-section-title">Principal</div>
                    <div class="nav-item active" data-vista="dashboard"><i data-lucide="layout-dashboard"></i><span>Dashboard</span></div>
                    <div class="nav-item" data-vista="inventario"><i data-lucide="package"></i><span>Inventario</span></div>
                    <div class="nav-item" data-vista="productos"><i data-lucide="database"></i><span>Productos</span></div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Operaciones</div>
                    <div class="nav-item" data-vista="ordenes"><i data-lucide="clipboard-list"></i><span>√ìrdenes</span><span class="nav-badge" id="badgeOrdenes">0</span></div>
                    <div class="nav-item" data-vista="picking"><i data-lucide="scan"></i><span>Picking</span></div>
                    <div class="nav-item" data-vista="packing"><i data-lucide="box"></i><span>Packing</span></div>
                    <div class="nav-item" data-vista="reclasificacion"><i data-lucide="repeat"></i><span>Reclasificaci√≥n</span><span class="nav-badge badge-warning" id="badgeReclas">0</span></div>
                    <div class="nav-item" data-vista="cubito"><i data-lucide="package"></i><span>Cubito Lukers</span></div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Configuraci√≥n</div>
                    <div class="nav-item" data-vista="equipos"><i data-lucide="users"></i><span>Equipos</span></div>
                    <div class="nav-item" data-vista="configuracion"><i data-lucide="settings"></i><span>Ajustes</span></div>
                </div>
            </nav>
            <div class="user-profile">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div>
                        <div class="user-name" id="userName">Usuario</div>
                        <div class="user-role" id="userRole">Rol</div>
                    </div>
                </div>
                <button class="btn btn-outline btn-sm" onclick="cerrarSesion()" style="width:100%;margin-top:0.5rem">
                    <i data-lucide="log-out" style="width:14px;height:14px"></i>
                    Cerrar Sesi√≥n
                </button>
            </div>
        </div>

        <!-- MAIN -->
        <div class="main-content">
            <header class="header">
                <div class="header-left">
                    <h1 class="header-title" id="headerTitle">Dashboard</h1>
                    <div class="header-breadcrumb">
                        <span>MAWI</span>
                        <i data-lucide="chevron-right" style="width:14px;height:14px"></i>
                        <span id="headerBreadcrumb" style="color:var(--primary);font-weight:600">Dashboard</span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-outline" onclick="sincronizarDatos()"><i data-lucide="refresh-cw" style="width:16px;height:16px"></i> Sincronizar</button>
                </div>
            </header>

            <!-- üîî Notificaci√≥n de Sincronizaci√≥n -->
            <div id="notificacionSincronizar" style="display:none;position:fixed;bottom:2rem;right:2rem;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:1.25rem 1.5rem;border-radius:12px;box-shadow:0 8px 24px rgba(102,126,234,0.4);z-index:10000;min-width:350px;animation:slideInUp 0.3s ease">
                <div style="display:flex;align-items:center;gap:1rem">
                    <div style="flex-shrink:0;width:48px;height:48px;background:rgba(255,255,255,0.2);border-radius:50%;display:flex;align-items:center;justify-content:center">
                        <i data-lucide="bell" style="width:24px;height:24px"></i>
                    </div>
                    <div style="flex:1">
                        <div style="font-weight:700;font-size:1rem;margin-bottom:0.25rem">¬°Hay cambios nuevos!</div>
                        <div style="font-size:0.85rem;opacity:0.9">Los datos han sido actualizados</div>
                    </div>
                    <button onclick="cerrarNotificacionSincronizar()" style="background:none;border:none;color:white;cursor:pointer;padding:0.25rem">
                        <i data-lucide="x" style="width:20px;height:20px"></i>
                    </button>
                </div>
                <div style="display:flex;gap:0.75rem;margin-top:1rem">
                    <button onclick="sincronizarSinPerder()" style="flex:1;background:white;color:#667eea;border:none;padding:0.6rem;border-radius:8px;font-weight:600;cursor:pointer;transition:all 0.2s" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                        <i data-lucide="refresh-cw" style="width:16px;height:16px;display:inline-block;vertical-align:middle;margin-right:0.5rem"></i>
                        Sincronizar Ahora
                    </button>
                    <button onclick="cerrarNotificacionSincronizar()" style="flex:0.5;background:rgba(255,255,255,0.15);color:white;border:none;padding:0.6rem;border-radius:8px;font-weight:600;cursor:pointer">
                        Despu√©s
                    </button>
                </div>
            </div>

            <div class="content-area" id="contentArea">
                <!-- VISTA DASHBOARD -->
                <div id="vista-dashboard" class="vista active">
                    <!-- Filtros Mejorados -->
                    <div class="filters-bar" style="background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);padding:1rem 1.5rem;border-radius:12px;box-shadow:0 4px 12px rgba(102,126,234,0.3);margin-bottom:1.5rem">
                        <div style="display:flex;flex-wrap:wrap;gap:0.75rem;align-items:center">
                            <!-- Filtro Per√≠odo -->
                            <div style="flex:1;min-width:150px">
                                <select id="filtroPeriodo" class="form-select form-input-sm" onchange="aplicarFiltrosDashboard()" style="border:none;background:rgba(255,255,255,0.95);font-weight:500;color:#1a202c;padding:0.6rem 0.8rem;border-radius:8px">
                                    <option value="hoy">üìÖ Hoy</option>
                                    <option value="semana">üìÖ Esta Semana</option>
                                    <option value="mes" selected>üìÖ Este Mes</option>
                                    <option value="a√±o">üìÖ Este A√±o</option>
                                    <option value="custom">üìÖ Personalizado</option>
                                </select>
                            </div>
                            
                            <!-- Filtro Equipo -->
                            <div style="flex:1;min-width:140px">
                                <select id="filtroEquipo" class="form-select form-input-sm" onchange="aplicarFiltrosDashboard()" style="border:none;background:rgba(255,255,255,0.95);font-weight:500;color:#1a202c;padding:0.6rem 0.8rem;border-radius:8px">
                                    <option value="">üë• Todos los equipos</option>
                                </select>
                            </div>
                            
                            <!-- Filtro G√©nero -->
                            <div style="flex:1;min-width:130px">
                                <select id="filtroGenero" class="form-select form-input-sm" onchange="aplicarFiltrosDashboard()" style="border:none;background:rgba(255,255,255,0.95);font-weight:500;color:#1a202c;padding:0.6rem 0.8rem;border-radius:8px">
                                    <option value="">üë§ Todos los g√©neros</option>
                                </select>
                            </div>
                            
                            <!-- Filtro L√≠nea -->
                            <div style="flex:1;min-width:130px">
                                <select id="filtroLinea" class="form-select form-input-sm" onchange="aplicarFiltrosDashboard()" style="border:none;background:rgba(255,255,255,0.95);font-weight:500;color:#1a202c;padding:0.6rem 0.8rem;border-radius:8px">
                                    <option value="">üìÇ Todas las l√≠neas</option>
                                </select>
                            </div>
                            
                            <!-- Filtro Tienda -->
                            <div style="flex:1;min-width:130px">
                                <select id="filtroTienda" class="form-select form-input-sm" onchange="aplicarFiltrosDashboard()" style="border:none;background:rgba(255,255,255,0.95);font-weight:500;color:#1a202c;padding:0.6rem 0.8rem;border-radius:8px">
                                    <option value="">üè™ Todas las tiendas</option>
                                </select>
                            </div>
                            
                            <!-- Bot√≥n Limpiar -->
                            <button class="btn btn-sm" onclick="limpiarFiltrosDashboard()" style="background:rgba(255,255,255,0.25);border:none;color:white;font-weight:600;padding:0.6rem 1rem;border-radius:8px;white-space:nowrap;backdrop-filter:blur(10px);transition:all 0.2s" onmouseover="this.style.background='rgba(255,255,255,0.35)'" onmouseout="this.style.background='rgba(255,255,255,0.25)'">
                                <i data-lucide="rotate-ccw" style="width:14px;height:14px"></i> Limpiar
                            </button>
                        </div>
                        
                        <!-- Filtro Custom (Fechas personalizadas) -->
                        <div id="filtroCustom" style="display:none;margin-top:0.75rem;padding-top:0.75rem;border-top:1px solid rgba(255,255,255,0.2)">
                            <div style="display:flex;gap:0.75rem;align-items:center;flex-wrap:wrap">
                                <span style="font-size:0.85rem;font-weight:600;color:white">Rango:</span>
                                <input type="date" id="filtroFechaDesde" class="form-input form-input-sm" onchange="aplicarFiltrosDashboard()" style="border:none;background:rgba(255,255,255,0.95);padding:0.5rem;border-radius:6px">
                                <span style="color:white">‚Äî</span>
                                <input type="date" id="filtroFechaHasta" class="form-input form-input-sm" onchange="aplicarFiltrosDashboard()" style="border:none;background:rgba(255,255,255,0.95);padding:0.5rem;border-radius:6px">
                            </div>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header"><div class="stat-icon blue"><i data-lucide="package"></i></div></div>
                            <div class="stat-value" id="statVariantes">0</div>
                            <div class="stat-label">Variantes en Inventario</div>
                            <div class="stat-footer"><span class="stat-footer-label">Ubicaciones</span><span class="stat-footer-value" id="statUbicaciones">0</span></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header"><div class="stat-icon green"><i data-lucide="trending-up"></i></div></div>
                            <div class="stat-value" id="statUnidades">0</div>
                            <div class="stat-label">Unidades Totales</div>
                            <div class="stat-footer"><span class="stat-footer-label">Disponibles</span><span class="stat-footer-value" id="statDisponibles">0</span></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header"><div class="stat-icon orange"><i data-lucide="shopping-cart"></i></div></div>
                            <div class="stat-value" id="statOrdenes">0</div>
                            <div class="stat-label">√ìrdenes Activas</div>
                            <div class="stat-footer"><span class="stat-footer-label">Monto Total</span><span class="stat-footer-value" id="statMontoOrdenes">S/ 0</span></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header"><div class="stat-icon purple"><i data-lucide="clock"></i></div></div>
                            <div class="stat-value" id="statTiempoProm">0<span style="font-size:0.9rem">d</span></div>
                            <div class="stat-label">Tiempo Promedio</div>
                            <div class="stat-footer"><span class="stat-footer-label">Completadas</span><span class="stat-footer-value" id="statCompletadas">0</span></div>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="charts-grid">
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title"><i data-lucide="bar-chart-3" style="width:18px;height:18px;color:var(--primary)"></i> √ìrdenes por Estado</div>
                            </div>
                            <div class="chart-wrapper"><canvas id="chartEstados"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title"><i data-lucide="trending-up" style="width:18px;height:18px;color:var(--success)"></i> Evoluci√≥n de Montos</div>
                            </div>
                            <div class="chart-wrapper"><canvas id="chartMontos"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title"><i data-lucide="users" style="width:18px;height:18px;color:var(--info)"></i> Rendimiento por Equipo</div>
                            </div>
                            <div class="chart-wrapper"><canvas id="chartEquipos"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title"><i data-lucide="pie-chart" style="width:18px;height:18px;color:var(--warning)"></i> Distribuci√≥n por G√©nero</div>
                            </div>
                            <div class="chart-wrapper"><canvas id="chartGeneros"></canvas></div>
                        </div>
                    </div>

                    <!-- Tablas de Consumo -->
                    <div style="margin-top:2rem">
                        <h3 style="margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem"><i data-lucide="bar-chart-4"></i> An√°lisis de Consumo</h3>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:1.5rem">
                            <!-- Tabla Consumo por G√©nero -->
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="card-title" style="font-size:1rem">üìä Consumo por G√©nero</h4>
                                </div>
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>G√©nero</th>
                                                <th style="text-align:right">Unidades</th>
                                                <th style="text-align:right">Monto</th>
                                                <th style="text-align:right">%</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tablaConsumoGenero">
                                            <tr><td colspan="4" class="empty-state">Sin datos</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Tabla Consumo por Tienda -->
                            <div class="card">
                                <div class="card-header">
                                    <h4 class="card-title" style="font-size:1rem">üè™ Consumo por Tienda</h4>
                                </div>
                                <div class="table-container">
                                    <table>
                                        <thead>
                                            <tr>
                                                <th>Tienda</th>
                                                <th style="text-align:right">Unidades</th>
                                                <th style="text-align:right">Monto</th>
                                                <th style="text-align:right">%</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tablaConsumoTienda">
                                            <tr><td colspan="4" class="empty-state">Sin datos</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Matriz G√©nero x Tienda -->
                        <div class="card" style="margin-top:1.5rem">
                            <div class="card-header">
                                <h4 class="card-title" style="font-size:1rem">üí∞ Matriz: G√©nero x Tienda (MONTO)</h4>
                            </div>
                            <div style="padding:1.5rem">
                                <canvas id="chartMatrizGeneroTienda" style="max-height:400px"></canvas>
                            </div>
                            <div class="table-container">
                                <table id="tablaMatrizGeneroTienda">
                                    <thead>
                                        <tr>
                                            <th>G√©nero</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td class="empty-state">Sin datos</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Las dem√°s vistas con HTML completo -->
                
                <!-- VISTA INVENTARIO -->
                <div id="vista-inventario" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i data-lucide="package"></i> Inventario <span class="badge badge-info" id="countInventario">0</span></h3>
                            <div class="card-actions">
                                <button class="btn btn-outline" onclick="abrirModal('modalAgregarItem')"><i data-lucide="plus"></i> Agregar</button>
                                <button class="btn btn-outline" onclick="abrirModal('modalSubirInventario')"><i data-lucide="upload"></i> Subir Excel</button>
                                <button class="btn btn-outline" onclick="abrirModal('modalModificarMasivo')"><i data-lucide="edit"></i> Modificar Masivo</button>
                                <button class="btn btn-outline" onclick="abrirModal('modalEliminarMasivo')"><i data-lucide="trash-2"></i> Eliminar Masivo</button>
                                <button class="btn btn-success" onclick="exportarInventarioCompleto()"><i data-lucide="download"></i> Exportar</button>
                                <button class="btn btn-warning" onclick="desbloquearTodoStock()"><i data-lucide="unlock"></i> Desbloquear Todo</button>
                            </div>
                        </div>
                        <div class="table-controls">
                            <div class="search-box"><i data-lucide="search" style="width:16px;height:16px;color:var(--text-secondary)"></i><input type="text" id="searchInventario" placeholder="Buscar variante o ubicaci√≥n..." onkeyup="filtrarInventario()"></div>
                        </div>
                        <div class="table-container"><table><thead><tr><th>Variante</th><th>Ubicaci√≥n</th><th>Stock F√≠sico</th><th>Bloqueado</th><th>Disponible</th><th>Acciones</th></tr></thead><tbody id="tablaInventario"></tbody></table></div>
                        <div class="pagination">
                            <button id="prevInventario" onclick="cambiarPagina('inventario',-1)">Anterior</button>
                            <span class="pagination-info">P√°gina <span id="paginaInventario">1</span> de <span id="totalPaginasInventario">1</span></span>
                            <button id="nextInventario" onclick="cambiarPagina('inventario',1)">Siguiente</button>
                        </div>
                    </div>
                </div>

                <!-- VISTA PRODUCTOS -->
                <div id="vista-productos" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i data-lucide="database"></i> Productos <span class="badge badge-info" id="countProductos">0</span></h3>
                            <div class="card-actions">
                                <button class="btn btn-outline" onclick="abrirModal('modalSubirProductos')"><i data-lucide="upload"></i> Subir Cat√°logo</button>
                                <button class="btn btn-success" onclick="exportarProductos()"><i data-lucide="download"></i> Exportar</button>
                            </div>
                        </div>
                        <!-- Filtros Armonizados -->
                        <div class="filters-bar">
                            <div class="filter-group">
                                <div class="search-box" style="min-width:200px">
                                    <i data-lucide="search" style="width:16px;height:16px;color:var(--text-secondary)"></i>
                                    <input type="text" id="searchProductos" placeholder="Buscar..." onkeyup="filtrarProductos()">
                                </div>
                            </div>
                            
                            <!-- Filtro G√©nero Multi-Select -->
                            <div class="filter-group">
                                <label class="filter-label">G√©nero:</label>
                                <div class="multi-select-filter" id="filtroGeneroContainer">
                                    <div class="multi-select-trigger" onclick="toggleMultiSelect('genero')">
                                        <span id="generoTriggerText">Todos</span>
                                    </div>
                                    <div class="multi-select-dropdown" id="generoDropdown">
                                        <div class="multi-select-search">
                                            <input type="text" placeholder="Buscar g√©nero..." onkeyup="buscarEnMultiSelect('genero', this.value)">
                                        </div>
                                        <div class="multi-select-options" id="generoOptions"></div>
                                        <div class="multi-select-actions">
                                            <button class="btn-clear" onclick="limpiarMultiSelect('genero')">Limpiar</button>
                                            <button class="btn-apply" onclick="aplicarMultiSelect('genero')">Aplicar</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Filtro L√≠nea Multi-Select -->
                            <div class="filter-group">
                                <label class="filter-label">L√≠nea:</label>
                                <div class="multi-select-filter" id="filtroLineaContainer">
                                    <div class="multi-select-trigger" onclick="toggleMultiSelect('linea')">
                                        <span id="lineaTriggerText">Todas</span>
                                    </div>
                                    <div class="multi-select-dropdown" id="lineaDropdown">
                                        <div class="multi-select-search">
                                            <input type="text" placeholder="Buscar l√≠nea..." onkeyup="buscarEnMultiSelect('linea', this.value)">
                                        </div>
                                        <div class="multi-select-options" id="lineaOptions"></div>
                                        <div class="multi-select-actions">
                                            <button class="btn-clear" onclick="limpiarMultiSelect('linea')">Limpiar</button>
                                            <button class="btn-apply" onclick="aplicarMultiSelect('linea')">Aplicar</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Filtro Marca Multi-Select -->
                            <div class="filter-group">
                                <label class="filter-label">Marca:</label>
                                <div class="multi-select-filter" id="filtroMarcaContainer">
                                    <div class="multi-select-trigger" onclick="toggleMultiSelect('marca')">
                                        <span id="marcaTriggerText">Todas</span>
                                    </div>
                                    <div class="multi-select-dropdown" id="marcaDropdown">
                                        <div class="multi-select-search">
                                            <input type="text" placeholder="Buscar marca..." onkeyup="buscarEnMultiSelect('marca', this.value)">
                                        </div>
                                        <div class="multi-select-options" id="marcaOptions"></div>
                                        <div class="multi-select-actions">
                                            <button class="btn-clear" onclick="limpiarMultiSelect('marca')">Limpiar</button>
                                            <button class="btn-apply" onclick="aplicarMultiSelect('marca')">Aplicar</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="table-container"><table><thead><tr><th>Variante</th><th>C√≥digo</th><th>Descripci√≥n</th><th>G√©nero</th><th>Marca</th><th>Talla</th><th>Kardex</th><th>PVP</th><th>CV (Costo Venta)</th></tr></thead><tbody id="tablaProductos"></tbody></table></div>
                        <div class="pagination">
                            <button id="prevProductos" onclick="cambiarPagina('productos',-1)">Anterior</button>
                            <span class="pagination-info">P√°gina <span id="paginaProductos">1</span> de <span id="totalPaginasProductos">1</span></span>
                            <button id="nextProductos" onclick="cambiarPagina('productos',1)">Siguiente</button>
                        </div>
                    </div>
                </div>

                <!-- VISTA √ìRDENES -->
                <div id="vista-ordenes" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i data-lucide="clipboard-list"></i> √ìrdenes</h3>
                            <div class="card-actions">
                                <button class="btn btn-primary" onclick="abrirModal('modalCrearOrden')"><i data-lucide="plus"></i> Nueva Orden</button>
                            </div>
                        </div>
                        
                        <!-- Tabs de √ìrdenes -->
                        <div class="tabs" id="tabsOrdenes">
                            <div class="tab active" data-tab="activas" onclick="cambiarTabOrden('activas')">Activos</div>
                            <div class="tab" data-tab="historial" onclick="cambiarTabOrden('historial')">Historial</div>
                        </div>
                        
                        <!-- Filtros para Activas -->
                        <div class="table-controls" id="filtrosOrdenActivas">
                            <div class="search-box"><i data-lucide="search" style="width:16px;height:16px;color:var(--text-secondary)"></i><input type="text" id="searchOrdenes" placeholder="Buscar..." onkeyup="filtrarOrdenes()"></div>
                            <select id="filtroEstadoOrden" class="form-select form-input-sm" onchange="filtrarOrdenes()"><option value="">Todos los estados</option><option value="Pendiente Divisi√≥n">Pendiente Divisi√≥n</option><option value="Pendiente Picking">Pendiente Picking</option><option value="En Picking">En Picking</option><option value="Pendiente Packing">Pendiente Packing</option><option value="En Packing">En Packing</option></select>
                        </div>
                        
                        <!-- Filtros para Historial -->
                        <div id="filtrosOrdenHistorial" style="display:none;padding:1rem 1.5rem;background:#f8fafc;border-bottom:1px solid var(--border)">
                            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem">
                                <div>
                                    <label style="display:block;margin-bottom:0.25rem;font-size:0.85rem;font-weight:500;color:#64748b">üîç Buscar orden</label>
                                    <input type="text" id="buscarOrdenHistorial" placeholder="Buscar por nombre de orden..." onkeyup="filtrarOrdenes()" style="width:100%;padding:0.5rem;border:1px solid #cbd5e0;border-radius:6px;font-size:0.85rem">
                                </div>
                                <div>
                                    <label style="display:block;margin-bottom:0.25rem;font-size:0.85rem;font-weight:500;color:#64748b">üìÖ Fecha desde</label>
                                    <input type="date" id="filtroFechaDesdeOrden" onchange="filtrarOrdenes()" style="width:100%;padding:0.5rem;border:1px solid #cbd5e0;border-radius:6px;font-size:0.85rem">
                                </div>
                                <div>
                                    <label style="display:block;margin-bottom:0.25rem;font-size:0.85rem;font-weight:500;color:#64748b">üìÖ Fecha hasta</label>
                                    <input type="date" id="filtroFechaHastaOrden" onchange="filtrarOrdenes()" style="width:100%;padding:0.5rem;border:1px solid #cbd5e0;border-radius:6px;font-size:0.85rem">
                                </div>
                                <div>
                                    <label style="display:block;margin-bottom:0.25rem;font-size:0.85rem;font-weight:500;color:#64748b">üë• Equipo</label>
                                    <select id="filtroEquipoOrden" onchange="filtrarOrdenes()" style="width:100%;padding:0.5rem;border:1px solid #cbd5e0;border-radius:6px;font-size:0.85rem">
                                        <option value="">Todos los equipos</option>
                                    </select>
                                </div>
                            </div>
                            <button onclick="limpiarFiltrosOrden()" style="margin-top:0.75rem;padding:0.4rem 1rem;background:white;border:1px solid #cbd5e0;border-radius:6px;font-size:0.85rem;cursor:pointer">üîÑ Limpiar filtros</button>
                        </div>
                        
                        <div class="table-container"><table><thead><tr><th>ID</th><th>Nombre</th><th>Fecha</th><th>Unidades</th><th>Monto</th><th>Progreso</th><th>Estado</th><th>Acciones</th></tr></thead><tbody id="tablaOrdenes"></tbody></table></div>
                    </div>
                </div>

                <!-- VISTA PICKING -->
                <div id="vista-picking" class="vista">
                    <div class="alert alert-warning" id="alertaHorario" style="display:none;margin-bottom:1rem"><i data-lucide="clock"></i><span id="alertaHorarioTexto"></span></div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i data-lucide="scan"></i> Picking</h3>
                            <div class="card-actions">
                                <button class="btn btn-outline" onclick="exportarHistorialPicking()"><i data-lucide="download"></i> Exportar Historial</button>
                            </div>
                        </div>
                        <div class="tabs" id="tabsPicking">
                            <div class="tab active" data-tab="activos" onclick="cambiarTabPicking('activos')">Activos</div>
                            <div class="tab" data-tab="historial" onclick="cambiarTabPicking('historial')">Historial</div>
                        </div>
                        <div class="table-container"><table><thead><tr><th>Orden</th><th>Parte</th><th>Equipo</th><th>Solicitado</th><th>Encontrado</th><th>Tiempo</th><th>Estado</th><th>Acciones</th></tr></thead><tbody id="tablaPicking"></tbody></table></div>
                    </div>
                </div>

                <!-- VISTA PACKING -->
                <div id="vista-packing" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i data-lucide="box"></i> Packing</h3>
                            <div class="card-actions">
                                <button class="btn btn-outline" onclick="exportarHistorialPacking()"><i data-lucide="download"></i> Exportar Historial</button>
                            </div>
                        </div>
                        <div class="tabs" id="tabsPacking">
                            <div class="tab active" data-tab="activos" onclick="cambiarTabPacking('activos')">Activos</div>
                            <div class="tab" data-tab="historial" onclick="cambiarTabPacking('historial')">Historial</div>
                        </div>
                        <div id="filtrosPackingHistorial" style="display:none;padding:1rem;background:#f8fafc;border-radius:8px;margin-bottom:1rem">
                            <div style="display:grid;grid-template-columns:1fr 200px 200px auto;gap:1rem;align-items:end">
                                <div class="form-group" style="margin:0">
                                    <label style="font-size:0.85rem;font-weight:600;color:#475569;margin-bottom:0.5rem">üîç Buscar Orden</label>
                                    <input type="text" id="buscarOrdenPacking" placeholder="Buscar por nombre de orden..." onkeyup="filtrarHistorialPacking()" style="width:100%;padding:0.5rem;border:1px solid #cbd5e0;border-radius:6px;font-size:0.85rem">
                                </div>
                                <div class="form-group" style="margin:0">
                                    <label style="font-size:0.85rem;font-weight:600;color:#475569;margin-bottom:0.5rem">üìÖ Desde</label>
                                    <input type="date" id="filtroFechaDesde" onchange="filtrarHistorialPacking()" style="width:100%;padding:0.5rem;border:1px solid #cbd5e0;border-radius:6px;font-size:0.85rem">
                                </div>
                                <div class="form-group" style="margin:0">
                                    <label style="font-size:0.85rem;font-weight:600;color:#475569;margin-bottom:0.5rem">üìÖ Hasta</label>
                                    <input type="date" id="filtroFechaHasta" onchange="filtrarHistorialPacking()" style="width:100%;padding:0.5rem;border:1px solid #cbd5e0;border-radius:6px;font-size:0.85rem">
                                </div>
                                <button onclick="limpiarFiltrosPacking()" class="btn btn-outline" style="padding:0.5rem 1rem">
                                    <i data-lucide="x" style="width:14px;height:14px"></i> Limpiar
                                </button>
                            </div>
                        </div>
                        <div class="table-container"><table><thead><tr><th>Orden</th><th>Parte</th><th>Equipo</th><th>Recibido</th><th>Empacado</th><th>Reclasificado</th><th>Tiempo</th><th>Estado</th><th>Acciones</th></tr></thead><tbody id="tablaPacking"></tbody></table></div>
                    </div>
                </div>

                <!-- VISTA RECLASIFICACI√ìN -->
                <div id="vista-reclasificacion" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i data-lucide="repeat"></i> Reclasificaci√≥n</h3>
                            <div class="card-actions">
                                <button class="btn btn-outline" onclick="exportarReclasificacionesPendientes()"><i data-lucide="download"></i> Descargar Pendientes</button>
                            </div>
                        </div>
                        <div class="tabs" id="tabsReclas">
                            <div class="tab active" data-tab="pendientes" onclick="cambiarTabReclas('pendientes')">üîÑ Pendientes</div>
                            <div class="tab" data-tab="completadas" onclick="cambiarTabReclas('completadas')">‚úÖ Completadas</div>
                            <div class="tab" data-tab="todas" onclick="cambiarTabReclas('todas')">üìã Todas</div>
                        </div>
                        <div class="table-container"><table><thead><tr><th>Orden</th><th>Parte</th><th>Variante</th><th>Cantidad</th><th>Motivo</th><th>Observaciones</th><th>Estado</th><th>Acciones</th></tr></thead><tbody id="tablaReclasificacion"></tbody></table></div>
                    </div>
                </div>

                <!-- VISTA CUBITO LUKERS -->
                <div id="vista-cubito" class="vista">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;padding:1.5rem;background:#f5f7fa">
                        
                        <!-- PANEL IZQUIERDO: Generador -->
                        <div style="background:white;border-radius:12px;padding:2rem;box-shadow:0 2px 8px rgba(0,0,0,0.08)">
                            <h3 style="margin:0 0 1.5rem 0;font-size:1.1rem;font-weight:700;color:#2d3748;display:flex;align-items:center;gap:0.5rem">
                                <i data-lucide="zap" style="width:20px;height:20px;color:#4299e1"></i>
                                Generador de Datos Verticalizados
                            </h3>
                            
                            <!-- Estad√≠sticas -->
                            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-bottom:2rem">
                                <div style="text-align:center;padding:1rem;border:2px solid #e2e8f0;border-radius:8px">
                                    <div style="font-size:0.7rem;color:#718096;text-transform:uppercase;font-weight:600;margin-bottom:0.5rem">TIENDAS</div>
                                    <div style="font-size:1.5rem;font-weight:700;color:#2d3748" id="cubitoTotalTiendas">0</div>
                                </div>
                                <div style="text-align:center;padding:1rem;border:2px solid #e2e8f0;border-radius:8px">
                                    <div style="font-size:0.7rem;color:#718096;text-transform:uppercase;font-weight:600;margin-bottom:0.5rem">PRODUCTOS</div>
                                    <div style="font-size:1.5rem;font-weight:700;color:#2d3748" id="cubitoTotalProductos">0</div>
                                </div>
                                <div style="text-align:center;padding:1rem;border:2px solid #e2e8f0;border-radius:8px">
                                    <div style="font-size:0.7rem;color:#718096;text-transform:uppercase;font-weight:600;margin-bottom:0.5rem">REGISTROS</div>
                                    <div style="font-size:1.5rem;font-weight:700;color:#2d3748" id="cubitoTotalRegistros">0</div>
                                </div>
                            </div>
                            
                            <!-- Selector de Hoja -->
                            <div style="margin-bottom:1.25rem">
                                <label style="display:block;font-size:0.8rem;font-weight:600;color:#2d3748;margin-bottom:0.5rem">
                                    <i data-lucide="file-text" style="width:14px;height:14px;display:inline-block;vertical-align:middle"></i> SELECCIONA LA HOJA:
                                </label>
                                <select id="cubitoSelectPacking" class="form-select" onchange="cargarDatosPacking()" style="width:100%;padding:0.7rem;border:1px solid #cbd5e0;border-radius:6px;font-size:0.85rem">
                                    <option value="">Seleccione una hoja</option>
                                </select>
                            </div>
                            
                            <!-- Texto Cabecera -->
                            <div style="margin-bottom:1.25rem">
                                <label style="display:block;font-size:0.8rem;font-weight:600;color:#2d3748;margin-bottom:0.5rem">
                                    <i data-lucide="type" style="width:14px;height:14px;display:inline-block;vertical-align:middle"></i> TEXTO DE CABECERA:
                                </label>
                                <input type="text" id="cubitoTextoCabecera" placeholder="Ingrese texto para la cabecera" style="width:100%;padding:0.7rem;border:1px solid #cbd5e0;border-radius:6px;font-size:0.85rem" />
                            </div>
                            
                            <!-- Fecha Actual -->
                            <div style="margin-bottom:1.25rem">
                                <label style="display:block;font-size:0.8rem;font-weight:600;color:#2d3748;margin-bottom:0.5rem">
                                    <i data-lucide="calendar" style="width:14px;height:14px;display:inline-block;vertical-align:middle"></i> FECHA ACTUAL:
                                </label>
                                <input type="text" id="cubitoFecha" readonly style="width:100%;padding:0.7rem;border:1px solid #cbd5e0;border-radius:6px;background:#f7fafc;font-size:0.85rem;font-weight:500" />
                            </div>
                            
                            <!-- Fechas Entrega -->
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1.5rem">
                                <div>
                                    <label style="display:block;font-size:0.8rem;font-weight:600;color:#2d3748;margin-bottom:0.5rem">
                                        <i data-lucide="truck" style="width:14px;height:14px;display:inline-block;vertical-align:middle"></i> ENTREGA R050:
                                    </label>
                                    <input type="date" id="cubitoFechaR050" style="width:100%;padding:0.7rem;border:1px solid #cbd5e0;border-radius:6px;font-size:0.85rem" />
                                </div>
                                <div>
                                    <label style="display:block;font-size:0.8rem;font-weight:600;color:#2d3748;margin-bottom:0.5rem">
                                        <i data-lucide="truck" style="width:14px;height:14px;display:inline-block;vertical-align:middle"></i> ENTREGA R040:
                                    </label>
                                    <input type="date" id="cubitoFechaR040" style="width:100%;padding:0.7rem;border:1px solid #cbd5e0;border-radius:6px;font-size:0.85rem" />
                                </div>
                            </div>
                            
                            <!-- Bot√≥n Verticalizar -->
                            <button id="cubitoProcesar" onclick="procesarVerticalizado()" disabled style="width:100%;padding:1rem;background:#718ba5;color:white;border:none;border-radius:8px;font-size:0.9rem;font-weight:600;cursor:pointer;transition:all 0.2s" onmouseover="if(!this.disabled){this.style.background='#5a7186'}" onmouseout="this.style.background='#718ba5'">
                                <i data-lucide="play" style="width:16px;height:16px;display:inline-block;vertical-align:middle"></i> 
                                Verticalizar Datos
                            </button>
                        </div>
                        
                        <!-- PANEL DERECHO: Resumen -->
                        <div style="background:white;border-radius:12px;padding:2rem;box-shadow:0 2px 8px rgba(0,0,0,0.08)">
                            <h3 style="margin:0 0 1.5rem 0;font-size:1.1rem;font-weight:700;color:#2d3748;display:flex;align-items:center;gap:0.5rem">
                                <i data-lucide="bar-chart-2" style="width:20px;height:20px;color:#4299e1"></i>
                                Resumen de Tiendas
                            </h3>
                            
                            <!-- B√∫squeda -->
                            <div style="margin-bottom:1rem">
                                <input type="text" id="cubitoSearchResumen" placeholder="üîç Buscar en la tabla..." onkeyup="filtrarResumenTiendas()" style="width:100%;padding:0.7rem;border:1px solid #cbd5e0;border-radius:6px;font-size:0.85rem" />
                            </div>
                            
                            <!-- Tabla -->
                            <div style="border:1px solid #e2e8f0;border-radius:8px;overflow:hidden;margin-bottom:1.5rem">
                                <table style="width:100%;border-collapse:collapse;font-size:0.85rem">
                                    <thead style="background:#f7fafc">
                                        <tr>
                                            <th style="padding:0.75rem;text-align:left;font-weight:700;color:#4a5568;border-bottom:1px solid #e2e8f0">
                                                <i data-lucide="home" style="width:14px;height:14px;display:inline-block;vertical-align:middle;margin-right:0.25rem"></i> TIENDA
                                            </th>
                                            <th style="padding:0.75rem;text-align:center;font-weight:700;color:#4a5568;border-bottom:1px solid #e2e8f0">
                                                <i data-lucide="building" style="width:14px;height:14px;display:inline-block;vertical-align:middle;margin-right:0.25rem"></i> SOCIEDAD
                                            </th>
                                            <th style="padding:0.75rem;text-align:center;font-weight:700;color:#4a5568;border-bottom:1px solid #e2e8f0">
                                                <i data-lucide="package" style="width:14px;height:14px;display:inline-block;vertical-align:middle;margin-right:0.25rem"></i> CANTIDAD
                                            </th>
                                            <th style="padding:0.75rem;text-align:center;font-weight:700;color:#4a5568;border-bottom:1px solid #e2e8f0">
                                                <i data-lucide="percent" style="width:14px;height:14px;display:inline-block;vertical-align:middle;margin-right:0.25rem"></i> % DEL TOTAL
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody id="cubitoTablaResumen">
                                        <tr>
                                            <td colspan="4" style="text-align:center;padding:3rem;color:#a0aec0;background:white">
                                                <div style="font-size:2rem;margin-bottom:0.5rem">‚ÑπÔ∏è</div>
                                                <div style="font-size:0.9rem">No hay datos disponibles</div>
                                            </td>
                                        </tr>
                                    </tbody>
                                    <tfoot style="background:#fef9e7;border-top:2px solid #f0b429">
                                        <tr>
                                            <td colspan="2" style="padding:0.75rem;font-weight:700;color:#2d3748">
                                                <i data-lucide="calculator" style="width:14px;height:14px;display:inline-block;vertical-align:middle;margin-right:0.25rem"></i> Total
                                            </td>
                                            <td id="cubitoTotalCantidad" style="padding:0.75rem;text-align:center;font-weight:700;color:#2d3748">0</td>
                                            <td style="padding:0.75rem;text-align:center;font-weight:700;color:#2d3748">100%</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                            
                            <!-- Secci√≥n Acciones -->
                            <div style="text-align:center;margin-bottom:1rem">
                                <div style="font-size:0.9rem;font-weight:700;color:#2d3748;margin-bottom:0rem;display:flex;align-items:center;justify-content:center;gap:0.5rem">
                                    <i data-lucide="settings" style="width:16px;height:16px"></i> Acciones Disponibles
                                </div>
                            </div>
                            
                            <!-- Botones -->
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem">
                                <button id="cubitoVisualizarBtn" onclick="abrirModalSeleccionSociedad()" disabled style="padding:0.9rem;background:#718ba5;color:white;border:none;border-radius:8px;font-size:0.85rem;font-weight:600;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:0.5rem" onmouseover="if(!this.disabled){this.style.background='#5a7186'}" onmouseout="this.style.background='#718ba5'">
                                    <i data-lucide="eye" style="width:16px;height:16px"></i> 
                                    Visualizar Datos
                                </button>
                                <button onclick="exportarVerticalizados()" id="btnExportarCubito" disabled style="padding:0.9rem;background:#718ba5;color:white;border:none;border-radius:8px;font-size:0.85rem;font-weight:600;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:0.5rem" onmouseover="if(!this.disabled){this.style.background='#5a7186'}" onmouseout="this.style.background='#718ba5'">
                                    <i data-lucide="download" style="width:16px;height:16px"></i> 
                                    Descargar Archivo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- VISTA EQUIPOS -->
                <div id="vista-equipos" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i data-lucide="users"></i> Equipos</h3>
                            <div class="card-actions">
                                <button class="btn btn-primary" onclick="equipoActual=null;document.getElementById('tituloModalEquipo').textContent='Nuevo Equipo';document.getElementById('equipoNombre').value='';document.getElementById('equipoIntegrantes').value='';abrirModal('modalCrearEquipo')"><i data-lucide="plus"></i> Nuevo Equipo</button>
                            </div>
                        </div>
                        <div class="tabs">
                            <div class="tab active" data-tipo="picking" onclick="cambiarTabEquipos('picking')">Picking</div>
                            <div class="tab" data-tipo="packing" onclick="cambiarTabEquipos('packing')">Packing</div>
                        </div>
                        <div class="table-container"><table><thead><tr><th>Nombre</th><th>Integrantes</th><th>Tipo</th><th>Estado</th><th>Acciones</th></tr></thead><tbody id="tablaEquipos"></tbody></table></div>
                    </div>
                </div>

                <!-- VISTA CONFIGURACI√ìN -->
                <div id="vista-configuracion" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i data-lucide="settings"></i> Configuraci√≥n</h3>
                        </div>
                        <div class="tabs">
                            <div class="tab active" data-config="columnas" onclick="cambiarTabConfig('columnas')">Columnas de Hojas</div>
                            <div class="tab" data-config="tiendas" onclick="cambiarTabConfig('tiendas')">Tiendas</div>
                            <div class="tab" data-config="horarios" onclick="cambiarTabConfig('horarios')">Horarios</div>
                            <div class="tab" data-config="general" onclick="cambiarTabConfig('general')">General</div>
                        </div>
                        
                        <div class="config-section" id="configColumnas" style="padding:1.5rem">
                            <!-- COLUMNAS PARA PICKING -->
                            <div style="background:#f8f9fa;padding:1.25rem;border-radius:8px;margin-bottom:1.5rem">
                                <h4 style="margin-bottom:1rem;color:var(--primary)">
                                    <i data-lucide="package-search" style="width:20px;height:20px;vertical-align:middle"></i>
                                    Columnas de Hoja de Picking
                                </h4>
                                <div id="columnasPickingCheckboxes" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:0.75rem">
                                    <label class="form-check"><input type="checkbox" value="Parte" checked> Parte</label>
                                    <label class="form-check"><input type="checkbox" value="Ubicaci√≥n" checked> Ubicaci√≥n</label>
                                    <label class="form-check"><input type="checkbox" value="Stock F√≠sico" checked> Stock F√≠sico</label>
                                    <label class="form-check"><input type="checkbox" value="Stock Bloqueado" checked> Stock Bloqueado</label>
                                    <label class="form-check"><input type="checkbox" value="Stock Disponible" checked> Stock Disponible</label>
                                    <label class="form-check"><input type="checkbox" value="Variante" checked> Variante</label>
                                    <label class="form-check"><input type="checkbox" value="C√≥digo Comercial" checked> C√≥digo Comercial</label>
                                    <label class="form-check"><input type="checkbox" value="Descripci√≥n" checked> Descripci√≥n</label>
                                    <label class="form-check"><input type="checkbox" value="Marca" checked> Marca</label>
                                    <label class="form-check"><input type="checkbox" value="G√©nero" checked> G√©nero</label>
                                    <label class="form-check"><input type="checkbox" value="L√≠nea" checked> L√≠nea</label>
                                    <label class="form-check"><input type="checkbox" value="Talla" checked> Talla</label>
                                    <label class="form-check"><input type="checkbox" value="Color" checked> Color</label>
                                    <label class="form-check"><input type="checkbox" value="Kardex" checked> Kardex</label>
                                    <label class="form-check"><input type="checkbox" value="PVP" checked> PVP</label>
                                    <label class="form-check"><input type="checkbox" value="CV" checked> CV (Costo Venta)</label>
                                    <label class="form-check"><input type="checkbox" value="Solicitado" checked> Solicitado</label>
                                    <label class="form-check"><input type="checkbox" value="Encontrado" checked> Encontrado</label>
                                </div>
                            </div>

                            <!-- COLUMNAS PARA PACKING -->
                            <div style="background:#fff3cd;padding:1.25rem;border-radius:8px;margin-bottom:1.5rem">
                                <h4 style="margin-bottom:1rem;color:#856404">
                                    <i data-lucide="package" style="width:20px;height:20px;vertical-align:middle"></i>
                                    Columnas de Hoja de Packing
                                </h4>
                                <div id="columnasPackingCheckboxes" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:0.75rem">
                                    <label class="form-check"><input type="checkbox" value="Parte" checked> Parte</label>
                                    <label class="form-check"><input type="checkbox" value="Ubicaci√≥n" checked> Ubicaci√≥n</label>
                                    <label class="form-check"><input type="checkbox" value="Variante" checked> Variante</label>
                                    <label class="form-check"><input type="checkbox" value="C√≥digo Comercial" checked> C√≥digo Comercial</label>
                                    <label class="form-check"><input type="checkbox" value="Descripci√≥n" checked> Descripci√≥n</label>
                                    <label class="form-check"><input type="checkbox" value="Marca" checked> Marca</label>
                                    <label class="form-check"><input type="checkbox" value="G√©nero" checked> G√©nero</label>
                                    <label class="form-check"><input type="checkbox" value="L√≠nea" checked> L√≠nea</label>
                                    <label class="form-check"><input type="checkbox" value="Talla" checked> Talla</label>
                                    <label class="form-check"><input type="checkbox" value="Color" checked> Color</label>
                                    <label class="form-check"><input type="checkbox" value="Kardex" checked> Kardex</label>
                                    <label class="form-check"><input type="checkbox" value="PVP" checked> PVP</label>
                                    <label class="form-check"><input type="checkbox" value="CV" checked> CV (Costo Venta)</label>
                                    <label class="form-check"><input type="checkbox" value="Solicitado" checked> Solicitado</label>
                                    <label class="form-check"><input type="checkbox" value="Encontrado" checked> Encontrado</label>
                                    <label class="form-check"><input type="checkbox" value="Tiendas" checked disabled> Columnas de Tiendas (siempre)</label>
                                </div>
                            </div>

                            <div style="display:flex;gap:0.75rem">
                                <button class="btn btn-primary" onclick="guardarConfigGeneral()">
                                    <i data-lucide="save" style="width:16px;height:16px"></i> Guardar Configuraci√≥n
                                </button>
                                <button class="btn btn-outline" onclick="restablecerColumnas()">
                                    <i data-lucide="rotate-ccw" style="width:16px;height:16px"></i> Restablecer a Predeterminado
                                </button>
                            </div>
                        </div>

                        <div class="config-section" id="configTiendas" style="display:none;padding:1.5rem">
                            <h4 style="margin-bottom:1rem">Gesti√≥n de Tiendas</h4>
                            <div class="form-group">
                                <label class="form-label">Agregar Nueva Tienda</label>
                                <div style="display:flex;gap:0.5rem">
                                    <input type="text" id="inputNuevaTienda" class="form-input" placeholder="Nombre de la tienda">
                                    <button class="btn btn-primary" onclick="agregarTienda()">Agregar</button>
                                </div>
                            </div>
                            <h4 style="margin:1.5rem 0 1rem">Tiendas Actuales</h4>
                            <div class="chips" id="listaTiendas"></div>
                            <button class="btn btn-primary" style="margin-top:1.5rem" onclick="guardarConfigTiendas()">Guardar</button>
                        </div>

                        <div class="config-section" id="configHorarios" style="display:none;padding:1.5rem">
                            <h4 style="margin-bottom:1rem">Horarios de Trabajo</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Hora Inicio</label>
                                    <input type="time" id="horaInicio" class="form-input" value="08:30" onchange="calcularTiempoEfectivo()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Hora Fin</label>
                                    <input type="time" id="horaFin" class="form-input" value="19:00" onchange="calcularTiempoEfectivo()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Almuerzo (minutos)</label>
                                    <input type="number" id="duracionAlmuerzo" class="form-input" value="60" onchange="calcularTiempoEfectivo()">
                                </div>
                            </div>
                            <div class="alert alert-info"><i data-lucide="info"></i><span>Tiempo efectivo: <strong id="tiempoEfectivo">9.5 horas</strong></span></div>
                            <button class="btn btn-primary" onclick="guardarConfigHorarios()">Guardar</button>
                        </div>

                        <div class="config-section" id="configGeneral" style="display:none;padding:1.5rem">
                            <h4 style="margin-bottom:1rem">Configuraci√≥n General</h4>
                            <div class="form-group">
                                <label class="form-label">Items por P√°gina</label>
                                <input type="number" class="form-input" value="100">
                            </div>
                            <div class="form-group">
                                <label class="form-label">D√≠as para Expiraci√≥n de √ìrdenes</label>
                                <input type="number" class="form-input" value="30">
                            </div>
                            <button class="btn btn-primary" onclick="guardarConfigGeneral()">Guardar</button>
                            <hr style="margin:2rem 0">
                            <h4 style="margin-bottom:1rem">Mantenimiento</h4>
                            <button class="btn btn-warning" onclick="limpiarOrdenesAntiguas()"><i data-lucide="trash-2"></i> Limpiar √ìrdenes Antiguas</button>
                            <button class="btn btn-success" onclick="exportarBackup()"><i data-lucide="download"></i> Exportar Backup</button>
                        </div>
                    </div>
                </div>

                <!-- MODALES (Agregar todos los modales necesarios) -->
                <div class="modal" id="modalAgregarItem"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Agregar Item</h3><button class="modal-close" onclick="cerrarModal('modalAgregarItem')"><i data-lucide="x"></i></button></div><div class="modal-body"><div class="form-group"><label class="form-label">Variante</label><input type="text" id="inputVariante" class="form-input"></div><div class="form-group"><label class="form-label">Ubicaci√≥n</label><input type="text" id="inputUbicacion" class="form-input"></div><div class="form-group"><label class="form-label">Stock</label><input type="number" id="inputStock" class="form-input"></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="cerrarModal('modalAgregarItem')">Cancelar</button><button class="btn btn-primary" onclick="guardarItem()">Guardar</button></div></div></div>

                <div class="modal" id="modalSubirInventario"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Subir Inventario</h3><button class="modal-close" onclick="cerrarModal('modalSubirInventario')"><i data-lucide="x"></i></button></div><div class="modal-body"><div class="alert alert-info" style="margin-bottom:1rem"><div style="display:flex;align-items:start;gap:0.75rem"><i data-lucide="info" style="width:20px;height:20px;flex-shrink:0;margin-top:2px"></i><div style="flex:1"><strong>üìã Columnas OBLIGATORIAS:</strong><div style="margin-top:0.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:0.5rem;font-size:0.85rem"><div><code style="background:rgba(0,0,0,0.05);padding:2px 6px;border-radius:4px;color:#dc2626;font-weight:600">Variante</code></div><div><code style="background:rgba(0,0,0,0.05);padding:2px 6px;border-radius:4px;color:#dc2626;font-weight:600">Descripci√≥n</code></div><div><code style="background:rgba(0,0,0,0.05);padding:2px 6px;border-radius:4px;color:#dc2626;font-weight:600">Stock_Fisico</code></div><div><code style="background:rgba(0,0,0,0.05);padding:2px 6px;border-radius:4px;color:#dc2626;font-weight:600">Ubicaci√≥n</code></div></div><div style="margin-top:0.75rem"><strong>Columnas opcionales:</strong><div style="margin-top:0.5rem;font-size:0.82rem;color:#64748b">Genero, Linea, Talla, Stock_Bloqueado, Punto_Reorden</div></div></div></div></div><div class="form-group"><input type="file" id="fileInventario" class="form-file" accept=".xlsx,.xls" onchange="mostrarArchivoSeleccionado(this,'fileInventarioInfo')"><label for="fileInventario" class="file-upload-btn"><i data-lucide="file-plus"></i> Seleccionar archivo</label><div class="file-selected" id="fileInventarioInfo"><div class="file-selected-icon"><i data-lucide="check"></i></div><span class="file-selected-name"></span><button class="file-selected-remove" onclick="limpiarArchivo('fileInventario','fileInventarioInfo')"><i data-lucide="x"></i></button></div></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="cerrarModal('modalSubirInventario')">Cancelar</button><button class="btn btn-primary" onclick="procesarInventario()">Procesar</button></div></div></div>

                <div class="modal" id="modalModificarMasivo"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Modificar Masivo</h3><button class="modal-close" onclick="cerrarModal('modalModificarMasivo')"><i data-lucide="x"></i></button></div><div class="modal-body"><div class="alert alert-info" style="margin-bottom:1rem"><div style="display:flex;align-items:start;gap:0.75rem"><i data-lucide="info" style="width:20px;height:20px;flex-shrink:0;margin-top:2px"></i><div style="flex:1"><strong>üìã Columnas para identificar (OBLIGATORIAS):</strong><div style="margin-top:0.5rem;display:flex;gap:0.5rem;font-size:0.85rem"><div><code style="background:rgba(0,0,0,0.05);padding:2px 6px;border-radius:4px;color:#dc2626;font-weight:600">Variante</code></div><div><code style="background:rgba(0,0,0,0.05);padding:2px 6px;border-radius:4px;color:#dc2626;font-weight:600">Ubicaci√≥n</code></div></div><div style="margin-top:0.75rem"><strong>Columnas a modificar (al menos una):</strong><div style="margin-top:0.5rem;font-size:0.82rem;color:#64748b">Stock_Fisico, Stock_Bloqueado, Punto_Reorden, Descripci√≥n</div></div></div></div></div><div class="form-group"><input type="file" id="fileModificar" class="form-file" accept=".xlsx,.xls" onchange="mostrarArchivoSeleccionado(this,'fileModificarInfo')"><label for="fileModificar" class="file-upload-btn"><i data-lucide="file-plus"></i> Seleccionar archivo</label><div class="file-selected" id="fileModificarInfo"><div class="file-selected-icon"><i data-lucide="check"></i></div><span class="file-selected-name"></span><button class="file-selected-remove" onclick="limpiarArchivo('fileModificar','fileModificarInfo')"><i data-lucide="x"></i></button></div></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="cerrarModal('modalModificarMasivo')">Cancelar</button><button class="btn btn-primary" onclick="procesarModificarMasivo()">Modificar</button></div></div></div>

                <div class="modal" id="modalEliminarMasivo"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Eliminar Masivo</h3><button class="modal-close" onclick="cerrarModal('modalEliminarMasivo')"><i data-lucide="x"></i></button></div><div class="modal-body"><div class="alert alert-danger"><i data-lucide="alert-triangle"></i><span>Esta acci√≥n eliminar√° los registros especificados</span></div><div class="alert alert-info" style="margin-bottom:1rem;margin-top:1rem"><div style="display:flex;align-items:start;gap:0.75rem"><i data-lucide="info" style="width:20px;height:20px;flex-shrink:0;margin-top:2px"></i><div style="flex:1"><strong>üìã Columnas OBLIGATORIAS:</strong><div style="margin-top:0.5rem;display:flex;gap:0.5rem;font-size:0.85rem"><div><code style="background:rgba(0,0,0,0.05);padding:2px 6px;border-radius:4px;color:#dc2626;font-weight:600">Variante</code></div><div><code style="background:rgba(0,0,0,0.05);padding:2px 6px;border-radius:4px;color:#dc2626;font-weight:600">Ubicaci√≥n</code></div></div><div style="margin-top:0.5rem;font-size:0.82rem;color:#64748b">Se eliminar√°n los registros que coincidan con estas variantes y ubicaciones</div></div></div></div><div class="form-group"><input type="file" id="fileEliminar" class="form-file" accept=".xlsx,.xls" onchange="mostrarArchivoSeleccionado(this,'fileEliminarInfo')"><label for="fileEliminar" class="file-upload-btn"><i data-lucide="file-plus"></i> Seleccionar archivo</label><div class="file-selected" id="fileEliminarInfo"><div class="file-selected-icon"><i data-lucide="check"></i></div><span class="file-selected-name"></span><button class="file-selected-remove" onclick="limpiarArchivo('fileEliminar','fileEliminarInfo')"><i data-lucide="x"></i></button></div></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="cerrarModal('modalEliminarMasivo')">Cancelar</button><button class="btn btn-danger" onclick="procesarEliminarMasivo()">Eliminar</button></div></div></div>

                <div class="modal" id="modalVerVariante"><div class="modal-content large"><div class="modal-header"><h3 class="modal-title">Detalle de Variante</h3><button class="modal-close" onclick="cerrarModal('modalVerVariante')"><i data-lucide="x"></i></button></div><div class="modal-body" id="varianteDetalleContent"></div><div class="modal-footer"><button class="btn btn-outline" onclick="cerrarModal('modalVerVariante')">Cerrar</button></div></div></div>

                <div class="modal" id="modalSubirProductos"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Subir Cat√°logo</h3><button class="modal-close" onclick="cerrarModal('modalSubirProductos')"><i data-lucide="x"></i></button></div><div class="modal-body"><div class="alert alert-warning"><i data-lucide="alert-triangle"></i><span>Esto reemplazar√° todo el cat√°logo actual</span></div><div class="form-group"><input type="file" id="fileProductos" class="form-file" accept=".xlsx,.xls" onchange="mostrarArchivoSeleccionado(this,'fileProductosInfo')"><label for="fileProductos" class="file-upload-btn"><i data-lucide="file-plus"></i> Seleccionar archivo</label><div class="file-selected" id="fileProductosInfo"><div class="file-selected-icon"><i data-lucide="check"></i></div><span class="file-selected-name"></span><button class="file-selected-remove" onclick="limpiarArchivo('fileProductos','fileProductosInfo')"><i data-lucide="x"></i></button></div></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="cerrarModal('modalSubirProductos')">Cancelar</button><button class="btn btn-primary" onclick="procesarProductos()">Procesar</button></div></div></div>

                <!-- Modal de Validaciones -->
                <div class="modal" id="modalValidaciones"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Validaciones</h3><button class="modal-close" onclick="cerrarModal('modalValidaciones')"><i data-lucide="x"></i></button></div><div class="modal-body" id="alertasValidacionContent"></div></div></div>

                <div class="modal" id="modalCrearOrden">
                    <div class="modal-content large">
                        <div class="modal-header">
                            <h3 class="modal-title">Nueva Orden</h3>
                            <button class="modal-close" onclick="cerrarModal('modalCrearOrden')"><i data-lucide="x"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <label class="form-label">Nombre de la Orden</label>
                                <input type="text" id="ordenNombre" class="form-input" placeholder="Ej: Tops Mujer Semana 48">
                            </div>
                            
                            <!-- Informaci√≥n de columnas requeridas -->
                            <div class="alert alert-info" style="margin-bottom:1rem">
                                <div style="display:flex;align-items:start;gap:0.75rem">
                                    <i data-lucide="info" style="width:20px;height:20px;flex-shrink:0;margin-top:2px"></i>
                                    <div>
                                        <strong>üìã Columnas requeridas en el archivo Excel:</strong>
                                        <div style="margin-top:0.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:0.5rem;font-size:0.85rem">
                                            <div><code style="background:rgba(0,0,0,0.05);padding:2px 6px;border-radius:4px">Variante</code></div>
                                            <div><code style="background:rgba(0,0,0,0.05);padding:2px 6px;border-radius:4px">Cantidad</code></div>
                                            <div><code style="background:rgba(0,0,0,0.05);padding:2px 6px;border-radius:4px">Ubicacion</code></div>
                                        </div>
                                        <div style="margin-top:0.5rem;font-size:0.85rem">
                                            <strong>Columnas opcionales de distribuci√≥n por tienda:</strong><br>
                                            <code style="background:rgba(0,0,0,0.05);padding:2px 6px;border-radius:4px;font-size:0.75rem">LUKERS EL SOL</code>
                                            <code style="background:rgba(0,0,0,0.05);padding:2px 6px;border-radius:4px;font-size:0.75rem">LUKERS TRU PIZARRO</code>
                                            <code style="background:rgba(0,0,0,0.05);padding:2px 6px;border-radius:4px;font-size:0.75rem">LUKERS LA MARINA</code>
                                            <span style="opacity:0.7">... (una columna por cada tienda)</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <input type="file" id="fileOrden" class="form-file" accept=".xlsx,.xls" onchange="mostrarArchivoSeleccionado(this,'fileOrdenInfo');previsualizarOrden()">
                                <label for="fileOrden" class="file-upload-btn">
                                    <i data-lucide="file-plus"></i> Seleccionar archivo Excel
                                </label>
                                <div class="file-selected" id="fileOrdenInfo">
                                    <div class="file-selected-icon"><i data-lucide="check"></i></div>
                                    <span class="file-selected-name"></span>
                                    <button class="file-selected-remove" onclick="limpiarArchivo('fileOrden','fileOrdenInfo')"><i data-lucide="x"></i></button>
                                </div>
                            </div>
                            
                            <div class="alert alert-info" id="previewOrden" style="display:none;margin-top:1rem">
                                <div id="previewOrdenContent"></div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline" onclick="cerrarModal('modalCrearOrden')">Cancelar</button>
                            <button class="btn btn-primary" onclick="crearOrden()">Crear Orden</button>
                        </div>
                    </div>
                </div>

                <div class="modal" id="modalDividirOrden"><div class="modal-content xl"><div class="modal-header"><h3 class="modal-title">Dividir Orden</h3><button class="modal-close" onclick="cerrarModal('modalDividirOrden')"><i data-lucide="x"></i></button></div><div class="modal-body"><div class="detail-grid" style="margin-bottom:1.5rem"><div class="detail-item"><div class="detail-label">Orden</div><div class="detail-value" id="divOrdenNombre"></div></div><div class="detail-item"><div class="detail-label">Variantes</div><div class="detail-value" id="divOrdenVariantes"></div></div><div class="detail-item"><div class="detail-label">Unidades</div><div class="detail-value" id="divOrdenUnidades"></div></div></div><div class="form-group"><label class="form-label">N√∫mero de Partes</label><input type="number" id="numPartes" class="form-input" value="1" min="1" max="10" onchange="generarPartesConfig()"></div><div id="partesConfig"></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="cerrarModal('modalDividirOrden')">Cancelar</button><button class="btn btn-primary" onclick="confirmarDivision()">Confirmar Divisi√≥n</button></div></div></div>

                <div class="modal" id="modalSubirCantidades">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">Subir Cantidades Encontradas</h3>
                            <button class="modal-close" onclick="cerrarModal('modalSubirCantidades')"><i data-lucide="x"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info" style="margin-bottom:1rem">
                                <div style="display:flex;align-items:start;gap:0.75rem">
                                    <i data-lucide="info" style="width:20px;height:20px;flex-shrink:0;margin-top:2px"></i>
                                    <div>
                                        <strong>üìã Columnas requeridas:</strong>
                                        <div style="margin-top:0.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:0.5rem;font-size:0.85rem">
                                            <div><code style="background:rgba(0,0,0,0.05);padding:2px 6px;border-radius:4px">Variante</code></div>
                                            <div><code style="background:rgba(0,0,0,0.05);padding:2px 6px;border-radius:4px">Ubicacion</code></div>
                                            <div><code style="background:rgba(0,0,0,0.05);padding:2px 6px;border-radius:4px">Encontrado</code></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group">
                                <input type="file" id="fileCantidades" class="form-file" accept=".xlsx,.xls" onchange="mostrarArchivoSeleccionado(this,'fileCantidadesInfo')">
                                <label for="fileCantidades" class="file-upload-btn"><i data-lucide="file-plus"></i> Seleccionar archivo</label>
                                <div class="file-selected" id="fileCantidadesInfo">
                                    <div class="file-selected-icon"><i data-lucide="check"></i></div>
                                    <span class="file-selected-name"></span>
                                    <button class="file-selected-remove" onclick="limpiarArchivo('fileCantidades','fileCantidadesInfo')"><i data-lucide="x"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline" onclick="cerrarModal('modalSubirCantidades')">Cancelar</button>
                            <button class="btn btn-primary" onclick="confirmarSubirCantidades()">Confirmar</button>
                        </div>
                    </div>
                </div>

                <div class="modal" id="modalPicking"><div class="modal-content large"><div class="modal-header"><h3 class="modal-title" id="tituloModalPicking">Picking</h3><button class="modal-close" onclick="cerrarModal('modalPicking')"><i data-lucide="x"></i></button></div><div class="modal-body" id="pickingContent"></div><div class="modal-footer" id="pickingFooter"></div></div></div>

                <div class="modal" id="modalPacking"><div class="modal-content large"><div class="modal-header"><h3 class="modal-title" id="tituloModalPacking">Packing</h3><button class="modal-close" onclick="cerrarModal('modalPacking')"><i data-lucide="x"></i></button></div><div class="modal-body" id="packingContent"></div><div class="modal-footer" id="packingFooter"></div></div></div>

                <div class="modal" id="modalCompletarReclas"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Completar Reclasificaci√≥n</h3><button class="modal-close" onclick="cerrarModal('modalCompletarReclas')"><i data-lucide="x"></i></button></div><div class="modal-body" id="completarReclasContent"></div><div class="modal-footer"><button class="btn btn-outline" onclick="cerrarModal('modalCompletarReclas')">Cancelar</button><button class="btn btn-primary" onclick="confirmarCompletarReclas()">Confirmar</button></div></div></div>

                <!-- Modal Reclasificar Productos No Empacados -->
                <div class="modal" id="modalReclasificarNoEmpacados">
                    <div class="modal-content xl">
                        <div class="modal-header">
                            <h3 class="modal-title">üì¶ Productos NO EMPACADOS - Reclasificaci√≥n</h3>
                            <button class="modal-close" onclick="cerrarModalReclasificacion()"><i data-lucide="x"></i></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-warning" style="margin-bottom:1.5rem">
                                <i data-lucide="alert-triangle"></i>
                                <span><strong>Productos encontrados pero NO empacados:</strong> Debes especificar el motivo y las observaciones para cada producto.</span>
                            </div>
                            
                            <div id="listaProductosNoEmpacados"></div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-outline" onclick="cerrarModalReclasificacion()">Cancelar</button>
                            <button class="btn btn-primary" onclick="guardarReclasificacionYCompletar()">‚úÖ Guardar y Completar Packing</button>
                        </div>
                    </div>
                </div>

                <div class="modal" id="modalCrearEquipo"><div class="modal-content"><div class="modal-header"><h3 class="modal-title" id="tituloModalEquipo">Nuevo Equipo</h3><button class="modal-close" onclick="cerrarModal('modalCrearEquipo')"><i data-lucide="x"></i></button></div><div class="modal-body"><div class="form-group"><label class="form-label">Nombre</label><input type="text" id="equipoNombre" class="form-input"></div><div class="form-group"><label class="form-label">Tipo</label><select id="equipoTipo" class="form-select"><option value="picking">Picking</option><option value="packing">Packing</option></select></div><div class="form-group"><label class="form-label">Integrantes (uno por l√≠nea)</label><textarea id="equipoIntegrantes" class="form-textarea" rows="5"></textarea></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="cerrarModal('modalCrearEquipo')">Cancelar</button><button class="btn btn-primary" onclick="guardarEquipo()">Guardar</button></div></div></div>

                <div class="modal" id="modalHistorialOrden"><div class="modal-content xl"><div class="modal-header"><h3 class="modal-title">Historial de Orden</h3><button class="modal-close" onclick="cerrarModal('modalHistorialOrden')"><i data-lucide="x"></i></button></div><div class="modal-body" id="historialOrdenBody"></div><div class="modal-footer"><button class="btn btn-outline" onclick="cerrarModal('modalHistorialOrden')">Cerrar</button></div></div></div>

                <!-- Modal Visualizaci√≥n Cubito -->
                <!-- MODAL: SELECCI√ìN DE SOCIEDAD -->
                <div class="modal" id="modalSeleccionSociedad">
                    <div class="modal-content" style="max-width:420px;background:white;border-radius:12px">
                        <div style="text-align:center;padding:2.5rem 2rem">
                            <h3 style="margin:0 0 0.5rem 0;font-size:1.15rem;font-weight:700;color:#2d3748;display:flex;align-items:center;justify-content:center;gap:0.5rem">
                                <i data-lucide="filter" style="width:22px;height:22px"></i>
                                Seleccione Sociedad a Visualizar
                            </h3>
                            <div style="width:60px;height:3px;background:#0066cc;margin:0.75rem auto 2rem auto"></div>
                            
                            <div style="display:flex;flex-direction:column;gap:0.875rem">
                                <button onclick="visualizarDatosVerticalizados('R050');cerrarModal('modalSeleccionSociedad')" style="width:100%;padding:1.1rem;background:#0066cc;color:white;border:none;border-radius:8px;font-size:0.95rem;font-weight:600;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:0.625rem" onmouseover="this.style.background='#0052a3'" onmouseout="this.style.background='#0066cc'">
                                    <i data-lucide="building" style="width:20px;height:20px"></i>
                                    Sociedad R050
                                </button>
                                <button onclick="visualizarDatosVerticalizados('R040');cerrarModal('modalSeleccionSociedad')" style="width:100%;padding:1.1rem;background:#0066cc;color:white;border:none;border-radius:8px;font-size:0.95rem;font-weight:600;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:0.625rem" onmouseover="this.style.background='#0052a3'" onmouseout="this.style.background='#0066cc'">
                                    <i data-lucide="building-2" style="width:20px;height:20px"></i>
                                    Sociedad R040
                                </button>
                                <button onclick="visualizarDatosVerticalizados('TODAS');cerrarModal('modalSeleccionSociedad')" style="width:100%;padding:1.1rem;background:#0066cc;color:white;border:none;border-radius:8px;font-size:0.95rem;font-weight:600;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:0.625rem" onmouseover="this.style.background='#0052a3'" onmouseout="this.style.background='#0066cc'">
                                    <i data-lucide="layers" style="width:20px;height:20px"></i>
                                    Todas las Sociedades
                                </button>
                            </div>
                            
                            <button onclick="cerrarModal('modalSeleccionSociedad')" style="margin-top:1.75rem;padding:0.85rem 1.75rem;background:#e2e8f0;color:#2d3748;border:none;border-radius:8px;font-size:0.9rem;font-weight:600;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background='#cbd5e0'" onmouseout="this.style.background='#e2e8f0'">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- MODAL: VISUALIZACI√ìN DE DATOS (Estilo Excel) -->
                <div class="modal" id="modalCubitoVisualizacion">
                    <div class="modal-content" style="max-width:96%;width:96%;max-height:94vh;border-radius:12px;overflow:hidden">
                        <!-- Header con gradiente azul-verde -->
                        <div style="background:linear-gradient(135deg,#0066cc 0%,#00cc99 100%);color:white;padding:1.25rem 2rem;display:flex;justify-content:space-between;align-items:center">
                            <h3 style="margin:0;font-size:1.2rem;font-weight:700;display:flex;align-items:center;gap:0.75rem">
                                <i data-lucide="table" style="width:26px;height:26px"></i>
                                Datos Verticalizados - Vista Excel
                            </h3>
                            <div style="display:flex;gap:0.75rem">
                                <button onclick="copiarDatosCubitoModal()" style="padding:0.75rem 1.35rem;background:#ffc107;color:#2d3748;border:none;border-radius:8px;font-size:0.9rem;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:0.625rem;transition:all 0.2s;box-shadow:0 2px 4px rgba(0,0,0,0.1)" onmouseover="this.style.background='#ffb300';this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#ffc107';this.style.transform='translateY(0)'">
                                    <i data-lucide="copy" style="width:18px;height:18px"></i>
                                    Copiar
                                </button>
                                <button onclick="exportarVerticalizados()" style="padding:0.75rem 1.35rem;background:#ffc107;color:#2d3748;border:none;border-radius:8px;font-size:0.9rem;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:0.625rem;transition:all 0.2s;box-shadow:0 2px 4px rgba(0,0,0,0.1)" onmouseover="this.style.background='#ffb300';this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#ffc107';this.style.transform='translateY(0)'">
                                    <i data-lucide="download" style="width:18px;height:18px"></i>
                                    Exportar
                                </button>
                                <button onclick="cerrarModal('modalCubitoVisualizacion')" style="padding:0.75rem 1.35rem;background:#ff5252;color:white;border:none;border-radius:8px;font-size:0.9rem;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:0.625rem;transition:all 0.2s;box-shadow:0 2px 4px rgba(0,0,0,0.1)" onmouseover="this.style.background='#e64545';this.style.transform='translateY(-1px)'" onmouseout="this.style.background='#ff5252';this.style.transform='translateY(0)'">
                                    <i data-lucide="x" style="width:18px;height:18px"></i>
                                    Cerrar
                                </button>
                            </div>
                        </div>
                        
                        <!-- B√∫squeda -->
                        <div style="padding:1rem 2rem;background:#f7fafc;border-bottom:1px solid #e2e8f0">
                            <input type="text" id="cubitoSearchModal" placeholder="üîç Buscar en los datos..." onkeyup="filtrarDatosModal()" style="width:100%;padding:0.8rem 1rem;border:1px solid #cbd5e0;border-radius:8px;font-size:0.9rem" />
                        </div>
                        
                        <!-- Tabla de datos -->
                        <div style="padding:0;overflow:auto;max-height:calc(94vh - 180px);background:white">
                            <table id="cubitoTablaModal" style="width:100%;border-collapse:collapse;font-family:Inter,sans-serif;font-size:0.85rem">
                                <thead></thead>
                                <tbody>
                                    <tr><td style="text-align:center;padding:4rem;color:#94a3b8">
                                        <div style="font-size:3rem;margin-bottom:1rem;opacity:0.5">üì¶</div>
                                        <div style="font-size:1.1rem;font-weight:600;margin-bottom:0.5rem;color:#64748b">No hay datos verticalizados</div>
                                        <div style="font-size:0.9rem">Procese un packing para ver los datos aqu√≠</div>
                                    </td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURACI√ìN
        // ============================================
        const SUPABASE_URL = 'https://dzxjzmlmmmwspemihhlv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6eGp6bWxtbW13c3BlbWloaGx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1NjI5MjAsImV4cCI6MjA3OTEzODkyMH0.uLXtsONi_c4myPbsvTIqV51pldRv6Wuff4adYWgVR6Q';
        
        // Inicializar Supabase cuando est√© disponible
        let supabase;
        
        // Funci√≥n para inicializar Supabase
        function inicializarSupabase() {
            try {
                // El UMD build expone createClient en window.supabase
                if (typeof window.supabase !== 'undefined' && typeof window.supabase.createClient === 'function') {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log('‚úÖ Supabase inicializado correctamente');
                    return true;
                } else if (typeof window.createClient === 'function') {
                    // Fallback por si est√° en el scope global
                    supabase = window.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log('‚úÖ Supabase inicializado (fallback)');
                    return true;
                } else {
                    console.error('‚ùå Supabase no est√° cargado. Verifica la conexi√≥n a internet.');
                    console.log('window.supabase:', typeof window.supabase);
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Error al inicializar Supabase:', error);
                return false;
            }
        }
        
        // Intentar inicializar inmediatamente
        inicializarSupabase();

        // Lista de tiendas - Flexible con may√∫sculas/min√∫sculas
        const TIENDAS_BASE = ['LUKERS EL SOL', 'LUKERS TRU PIZARRO', 'LUKERS LA MARINA', 'LUKERS PROLONGACI√ìN IQUITOS', 'LUKERS CHI P. RUIZ', 'LUKERS TARAPOTO', 'LUKERS MENDIOLA', 'LUKERS ALFONSO UGARTE', 'LUKERS IQT LORES', 'LUKERS JR UNION'];
        
        // Constantes
        const ITEMS_POR_PAGINA = 100;
        const BATCH_SIZE = 500;
        
        // Roles de usuario
        const ROLES = {
            JEFE_ALMACEN: 'Jefe de Almac√©n',
            PRODUCTO: 'Producto',
            SUPERVISOR: 'Supervisor',
            JEFES: 'Jefes'
        };

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let inventario = [], productos = [], ordenes = [], picking = [], packing = [], reclasificacion = [], equipos = [], configuraciones = [];
        let inventarioFiltrado = [], productosFiltrado = [], ordenesFiltradas = [];
        let paginaInv = 1, paginaProd = 1;
        let chartEstados, chartMontos, chartEquipos, chartGeneros, chartMatrizGeneroTienda;
        let ordenActual = null, pickingActual = null, packingActual = null, reclasActual = null, equipoActual = null;
        let tabReclasActual = 'pendientes', tabEquiposActual = 'picking';
        
        // ============================================
        // FUNCI√ìN SEGURA PARA RENDERIZAR ICONOS LUCIDE
        // ============================================
        function renderIcons() {
            try {
                if (typeof lucide !== 'undefined' && lucide && typeof lucide.createIcons === 'function') {
                    lucide.createIcons();
                }
            } catch (e) {
                // Silenciar error si Lucide no est√° disponible a√∫n
                console.debug('Lucide icons not ready yet');
            }
        }
        
        // Intentar renderizar iconos cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(renderIcons, 100);
            });
        } else {
            setTimeout(renderIcons, 100);
        }

        
        // Usuario actual (por defecto Jefe de Almac√©n - cambiar seg√∫n login real)
        let usuarioActual = {
            id: 1,
            nombre: 'Usuario Sistema',
            rol: ROLES.JEFE_ALMACEN  // Cambiar seg√∫n el usuario logueado
        };
        
        // Variables para CUBITO LUKERS
        let cubitoOutputData = [];
        let cubitoCurrentFilteredData = [];
        let cubitoPackingSeleccionado = null;
        let cubitoPackingsCompletados = [];
        
        // Mapeo de tiendas para CUBITO
        const CUBITO_TIENDA_MAPPING = {
            "LUKERS EL SOL": { Clase: "Z009", Proveedor: "RD50", OrgCompra: "R050", GrupoCompra: "104", Sociedad: "R050", CondPago: "", PrecioNeto: "", CentroTienda: "R501", Almacen: "PT01", Solicitante: "R501", AlmacenProcedencia: "PT01" },
            "LUKERS JR UNION": { Clase: "Z009", Proveedor: "RD50", OrgCompra: "R050", GrupoCompra: "104", Sociedad: "R050", CondPago: "", PrecioNeto: "", CentroTienda: "R511", Almacen: "PT01", Solicitante: "R511", AlmacenProcedencia: "PT01" },
            "LUKERS MENDIOLA": { Clase: "Z009", Proveedor: "RD50", OrgCompra: "R050", GrupoCompra: "104", Sociedad: "R050", CondPago: "", PrecioNeto: "", CentroTienda: "R502", Almacen: "PT01", Solicitante: "R502", AlmacenProcedencia: "PT01" },
            "LUKERS PROLONGACI√ìN IQUITOS": { Clase: "Z009", Proveedor: "RD50", OrgCompra: "R050", GrupoCompra: "104", Sociedad: "R050", CondPago: "", PrecioNeto: "", CentroTienda: "R504", Almacen: "PT01", Solicitante: "R504", AlmacenProcedencia: "PT01" },
            "LUKERS LA MARINA": { Clase: "Z009", Proveedor: "RD50", OrgCompra: "R050", GrupoCompra: "104", Sociedad: "R050", CondPago: "", PrecioNeto: "", CentroTienda: "R503", Almacen: "PT01", Solicitante: "R503", AlmacenProcedencia: "PT01" },
            "LUKERS ALFONSO UGARTE": { Clase: "Z009", Proveedor: "RD50", OrgCompra: "R050", GrupoCompra: "104", Sociedad: "R050", CondPago: "", PrecioNeto: "", CentroTienda: "R505", Almacen: "PT01", Solicitante: "R505", AlmacenProcedencia: "PT01" },
            "LUKERS TRU PIZARRO": { Clase: "Z009", Proveedor: "RD50", OrgCompra: "R050", GrupoCompra: "104", Sociedad: "R050", CondPago: "", PrecioNeto: "", CentroTienda: "R506", Almacen: "PT01", Solicitante: "R506", AlmacenProcedencia: "PT01" },
            "LUKERS TARAPOTO": { Clase: "Z008", Proveedor: "RD50", OrgCompra: "R040", GrupoCompra: "104", Sociedad: "R040", CondPago: "P030", PrecioNeto: "", CentroTienda: "R402", Almacen: "PT01", Solicitante: "R402", AlmacenProcedencia: "PT01" },
            "LUKERS IQT LORES": { Clase: "Z008", Proveedor: "RD50", OrgCompra: "R040", GrupoCompra: "104", Sociedad: "R040", CondPago: "P030", PrecioNeto: "", CentroTienda: "R401", Almacen: "PT01", Solicitante: "R401", AlmacenProcedencia: "PT01" },
            "LUKERS CHI P. RUIZ": { Clase: "Z009", Proveedor: "RD50", OrgCompra: "R050", GrupoCompra: "104", Sociedad: "R050", CondPago: "", PrecioNeto: "", CentroTienda: "R510", Almacen: "PT01", Solicitante: "R510", AlmacenProcedencia: "PT01" }
        };
        
        // Variables para filtros multi-select en cascada
        let filtrosSeleccionados = {
            genero: [],
            linea: [],
            marca: []
        };
        let opcionesDisponibles = {
            genero: [],
            linea: [],
            marca: []
        };

        // ============================================
        // UTILIDADES
        // ============================================
        function normalizarTexto(texto) {
            if (!texto) return '';
            return String(texto).trim().toUpperCase();
        }

        function getCol(row, names) {
            for (const n of names) {
                if (row[n] !== undefined && row[n] !== null && row[n] !== '') return row[n];
                const keys = Object.keys(row);
                for (const k of keys) {
                    if (k.toLowerCase() === n.toLowerCase()) return row[k];
                }
            }
            return null;
        }

        function buscarTienda(row) {
            const resultado = {};
            const keys = Object.keys(row);
            
            for (const tienda of TIENDAS_BASE) {
                let encontrado = false;
                for (const key of keys) {
                    const keyNorm = normalizarTexto(key);
                    const tiendaNorm = normalizarTexto(tienda);
                    const tiendaCorta = tiendaNorm.replace('LUKERS ', '');
                    
                    if (keyNorm === tiendaNorm || keyNorm === tiendaCorta || 
                        keyNorm.includes(tiendaCorta) || tiendaCorta.includes(keyNorm)) {
                        const val = parseInt(row[key]) || 0;
                        if (val > 0) {
                            resultado[tienda] = val;
                            encontrado = true;
                        }
                        break;
                    }
                }
            }
            return resultado;
        }

        function formatMoney(num) {
            return 'S/ ' + (parseFloat(num) || 0).toLocaleString('es-PE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function calcularCV(pvp, kardex) {
            // CV = 1 / ((PVP / 1.18) / KARDEX) * 100
            if (!pvp || !kardex || kardex === 0) return 0;
            
            const pvpSinIGV = pvp / 1.18;
            const ratio = pvpSinIGV / kardex;
            const cv = (1 / ratio) * 100;
            
            return parseFloat(cv.toFixed(2));
        }
        
        function formatPorcentaje(num) {
            return (parseFloat(num) || 0).toFixed(2) + '%';
        }

        function formatFecha(iso) {
            if (!iso) return '-';
            return new Date(iso).toLocaleDateString('es-PE', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function formatFechaHora(iso) {
            if (!iso) return '-';
            return new Date(iso).toLocaleString('es-PE');
        }

        function diasTranscurridos(fecha) {
            if (!fecha) return 0;
            return Math.floor((new Date() - new Date(fecha)) / 86400000);
        }

        function getBadge(estado) {
            const badges = {
                'Pendiente Divisi√≥n': 'badge-purple',
                'En Divisi√≥n': 'badge-purple',
                'Pendiente Picking': 'badge-warning',
                'En Picking': 'badge-info',
                'Pendiente Packing': 'badge-warning',
                'En Packing': 'badge-info',
                'Completada': 'badge-success',
                'Cancelada': 'badge-danger',
                'Pendiente': 'badge-warning',
                'En Proceso': 'badge-info'
            };
            return `<span class="badge ${badges[estado] || 'badge-primary'}">${estado}</span>`;
        }

        // ============================================
        // ARCHIVOS
        // ============================================
        function mostrarArchivoSeleccionado(input, infoId) {
            const infoDiv = document.getElementById(infoId);
            if (input.files && input.files[0]) {
                infoDiv.querySelector('.file-selected-name').textContent = input.files[0].name;
                infoDiv.classList.add('show');
                renderIcons();
            }
        }

        function limpiarArchivo(inputId, infoId) {
            document.getElementById(inputId).value = '';
            document.getElementById(infoId).classList.remove('show');
        }

        async function leerExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                        resolve(data);
                    } catch (err) { reject(err); }
                };
                reader.onerror = () => reject(new Error('Error leyendo archivo'));
                reader.readAsArrayBuffer(file);
            });
        }

        // ============================================
        // UI HELPERS
        // ============================================
        function mostrarLoading(texto, sub = '') {
            document.getElementById('loadingText').textContent = texto;
            document.getElementById('loadingSubtext').textContent = sub;
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function ocultarLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
            document.getElementById('progressFill').style.width = '0%';
        }

        function actualizarProgreso(p) {
            document.getElementById('progressFill').style.width = Math.min(p, 100) + '%';
        }

        function toast(msg, tipo = 'info') {
            const div = document.createElement('div');
            div.className = `toast ${tipo}`;
            div.innerHTML = msg;
            document.getElementById('toastContainer').appendChild(div);
            setTimeout(() => div.remove(), 4000);
        }

        function abrirModal(id) {
            document.getElementById(id).classList.add('active');
            renderIcons();
        }

        function cerrarModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function toggleDropdown(id) {
            document.getElementById(id).classList.toggle('active');
        }

        document.addEventListener('click', e => {
            if (!e.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('active'));
            }
        });

        document.querySelectorAll('.modal').forEach(m => {
            m.addEventListener('click', e => { if (e.target === m) cerrarModal(m.id); });
        });

        // ============================================
        // NAVEGACI√ìN
        // ============================================
        function cambiarVista(nombre) {
            document.querySelectorAll('.vista').forEach(v => v.classList.remove('active'));
            document.getElementById(`vista-${nombre}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => {
                n.classList.remove('active');
                if (n.dataset.vista === nombre) n.classList.add('active');
            });
            const titulos = {
                dashboard: 'Dashboard', inventario: 'Inventario', productos: 'Productos',
                ordenes: '√ìrdenes', picking: 'Picking', packing: 'Packing',
                reclasificacion: 'Reclasificaci√≥n', cubito: 'Cubito Lukers', equipos: 'Equipos', configuracion: 'Configuraci√≥n'
            };
            document.getElementById('headerTitle').textContent = titulos[nombre] || 'MAWI';
            document.getElementById('headerBreadcrumb').textContent = titulos[nombre] || 'MAWI';
            
            // ‚ö° CARGA BAJO DEMANDA
            if (nombre === 'inventario' && !inventarioCargado) {
                cargarInventarioSiNecesario();
            } else if (nombre === 'productos' && !productosCargados) {
                cargarProductosSiNecesario();
            }
            
            // Actualizar filtros espec√≠ficos seg√∫n la vista
            if (nombre === 'productos') {
                if (productosCargados) actualizarFiltrosProductos();
            } else if (nombre === 'dashboard') {
                inicializarFiltrosDashboard();
                actualizarDashboard();
            } else if (nombre === 'cubito') {
                inicializarCubito();
                cargarPackingsCompletados();
            }
            
            renderIcons();
        }

        document.querySelectorAll('.nav-item').forEach(i => {
            i.addEventListener('click', () => { if (i.dataset.vista) cambiarVista(i.dataset.vista); });
        });

        // ============================================
        // AUTENTICACI√ìN
        // ============================================
        async function verificarSesion() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('appSection').style.display = 'flex';
                
                // Obtener informaci√≥n del usuario desde usuarios_sistema
                const { data: userData } = await supabase
                    .from('usuarios_sistema')
                    .select('nombre_completo, rol')
                    .eq('user_id', session.user.id)
                    .single();
                
                // Mostrar nombre y rol
                if (userData) {
                    document.getElementById('userName').textContent = userData.nombre_completo;
                    document.getElementById('userAvatar').textContent = userData.nombre_completo.charAt(0).toUpperCase();
                    document.getElementById('userRole').textContent = userData.rol;
                } else {
                    document.getElementById('userName').textContent = session.user.email.split('@')[0];
                    document.getElementById('userAvatar').textContent = session.user.email.charAt(0).toUpperCase();
                    document.getElementById('userRole').textContent = 'Usuario';
                }
                
                await cargarDatos();
            } else {
                document.getElementById('loginSection').style.display = 'flex';
                document.getElementById('appSection').style.display = 'none';
            }
        }

        async function iniciarSesion() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) { toast('Completa todos los campos', 'error'); return; }
            mostrarLoading('Iniciando sesi√≥n...');
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            ocultarLoading();
            if (error) toast('Error: ' + error.message, 'error');
            else { toast('Sesi√≥n iniciada', 'success'); await verificarSesion(); }
        }

        async function cerrarSesion() {
            await supabase.auth.signOut();
            toast('Sesi√≥n cerrada', 'info');
            setTimeout(() => location.reload(), 500);
        }

        // ============================================
        // REGISTRO DE USUARIOS
        // ============================================
        function cambiarAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-tab-content').forEach(c => c.classList.remove('active'));
            
            if (tab === 'login') {
                document.querySelectorAll('.auth-tab')[0].classList.add('active');
                document.getElementById('tabLogin').classList.add('active');
            } else {
                document.querySelectorAll('.auth-tab')[1].classList.add('active');
                document.getElementById('tabRegistro').classList.add('active');
            }
        }

        // REGISTRO DE USUARIOS CON C√ìDIGO DE INVITACI√ìN
        async function enviarCodigoVerificacion() {
            // 1. Obtener y validar datos
            const nombre = document.getElementById('registroNombre').value.trim();
            const email = document.getElementById('registroEmail').value.trim().toLowerCase();
            const rol = document.getElementById('registroRol').value;
            const codigo = document.getElementById('registroCodigo').value.trim().toUpperCase();
            const password = document.getElementById('registroPassword').value;
            const passwordConfirm = document.getElementById('registroPasswordConfirm').value;

            // Validaciones b√°sicas
            if (!nombre || !email || !rol || !codigo || !password || !passwordConfirm) {
                toast('Completa todos los campos', 'error');
                return;
            }

            if (nombre.length < 3) {
                toast('El nombre debe tener al menos 3 caracteres', 'error');
                return;
            }

            // Validar dominio @lukers.pe
            if (!email.endsWith('@lukers.pe')) {
                toast('Debes usar un correo corporativo @lukers.pe', 'error');
                return;
            }

            // Validar contrase√±as
            if (password.length < 8) {
                toast('La contrase√±a debe tener m√≠nimo 8 caracteres', 'error');
                return;
            }

            if (password !== passwordConfirm) {
                toast('Las contrase√±as no coinciden', 'error');
                return;
            }

            mostrarLoading('Validando c√≥digo de invitaci√≥n...');

            try {
                // 2. Validar c√≥digo de invitaci√≥n
                const { data: codigoData, error: codigoError } = await supabase
                    .from('codigos_invitacion')
                    .select('*')
                    .eq('codigo', codigo)
                    .eq('rol', rol)
                    .eq('usado', false)
                    .eq('activo', true)
                    .single();

                if (codigoError || !codigoData) {
                    ocultarLoading();
                    toast('C√≥digo inv√°lido, ya usado o no corresponde al rol seleccionado', 'error');
                    return;
                }

                // 3. Crear usuario en Supabase Auth
                document.getElementById('loadingText').textContent = 'Creando tu cuenta...';
                
                const { data: authData, error: authError } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            nombre_completo: nombre,
                            rol: rol
                        },
                        emailRedirectTo: window.location.origin
                    }
                });

                if (authError) {
                    ocultarLoading();
                    if (authError.message.includes('already registered') || authError.message.includes('User already registered')) {
                        toast('Este correo ya est√° registrado', 'error');
                    } else {
                        toast('Error al crear cuenta: ' + authError.message, 'error');
                    }
                    return;
                }

                // 4. Guardar informaci√≥n adicional en usuarios_sistema
                document.getElementById('loadingText').textContent = 'Guardando informaci√≥n...';
                
                if (authData.user) {
                    const { error: userError } = await supabase
                        .from('usuarios_sistema')
                        .insert([{
                            user_id: authData.user.id,
                            nombre_completo: nombre,
                            email: email,
                            rol: rol,
                            codigo_usado: codigo
                        }]);

                    if (userError) {
                        console.error('Error guardando usuario:', userError);
                    }
                }

                // 5. Marcar c√≥digo como usado
                document.getElementById('loadingText').textContent = 'Finalizando...';
                
                await supabase
                    .from('codigos_invitacion')
                    .update({
                        usado: true,
                        usado_por: email,
                        fecha_uso: new Date().toISOString()
                    })
                    .eq('codigo', codigo);

                ocultarLoading();
                
                // 6. Limpiar formulario
                document.getElementById('registroNombre').value = '';
                document.getElementById('registroEmail').value = '';
                document.getElementById('registroRol').value = '';
                document.getElementById('registroCodigo').value = '';
                document.getElementById('registroPassword').value = '';
                document.getElementById('registroPasswordConfirm').value = '';
                
                // 7. Mostrar √©xito
                toast('¬°Cuenta creada exitosamente!', 'success');
                toast('Revisa tu correo para confirmar tu cuenta', 'info');
                
                // 8. Cambiar a login
                setTimeout(() => {
                    cambiarAuthTab('login');
                    document.getElementById('loginEmail').value = email;
                }, 2000);

            } catch (error) {
                ocultarLoading();
                console.error('Error en registro:', error);
                toast('Error inesperado: ' + error.message, 'error');
            }
        }

        // Funciones auxiliares (para usar en consola del navegador)
        async function generarCodigoInvitacion(rol) {
            try {
                const { data, error } = await supabase.rpc('generar_codigo_invitacion', {
                    p_rol: rol
                });

                if (error) throw error;
                
                console.log('C√≥digo generado:', data);
                return data;
            } catch (error) {
                console.error('Error generando c√≥digo:', error);
                return null;
            }
        }

        async function listarCodigosDisponibles() {
            try {
                const { data, error } = await supabase
                    .from('codigos_invitacion')
                    .select('codigo, rol, usado, fecha_creacion')
                    .eq('usado', false)
                    .eq('activo', true)
                    .order('rol', { ascending: true })
                    .order('fecha_creacion', { ascending: false });

                if (error) throw error;
                
                console.table(data);
                return data;
            } catch (error) {
                console.error('Error listando c√≥digos:', error);
                return null;
            }
        }

        // Estas funciones ya no son necesarias con el sistema de c√≥digos
        async function verificarCodigoYRegistrar() {
            toast('Funci√≥n no utilizada en esta versi√≥n', 'info');
        }

        function volverPaso1() {
            toast('Funci√≥n no utilizada en esta versi√≥n', 'info');
        }

        async function reenviarCodigo() {
            const email = document.getElementById('registroEmail').value.trim().toLowerCase();
            
            if (!email || !email.endsWith('@lukers.pe')) {
                toast('Ingresa un email v√°lido @lukers.pe', 'error');
                return;
            }

            mostrarLoading('Reenviando email...');

            try {
                const { error } = await supabase.auth.resend({
                    type: 'signup',
                    email: email
                });

                ocultarLoading();

                if (error) {
                    toast('Error al reenviar: ' + error.message, 'error');
                } else {
                    toast('Email de confirmaci√≥n reenviado', 'success');
                }
            } catch (error) {
                ocultarLoading();
                toast('Error al reenviar email', 'error');
            }
        }

        // ============================================
        // CARGA DE DATOS
        // ============================================
        async function cargarTodosLosRegistros(tabla, orderColumn = 'variante') {
            let allData = [];
            let from = 0;
            const batchSize = 1000;
            
            while (true) {
                const { data, error } = await supabase.from(tabla).select('*').order(orderColumn, { ascending: true }).range(from, from + batchSize - 1);
                if (error) { console.error(`Error cargando ${tabla}:`, error); break; }
                if (!data || data.length === 0) break;
                allData = allData.concat(data);
                actualizarProgreso((allData.length / (from + batchSize * 2)) * 100);
                document.getElementById('loadingSubtext').textContent = `${tabla}: ${allData.length.toLocaleString()} registros...`;
                if (data.length < batchSize) break;
                from += batchSize;
            }
            return allData;
        }

        // ============================================
        // CARGA OPTIMIZADA - SOLO DATOS ESENCIALES
        // ============================================
        async function cargarDatos() {
            mostrarLoading('Cargando datos...');
            try {
                // 1Ô∏è‚É£ √ìRDENES (pocos registros, r√°pido)
                document.getElementById('loadingText').textContent = 'Cargando √≥rdenes...';
                const { data: ordenesData } = await supabase.from('ordenes').select('*').order('fecha', { ascending: false }).limit(500);
                ordenes = ordenesData || [];
                ordenesFiltradas = [...ordenes];

                // 2Ô∏è‚É£ PICKING (pocos registros, r√°pido)
                document.getElementById('loadingText').textContent = 'Cargando picking...';
                const { data: pickingData } = await supabase.from('picking').select('*').order('id', { ascending: false }).limit(500);
                picking = pickingData || [];

                document.getElementById('loadingText').textContent = 'Cargando packing...';
                const { data: packingData } = await supabase.from('packing').select('*').order('id', { ascending: false }).limit(500);
                packing = packingData || [];

                // 3Ô∏è‚É£ RECLASIFICACI√ìN (pocos registros, r√°pido)
                document.getElementById('loadingText').textContent = 'Cargando reclasificaci√≥n...';
                const { data: reclasData } = await supabase.from('reclasificacion').select('*').order('fecha', { ascending: false }).limit(500);
                reclasificacion = reclasData || [];

                // 4Ô∏è‚É£ EQUIPOS (muy pocos registros)
                document.getElementById('loadingText').textContent = 'Cargando equipos...';
                const { data: equiposData } = await supabase.from('equipos').select('*').order('nombre');
                equipos = equiposData || [];
                
                // Poblar selector de equipos
                const filtroEquipoOrden = document.getElementById('filtroEquipoOrden');
                if (filtroEquipoOrden) {
                    filtroEquipoOrden.innerHTML = '<option value="">Todos los equipos</option>' + 
                        equipos.map(e => `<option value="${e.id}">${e.nombre}</option>`).join('');
                }

                // 5Ô∏è‚É£ CONFIGURACIONES (muy pocos registros)
                document.getElementById('loadingText').textContent = 'Cargando configuraciones...';
                const { data: configData } = await supabase.from('configuraciones').select('*');
                configuraciones = configData || [];
                aplicarConfiguraciones();

                // 6Ô∏è‚É£ INVENTARIO Y PRODUCTOS - Cargar SOLO metadatos (counts)
                document.getElementById('loadingText').textContent = 'Obteniendo estad√≠sticas...';
                
                // Contar registros sin cargarlos
                const { count: countInv } = await supabase.from('inventario').select('*', { count: 'exact', head: true });
                const { count: countProd } = await supabase.from('productos_system').select('*', { count: 'exact', head: true });
                
                // Inicializar arrays vac√≠os - se cargar√°n bajo demanda
                inventario = [];
                productos = [];
                inventarioFiltrado = [];
                productosFiltrado = [];
                
                // Guardar counts para mostrar
                window.totalInventario = countInv || 0;
                window.totalProductos = countProd || 0;

                // Renderizar solo lo necesario (NO inventario ni productos a√∫n)
                renderizarOrdenes();
                renderizarPicking();
                renderizarPacking();
                renderizarReclasificacion();
                renderizarEquipos();
                actualizarBadges();
                inicializarFiltrosDashboard();
                actualizarDashboard();
                
                ocultarLoading();
                toast(`‚úÖ Carga r√°pida completada`, 'success');
                
                // 7Ô∏è‚É£ CARGAR INVENTARIO Y PRODUCTOS EN BACKGROUND (opcional)
                // Solo si el usuario va a esas secciones
                console.log('üí° Inventario y Productos se cargar√°n cuando los necesites');
                
            } catch (e) {
                ocultarLoading();
                toast('Error: ' + e.message, 'error');
                console.error(e);
            }
        }

        async function sincronizarDatos() {
            await cargarDatos();
        }

        // ============================================
        // CARGA BAJO DEMANDA - INVENTARIO Y PRODUCTOS
        // ============================================
        
        let inventarioCargado = false;
        let productosCargados = false;

        async function cargarInventarioSiNecesario() {
            if (inventarioCargado) return;
            
            mostrarLoading('Cargando inventario completo...');
            try {
                inventario = await cargarTodosLosRegistros('inventario', 'variante');
                inventarioFiltrado = [...inventario];
                inventarioCargado = true;
                actualizarFiltrosInventario();
                renderizarInventario();
                ocultarLoading();
                toast('Inventario cargado', 'success');
            } catch (e) {
                ocultarLoading();
                toast('Error cargando inventario: ' + e.message, 'error');
            }
        }

        async function cargarProductosSiNecesario() {
            if (productosCargados) return;
            
            mostrarLoading('Cargando productos completos...');
            try {
                productos = await cargarTodosLosRegistros('productos_system', 'variante');
                productosFiltrado = [...productos];
                productosCargados = true;
                actualizarFiltrosProductos();
                renderizarProductos();
                ocultarLoading();
                toast('Productos cargados', 'success');
            } catch (e) {
                ocultarLoading();
                toast('Error cargando productos: ' + e.message, 'error');
            }
        }

        // ============================================
        // B√öSQUEDA R√ÅPIDA EN SERVIDOR (SIN CARGAR TODO)
        // ============================================
        
        async function buscarInventarioRapido(termino) {
            if (!termino || termino.length < 2) {
                inventarioFiltrado = inventarioCargado ? inventario : [];
                renderizarInventario();
                return;
            }

            mostrarLoading('Buscando...');
            try {
                const { data } = await supabase
                    .from('inventario')
                    .select('*')
                    .or(`variante.ilike.%${termino}%,descripcion.ilike.%${termino}%,ubicacion.ilike.%${termino}%`)
                    .limit(100);
                
                inventarioFiltrado = data || [];
                renderizarInventario();
                ocultarLoading();
            } catch (e) {
                ocultarLoading();
                toast('Error en b√∫squeda', 'error');
            }
        }

        async function buscarProductosRapido(termino) {
            if (!termino || termino.length < 2) {
                productosFiltrado = productosCargados ? productos : [];
                renderizarProductos();
                return;
            }

            mostrarLoading('Buscando...');
            try {
                const { data } = await supabase
                    .from('productos_system')
                    .select('*')
                    .or(`variante.ilike.%${termino}%,descripcion.ilike.%${termino}%,codigo_comercial.ilike.%${termino}%`)
                    .limit(100);
                
                productosFiltrado = data || [];
                renderizarProductos();
                ocultarLoading();
            } catch (e) {
                ocultarLoading();
                toast('Error en b√∫squeda', 'error');
            }
        }


        // ============================================
        // SISTEMA DE NOTIFICACIONES Y SINCRONIZACI√ìN
        // ============================================

        let ultimaActualizacion = new Date();
        let intervaloVerificacion = null;
        let hayDatosNuevos = false;

        // Iniciar verificaci√≥n autom√°tica cada 30 segundos
        function iniciarVerificacionAutomatica() {
            if (intervaloVerificacion) {
                clearInterval(intervaloVerificacion);
            }
            
            intervaloVerificacion = setInterval(async () => {
                await verificarCambios();
            }, 30000); // 30 segundos
        }

        // Verificar si hay cambios en la base de datos
        async function verificarCambios() {
            try {
                // Verificar ordenes
                const { data: ordenesNuevas } = await supabase
                    .from('ordenes')
                    .select('id, fecha')
                    .gt('fecha', ultimaActualizacion.toISOString())
                    .limit(1);
                
                // Verificar picking
                const { data: pickingNuevo } = await supabase
                    .from('picking')
                    .select('id, created_at')
                    .gt('created_at', ultimaActualizacion.toISOString())
                    .limit(1);
                
                // Verificar packing
                const { data: packingNuevo } = await supabase
                    .from('packing')
                    .select('id, created_at')
                    .gt('created_at', ultimaActualizacion.toISOString())
                    .limit(1);
                
                // Si hay cambios, mostrar notificaci√≥n
                if ((ordenesNuevas && ordenesNuevas.length > 0) || 
                    (pickingNuevo && pickingNuevo.length > 0) || 
                    (packingNuevo && packingNuevo.length > 0)) {
                    hayDatosNuevos = true;
                    mostrarNotificacionSincronizacion();
                }
            } catch (e) {
                console.error('Error verificando cambios:', e);
            }
        }

        // Mostrar notificaci√≥n de sincronizaci√≥n
        function mostrarNotificacionSincronizacion() {
            const notificacion = document.getElementById('notificacionSincronizar');
            if (notificacion) {
                notificacion.style.display = 'flex';
                
                // Renderizar iconos
                setTimeout(renderIcons, 100);
                
                // Vibraci√≥n si est√° soportada
                if ('vibrate' in navigator) {
                    navigator.vibrate([200, 100, 200]);
                }
            }
        }

        // Sincronizar sin perder trabajo actual
        async function sincronizarSinPerder() {
            if (!hayDatosNuevos) {
                toast('No hay cambios nuevos', 'info');
                return;
            }
            
            // Guardar estado actual
            const estadoActual = {
                vistaActual: document.querySelector('.vista.active')?.id,
                scrollPosition: window.scrollY,
                modalesAbiertos: []
            };
            
            // Identificar modales abiertos
            document.querySelectorAll('.modal').forEach(modal => {
                if (modal.style.display === 'flex') {
                    estadoActual.modalesAbiertos.push(modal.id);
                }
            });
            
            // Recargar datos
            await cargarDatos();
            
            // Restaurar estado
            if (estadoActual.vistaActual) {
                const vistaId = estadoActual.vistaActual.replace('vista-', '');
                cambiarVista(vistaId);
            }
            
            window.scrollTo(0, estadoActual.scrollPosition);
            
            // Ocultar notificaci√≥n
            const notificacion = document.getElementById('notificacionSincronizar');
            if (notificacion) {
                notificacion.style.display = 'none';
            }
            
            hayDatosNuevos = false;
            ultimaActualizacion = new Date();
        }

        // Cerrar notificaci√≥n sin sincronizar
        function cerrarNotificacionSincronizar() {
            const notificacion = document.getElementById('notificacionSincronizar');
            if (notificacion) {
                notificacion.style.display = 'none';
            }
        }


        function renderizarTodo() {
            renderizarInventario();
            renderizarProductos();
            renderizarOrdenes();
            renderizarPicking();
            renderizarPacking();
            renderizarReclasificacion();
            renderizarEquipos();
            actualizarBadges();
        }

        function actualizarBadges() {
            const activas = ordenes.filter(o => !['Completada', 'Cancelada'].includes(o.estado)).length;
            document.getElementById('badgeOrdenes').textContent = activas;
            const pendientes = reclasificacion.filter(r => r.estado === 'Pendiente').length;
            document.getElementById('badgeReclas').textContent = pendientes;
        }

        // ============================================
        // DASHBOARD
        // ============================================
        function aplicarFiltrosDashboard() {
            const periodo = document.getElementById('filtroPeriodo').value;
            const equipoFiltro = document.getElementById('filtroEquipo').value;
            const generoFiltro = document.getElementById('filtroGenero').value;
            const lineaFiltro = document.getElementById('filtroLinea').value;
            const tiendaFiltro = document.getElementById('filtroTienda').value;
            
            document.getElementById('filtroCustom').style.display = periodo === 'custom' ? 'flex' : 'none';
            
            // Calcular rango de fechas seg√∫n el per√≠odo
            let fechaInicio, fechaFin = new Date();
            const hoy = new Date();
            
            switch(periodo) {
                case 'hoy':
                    fechaInicio = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());
                    break;
                case 'semana':
                    fechaInicio = new Date(hoy);
                    fechaInicio.setDate(hoy.getDate() - hoy.getDay());
                    break;
                case 'mes':
                    fechaInicio = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
                    break;
                case 'a√±o':
                    fechaInicio = new Date(hoy.getFullYear(), 0, 1);
                    break;
                case 'custom':
                    const desde = document.getElementById('filtroFechaDesde').value;
                    const hasta = document.getElementById('filtroFechaHasta').value;
                    if (desde) fechaInicio = new Date(desde);
                    if (hasta) fechaFin = new Date(hasta);
                    break;
            }
            
            // Filtrar √≥rdenes seg√∫n TODOS los criterios
            let ordenesFiltradas = ordenes;
            
            // Filtro por fecha
            if (fechaInicio) {
                ordenesFiltradas = ordenesFiltradas.filter(o => {
                    const fecha = new Date(o.fecha);
                    return fecha >= fechaInicio && fecha <= fechaFin;
                });
            }
            
            // Filtro por equipo
            if (equipoFiltro) {
                ordenesFiltradas = ordenesFiltradas.filter(o => {
                    const equipoPicking = o.division_config?.find(d => d.equipoPicking === equipoFiltro);
                    const equipoPacking = o.division_config?.find(d => d.equipoPacking === equipoFiltro);
                    return equipoPicking || equipoPacking;
                });
            }
            
            // Filtro por g√©nero
            if (generoFiltro) {
                ordenesFiltradas = ordenesFiltradas.filter(o => {
                    return (o.items || []).some(item => {
                        const prod = productos.find(p => p.variante === item.variante);
                        return prod && prod.genero === generoFiltro;
                    });
                });
            }
            
            // Filtro por l√≠nea
            if (lineaFiltro) {
                ordenesFiltradas = ordenesFiltradas.filter(o => {
                    return (o.items || []).some(item => {
                        const prod = productos.find(p => p.variante === item.variante);
                        return prod && prod.linea === lineaFiltro;
                    });
                });
            }
            
            // Filtro por tienda
            if (tiendaFiltro) {
                ordenesFiltradas = ordenesFiltradas.filter(o => {
                    return (o.items || []).some(item => {
                        const dist = item.distribucion || {};
                        return dist[tiendaFiltro] && dist[tiendaFiltro] > 0;
                    });
                });
            }
            
            actualizarDashboard(ordenesFiltradas);
        }
        
        function limpiarFiltrosDashboard() {
            document.getElementById('filtroPeriodo').value = 'mes';
            document.getElementById('filtroEquipo').value = '';
            document.getElementById('filtroGenero').value = '';
            document.getElementById('filtroLinea').value = '';
            document.getElementById('filtroTienda').value = '';
            document.getElementById('filtroFechaDesde').value = '';
            document.getElementById('filtroFechaHasta').value = '';
            document.getElementById('filtroCustom').style.display = 'none';
            aplicarFiltrosDashboard();
        }
        
        function inicializarFiltrosDashboard() {
            // Poblar filtro de equipos
            const equiposSet = new Set();
            equipos.forEach(e => equiposSet.add(e.nombre));
            const equipoSelect = document.getElementById('filtroEquipo');
            equipoSelect.innerHTML = '<option value="">Todos</option>' +
                Array.from(equiposSet).sort().map(e => `<option value="${e}">${e}</option>`).join('');
            
            // Poblar filtro de g√©neros
            const generosSet = new Set();
            productos.forEach(p => { if (p.genero) generosSet.add(p.genero); });
            const generoSelect = document.getElementById('filtroGenero');
            generoSelect.innerHTML = '<option value="">Todos</option>' +
                Array.from(generosSet).sort().map(g => `<option value="${g}">${g}</option>`).join('');
            
            // Poblar filtro de l√≠neas
            const lineasSet = new Set();
            productos.forEach(p => { if (p.linea) lineasSet.add(p.linea); });
            const lineaSelect = document.getElementById('filtroLinea');
            lineaSelect.innerHTML = '<option value="">Todas</option>' +
                Array.from(lineasSet).sort().map(l => `<option value="${l}">${l}</option>`).join('');
            
            // Poblar filtro de tiendas
            const tiendaSelect = document.getElementById('filtroTienda');
            tiendaSelect.innerHTML = '<option value="">Todas</option>' +
                TIENDAS_BASE.map(t => `<option value="${t}">${t}</option>`).join('');
        }

        function actualizarDashboard(ordenesFiltradas = ordenes) {
            const variantes = new Set(inventario.map(i => i.variante)).size;
            const ubicaciones = new Set(inventario.map(i => i.ubicacion)).size;
            const unidades = inventario.reduce((s, i) => s + (parseInt(i.stock_fisico) || 0), 0);
            const bloqueadas = inventario.reduce((s, i) => s + (parseInt(i.stock_bloqueado) || 0), 0);
            const activas = ordenesFiltradas.filter(o => !['Completada', 'Cancelada'].includes(o.estado));
            const montoActivas = activas.reduce((s, o) => s + (parseFloat(o.monto_solicitado) || 0), 0);
            const completadas = ordenesFiltradas.filter(o => o.estado === 'Completada');
            
            let tiempoProm = 0;
            if (completadas.length > 0) {
                const tiempos = completadas.map(o => {
                    if (o.fecha_cierre && o.fecha) {
                        return (new Date(o.fecha_cierre) - new Date(o.fecha)) / 86400000;
                    }
                    return 0;
                }).filter(t => t > 0);
                if (tiempos.length > 0) {
                    tiempoProm = tiempos.reduce((a, b) => a + b, 0) / tiempos.length;
                }
            }

            document.getElementById('statVariantes').textContent = variantes.toLocaleString();
            document.getElementById('statUbicaciones').textContent = ubicaciones.toLocaleString();
            document.getElementById('statUnidades').textContent = unidades.toLocaleString();
            document.getElementById('statDisponibles').textContent = (unidades - bloqueadas).toLocaleString();
            document.getElementById('statOrdenes').textContent = activas.length;
            document.getElementById('statMontoOrdenes').textContent = formatMoney(montoActivas);
            document.getElementById('statTiempoProm').innerHTML = tiempoProm.toFixed(1) + '<span style="font-size:0.9rem">d</span>';
            document.getElementById('statCompletadas').textContent = completadas.length;

            generarGraficas(ordenesFiltradas);
            generarTablasConsumo(ordenesFiltradas);
        }
        
        function generarTablasConsumo(ordenesFiltradas) {
            // Calcular consumo por g√©nero
            const consumoGenero = {};
            let totalUnidades = 0;
            let totalMonto = 0;
            
            ordenesFiltradas.forEach(o => {
                if (o.estado === 'Completada' && o.items) {
                    o.items.forEach(item => {
                        const prod = productos.find(p => p.variante === item.variante);
                        if (prod && prod.genero) {
                            if (!consumoGenero[prod.genero]) {
                                consumoGenero[prod.genero] = { unidades: 0, monto: 0 };
                            }
                            const cantidad = item.cantidad || 0;
                            const precio = prod.pvp_regular || prod.pvp || 0;
                            consumoGenero[prod.genero].unidades += cantidad;
                            consumoGenero[prod.genero].monto += cantidad * precio;
                            totalUnidades += cantidad;
                            totalMonto += cantidad * precio;
                        }
                    });
                }
            });
            
            // Renderizar tabla de g√©nero
            let htmlGenero = '';
            Object.entries(consumoGenero)
                .sort((a, b) => b[1].unidades - a[1].unidades)
                .forEach(([genero, datos]) => {
                    const pct = totalUnidades > 0 ? ((datos.unidades / totalUnidades) * 100).toFixed(1) : 0;
                    htmlGenero += `<tr>
                        <td><strong>${genero}</strong></td>
                        <td style="text-align:right">${datos.unidades.toLocaleString()}</td>
                        <td style="text-align:right">${formatMoney(datos.monto)}</td>
                        <td style="text-align:right"><span class="badge badge-info">${pct}%</span></td>
                    </tr>`;
                });
            
            if (htmlGenero) {
                htmlGenero += `<tr style="background:var(--bg-hover);font-weight:600">
                    <td>TOTAL</td>
                    <td style="text-align:right">${totalUnidades.toLocaleString()}</td>
                    <td style="text-align:right">${formatMoney(totalMonto)}</td>
                    <td style="text-align:right">100%</td>
                </tr>`;
            } else {
                htmlGenero = '<tr><td colspan="4" class="empty-state">Sin datos</td></tr>';
            }
            document.getElementById('tablaConsumoGenero').innerHTML = htmlGenero;
            
            // Calcular consumo por tienda
            const consumoTienda = {};
            ordenesFiltradas.forEach(o => {
                if (o.estado === 'Completada' && o.items) {
                    o.items.forEach(item => {
                        const prod = productos.find(p => p.variante === item.variante);
                        const precio = prod ? (prod.pvp_regular || prod.pvp || 0) : 0;
                        const dist = item.distribucion || {};
                        
                        Object.entries(dist).forEach(([tienda, cant]) => {
                            if (cant > 0) {
                                if (!consumoTienda[tienda]) {
                                    consumoTienda[tienda] = { unidades: 0, monto: 0 };
                                }
                                consumoTienda[tienda].unidades += cant;
                                consumoTienda[tienda].monto += cant * precio;
                            }
                        });
                    });
                }
            });
            
            // Renderizar tabla de tienda
            let htmlTienda = '';
            let totalUnidadesTienda = 0;
            let totalMontoTienda = 0;
            
            Object.entries(consumoTienda)
                .sort((a, b) => b[1].unidades - a[1].unidades)
                .forEach(([tienda, datos]) => {
                    totalUnidadesTienda += datos.unidades;
                    totalMontoTienda += datos.monto;
                });
            
            Object.entries(consumoTienda)
                .sort((a, b) => b[1].unidades - a[1].unidades)
                .forEach(([tienda, datos]) => {
                    const pct = totalUnidadesTienda > 0 ? ((datos.unidades / totalUnidadesTienda) * 100).toFixed(1) : 0;
                    htmlTienda += `<tr>
                        <td><strong>${tienda.replace('LUKERS ', '')}</strong></td>
                        <td style="text-align:right">${datos.unidades.toLocaleString()}</td>
                        <td style="text-align:right">${formatMoney(datos.monto)}</td>
                        <td style="text-align:right"><span class="badge badge-info">${pct}%</span></td>
                    </tr>`;
                });
            
            if (htmlTienda) {
                htmlTienda += `<tr style="background:var(--bg-hover);font-weight:600">
                    <td>TOTAL</td>
                    <td style="text-align:right">${totalUnidadesTienda.toLocaleString()}</td>
                    <td style="text-align:right">${formatMoney(totalMontoTienda)}</td>
                    <td style="text-align:right">100%</td>
                </tr>`;
            } else {
                htmlTienda = '<tr><td colspan="4" class="empty-state">Sin datos</td></tr>';
            }
            document.getElementById('tablaConsumoTienda').innerHTML = htmlTienda;
            
            // Generar matriz g√©nero x tienda
            generarMatrizGeneroTienda(ordenesFiltradas);
        }
        
        function generarMatrizGeneroTienda(ordenesFiltradas) {
            const matriz = {};
            const tiendas = new Set();
            const generos = new Set();
            
            // Calcular MONTOS (no cantidades)
            ordenesFiltradas.forEach(o => {
                if (o.estado === 'Completada' && o.items) {
                    o.items.forEach(item => {
                        const prod = productos.find(p => p.variante === item.variante);
                        if (prod && prod.genero) {
                            generos.add(prod.genero);
                            const dist = item.distribucion || {};
                            const kardex = prod.kardex || 0;  // Usar kardex para el monto
                            
                            Object.entries(dist).forEach(([tienda, cant]) => {
                                if (cant > 0) {
                                    tiendas.add(tienda);
                                    if (!matriz[prod.genero]) matriz[prod.genero] = {};
                                    // Calcular monto: cantidad * kardex
                                    const monto = cant * kardex;
                                    matriz[prod.genero][tienda] = (matriz[prod.genero][tienda] || 0) + monto;
                                }
                            });
                        }
                    });
                }
            });
            
            if (generos.size === 0 || tiendas.size === 0) {
                document.getElementById('tablaMatrizGeneroTienda').innerHTML = 
                    '<thead><tr><th>G√©nero</th></tr></thead><tbody><tr><td class="empty-state">Sin datos</td></tr></tbody>';
                
                // Limpiar gr√°fica si existe
                const ctx = document.getElementById('chartMatrizGeneroTienda');
                if (ctx && chartMatrizGeneroTienda) {
                    chartMatrizGeneroTienda.destroy();
                    chartMatrizGeneroTienda = null;
                }
                return;
            }
            
            // Construir tabla con MONTOS
            let html = '<thead><tr><th>G√©nero</th>';
            const tiendasArray = Array.from(tiendas).sort();
            tiendasArray.forEach(t => {
                html += `<th style="text-align:right">${t.replace('LUKERS ', '')}</th>`;
            });
            html += '<th style="text-align:right;background:var(--bg-hover)">TOTAL</th></tr></thead><tbody>';
            
            const generosArray = Array.from(generos).sort();
            generosArray.forEach(g => {
                html += `<tr><td><strong>${g}</strong></td>`;
                let totalGenero = 0;
                tiendasArray.forEach(t => {
                    const valor = matriz[g]?.[t] || 0;
                    totalGenero += valor;
                    html += `<td style="text-align:right">${valor > 0 ? formatMoney(valor) : '-'}</td>`;
                });
                html += `<td style="text-align:right;background:var(--bg-hover);font-weight:600">${formatMoney(totalGenero)}</td></tr>`;
            });
            
            // Fila de totales
            html += '<tr style="background:var(--bg-hover);font-weight:600"><td>TOTAL</td>';
            let granTotal = 0;
            tiendasArray.forEach(t => {
                let totalTienda = 0;
                generosArray.forEach(g => {
                    totalTienda += matriz[g]?.[t] || 0;
                });
                granTotal += totalTienda;
                html += `<td style="text-align:right">${formatMoney(totalTienda)}</td>`;
            });
            html += `<td style="text-align:right">${formatMoney(granTotal)}</td></tr></tbody>`;
            
            document.getElementById('tablaMatrizGeneroTienda').innerHTML = html;
            
            // Generar gr√°fica visual
            generarGraficaMatrizGeneroTienda(matriz, generosArray, tiendasArray);
        }
        
        function generarGraficaMatrizGeneroTienda(matriz, generos, tiendas) {
            const ctx = document.getElementById('chartMatrizGeneroTienda');
            if (!ctx) return;
            
            // Destruir gr√°fica anterior si existe
            if (chartMatrizGeneroTienda) {
                chartMatrizGeneroTienda.destroy();
            }
            
            // Colores por g√©nero
            const coloresPorGenero = {
                'HOMBRE': '#3b82f6',     // Azul
                'MUJER': '#ec4899',      // Rosa
                'NI√ëO': '#10b981',       // Verde
                'NI√ëA': '#f59e0b',       // Naranja
                'BEBE': '#a855f7',       // Morado
                'UNISEX': '#64748b'      // Gris
            };
            
            // Preparar datasets (un dataset por g√©nero)
            const datasets = generos.map(genero => {
                const data = tiendas.map(tienda => matriz[genero]?.[tienda] || 0);
                return {
                    label: genero,
                    data: data,
                    backgroundColor: coloresPorGenero[genero] || '#64748b',
                    borderColor: 'white',
                    borderWidth: 2
                };
            });
            
            // Crear gr√°fica de barras agrupadas
            chartMatrizGeneroTienda = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: tiendas.map(t => t.replace('LUKERS ', '')),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    return label + ': ' + formatMoney(value);
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            stacked: false,
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            stacked: false,
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'S/ ' + value.toLocaleString();
                                }
                            },
                            title: {
                                display: true,
                                text: 'Monto (S/)'
                            }
                        }
                    }
                }
            });
        }

        function generarGraficas(ordenesFiltradas = ordenes) {
            const ctxEstados = document.getElementById('chartEstados');
            if (chartEstados) chartEstados.destroy();
            const estados = {};
            ordenesFiltradas.forEach(o => { estados[o.estado] = (estados[o.estado] || 0) + 1; });
            chartEstados = new Chart(ctxEstados, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(estados),
                    datasets: [{
                        data: Object.values(estados),
                        backgroundColor: ['#a855f7', '#f59e0b', '#3b82f6', '#f59e0b', '#3b82f6', '#10b981', '#ef4444']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });

            const ctxMontos = document.getElementById('chartMontos');
            if (chartMontos) chartMontos.destroy();
            const labels = [], dataMontos = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const fecha = d.toISOString().split('T')[0];
                labels.push(d.toLocaleDateString('es-PE', { day: '2-digit', month: 'short' }));
                const monto = ordenesFiltradas.filter(o => o.fecha && o.fecha.startsWith(fecha))
                    .reduce((s, o) => s + (parseFloat(o.monto_solicitado) || 0), 0);
                dataMontos.push(monto);
            }
            chartMontos = new Chart(ctxMontos, {
                type: 'line',
                data: { labels, datasets: [{ data: dataMontos, borderColor: '#6366f1', backgroundColor: 'rgba(99,102,241,0.1)', tension: 0.4, fill: true }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            const ctxEquipos = document.getElementById('chartEquipos');
            if (chartEquipos) chartEquipos.destroy();
            const equiposNombres = equipos.map(e => e.nombre);
            const equiposData = equipos.map(e => {
                return picking.filter(p => p.equipo_id === e.id && p.estado === 'Completado').length;
            });
            chartEquipos = new Chart(ctxEquipos, {
                type: 'bar',
                data: { labels: equiposNombres.length ? equiposNombres : ['Sin equipos'], datasets: [{ data: equiposData.length ? equiposData : [0], backgroundColor: '#3b82f6', borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            const ctxGeneros = document.getElementById('chartGeneros');
            if (chartGeneros) chartGeneros.destroy();
            const generos = {};
            productos.forEach(p => { generos[p.genero || 'Sin g√©nero'] = (generos[p.genero || 'Sin g√©nero'] || 0) + 1; });
            chartGeneros = new Chart(ctxGeneros, {
                type: 'pie',
                data: { labels: Object.keys(generos), datasets: [{ data: Object.values(generos), backgroundColor: ['#6366f1', '#ec4899', '#f59e0b', '#10b981', '#8b5cf6'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });
        }

        // ============================================
        // INVENTARIO
        // ============================================
        function renderizarInventario() {
            document.getElementById('countInventario').textContent = inventarioFiltrado.length.toLocaleString();
            const totalPag = Math.ceil(inventarioFiltrado.length / ITEMS_POR_PAGINA) || 1;
            if (paginaInv > totalPag) paginaInv = totalPag;
            const items = inventarioFiltrado.slice((paginaInv - 1) * ITEMS_POR_PAGINA, paginaInv * ITEMS_POR_PAGINA);

            document.getElementById('tablaInventario').innerHTML = items.length === 0 
                ? '<tr><td colspan="6" class="empty-state">No hay datos</td></tr>'
                : items.map(i => {
                    const bloq = parseInt(i.stock_bloqueado) || 0;
                    const disp = (parseInt(i.stock_fisico) || 0) - bloq;
                    return `<tr>
                        <td><strong>${i.variante}</strong></td>
                        <td><span class="badge badge-info">${i.ubicacion}</span></td>
                        <td>${i.stock_fisico || 0}</td>
                        <td>${bloq > 0 ? `<strong style="color:var(--warning)">${bloq}</strong>` : '0'}</td>
                        <td><strong style="color:${disp > 0 ? 'var(--success)' : 'var(--danger)'}">${disp}</strong></td>
                        <td>
                            <button class="btn btn-info btn-icon btn-sm" onclick="verVariante('${i.variante}','${i.ubicacion}')" title='Ver Info'><i data-lucide="info" style="width:14px;height:14px"></i></button>
                            ${bloq > 0 ? `<button class="btn btn-warning btn-icon btn-sm" onclick="desbloquearItem('${i.variante}','${i.ubicacion}')" title='Desbloquear'><i data-lucide="unlock" style="width:14px;height:14px"></i></button>` : ''}
                            <button class="btn btn-danger btn-icon btn-sm" onclick="eliminarItem('${i.variante}','${i.ubicacion}')" title='Eliminar'><i data-lucide="trash-2" style="width:14px;height:14px"></i></button>
                        </td>
                    </tr>`;
                }).join('');

            document.getElementById('paginaInventario').textContent = paginaInv;
            document.getElementById('totalPaginasInventario').textContent = totalPag;
            document.getElementById('prevInventario').disabled = paginaInv === 1;
            document.getElementById('nextInventario').disabled = paginaInv >= totalPag;
            renderIcons();
        }

        function filtrarInventario() {
            const search = normalizarTexto(document.getElementById('searchInventario')?.value || '');
            
            // Si inventario NO est√° cargado, usar b√∫squeda en servidor
            if (!inventarioCargado && search.length >= 2) {
                buscarInventarioRapido(search);
                return;
            }
            
            // Si est√° cargado, filtrar localmente
            inventarioFiltrado = inventario.filter(i => 
                normalizarTexto(i.variante).includes(search) || normalizarTexto(i.ubicacion).includes(search)
            );
            paginaInv = 1;
            renderizarInventario();
        }

        function verVariante(variante, ubicacion) {
            const inv = inventario.find(i => i.variante === variante && i.ubicacion === ubicacion);
            const prod = productos.find(p => p.variante === variante);
            const todasUbicaciones = inventario.filter(i => i.variante === variante);
            
            let html = `
                <div class="tabs" style="margin-bottom:1rem">
                    <div class="tab active" data-tab="producto" onclick="cambiarTabInfo('producto', '${variante}', '${ubicacion}')">üì¶ Producto</div>
                    <div class="tab" data-tab="inventario" onclick="cambiarTabInfo('inventario', '${variante}', '${ubicacion}')">üìä Inventario</div>
                    <div class="tab" data-tab="movimientos" onclick="cambiarTabInfo('movimientos', '${variante}', '${ubicacion}')">üìã Movimientos</div>
                </div>
                <div id="infoTabContent"></div>
            `;
            
            document.getElementById('varianteDetalleContent').innerHTML = html;
            abrirModal('modalVerVariante');
            cambiarTabInfo('producto', variante, ubicacion);
        }
        
        function cambiarTabInfo(tab, variante, ubicacion) {
            // Actualizar tabs
            document.querySelectorAll('#modalVerVariante .tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab);
            });
            
            const inv = inventario.find(i => i.variante === variante && i.ubicacion === ubicacion);
            const prod = productos.find(p => p.variante === variante);
            const todasUbicaciones = inventario.filter(i => i.variante === variante);
            
            let html = '';
            
            if (tab === 'producto') {
                html = '<div class="detail-grid">';
                html += `<div class="detail-item"><div class="detail-label">Variante</div><div class="detail-value"><strong>${variante}</strong></div></div>`;
                
                if (prod) {
                    html += `<div class="detail-item"><div class="detail-label">C√≥digo Comercial</div><div class="detail-value">${prod.codigo_comercial || '-'}</div></div>`;
                    html += `<div class="detail-item" style="grid-column:span 2"><div class="detail-label">Descripci√≥n</div><div class="detail-value">${prod.descripcion || '-'}</div></div>`;
                    html += `<div class="detail-item"><div class="detail-label">Marca</div><div class="detail-value">${prod.marca || '-'}</div></div>`;
                    html += `<div class="detail-item"><div class="detail-label">G√©nero</div><div class="detail-value">${prod.genero || '-'}</div></div>`;
                    html += `<div class="detail-item"><div class="detail-label">L√≠nea</div><div class="detail-value">${prod.linea || '-'}</div></div>`;
                    html += `<div class="detail-item"><div class="detail-label">Talla</div><div class="detail-value">${prod.talla || '-'}</div></div>`;
                    html += `<div class="detail-item"><div class="detail-label">Color</div><div class="detail-value">${prod.color || '-'}</div></div>`;
                    html += `<div class="detail-item"><div class="detail-label">Kardex</div><div class="detail-value" ${prod.kardex === 0 ? 'style="color:var(--danger)"' : ''}><strong>${prod.kardex || 0}</strong> ${prod.kardex === 0 ? '‚ö†Ô∏è' : ''}</div></div>`;
                    html += `<div class="detail-item"><div class="detail-label">PVP</div><div class="detail-value" style="color:var(--success)">${formatMoney(prod.pvp || 0)}</div></div>`;
                    html += `<div class="detail-item"><div class="detail-label">PVP Regular</div><div class="detail-value">${formatMoney(prod.pvp_regular || 0)}</div></div>`;
                } else {
                    html += `<div class="detail-item" style="grid-column:span 2"><div class="alert alert-warning" style="margin:0"><i data-lucide="alert-triangle"></i><span>Este producto NO existe en el cat√°logo</span></div></div>`;
                }
                html += '</div>';
                
            } else if (tab === 'inventario') {
                html = '<div class="detail-grid" style="margin-bottom:1rem">';
                html += `<div class="detail-item"><div class="detail-label">Variante</div><div class="detail-value"><strong>${variante}</strong></div></div>`;
                html += `<div class="detail-item"><div class="detail-label">Ubicaci√≥n Actual</div><div class="detail-value"><span class="badge badge-info">${ubicacion}</span></div></div>`;
                
                if (inv) {
                    html += `<div class="detail-item"><div class="detail-label">Stock F√≠sico</div><div class="detail-value"><strong>${inv.stock_fisico || 0}</strong></div></div>`;
                    html += `<div class="detail-item"><div class="detail-label">Bloqueado</div><div class="detail-value" style="color:var(--warning)"><strong>${inv.stock_bloqueado || 0}</strong></div></div>`;
                    html += `<div class="detail-item"><div class="detail-label">Disponible</div><div class="detail-value" style="color:var(--success)"><strong>${(inv.stock_fisico || 0) - (inv.stock_bloqueado || 0)}</strong></div></div>`;
                }
                html += '</div>';
                
                if (todasUbicaciones.length > 1) {
                    html += '<h4 style="margin:1rem 0">Todas las Ubicaciones</h4>';
                    html += '<div class="table-container"><table><thead><tr><th>Ubicaci√≥n</th><th>Stock F√≠sico</th><th>Bloqueado</th><th>Disponible</th></tr></thead><tbody>';
                    todasUbicaciones.forEach(i => {
                        const disp = (i.stock_fisico || 0) - (i.stock_bloqueado || 0);
                        html += `<tr>
                            <td><span class="badge badge-info">${i.ubicacion}</span></td>
                            <td>${i.stock_fisico || 0}</td>
                            <td style="color:var(--warning)">${i.stock_bloqueado || 0}</td>
                            <td style="color:${disp > 0 ? 'var(--success)' : 'var(--danger)'}"><strong>${disp}</strong></td>
                        </tr>`;
                    });
                    html += '</tbody></table></div>';
                }
                
            } else if (tab === 'movimientos') {
                // Generar movimientos simulados basados en √≥rdenes reales
                const movimientos = [];
                
                // Buscar en √≥rdenes completadas que usaron esta variante
                ordenes.filter(o => o.estado === 'Completada').forEach(orden => {
                    if (orden.items && orden.items.some(item => item.variante === variante)) {
                        const item = orden.items.find(i => i.variante === variante);
                        if (item) {
                            movimientos.push({
                                fecha: orden.fecha_cierre || orden.fecha,
                                tipo: 'Salida',
                                cantidad: -(item.cantidad || 0),
                                motivo: `Orden ${orden.nombre}`,
                                estado: 'Completado'
                            });
                        }
                    }
                });
                
                // Buscar en packing
                packing.filter(p => p.estado === 'Completado').forEach(pack => {
                    if (pack.items_recibidos && pack.items_recibidos.some(item => item.variante === variante)) {
                        const item = pack.items_recibidos.find(i => i.variante === variante);
                        if (item && item.cantidad_encontrada) {
                            movimientos.push({
                                fecha: pack.fecha_fin || pack.fecha_inicio,
                                tipo: 'Empaque',
                                cantidad: item.cantidad_encontrada,
                                motivo: `Packing PT${pack.parte}`,
                                estado: 'Procesado'
                            });
                        }
                    }
                });
                
                // Buscar en reclasificaci√≥n
                reclasificacion.filter(r => r.variante === variante).forEach(reclas => {
                    movimientos.push({
                        fecha: reclas.fecha_procesado || reclas.fecha_reporte,
                        tipo: 'Reclasificaci√≥n',
                        cantidad: reclas.cantidad || 0,
                        motivo: reclas.motivo || 'Reclasificaci√≥n',
                        estado: reclas.estado
                    });
                });
                
                // Ordenar por fecha (m√°s reciente primero)
                movimientos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
                
                if (movimientos.length > 0) {
                    html = '<div class="timeline">';
                    movimientos.slice(0, 10).forEach(mov => {
                        const fecha = new Date(mov.fecha);
                        const colorTipo = mov.tipo === 'Salida' ? 'var(--danger)' : mov.tipo === 'Empaque' ? 'var(--success)' : 'var(--warning)';
                        const iconoTipo = mov.tipo === 'Salida' ? 'üì§' : mov.tipo === 'Empaque' ? 'üì¶' : 'üîÑ';
                        
                        html += `<div class="timeline-item">
                            <div class="timeline-date">${formatFechaHora(mov.fecha)}</div>
                            <div class="timeline-title" style="color:${colorTipo}">${iconoTipo} ${mov.tipo}</div>
                            <div class="timeline-desc">
                                <strong style="color:${mov.cantidad < 0 ? 'var(--danger)' : 'var(--success)'}">
                                    ${mov.cantidad > 0 ? '+' : ''}${mov.cantidad} unidades
                                </strong><br>
                                ${mov.motivo}<br>
                                <span class="badge badge-${mov.estado === 'Completado' ? 'success' : mov.estado === 'Procesado' ? 'info' : 'warning'}" style="margin-top:0.25rem">
                                    ${mov.estado}
                                </span>
                            </div>
                        </div>`;
                    });
                    
                    if (movimientos.length > 10) {
                        html += `<div class="timeline-item" style="opacity:0.6">
                            <div class="timeline-desc" style="text-align:center;font-style:italic">
                                + ${movimientos.length - 10} movimientos m√°s antiguos
                            </div>
                        </div>`;
                    }
                    
                    html += '</div>';
                } else {
                    html = '<div style="text-align:center;padding:2rem;color:var(--text-secondary)">';
                    html += '<i data-lucide="inbox" style="width:48px;height:48px;margin-bottom:1rem;opacity:0.5"></i><br>';
                    html += '<strong>Sin movimientos registrados</strong><br>';
                    html += '<span style="font-size:0.9rem">Esta variante no tiene historial de movimientos a√∫n</span>';
                    html += '</div>';
                }
            }
            
            document.getElementById('infoTabContent').innerHTML = html;
            renderIcons();
        }

        async function desbloquearItem(variante, ubicacion) {
            if (!confirm(`¬øDesbloquear stock de ${variante} en ${ubicacion}?`)) return;
            mostrarLoading('Desbloqueando...');
            await supabase.from('inventario').update({ stock_bloqueado: 0 }).eq('variante', variante).eq('ubicacion', ubicacion);
            ocultarLoading();
            toast('Stock desbloqueado', 'success');
            await cargarDatos();
        }

        async function desbloquearTodoStock() {
            if (!confirm('‚ö†Ô∏è Esto desbloquear√° TODO el stock. ¬øContinuar?')) return;
            mostrarLoading('Desbloqueando todo...');
            const bloqueados = inventario.filter(i => (parseInt(i.stock_bloqueado) || 0) > 0);
            let count = 0;
            for (const item of bloqueados) {
                await supabase.from('inventario').update({ stock_bloqueado: 0 }).eq('variante', item.variante).eq('ubicacion', item.ubicacion);
                count++;
            }
            ocultarLoading();
            toast(`${count} items desbloqueados`, 'success');
            await cargarDatos();
        }

        async function eliminarItem(variante, ubicacion) {
            if (!confirm(`¬øEliminar ${variante} de ${ubicacion}?`)) return;
            mostrarLoading('Eliminando...');
            await supabase.from('inventario').delete().eq('variante', variante).eq('ubicacion', ubicacion);
            ocultarLoading();
            toast('Eliminado', 'success');
            await cargarDatos();
        }

        async function guardarItem() {
            const v = normalizarTexto(document.getElementById('inputVariante').value);
            const u = normalizarTexto(document.getElementById('inputUbicacion').value);
            const s = parseInt(document.getElementById('inputStock').value) || 0;
            if (!v || !u) { toast('Completa variante y ubicaci√≥n', 'error'); return; }
            mostrarLoading('Guardando...');
            await supabase.from('inventario').upsert({ variante: v, ubicacion: u, stock_fisico: s, stock_bloqueado: 0 }, { onConflict: 'variante,ubicacion' });
            ocultarLoading();
            toast('Guardado', 'success');
            cerrarModal('modalAgregarItem');
            await cargarDatos();
        }

        async function procesarInventario() {
            const file = document.getElementById('fileInventario').files[0];
            if (!file) { toast('Selecciona un archivo', 'error'); return; }
            mostrarLoading('Procesando inventario...');
            try {
                const data = await leerExcel(file);
                const items = data.map(r => ({
                    variante: normalizarTexto(getCol(r, ['variante', 'Variante', 'VARIANTE'])),
                    ubicacion: normalizarTexto(getCol(r, ['ubicacion', 'Ubicacion', 'UBICACION', 'Ubicaci√≥n'])),
                    stock_fisico: parseInt(getCol(r, ['stock_fisico', 'StockFisico', 'stockfisico', 'Stock', 'stock', 'STOCK'])) || 0,
                    stock_bloqueado: 0
                })).filter(i => i.variante && i.ubicacion);

                for (let i = 0; i < items.length; i += BATCH_SIZE) {
                    await supabase.from('inventario').upsert(items.slice(i, i + BATCH_SIZE), { onConflict: 'variante,ubicacion' });
                    actualizarProgreso((i / items.length) * 100);
                }
                ocultarLoading();
                toast(`${items.length} registros procesados`, 'success');
                cerrarModal('modalSubirInventario');
                limpiarArchivo('fileInventario', 'fileInventarioInfo');
                await cargarDatos();
            } catch (e) {
                ocultarLoading();
                toast('Error: ' + e.message, 'error');
            }
        }

        async function procesarModificarMasivo() {
            const file = document.getElementById('fileModificar').files[0];
            if (!file) { toast('Selecciona un archivo', 'error'); return; }
            mostrarLoading('Modificando...');
            const data = await leerExcel(file);
            let count = 0;
            for (const r of data) {
                const v = normalizarTexto(getCol(r, ['variante', 'Variante']));
                const u = normalizarTexto(getCol(r, ['ubicacion', 'Ubicacion']));
                const s = parseInt(getCol(r, ['stock_fisico', 'StockFisico', 'Stock'])) || 0;
                if (v && u) {
                    await supabase.from('inventario').update({ stock_fisico: s }).eq('variante', v).eq('ubicacion', u);
                    count++;
                }
            }
            ocultarLoading();
            toast(`${count} registros actualizados`, 'success');
            cerrarModal('modalModificarMasivo');
            limpiarArchivo('fileModificar', 'fileModificarInfo');
            await cargarDatos();
        }

        async function procesarEliminarMasivo() {
            const file = document.getElementById('fileEliminar').files[0];
            if (!file) { toast('Selecciona un archivo', 'error'); return; }
            if (!confirm('¬øEliminar estos productos?')) return;
            mostrarLoading('Eliminando...');
            const data = await leerExcel(file);
            let count = 0;
            for (const r of data) {
                const v = normalizarTexto(getCol(r, ['variante', 'Variante']));
                const u = normalizarTexto(getCol(r, ['ubicacion', 'Ubicacion']));
                if (v && u) {
                    await supabase.from('inventario').delete().eq('variante', v).eq('ubicacion', u);
                    count++;
                }
            }
            ocultarLoading();
            toast(`${count} eliminados`, 'success');
            cerrarModal('modalEliminarMasivo');
            limpiarArchivo('fileEliminar', 'fileEliminarInfo');
            await cargarDatos();
        }

        function exportarInventarioCompleto() {
            if (!inventario.length) { toast('Sin datos', 'warning'); return; }
            const data = inventario.map(i => {
                const prod = productos.find(p => p.variante === i.variante);
                return {
                    Variante: i.variante,
                    Ubicacion: i.ubicacion,
                    StockFisico: i.stock_fisico,
                    StockBloqueado: i.stock_bloqueado,
                    Disponible: (i.stock_fisico || 0) - (i.stock_bloqueado || 0),
                    CodigoComercial: prod?.codigo_comercial || '',
                    Descripcion: prod?.descripcion || '',
                    Genero: prod?.genero || '',
                    Marca: prod?.marca || '',
                    Talla: prod?.talla || '',
                    Kardex: prod?.kardex || 0,
                    PVP: prod?.pvp || 0,
                    PVPRegular: prod?.pvp_regular || 0
                };
            });
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'InventarioCompleto');
            XLSX.writeFile(wb, `Inventario_Completo_${new Date().toISOString().split('T')[0]}.xlsx`);
            toast('Exportado', 'success');
        }

        // ============================================
        // PRODUCTOS
        // ============================================
        function actualizarFiltrosProductos() {
            // Inicializar opciones disponibles desde TODOS los productos
            opcionesDisponibles.genero = [...new Set(productos.map(p => p.genero).filter(Boolean))].sort();
            opcionesDisponibles.linea = [...new Set(productos.map(p => p.linea).filter(Boolean))].sort();
            opcionesDisponibles.marca = [...new Set(productos.map(p => p.marca).filter(Boolean))].sort();
            
            // Renderizar todos los filtros
            renderizarMultiSelect('genero');
            renderizarMultiSelect('linea');
            renderizarMultiSelect('marca');
        }
        
        function renderizarMultiSelect(tipo) {
            const container = document.getElementById(`${tipo}Options`);
            if (!container) return;
            
            // Obtener productos filtrados por los OTROS filtros (cascada)
            let productosFiltradosCascada = productos;
            
            if (tipo === 'linea') {
                // Si hay g√©neros seleccionados, filtrar por ellos
                if (filtrosSeleccionados.genero.length > 0) {
                    productosFiltradosCascada = productosFiltradosCascada.filter(p => 
                        filtrosSeleccionados.genero.includes(p.genero)
                    );
                }
            } else if (tipo === 'marca') {
                // Si hay g√©neros seleccionados, filtrar por ellos
                if (filtrosSeleccionados.genero.length > 0) {
                    productosFiltradosCascada = productosFiltradosCascada.filter(p => 
                        filtrosSeleccionados.genero.includes(p.genero)
                    );
                }
                // Si hay l√≠neas seleccionadas, filtrar por ellas
                if (filtrosSeleccionados.linea.length > 0) {
                    productosFiltradosCascada = productosFiltradosCascada.filter(p => 
                        filtrosSeleccionados.linea.includes(p.linea)
                    );
                }
            }
            
            // Obtener opciones disponibles con este filtrado
            const opcionesDisponiblesCascada = [...new Set(productosFiltradosCascada.map(p => p[tipo]).filter(Boolean))].sort();
            
            // Generar HTML de opciones
            let html = '';
            opcionesDisponibles[tipo].forEach(opcion => {
                const count = productosFiltradosCascada.filter(p => p[tipo] === opcion).length;
                const isSelected = filtrosSeleccionados[tipo].includes(opcion);
                const isDisabled = count === 0 && !isSelected; // Deshabilitado si no hay productos (excepto si ya est√° seleccionado)
                
                html += `
                    <div class="multi-select-option ${isDisabled ? 'disabled' : ''}" onclick="toggleOpcion('${tipo}', '${opcion}')">
                        <input type="checkbox" ${isSelected ? 'checked' : ''} ${isDisabled ? 'disabled' : ''}>
                        <span class="multi-select-option-text">${opcion}</span>
                        <span class="multi-select-option-count">${count}</span>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<div style="padding:1rem;text-align:center;color:var(--text-secondary)">Sin opciones</div>';
            
            // Actualizar texto del trigger
            actualizarTriggerText(tipo);
        }
        
        function toggleOpcion(tipo, valor) {
            const index = filtrosSeleccionados[tipo].indexOf(valor);
            if (index > -1) {
                filtrosSeleccionados[tipo].splice(index, 1);
            } else {
                filtrosSeleccionados[tipo].push(valor);
            }
            
            // Re-renderizar checkbox espec√≠fico (sin cerrar dropdown)
            renderizarMultiSelect(tipo);
            
            // Actualizar filtros en cascada
            if (tipo === 'genero') {
                renderizarMultiSelect('linea');
                renderizarMultiSelect('marca');
            } else if (tipo === 'linea') {
                renderizarMultiSelect('marca');
            }
        }
        
        function toggleMultiSelect(tipo) {
            const dropdown = document.getElementById(`${tipo}Dropdown`);
            const trigger = dropdown.previousElementSibling;
            const isOpen = dropdown.classList.contains('open');
            
            // Cerrar todos los otros dropdowns
            document.querySelectorAll('.multi-select-dropdown').forEach(d => {
                d.classList.remove('open');
            });
            document.querySelectorAll('.multi-select-trigger').forEach(t => {
                t.classList.remove('open');
            });
            
            // Toggle este dropdown
            if (!isOpen) {
                dropdown.classList.add('open');
                trigger.classList.add('open');
            }
        }
        
        function aplicarMultiSelect(tipo) {
            // Cerrar dropdown
            document.getElementById(`${tipo}Dropdown`).classList.remove('open');
            document.querySelector(`#${tipo}Dropdown`).previousElementSibling.classList.remove('open');
            
            // Aplicar filtros
            filtrarProductos();
        }
        
        function limpiarMultiSelect(tipo) {
            filtrosSeleccionados[tipo] = [];
            renderizarMultiSelect(tipo);
            
            // Actualizar cascada
            if (tipo === 'genero') {
                renderizarMultiSelect('linea');
                renderizarMultiSelect('marca');
            } else if (tipo === 'linea') {
                renderizarMultiSelect('marca');
            }
        }
        
        function buscarEnMultiSelect(tipo, query) {
            const container = document.getElementById(`${tipo}Options`);
            const opciones = container.querySelectorAll('.multi-select-option');
            
            opciones.forEach(opcion => {
                const texto = opcion.querySelector('.multi-select-option-text').textContent.toLowerCase();
                if (texto.includes(query.toLowerCase())) {
                    opcion.style.display = 'flex';
                } else {
                    opcion.style.display = 'none';
                }
            });
        }
        
        function actualizarTriggerText(tipo) {
            const selected = filtrosSeleccionados[tipo];
            const triggerText = document.getElementById(`${tipo}TriggerText`);
            const trigger = triggerText.parentElement;
            
            // Remover badge existente
            const existingBadge = trigger.querySelector('.multi-select-count');
            if (existingBadge) existingBadge.remove();
            
            if (selected.length === 0) {
                const labels = { genero: 'Todos', linea: 'Todas', marca: 'Todas' };
                triggerText.textContent = labels[tipo];
            } else if (selected.length === 1) {
                triggerText.textContent = selected[0];
            } else {
                const labels = { genero: 'g√©neros', linea: 'l√≠neas', marca: 'marcas' };
                triggerText.textContent = `${selected.length} ${labels[tipo]}`;
                
                // Agregar badge
                const badge = document.createElement('span');
                badge.className = 'multi-select-count';
                badge.textContent = selected.length;
                trigger.insertBefore(badge, triggerText);
            }
        }
        
        // Cerrar dropdowns al hacer click fuera
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.multi-select-filter')) {
                document.querySelectorAll('.multi-select-dropdown').forEach(d => {
                    d.classList.remove('open');
                });
                document.querySelectorAll('.multi-select-trigger').forEach(t => {
                    t.classList.remove('open');
                });
            }
        });

        function renderizarProductos() {
            document.getElementById('countProductos').textContent = productosFiltrado.length.toLocaleString();
            const totalPag = Math.ceil(productosFiltrado.length / ITEMS_POR_PAGINA) || 1;
            if (paginaProd > totalPag) paginaProd = totalPag;
            const items = productosFiltrado.slice((paginaProd - 1) * ITEMS_POR_PAGINA, paginaProd * ITEMS_POR_PAGINA);

            document.getElementById('tablaProductos').innerHTML = items.length === 0
                ? '<tr><td colspan="9" class="empty-state">No hay productos</td></tr>'
                : items.map(p => `<tr>
                    <td><strong>${p.variante}</strong></td>
                    <td>${p.codigo_comercial || '-'}</td>
                    <td class="td-wrap">${p.descripcion || '-'}</td>
                    <td>${p.genero || '-'}</td>
                    <td>${p.marca || '-'}</td>
                    <td>${p.talla || '-'}</td>
                    <td><strong style="color:var(--primary)">${formatMoney(p.kardex)}</strong></td>
                    <td><strong style="color:var(--success)">${formatMoney(p.pvp)}</strong></td>
                    <td><strong style="color:var(--info)">${formatPorcentaje(calcularCV(p.pvp, p.kardex))}</strong></td>
                </tr>`).join('');

            document.getElementById('paginaProductos').textContent = paginaProd;
            document.getElementById('totalPaginasProductos').textContent = totalPag;
            document.getElementById('prevProductos').disabled = paginaProd === 1;
            document.getElementById('nextProductos').disabled = paginaProd >= totalPag;
        }

        function filtrarProductos() {
            const search = normalizarTexto(document.getElementById('searchProductos')?.value || '');
            
            // Si productos NO est√°n cargados, usar b√∫squeda en servidor
            if (!productosCargados && search.length >= 2) {
                buscarProductosRapido(search);
                return;
            }
            
            // Si est√°n cargados, filtrar localmente
            productosFiltrado = productos.filter(p => {
                // Filtro de b√∫squeda por texto
                const matchSearch = search === '' || 
                    normalizarTexto(p.variante).includes(search) || 
                    normalizarTexto(p.descripcion || '').includes(search) || 
                    normalizarTexto(p.codigo_comercial || '').includes(search);
                
                // Filtro por g√©nero (multi-select)
                const matchGenero = filtrosSeleccionados.genero.length === 0 || 
                    filtrosSeleccionados.genero.includes(p.genero);
                
                // Filtro por l√≠nea (multi-select)
                const matchLinea = filtrosSeleccionados.linea.length === 0 || 
                    filtrosSeleccionados.linea.includes(p.linea);
                
                // Filtro por marca (multi-select)
                const matchMarca = filtrosSeleccionados.marca.length === 0 || 
                    filtrosSeleccionados.marca.includes(p.marca);
                
                return matchSearch && matchGenero && matchLinea && matchMarca;
            });
            
            paginaProd = 1;
            renderizarProductos();
        }

        async function procesarProductos() {
            const file = document.getElementById('fileProductos').files[0];
            if (!file) { toast('Selecciona un archivo', 'error'); return; }
            if (!confirm('Esto reemplazar√° el cat√°logo. ¬øContinuar?')) return;
            mostrarLoading('Procesando cat√°logo...');
            await supabase.from('productos_system').delete().neq('variante', '');
            const data = await leerExcel(file);
            const items = data.map(r => ({
                variante: normalizarTexto(getCol(r, ['variante', 'Variante', 'VARIANTE'])),
                codigo_comercial: String(getCol(r, ['codigo_comercial', 'CodigoComercial', 'Codigo', 'codigo']) || '').trim(),
                descripcion: String(getCol(r, ['descripcion', 'Descripcion', 'DESCRIPCION']) || '').trim(),
                kardex: parseFloat(getCol(r, ['kardex', 'Kardex', 'KARDEX'])) || 0,
                pvp: parseFloat(getCol(r, ['pvp', 'PVP'])) || 0,
                pvp_regular: parseFloat(getCol(r, ['pvp_regular', 'PVPRegular', 'pvpregular'])) || 0,
                pvp_oferta: parseFloat(getCol(r, ['pvp_oferta', 'PVPOferta', 'pvpoferta'])) || 0,
                genero: String(getCol(r, ['genero', 'Genero', 'GENERO']) || '').trim(),
                linea: String(getCol(r, ['linea', 'Linea', 'LINEA']) || '').trim(),
                marca: String(getCol(r, ['marca', 'Marca', 'MARCA']) || '').trim(),
                talla: String(getCol(r, ['talla', 'Talla', 'TALLA']) || '').trim(),
                color: String(getCol(r, ['color', 'Color', 'COLOR']) || '').trim()
            })).filter(i => i.variante);

            // VALIDACIONES
            const variantesInventario = new Set(inventario.map(i => i.variante));
            const variantesFaltantes = items.filter(p => !variantesInventario.has(p.variante));
            const kardexCero = items.filter(p => p.kardex === 0);

            for (let i = 0; i < items.length; i += BATCH_SIZE) {
                await supabase.from('productos_system').insert(items.slice(i, i + BATCH_SIZE));
                actualizarProgreso((i / items.length) * 100);
            }
            
            ocultarLoading();
            toast(`${items.length} productos cargados`, 'success');
            
            // Mostrar alertas
            let alertas = [];
            if (variantesFaltantes.length > 0) {
                alertas.push(`‚ö†Ô∏è <strong>${variantesFaltantes.length} variantes NO existen en inventario</strong>`);
            }
            if (kardexCero.length > 0) {
                alertas.push(`‚ö†Ô∏è <strong>${kardexCero.length} productos tienen kardex = 0</strong>`);
            }
            
            if (alertas.length > 0) {
                const html = `
                    <div style="text-align:left">
                        <h3 style="margin-bottom:1rem">‚ö†Ô∏è Validaciones Detectadas</h3>
                        ${alertas.map(a => `<div style="padding:0.5rem 0">${a}</div>`).join('')}
                        <div style="margin-top:1.5rem;display:flex;gap:0.5rem;justify-content:center">
                            ${variantesFaltantes.length > 0 ? '<button class="btn btn-warning" onclick="descargarVariantesFaltantes()">üì• Descargar Faltantes</button>' : ''}
                            ${kardexCero.length > 0 ? '<button class="btn btn-warning" onclick="descargarKardexCero()">üì• Descargar Kardex=0</button>' : ''}
                            <button class="btn btn-outline" onclick="cerrarModal(&apos;modalValidaciones&apos;)">Cerrar</button>
                        </div>
                    </div>
                `;
                
                // Guardar para descargas
                window.variantesFaltantesTemp = variantesFaltantes;
                window.kardexCeroTemp = kardexCero;
                
                document.getElementById('alertasValidacionContent').innerHTML = html;
                abrirModal('modalValidaciones');
            }
            
            cerrarModal('modalSubirProductos');
            limpiarArchivo('fileProductos', 'fileProductosInfo');
            await cargarDatos();
        }
        
        function descargarVariantesFaltantes() {
            if (!window.variantesFaltantesTemp || window.variantesFaltantesTemp.length === 0) return;
            const ws = XLSX.utils.json_to_sheet(window.variantesFaltantesTemp);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Faltantes');
            XLSX.writeFile(wb, `Variantes_Faltantes_Inventario_${new Date().toISOString().split('T')[0]}.xlsx`);
            toast('Archivo descargado', 'success');
        }
        
        function descargarKardexCero() {
            if (!window.kardexCeroTemp || window.kardexCeroTemp.length === 0) return;
            const ws = XLSX.utils.json_to_sheet(window.kardexCeroTemp);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'KardexCero');
            XLSX.writeFile(wb, `Productos_Kardex_Cero_${new Date().toISOString().split('T')[0]}.xlsx`);
            toast('Archivo descargado', 'success');
        }

        function exportarProductos() {
            if (!productos.length) { toast('Sin productos', 'warning'); return; }
            const ws = XLSX.utils.json_to_sheet(productos);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Productos');
            XLSX.writeFile(wb, `Productos_${new Date().toISOString().split('T')[0]}.xlsx`);
            toast('Exportado', 'success');
        }

        // ============================================
        // √ìRDENES
        // ============================================
        function renderizarOrdenes() {
            document.getElementById('tablaOrdenes').innerHTML = ordenesFiltradas.length === 0
                ? '<tr><td colspan="8" class="empty-state">No hay √≥rdenes</td></tr>'
                : ordenesFiltradas.map(o => {
                    const total = o.total_unidades || 1;
                    const encontrado = o.unidades_encontradas || 0;
                    const empacado = o.unidades_empacadas || 0;
                    let progreso = 0;
                    let progresoTexto = '';
                    
                    if (o.estado === 'Pendiente Divisi√≥n') {
                        progreso = 0;
                        progresoTexto = 'Sin iniciar';
                    } else if (o.estado === 'Pendiente Picking' || o.estado === 'En Picking') {
                        progreso = Math.round((encontrado / total) * 50);
                        progresoTexto = `Picking: ${encontrado}/${total}`;
                    } else if (o.estado === 'Pendiente Packing' || o.estado === 'En Packing') {
                        progreso = 50 + Math.round((empacado / encontrado) * 50) || 50;
                        progresoTexto = `Packing: ${empacado}/${encontrado}`;
                    } else if (o.estado === 'Completada') {
                        progreso = 100;
                        progresoTexto = 'Completada';
                    }
                    
                    const colorBarra = progreso === 100 ? 'var(--success)' : progreso > 50 ? 'var(--info)' : 'var(--warning)';
                    
                    return `<tr>
                        <td><strong>${o.id}</strong></td>
                        <td class="td-wrap" style="max-width:180px">${o.nombre}</td>
                        <td>${formatFecha(o.fecha)}<br><small style="color:var(--text-secondary)">${diasTranscurridos(o.fecha)}d</small></td>
                        <td>${(o.total_unidades || 0).toLocaleString()}</td>
                        <td><strong style="color:var(--primary)">${formatMoney(o.monto_final || o.monto_solicitado)}</strong></td>
                        <td style="min-width:120px">
                            <div style="background:var(--bg-hover);border-radius:4px;height:8px;overflow:hidden">
                                <div style="width:${progreso}%;height:100%;background:${colorBarra}"></div>
                            </div>
                            <small style="color:var(--text-secondary)">${progresoTexto}</small>
                        </td>
                        <td>${getBadge(o.estado)}</td>
                        <td>
                            <button class="btn btn-info btn-icon btn-sm" onclick="verHistorialOrden('${o.id}')" title='Historial'><i data-lucide="history" style="width:14px;height:14px"></i></button>
                            ${o.estado === 'Pendiente Divisi√≥n' ? `<button class="btn btn-purple btn-icon btn-sm" onclick="abrirDividirOrden('${o.id}')" title='Dividir'><i data-lucide="scissors" style="width:14px;height:14px"></i></button>` : ''}
                            ${
                                // Bot√≥n eliminar con validaci√≥n de permisos
                                (() => {
                                    if (o.estado === 'Completada') {
                                        // Solo Jefe de Almac√©n y Jefes pueden eliminar completadas
                                        if ([ROLES.JEFE_ALMACEN, ROLES.JEFES].includes(usuarioActual.rol)) {
                                            return `<button class="btn btn-danger btn-icon btn-sm" onclick="eliminarOrden('${o.id}')" title='Eliminar (Solo Jefe de Almac√©n/Jefes)'><i data-lucide="trash-2" style="width:14px;height:14px"></i></button>`;
                                        } else {
                                            return `<button class="btn btn-danger btn-icon btn-sm" disabled title='Solo Jefe de Almac√©n o Jefes pueden eliminar completadas' style="opacity:0.5;cursor:not-allowed"><i data-lucide="lock" style="width:14px;height:14px"></i></button>`;
                                        }
                                    } else if (['Pendiente Divisi√≥n', 'Cancelada'].includes(o.estado)) {
                                        // Cualquiera puede eliminar pendientes o canceladas
                                        return `<button class="btn btn-danger btn-icon btn-sm" onclick="eliminarOrden('${o.id}')" title='Eliminar'><i data-lucide="trash-2" style="width:14px;height:14px"></i></button>`;
                                    }
                                    return '';
                                })()
                            }
                        </td>
                    </tr>`;
                }).join('');
            renderIcons();
        }

        function filtrarOrdenes() {
            // Determinar qu√© filtros usar seg√∫n el tab actual
            if (tabOrdenActual === 'activas') {
                // Filtros de √≥rdenes activas
                const search = normalizarTexto(document.getElementById('searchOrdenes')?.value || '');
                const estado = document.getElementById('filtroEstadoOrden')?.value || '';
                
                ordenesFiltradas = ordenes.filter(o => 
                    o.estado !== 'Completada' &&  // Solo no completadas
                    (normalizarTexto(o.id).includes(search) || normalizarTexto(o.nombre).includes(search)) &&
                    (!estado || o.estado === estado)
                );
            } else {
                // Filtros de historial (completadas)
                ordenesFiltradas = ordenes.filter(o => o.estado === 'Completada');
                
                // Filtrar por b√∫squeda
                const busqueda = document.getElementById('buscarOrdenHistorial')?.value.toLowerCase() || '';
                if (busqueda) {
                    ordenesFiltradas = ordenesFiltradas.filter(o => 
                        o.nombre.toLowerCase().includes(busqueda) ||
                        o.id.toLowerCase().includes(busqueda)
                    );
                }
                
                // Filtrar por fecha desde
                const desde = document.getElementById('filtroFechaDesdeOrden')?.value;
                if (desde) {
                    ordenesFiltradas = ordenesFiltradas.filter(o => {
                        const fechaCierre = o.fecha_cierre || o.fecha_fin_packing;
                        return fechaCierre && new Date(fechaCierre) >= new Date(desde);
                    });
                }
                
                // Filtrar por fecha hasta
                const hasta = document.getElementById('filtroFechaHastaOrden')?.value;
                if (hasta) {
                    ordenesFiltradas = ordenesFiltradas.filter(o => {
                        const fechaCierre = o.fecha_cierre || o.fecha_fin_packing;
                        return fechaCierre && new Date(fechaCierre) <= new Date(hasta + 'T23:59:59');
                    });
                }
                
                // Filtrar por equipo (buscar en pickings y packings de la orden)
                const equipo = document.getElementById('filtroEquipoOrden')?.value;
                if (equipo) {
                    ordenesFiltradas = ordenesFiltradas.filter(o => {
                        // Buscar si alg√∫n picking o packing tiene ese equipo
                        const tieneEquipo = 
                            picking.some(p => p.orden_id === o.id && p.equipo_id === parseInt(equipo)) ||
                            packing.some(p => p.orden_id === o.id && p.equipo_id === parseInt(equipo));
                        return tieneEquipo;
                    });
                }
            }
            
            renderizarOrdenes();
        }

        async function previsualizarOrden() {
            const file = document.getElementById('fileOrden').files[0];
            if (!file) return;
            try {
                const data = await leerExcel(file);
                const items = [];
                let totalUnidades = 0;
                const tiendasDetectadas = new Set();

                data.forEach(r => {
                    const v = normalizarTexto(getCol(r, ['variante', 'Variante', 'VARIANTE']));
                    const u = normalizarTexto(getCol(r, ['ubicacion', 'Ubicacion', 'UBICACION', 'Ubicaci√≥n']));
                    if (!v) return;

                    const dist = buscarTienda(r);
                    const cant = Object.values(dist).reduce((a, b) => a + b, 0);
                    Object.keys(dist).forEach(t => tiendasDetectadas.add(t));

                    if (cant > 0) {
                        items.push({ variante: v, ubicacion: u || '-', cantidad: cant, distribucion: dist });
                        totalUnidades += cant;
                    }
                });

                const preview = document.getElementById('previewOrden');
                const content = document.getElementById('previewOrdenContent');
                
                if (items.length === 0) {
                    content.innerHTML = '<strong style="color:var(--danger)">‚ö†Ô∏è No se encontraron items v√°lidos</strong><br>Verifica las columnas del archivo.';
                } else {
                    let monto = 0;
                    items.forEach(i => {
                        const prod = productos.find(p => p.variante === i.variante);
                        monto += (prod?.kardex || 0) * i.cantidad;
                    });

                    content.innerHTML = `
                        <strong style="color:var(--success)">‚úÖ Archivo v√°lido</strong><br>
                        <strong>Variantes:</strong> ${items.length}<br>
                        <strong>Unidades:</strong> ${totalUnidades.toLocaleString()}<br>
                        <strong>Monto estimado:</strong> ${formatMoney(monto)}<br>
                        <strong>Tiendas:</strong> ${Array.from(tiendasDetectadas).join(', ') || 'Ninguna detectada'}
                    `;
                }
                preview.style.display = 'block';
            } catch (e) {
                toast('Error leyendo archivo: ' + e.message, 'error');
            }
        }

        async function crearOrden() {
            const nombre = document.getElementById('ordenNombre').value.trim();
            const file = document.getElementById('fileOrden').files[0];
            
            if (!nombre) { toast('Ingresa un nombre para la orden', 'error'); return; }
            if (!file) { toast('Selecciona un archivo', 'error'); return; }

            mostrarLoading('Creando orden...');
            try {
                const data = await leerExcel(file);
                const items = [];
                let totalUnidades = 0;
                let monto = 0;

                data.forEach(r => {
                    const v = normalizarTexto(getCol(r, ['variante', 'Variante', 'VARIANTE']));
                    const u = normalizarTexto(getCol(r, ['ubicacion', 'Ubicacion', 'UBICACION', 'Ubicaci√≥n']));
                    if (!v) return;

                    const dist = buscarTienda(r);
                    const cant = Object.values(dist).reduce((a, b) => a + b, 0);
                    
                    if (cant > 0) {
                        const prod = productos.find(p => p.variante === v);
                        items.push({
                            variante: v,
                            ubicacion: u || '-',
                            cantidad: cant,
                            distribucion: dist,
                            kardex: prod?.kardex || 0,
                            descripcion: prod?.descripcion || '',
                            genero: prod?.genero || '',
                            talla: prod?.talla || ''
                        });
                        totalUnidades += cant;
                        monto += (prod?.kardex || 0) * cant;
                    }
                });

                if (items.length === 0) {
                    ocultarLoading();
                    toast('No se encontraron items v√°lidos', 'error');
                    return;
                }

                const ordenId = 'ORD-' + Date.now().toString(36).toUpperCase();
                const orden = {
                    id: ordenId,
                    nombre: nombre,
                    fecha: new Date().toISOString(),
                    estado: 'Pendiente Divisi√≥n',
                    monto_solicitado: monto,
                    monto_picking: 0,
                    monto_packing: 0,
                    monto_final: 0,
                    total_variantes: items.length,
                    total_unidades: totalUnidades,
                    unidades_encontradas: 0,
                    unidades_empacadas: 0,
                    unidades_reclasificadas: 0,
                    partes: 1,
                    division_config: [],
                    items: items,
                    historial: [{
                        fecha: new Date().toISOString(),
                        accion: 'Orden creada',
                        detalle: `${items.length} variantes, ${totalUnidades} unidades, ${formatMoney(monto)}`
                    }]
                };

                const { error } = await supabase.from('ordenes').insert([orden]);
                if (error) throw error;

                ocultarLoading();
                toast(`Orden ${ordenId} creada exitosamente`, 'success');
                cerrarModal('modalCrearOrden');
                document.getElementById('ordenNombre').value = '';
                limpiarArchivo('fileOrden', 'fileOrdenInfo');
                document.getElementById('previewOrden').style.display = 'none';
                await cargarDatos();
            } catch (e) {
                ocultarLoading();
                toast('Error: ' + e.message, 'error');
                console.error(e);
            }
        }

        function abrirDividirOrden(id) {
            ordenActual = ordenes.find(o => o.id === id);
            if (!ordenActual) return;
            
            document.getElementById('divOrdenNombre').textContent = ordenActual.nombre;
            document.getElementById('divOrdenVariantes').textContent = ordenActual.total_variantes;
            document.getElementById('divOrdenUnidades').textContent = ordenActual.total_unidades?.toLocaleString();
            document.getElementById('numPartes').value = 1;
            generarPartesConfig();
            abrirModal('modalDividirOrden');
        }

        function generarPartesConfig() {
            const numPartes = parseInt(document.getElementById('numPartes').value) || 1;
            const unidadesTotal = ordenActual?.total_unidades || 0;
            
            let html = '';
            for (let i = 1; i <= numPartes; i++) {
                html += `
                    <div class="card" style="margin-bottom:1rem;padding:1rem">
                        <h4 style="margin-bottom:0.75rem">Parte ${i}</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Nombre</label>
                                <input type="text" class="form-input form-input-sm" id="parteNombre${i}" value="${ordenActual?.nombre || ''} PT${i}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Equipo Picking</label>
                                <select class="form-select form-input-sm" id="parteEquipoPicking${i}">
                                    <option value="">Sin asignar</option>
                                    ${equipos.filter(e => e.tipo === 'picking' && e.activo).map(e => `<option value="${e.id}">${e.nombre}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Equipo Packing</label>
                                <select class="form-select form-input-sm" id="parteEquipoPacking${i}">
                                    <option value="">Sin asignar</option>
                                    ${equipos.filter(e => e.tipo === 'packing' && e.activo).map(e => `<option value="${e.id}">${e.nombre}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                    </div>
                `;
            }
            document.getElementById('partesConfig').innerHTML = html;
        }

        async function confirmarDivision() {
            const numPartes = parseInt(document.getElementById('numPartes').value) || 1;
            mostrarLoading('Dividiendo orden...');

            try {
                const items = ordenActual.items || [];
                const itemsPorParte = Math.ceil(items.length / numPartes);
                const divisionConfig = [];

                for (let i = 0; i < numPartes; i++) {
                    const parteNum = i + 1;
                    const nombreParte = document.getElementById(`parteNombre${parteNum}`)?.value || `${ordenActual.nombre} PT${parteNum}`;
                    const equipoPickingId = document.getElementById(`parteEquipoPicking${parteNum}`)?.value || null;
                    const equipoPackingId = document.getElementById(`parteEquipoPacking${parteNum}`)?.value || null;
                    const equipoPicking = equipos.find(e => e.id == equipoPickingId);
                    const equipoPacking = equipos.find(e => e.id == equipoPackingId);

                    const itemsParte = items.slice(i * itemsPorParte, (i + 1) * itemsPorParte);
                    const totalSolicitado = itemsParte.reduce((s, it) => s + it.cantidad, 0);

                    const pickingData = {
                        orden_id: ordenActual.id,
                        parte: parteNum,
                        nombre_parte: nombreParte,
                        equipo_id: equipoPickingId ? parseInt(equipoPickingId) : null,
                        equipo_nombre: equipoPicking?.nombre || null,
                        integrantes: equipoPicking?.integrantes || [],
                        items_asignados: itemsParte,
                        items_encontrados: [],
                        total_solicitado: totalSolicitado,
                        total_encontrado: 0,
                        estado: 'Pendiente'
                    };

                    await supabase.from('picking').insert([pickingData]);

                    const packingData = {
                        orden_id: ordenActual.id,
                        parte: parteNum,
                        nombre_parte: nombreParte,
                        equipo_id: equipoPackingId ? parseInt(equipoPackingId) : null,
                        equipo_nombre: equipoPacking?.nombre || null,
                        integrantes: equipoPacking?.integrantes || [],
                        total_recibido: 0,
                        total_empacado: 0,
                        total_reclasificado: 0,
                        estado: 'Esperando Picking'
                    };

                    await supabase.from('packing').insert([packingData]);

                    divisionConfig.push({
                        parte: parteNum,
                        nombre: nombreParte,
                        items: itemsParte.length,
                        unidades: totalSolicitado,
                        equipoPicking: equipoPicking?.nombre || 'Sin asignar',
                        equipoPacking: equipoPacking?.nombre || 'Sin asignar'
                    });
                }

                const historial = ordenActual.historial || [];
                historial.push({
                    fecha: new Date().toISOString(),
                    accion: 'Orden dividida',
                    detalle: `Dividida en ${numPartes} partes`
                });

                await supabase.from('ordenes').update({
                    estado: 'Pendiente Picking',
                    partes: numPartes,
                    division_config: divisionConfig,
                    historial: historial
                }).eq('id', ordenActual.id);

                for (const item of items) {
                    const inv = inventario.find(i => i.variante === item.variante && i.ubicacion === item.ubicacion);
                    if (inv) {
                        await supabase.from('inventario').update({
                            stock_bloqueado: (parseInt(inv.stock_bloqueado) || 0) + item.cantidad
                        }).eq('variante', item.variante).eq('ubicacion', item.ubicacion);
                    }
                }

                ocultarLoading();
                toast('Orden dividida exitosamente', 'success');
                cerrarModal('modalDividirOrden');
                await cargarDatos();
            } catch (e) {
                ocultarLoading();
                toast('Error: ' + e.message, 'error');
                console.error(e);
            }
        }

        function verHistorialOrden(id) {
            ordenActual = ordenes.find(o => o.id === id);
            if (!ordenActual) return;
            
            // Guardar en variable global para cambiarTabHistorial
            ordenHistorialActual = ordenActual;

            const historial = ordenActual.historial || [];
            const noEncontrados = [];
            const reclasificados = [];
            
            // Extraer items no encontrados y reclasificados
            (ordenActual.items || []).forEach(item => {
                const pickings = picking.filter(p => p.orden_id === id && p.estado === 'Completado');
                let totalEncontrado = 0;
                pickings.forEach(p => {
                    const enc = (p.items_encontrados || []).find(e => e.variante === item.variante);
                    totalEncontrado += enc?.cantidad_encontrada || 0;
                });
                
                if (totalEncontrado < item.cantidad) {
                    noEncontrados.push({
                        variante: item.variante,
                        solicitado: item.cantidad,
                        encontrado: totalEncontrado,
                        faltante: item.cantidad - totalEncontrado
                    });
                }
            });

            const reclasItems = reclasificacion.filter(r => r.orden_id === id);
            reclasItems.forEach(r => {
                reclasificados.push({
                    variante: r.variante_original,
                    cantidad: r.cantidad,
                    motivo: r.motivo,
                    estado: r.estado
                });
            });

            let htmlTabs = `
                <div class="tabs">
                    <div class="tab active" data-tab="timeline" onclick="cambiarTabHistorial('timeline')">Timeline</div>
                    <div class="tab" data-tab="noEncontrados" onclick="cambiarTabHistorial('noEncontrados')">No Encontrados <span class="badge badge-warning">${noEncontrados.length}</span></div>
                    <div class="tab" data-tab="reclasificados" onclick="cambiarTabHistorial('reclasificados')">Reclasificados <span class="badge badge-purple">${reclasificados.length}</span></div>
                    <div class="tab" data-tab="items" onclick="cambiarTabHistorial('items')">Todos los Items</div>
                </div>
                <div id="historialContent"></div>
            `;

            document.getElementById('historialOrdenBody').innerHTML = htmlTabs;
            abrirModal('modalHistorialOrden');
            cambiarTabHistorial('timeline');
        }

        let tabHistorialActual = 'timeline';
        let ordenHistorialActual = null;
        
        function cambiarTabHistorial(tab) {
            tabHistorialActual = tab;
            document.querySelectorAll('#modalHistorialOrden .tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab);
            });

            if (!ordenHistorialActual) return;

            let html = '';
            
            if (tab === 'timeline') {
                const historial = ordenHistorialActual.historial || [];
                if (historial.length === 0) {
                    html = '<div style="text-align:center;padding:2rem;opacity:0.6">No hay historial registrado</div>';
                } else {
                    html = '<div class="timeline">';
                    historial.forEach(h => {
                        html += `
                            <div class="timeline-item">
                                <div class="timeline-date">${formatFechaHora(h.fecha)}</div>
                                <div class="timeline-title">${h.accion}</div>
                                <div class="timeline-desc">${h.detalle || ''}</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
            } else if (tab === 'noEncontrados') {
                const noEncontrados = [];
                (ordenHistorialActual.items || []).forEach(item => {
                    const pickings = picking.filter(p => p.orden_id === ordenHistorialActual.id && p.estado === 'Completado');
                    let totalEncontrado = 0;
                    pickings.forEach(p => {
                        const enc = (p.items_encontrados || []).find(e => e.variante === item.variante);
                        totalEncontrado += enc?.cantidad_encontrada || 0;
                    });
                    
                    if (totalEncontrado < item.cantidad) {
                        noEncontrados.push({
                            variante: item.variante,
                            solicitado: item.cantidad,
                            encontrado: totalEncontrado,
                            faltante: item.cantidad - totalEncontrado
                        });
                    }
                });

                if (noEncontrados.length === 0) {
                    html = '<div style="text-align:center;padding:2rem;opacity:0.6">‚úÖ Todos los items fueron encontrados</div>';
                } else {
                    html = `<div class="table-container"><table>
                        <thead><tr><th>Variante</th><th>Solicitado</th><th>Encontrado</th><th>Faltante</th></tr></thead>
                        <tbody>`;
                    noEncontrados.forEach(i => {
                        html += `<tr>
                            <td><strong>${i.variante}</strong></td>
                            <td>${i.solicitado}</td>
                            <td style="color:var(--warning)">${i.encontrado}</td>
                            <td style="color:var(--danger)"><strong>${i.faltante}</strong></td>
                        </tr>`;
                    });
                    html += '</tbody></table></div>';
                }
            } else if (tab === 'reclasificados') {
                const reclasItems = reclasificacion.filter(r => r.orden_id === ordenHistorialActual.id);
                if (reclasItems.length === 0) {
                    html = '<div style="text-align:center;padding:2rem;opacity:0.6">Sin items reclasificados</div>';
                } else {
                    html = `<div class="table-container"><table>
                        <thead><tr><th>Variante</th><th>Cantidad</th><th>Motivo</th><th>Estado</th></tr></thead>
                        <tbody>`;
                    reclasItems.forEach(r => {
                        html += `<tr>
                            <td><strong>${r.variante_original}</strong></td>
                            <td>${r.cantidad}</td>
                            <td><span class="badge badge-purple">${r.motivo}</span></td>
                            <td>${getBadge(r.estado)}</td>
                        </tr>`;
                    });
                    html += '</tbody></table></div>';
                }
            } else if (tab === 'items') {
                html = `<div class="table-container"><table>
                    <thead><tr><th>Variante</th><th>Ubicaci√≥n</th><th>Cantidad</th><th>Distribuci√≥n</th></tr></thead>
                    <tbody>`;
                (ordenHistorialActual.items || []).forEach(i => {
                    const distStr = Object.entries(i.distribucion || {}).map(([t, c]) => `${t}: ${c}`).join(', ');
                    html += `<tr>
                        <td><strong>${i.variante}</strong></td>
                        <td><span class="badge badge-info">${i.ubicacion || '-'}</span></td>
                        <td>${i.cantidad}</td>
                        <td class="td-wrap" style="max-width:300px">${distStr || '-'}</td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
            }

            document.getElementById('historialContent').innerHTML = html;
            renderIcons();
        }

        async function eliminarOrden(id) {
            const orden = ordenes.find(o => o.id === id);
            if (!orden) return;
            
            // Validar permisos para eliminar √≥rdenes completadas
            // Solo Jefe de Almac√©n y Jefes pueden eliminar completadas
            if (orden.estado === 'Completada') {
                if (![ROLES.JEFE_ALMACEN, ROLES.JEFES].includes(usuarioActual.rol)) {
                    toast('‚ùå Solo el Jefe de Almac√©n o Jefes pueden eliminar √≥rdenes completadas', 'error');
                    return;
                }
            }
            
            if (!confirm('¬øEliminar esta orden?')) return;
            mostrarLoading('Eliminando...');
            
            if (orden?.items) {
                for (const item of orden.items) {
                    const inv = inventario.find(i => i.variante === item.variante && i.ubicacion === item.ubicacion);
                    if (inv) {
                        await supabase.from('inventario').update({
                            stock_bloqueado: Math.max(0, (parseInt(inv.stock_bloqueado) || 0) - item.cantidad)
                        }).eq('variante', item.variante).eq('ubicacion', item.ubicacion);
                    }
                }
            }

            await supabase.from('picking').delete().eq('orden_id', id);
            await supabase.from('packing').delete().eq('orden_id', id);
            await supabase.from('ordenes').delete().eq('id', id);
            
            ocultarLoading();
            toast('Orden eliminada', 'success');
            await cargarDatos();
        }

        // ============================================
        // PICKING
        // ============================================
        let tabPickingActual = 'activos';
        
        function cambiarTabPicking(tab) {
            tabPickingActual = tab;
            document.querySelectorAll('#tabsPicking .tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`#tabsPicking .tab[data-tab="${tab}"]`).classList.add('active');
            renderizarPicking();
        }

        function renderizarPicking() {
            verificarHorarioLaboral();
            
            let pickingMostrar;
            if (tabPickingActual === 'activos') {
                pickingMostrar = picking.filter(p => ['Pendiente', 'En Proceso', 'Pausado'].includes(p.estado));
            } else {
                pickingMostrar = picking.filter(p => p.estado === 'Completado');
            }
            
            document.getElementById('tablaPicking').innerHTML = pickingMostrar.length === 0
                ? `<tr><td colspan="8" class="empty-state">No hay tareas de picking ${tabPickingActual === 'activos' ? 'pendientes' : 'en historial'}</td></tr>`
                : pickingMostrar.map(p => {
                    const orden = ordenes.find(o => o.id === p.orden_id);
                    const tiempoStr = calcularTiempoTrabajado(p);
                    return `<tr>
                        <td><strong>${orden?.nombre || p.orden_id}</strong></td>
                        <td><span class="badge badge-purple">PT${p.parte}</span></td>
                        <td>${p.equipo_nombre || '<span style="color:var(--warning)">Sin asignar</span>'}</td>
                        <td>${p.total_solicitado || 0}</td>
                        <td>${p.total_encontrado || 0}</td>
                        <td>${tiempoStr}</td>
                        <td>${getBadge(p.estado)}</td>
                        <td style="white-space:nowrap">
                            <button class="btn btn-info btn-icon btn-sm" onclick="descargarHojaPicking(${p.id})" title='Descargar Hoja'><i data-lucide="download" style="width:14px;height:14px"></i></button>
                            ${p.estado === 'Pendiente' ? `<button class="btn btn-success btn-sm" onclick="iniciarPicking(${p.id})"><i data-lucide="play" style="width:12px;height:12px"></i> Iniciar</button>` : ''}
                            ${p.estado === 'En Proceso' ? `
                                <button class="btn btn-warning btn-sm" onclick="pausarPicking(${p.id})" title='Pausar'><i data-lucide="pause" style="width:12px;height:12px"></i></button>
                                <button class="btn btn-success btn-sm" onclick="abrirSubirCantidadesPicking(${p.id})"><i data-lucide="upload" style="width:12px;height:12px"></i> Subir</button>
                            ` : ''}
                            ${p.estado === 'Pausado' ? `<button class="btn btn-success btn-sm" onclick="reanudarPicking(${p.id})"><i data-lucide="play" style="width:12px;height:12px"></i> Reanudar</button>` : ''}
                            ${p.estado === 'Completado' ? `<button class="btn btn-purple btn-icon btn-sm" onclick="verDetallePicking(${p.id})" title='Ver Detalle'><i data-lucide="eye" style="width:14px;height:14px"></i></button>` : ''}
                        </td>
                    </tr>`;
                }).join('');
            renderIcons();
        }

        function calcularTiempoTrabajado(registro) {
            if (!registro.fecha_inicio) return '-';
            
            let tiempoTotal = registro.tiempo_minutos || 0;
            
            if (registro.estado === 'En Proceso' && registro.fecha_inicio) {
                const ahora = new Date();
                const inicio = new Date(registro.fecha_inicio);
                tiempoTotal += Math.round((ahora - inicio) / 60000);
            }
            
            if (tiempoTotal < 60) return `${tiempoTotal} min`;
            return `${Math.floor(tiempoTotal / 60)}h ${tiempoTotal % 60}m`;
        }

        function verificarHorarioLaboral() {
            const ahora = new Date();
            const hora = ahora.getHours();
            const minutos = ahora.getMinutes();
            const tiempoActual = hora * 60 + minutos;
            
            const horaInicio = 8 * 60 + 30;
            const horaFin = 19 * 60;
            
            const alertaEl = document.getElementById('alertaHorario');
            if (alertaEl) {
                if (tiempoActual < horaInicio) {
                    alertaEl.style.display = 'flex';
                    document.getElementById('alertaHorarioTexto').innerHTML = `‚è∞ Fuera de horario. El turno inicia a las 8:30 AM`;
                } else if (tiempoActual >= horaFin) {
                    alertaEl.style.display = 'flex';
                    document.getElementById('alertaHorarioTexto').innerHTML = `‚è∞ Fin de jornada. Recuerda pausar las tareas activas`;
                } else {
                    alertaEl.style.display = 'none';
                }
            }
        }

        async function iniciarPicking(id) {
            mostrarLoading('Iniciando picking...');
            await supabase.from('picking').update({ 
                estado: 'En Proceso',
                fecha_inicio: new Date().toISOString()
            }).eq('id', id);
            
            const pick = picking.find(p => p.id === id);
            if (pick) {
                const orden = ordenes.find(o => o.id === pick.orden_id);
                if (orden) {
                    const historial = orden.historial || [];
                    historial.push({
                        fecha: new Date().toISOString(),
                        accion: `Picking Parte ${pick.parte} iniciado`,
                        detalle: `Equipo: ${pick.equipo_nombre || 'Sin asignar'}`
                    });
                    await supabase.from('ordenes').update({ historial, estado: 'En Picking' }).eq('id', orden.id);
                }
            }
            
            ocultarLoading();
            toast('Picking iniciado', 'success');
            await cargarDatos();
        }

        async function pausarPicking(id) {
            mostrarLoading('Pausando...');
            const pick = picking.find(p => p.id === id);
            if (pick && pick.fecha_inicio) {
                const tiempoAcumulado = (pick.tiempo_minutos || 0) + Math.round((new Date() - new Date(pick.fecha_inicio)) / 60000);
                await supabase.from('picking').update({ 
                    estado: 'Pausado',
                    tiempo_minutos: tiempoAcumulado,
                    fecha_inicio: null
                }).eq('id', id);
            }
            ocultarLoading();
            toast('Picking pausado', 'info');
            await cargarDatos();
        }

        async function reanudarPicking(id) {
            mostrarLoading('Reanudando...');
            await supabase.from('picking').update({ 
                estado: 'En Proceso',
                fecha_inicio: new Date().toISOString()
            }).eq('id', id);
            ocultarLoading();
            toast('Picking reanudado', 'success');
            await cargarDatos();
        }

        function verDetallePicking(id) {
            const pick = picking.find(p => p.id === id);
            if (!pick) return;
            
            const orden = ordenes.find(o => o.id === pick.orden_id);
            const equipo = equipos.find(e => e.id === pick.equipo_id);
            const encontrados = pick.items_encontrados || [];
            const asignados = pick.items_asignados || [];
            
            // Generar lista de integrantes del equipo
            let equipoHTML = pick.equipo_nombre || '-';
            if (equipo && equipo.integrantes && equipo.integrantes.length > 0) {
                const miembros = equipo.integrantes.map(m => `<div style="font-size:0.85rem;color:#64748b;margin-left:0.5rem;display:flex;align-items:center;gap:0.25rem"><i data-lucide="user" style="width:12px;height:12px"></i> ${m}</div>`).join('');
                equipoHTML = `<div><strong>${pick.equipo_nombre}</strong>${miembros}</div>`;
            }
            
            let html = `
                <div class="detail-grid" style="margin-bottom:1rem">
                    <div class="detail-item"><div class="detail-label">Orden</div><div class="detail-value">${orden?.nombre || pick.orden_id}</div></div>
                    <div class="detail-item"><div class="detail-label">Parte</div><div class="detail-value">PT${pick.parte}</div></div>
                    <div class="detail-item"><div class="detail-label">üë• Equipo</div><div class="detail-value">${equipoHTML}</div></div>
                    <div class="detail-item"><div class="detail-label">Tiempo</div><div class="detail-value">${calcularTiempoTrabajado(pick)}</div></div>
                    <div class="detail-item"><div class="detail-label">Solicitado</div><div class="detail-value">${pick.total_solicitado}</div></div>
                    <div class="detail-item"><div class="detail-label">Encontrado</div><div class="detail-value" style="color:var(--success)">${pick.total_encontrado}</div></div>
                </div>
                <h4 style="margin:1rem 0">Items Encontrados</h4>
                <div class="table-container" style="max-height:300px">
                    <table>
                        <thead><tr><th>Variante</th><th>Solicitado</th><th>Encontrado</th><th>Diferencia</th></tr></thead>
                        <tbody>
                            ${asignados.map(a => {
                                const enc = encontrados.find(e => e.variante === a.variante);
                                const cantEnc = enc?.cantidad_encontrada || 0;
                                const diff = cantEnc - a.cantidad;
                                return `<tr>
                                    <td><strong>${a.variante}</strong></td>
                                    <td>${a.cantidad}</td>
                                    <td style="color:var(--success)">${cantEnc}</td>
                                    <td style="color:${diff >= 0 ? 'var(--success)' : 'var(--danger)'}">${diff >= 0 ? '+' : ''}${diff}</td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('pickingContent').innerHTML = html;
            document.getElementById('pickingFooter').innerHTML = '<button class="btn btn-outline" onclick="cerrarModal(\'modalPicking\')">Cerrar</button>';
            document.getElementById('tituloModalPicking').textContent = 'Detalle de Picking';
            abrirModal('modalPicking');
            renderIcons();
        }

        function exportarHistorialPicking() {
            const completados = picking.filter(p => p.estado === 'Completado');
            if (!completados.length) { toast('No hay historial', 'warning'); return; }
            
            const data = completados.map(p => {
                const orden = ordenes.find(o => o.id === p.orden_id);
                return {
                    Orden: orden?.nombre || p.orden_id,
                    Parte: `PT${p.parte}`,
                    Equipo: p.equipo_nombre || '',
                    Integrantes: (p.integrantes || []).join(', '),
                    Solicitado: p.total_solicitado,
                    Encontrado: p.total_encontrado,
                    TiempoMinutos: p.tiempo_minutos,
                    FechaInicio: formatFechaHora(p.fecha_inicio),
                    FechaFin: formatFechaHora(p.fecha_fin)
                };
            });
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'HistorialPicking');
            XLSX.writeFile(wb, `Historial_Picking_${new Date().toISOString().split('T')[0]}.xlsx`);
            toast('Historial exportado', 'success');
        }

        function descargarHojaPicking(id) {
            const pick = picking.find(p => p.id === id);
            if (!pick) {
                toast('Error: Picking no encontrado', 'error');
                return;
            }
            
            if (!pick.items_asignados || pick.items_asignados.length === 0) {
                toast('Error: No hay items asignados para descargar', 'error');
                return;
            }
            
            const orden = ordenes.find(o => o.id === pick.orden_id);

            const data = (pick.items_asignados || []).map(i => {
                const prod = productos.find(p => p.variante === i.variante);
                const inv = inventario.find(inv => inv.variante === i.variante && inv.ubicacion === i.ubicacion);
                
                return {
                    // ORDEN (solo parte)
                    'Parte': `PT${pick.parte}`,
                    
                    // INVENTARIO
                    'Ubicaci√≥n': i.ubicacion || '',
                    'Stock F√≠sico': inv?.stock_fisico || 0,
                    'Stock Bloqueado': inv?.stock_bloqueado || 0,
                    'Stock Disponible': (inv?.stock_fisico || 0) - (inv?.stock_bloqueado || 0),
                    
                    // PRODUCTO
                    'Variante': i.variante,
                    'C√≥digo Comercial': prod?.codigo_comercial || '',
                    'Descripci√≥n': prod?.descripcion || '',
                    'Marca': prod?.marca || '',
                    'G√©nero': prod?.genero || '',
                    'L√≠nea': prod?.linea || '',
                    'Talla': prod?.talla || '',
                    'Color': prod?.color || '',
                    'Kardex': prod?.kardex || 0,
                    'PVP': prod?.pvp || 0,
                    'PVP Regular': prod?.pvp_regular || 0,
                    
                    // CANTIDADES
                    'Solicitado': i.cantidad,
                    'Encontrado': ''
                };
            });

            if (data.length === 0) {
                toast('Error: No hay datos para descargar', 'error');
                return;
            }

            // Ordenar por ubicaci√≥n
            data.sort((a, b) => (a['Ubicaci√≥n'] || '').localeCompare(b['Ubicaci√≥n'] || ''));

            const ws = XLSX.utils.json_to_sheet(data);
            
            // Ajustar anchos
            ws['!cols'] = [
                {wch: 8},  // Parte
                {wch: 15}, // Ubicaci√≥n
                {wch: 12}, // Stock F√≠sico
                {wch: 15}, // Stock Bloqueado
                {wch: 18}, // Stock Disponible
                {wch: 15}, // Variante
                {wch: 15}, // C√≥digo Comercial
                {wch: 40}, // Descripci√≥n
                {wch: 15}, // Marca
                {wch: 10}, // G√©nero
                {wch: 15}, // L√≠nea
                {wch: 8},  // Talla
                {wch: 12}, // Color
                {wch: 8},  // Kardex
                {wch: 10}, // PVP
                {wch: 12}, // PVP Regular
                {wch: 10}, // Solicitado
                {wch: 12}  // Encontrado
            ];
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'HojaPicking');
            const filename = `Picking_${orden?.nombre || pick.orden_id}_PT${pick.parte}.xlsx`;
            
            try {
                XLSX.writeFile(wb, filename);
                console.log('‚úÖ Archivo descargado:', filename);
                toast('‚úÖ Hoja descargada exitosamente', 'success');
            } catch (e) {
                console.error('‚ùå Error al descargar:', e);
                toast('Error al descargar: ' + e.message, 'error');
            }
        }

        function abrirSubirCantidadesPicking(id) {
            pickingActual = picking.find(p => p.id === id);
            abrirModal('modalSubirCantidades');
        }

        async function confirmarSubirCantidades() {
            const file = document.getElementById('fileCantidades').files[0];
            if (!file) { toast('Selecciona un archivo', 'error'); return; }
            if (!pickingActual) return;

            mostrarLoading('Procesando...');
            try {
                const data = await leerExcel(file);
                const itemsEncontrados = [];
                let totalEncontrado = 0;
                let montoEncontrado = 0;

                data.forEach(r => {
                    const v = normalizarTexto(getCol(r, ['variante', 'Variante']));
                    const u = normalizarTexto(getCol(r, ['ubicacion', 'Ubicacion']));
                    const enc = parseInt(getCol(r, ['encontrado', 'Encontrado', 'ENCONTRADO'])) || 0;
                    
                    if (v && enc > 0) {
                        const prod = productos.find(p => p.variante === v);
                        itemsEncontrados.push({
                            variante: v,
                            ubicacion: u,
                            cantidad_encontrada: enc,
                            kardex: prod?.kardex || 0
                        });
                        totalEncontrado += enc;
                        montoEncontrado += (prod?.kardex || 0) * enc;
                    }
                });

                const fechaFin = new Date();
                const fechaInicio = new Date(pickingActual.fecha_inicio);
                const tiempoMinutos = Math.round((fechaFin - fechaInicio) / 60000);

                await supabase.from('picking').update({
                    items_encontrados: itemsEncontrados,
                    total_encontrado: totalEncontrado,
                    fecha_fin: fechaFin.toISOString(),
                    tiempo_minutos: tiempoMinutos,
                    estado: 'Completado'
                }).eq('id', pickingActual.id);

                await supabase.from('packing').update({
                    items_recibidos: itemsEncontrados,
                    total_recibido: totalEncontrado,
                    estado: 'Pendiente'
                }).eq('orden_id', pickingActual.orden_id).eq('parte', pickingActual.parte);

                const orden = ordenes.find(o => o.id === pickingActual.orden_id);
                if (orden) {
                    const historial = orden.historial || [];
                    historial.push({
                        fecha: fechaFin.toISOString(),
                        accion: `Picking Parte ${pickingActual.parte} completado`,
                        detalle: `${totalEncontrado} unidades encontradas en ${tiempoMinutos} min`
                    });

                    await supabase.from('ordenes').update({
                        unidades_encontradas: (orden.unidades_encontradas || 0) + totalEncontrado,
                        monto_picking: (parseFloat(orden.monto_picking) || 0) + montoEncontrado,
                        historial: historial
                    }).eq('id', orden.id);

                    const pickingsOrden = picking.filter(p => p.orden_id === orden.id);
                    const todosCompletados = pickingsOrden.every(p => p.id === pickingActual.id || p.estado === 'Completado');
                    if (todosCompletados) {
                        await supabase.from('ordenes').update({
                            estado: 'Pendiente Packing',
                            fecha_fin_picking: fechaFin.toISOString()
                        }).eq('id', orden.id);
                    }
                }

                ocultarLoading();
                toast('Picking completado', 'success');
                cerrarModal('modalSubirCantidades');
                limpiarArchivo('fileCantidades', 'fileCantidadesInfo');
                await cargarDatos();
            } catch (e) {
                ocultarLoading();
                toast('Error: ' + e.message, 'error');
            }
        }

        // ============================================
        // PACKING
        // ============================================
        let tabPackingActual = 'activos';
        
        function cambiarTabPacking(tab) {
            tabPackingActual = tab;
            document.querySelectorAll('#tabsPacking .tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`#tabsPacking .tab[data-tab="${tab}"]`).classList.add('active');
            
            // Mostrar/ocultar filtros seg√∫n el tab
            const filtros = document.getElementById('filtrosPackingHistorial');
            if (filtros) {
                filtros.style.display = tab === 'historial' ? 'block' : 'none';
            }
            
            renderizarPacking();
        }
        
        // √ìRDENES - TABS
        // ============================================
        let tabOrdenActual = 'activas';
        
        function cambiarTabOrden(tab) {
            tabOrdenActual = tab;
            
            // Cambiar clases activas de los tabs usando data-tab
            document.querySelectorAll('#tabsOrdenes .tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab);
            });
            
            // Mostrar/ocultar filtros seg√∫n el tab
            const filtrosActivas = document.getElementById('filtrosOrdenActivas');
            const filtrosHistorial = document.getElementById('filtrosOrdenHistorial');
            
            if (filtrosActivas && filtrosHistorial) {
                filtrosActivas.style.display = tab === 'activas' ? 'flex' : 'none';
                filtrosHistorial.style.display = tab === 'historial' ? 'block' : 'none';
            }
            
            // Limpiar filtros al cambiar de tab
            if (tab === 'activas') {
                document.getElementById('searchOrdenes').value = '';
                document.getElementById('filtroEstadoOrden').value = '';
            } else {
                document.getElementById('buscarOrdenHistorial').value = '';
                document.getElementById('filtroFechaDesdeOrden').value = '';
                document.getElementById('filtroFechaHastaOrden').value = '';
                document.getElementById('filtroEquipoOrden').value = '';
            }
            
            filtrarOrdenes();
        }
        
        function limpiarFiltrosOrden() {
            document.getElementById('buscarOrdenHistorial').value = '';
            document.getElementById('filtroFechaDesdeOrden').value = '';
            document.getElementById('filtroFechaHastaOrden').value = '';
            document.getElementById('filtroEquipoOrden').value = '';
            filtrarOrdenes();
        }

        function renderizarPacking() {
            let packingMostrar;
            if (tabPackingActual === 'activos') {
                packingMostrar = packing.filter(p => ['Pendiente', 'En Proceso', 'Pausado', 'Esperando Picking'].includes(p.estado));
            } else {
                // Aplicar filtros en historial
                packingMostrar = packing.filter(p => p.estado === 'Completado');
                
                // Filtrar por b√∫squeda de orden
                const busqueda = document.getElementById('buscarOrdenPacking')?.value.toLowerCase() || '';
                if (busqueda) {
                    packingMostrar = packingMostrar.filter(p => {
                        const orden = ordenes.find(o => o.id === p.orden_id);
                        return orden?.nombre.toLowerCase().includes(busqueda);
                    });
                }
                
                // Filtrar por fecha desde
                const desde = document.getElementById('filtroFechaDesde')?.value;
                if (desde) {
                    packingMostrar = packingMostrar.filter(p => {
                        const fechaFin = p.fecha_completado || p.fecha_fin;
                        return fechaFin && new Date(fechaFin) >= new Date(desde);
                    });
                }
                
                // Filtrar por fecha hasta
                const hasta = document.getElementById('filtroFechaHasta')?.value;
                if (hasta) {
                    packingMostrar = packingMostrar.filter(p => {
                        const fechaFin = p.fecha_completado || p.fecha_fin;
                        return fechaFin && new Date(fechaFin) <= new Date(hasta + 'T23:59:59');
                    });
                }
            }
            
            document.getElementById('tablaPacking').innerHTML = packingMostrar.length === 0
                ? `<tr><td colspan="9" class="empty-state">No hay tareas de packing ${tabPackingActual === 'activos' ? 'pendientes' : 'en historial'}</td></tr>`
                : packingMostrar.map(p => {
                    const orden = ordenes.find(o => o.id === p.orden_id);
                    const tiempoStr = calcularTiempoTrabajado(p);
                    return `<tr>
                        <td><strong>${orden?.nombre || p.orden_id}</strong></td>
                        <td><span class="badge badge-purple">PT${p.parte}</span></td>
                        <td>${p.equipo_nombre || '<span style="color:var(--warning)">Sin asignar</span>'}</td>
                        <td>${p.total_recibido || 0}</td>
                        <td style="color:var(--success)">${p.total_empacado || 0}</td>
                        <td style="color:var(--warning)">${p.total_reclasificado || 0}</td>
                        <td>${tiempoStr}</td>
                        <td>${getBadge(p.estado)}</td>
                        <td style="white-space:nowrap">
                            <button class="btn btn-info btn-icon btn-sm" onclick="descargarHojaPacking(${p.id})" title='Descargar Hoja'><i data-lucide="download" style="width:14px;height:14px"></i></button>
                            ${p.estado === 'Esperando Picking' ? '<span class="badge badge-purple">Esperando</span>' : ''}
                            ${p.estado === 'Pendiente' ? `<button class="btn btn-success btn-sm" onclick="iniciarPacking(${p.id})"><i data-lucide="play" style="width:12px;height:12px"></i> Iniciar</button>` : ''}
                            ${p.estado === 'En Proceso' ? `
                                <button class="btn btn-warning btn-sm" onclick="pausarPacking(${p.id})" title='Pausar'><i data-lucide="pause" style="width:12px;height:12px"></i></button>
                                <button class="btn btn-purple btn-sm" onclick="abrirSubirDistribucion(${p.id})"><i data-lucide="upload" style="width:12px;height:12px"></i> Subir</button>
                                <button class="btn btn-success btn-sm" onclick="completarPacking(${p.id})"><i data-lucide="check" style="width:12px;height:12px"></i></button>
                            ` : ''}
                            ${p.estado === 'Pausado' ? `<button class="btn btn-success btn-sm" onclick="reanudarPacking(${p.id})"><i data-lucide="play" style="width:12px;height:12px"></i> Reanudar</button>` : ''}
                            ${p.estado === 'Completado' ? `<button class="btn btn-purple btn-icon btn-sm" onclick="verDetallePacking(${p.id})" title='Ver Detalle'><i data-lucide="eye" style="width:14px;height:14px"></i></button>` : ''}
                        </td>
                    </tr>`;
                }).join('');
            renderIcons();
        }
        
        // üîç Funci√≥n para filtrar historial de packing
        function filtrarHistorialPacking() {
            renderizarPacking();
        }

        async function iniciarPacking(id) {
            mostrarLoading('Iniciando packing...');
            await supabase.from('packing').update({ 
                estado: 'En Proceso',
                fecha_inicio: new Date().toISOString()
            }).eq('id', id);
            
            const pack = packing.find(p => p.id === id);
            if (pack) {
                const orden = ordenes.find(o => o.id === pack.orden_id);
                if (orden) {
                    const historial = orden.historial || [];
                    historial.push({
                        fecha: new Date().toISOString(),
                        accion: `Packing Parte ${pack.parte} iniciado`,
                        detalle: `Equipo: ${pack.equipo_nombre || 'Sin asignar'}`
                    });
                    await supabase.from('ordenes').update({ historial, estado: 'En Packing' }).eq('id', orden.id);
                }
            }
            
            ocultarLoading();
            toast('Packing iniciado', 'success');
            await cargarDatos();
        }

        async function pausarPacking(id) {
            mostrarLoading('Pausando...');
            const pack = packing.find(p => p.id === id);
            if (pack && pack.fecha_inicio) {
                const tiempoAcumulado = (pack.tiempo_minutos || 0) + Math.round((new Date() - new Date(pack.fecha_inicio)) / 60000);
                await supabase.from('packing').update({ 
                    estado: 'Pausado',
                    tiempo_minutos: tiempoAcumulado,
                    fecha_inicio: null
                }).eq('id', id);
            }
            ocultarLoading();
            toast('Packing pausado', 'info');
            await cargarDatos();
        }

        async function reanudarPacking(id) {
            mostrarLoading('Reanudando...');
            await supabase.from('packing').update({ 
                estado: 'En Proceso',
                fecha_inicio: new Date().toISOString()
            }).eq('id', id);
            ocultarLoading();
            toast('Packing reanudado', 'success');
            await cargarDatos();
        }

        function abrirSubirDistribucion(id) {
            packingActual = packing.find(p => p.id === id);
            if (!packingActual) return;
            
            const contentHTML = [
                '<div class="alert alert-info" style="margin-bottom:1rem">',
                '    <div style="display:flex;align-items:start;gap:0.75rem">',
                '        <i data-lucide="info" style="width:20px;height:20px;flex-shrink:0;margin-top:2px"></i>',
                '        <div style="flex:1">',
                '            <strong>üìã Columnas requeridas:</strong>',
                '            <div style="margin-top:0.5rem;display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:0.5rem;font-size:0.85rem">',
                '                <div><code style="background:rgba(0,0,0,0.05);padding:2px 6px;border-radius:4px;color:#dc2626;font-weight:600">Variante</code></div>',
                '                <div><code style="background:rgba(0,0,0,0.05);padding:2px 6px;border-radius:4px;color:#dc2626;font-weight:600">Encontrado</code></div>',
                '                <div><code style="background:rgba(0,0,0,0.05);padding:2px 6px;border-radius:4px;color:#2563eb;font-weight:600">Unificar</code> <span style="font-size:0.75rem;color:#64748b">(opcional, solo Cubito)</span></div>',
                '            </div>',
                '            <div style="margin-top:0.75rem">',
                '                <strong>Columnas de tiendas:</strong>',
                '                <div style="margin-top:0.5rem;font-size:0.82rem">EL SOL, TRU PIZARRO, LA MARINA, PROLONGACI√ìN IQUITOS, CHI P. RUIZ, TARAPOTO, MENDIOLA, ALFONSO UGARTE, IQT LORES, JR UNION</div>',
                '            </div>',
                '            <div style="margin-top:0.75rem;padding:0.75rem;background:#dbeafe;border-radius:6px;font-size:0.82rem">',
                '                <strong style="color:#1e40af">‚ÑπÔ∏è Columna Unificar:</strong><br>',
                '                <span style="color:#1e40af">Si una variante tiene valor en "Unificar", esa ser√° la variante que aparecer√° en los registros SAP del Cubito. Las variantes sin unificar mantendr√°n su variante original.</span>',
                '            </div>',
                '        </div>',
                '    </div>',
                '</div>',
                '<div class="form-group">',
                '    <input type="file" id="fileDistribucion" class="form-file" accept=".xlsx,.xls">',
                '    <label for="fileDistribucion" class="file-upload-btn"><i data-lucide="file-plus" style="width:16px;height:16px"></i> Seleccionar archivo</label>',
                '    <div class="file-selected" id="fileDistribucionInfo" style="display:none">',
                '        <div class="file-selected-icon"><i data-lucide="check" style="width:14px;height:14px"></i></div>',
                '        <span class="file-selected-name"></span>',
                '        <button class="file-selected-remove" type="button"><i data-lucide="x" style="width:16px;height:16px"></i></button>',
                '    </div>',
                '</div>'
            ].join('');
            
            document.getElementById('packingContent').innerHTML = contentHTML;
            
            setTimeout(() => {
                const fileInput = document.getElementById('fileDistribucion');
                const btnRemove = document.querySelector('#fileDistribucionInfo .file-selected-remove');
                
                if (fileInput) {
                    fileInput.addEventListener('change', function() {
                        mostrarArchivoSeleccionado(this, 'fileDistribucionInfo');
                    });
                }
                
                if (btnRemove) {
                    btnRemove.addEventListener('click', function() {
                        limpiarArchivo('fileDistribucion', 'fileDistribucionInfo');
                    });
                }
            }, 100);
            
            document.getElementById('packingFooter').innerHTML = '<button class="btn btn-outline" id="btnCancelPacking">Cancelar</button><button class="btn btn-primary" id="btnProcessDist">Procesar</button>';
            
            setTimeout(() => {
                const btnCancel = document.getElementById('btnCancelPacking');
                const btnProcess = document.getElementById('btnProcessDist');
                
                if (btnCancel) btnCancel.addEventListener('click', () => cerrarModal('modalPacking'));
                if (btnProcess) btnProcess.addEventListener('click', procesarDistribucion);
            }, 100);
            
            document.getElementById('tituloModalPacking').textContent = 'Subir Distribuci√≥n';
            abrirModal('modalPacking');
            renderIcons();
        }


        async function procesarDistribucion() {
            const file = document.getElementById('fileDistribucion')?.files[0];
            if (!file) { toast('Selecciona un archivo', 'error'); return; }
            if (!packingActual) return;

            mostrarLoading('Procesando distribuci√≥n...');
            try {
                const data = await leerExcel(file);
                let totalEmpacado = 0;
                let totalReclas = 0;
                const itemsEmpacados = [];
                const itemsReclas = [];

                data.forEach(r => {
                    const v = normalizarTexto(getCol(r, ['variante', 'Variante']));
                    if (!v) return;

                    // üîÑ NUEVO: Capturar columna Unificar (solo para Cubito)
                    const unificar = normalizarTexto(getCol(r, ['unificar', 'Unificar', 'UNIFICAR']));

                    const dist = buscarTienda(r);
                    const cantEmpacada = Object.values(dist).reduce((a, b) => a + b, 0);
                    const recibido = packingActual.items_recibidos?.find(i => i.variante === v);
                    const cantRecibida = recibido?.cantidad_encontrada || 0;
                    const diferencia = cantRecibida - cantEmpacada;

                    if (cantEmpacada > 0) {
                        itemsEmpacados.push({ 
                            variante: v,                    // Variante original (para Packing)
                            variante_unificada: unificar,   // Variante unificada (solo para Cubito)
                            cantidad: cantEmpacada, 
                            distribucion: dist 
                        });
                        totalEmpacado += cantEmpacada;
                        
                        // Log para debugging
                        if (unificar) {
                            console.log(`üîÑ ${v} ‚Üí ${unificar} (unificada para Cubito)`);
                        }
                    }

                    if (diferencia > 0) {
                        const prod = productos.find(p => p.variante === v);
                        itemsReclas.push({
                            orden_id: packingActual.orden_id,
                            packing_id: packingActual.id,
                            variante_original: v,
                            cantidad: diferencia,
                            motivo: 'No empacado',
                            estado: 'Pendiente',
                            fecha: new Date().toISOString(),
                            info_variante: { descripcion: prod?.descripcion, genero: prod?.genero, talla: prod?.talla }
                        });
                        totalReclas += diferencia;
                    }
                });

                await supabase.from('packing').update({
                    items_empacados: itemsEmpacados,
                    total_empacado: totalEmpacado,
                    total_reclasificado: totalReclas,
                    distribucion_tiendas: itemsEmpacados.reduce((acc, i) => {
                        Object.entries(i.distribucion).forEach(([t, c]) => {
                            acc[t] = (acc[t] || 0) + c;
                        });
                        return acc;
                    }, {})
                }).eq('id', packingActual.id);

                if (itemsReclas.length > 0) {
                    await supabase.from('reclasificacion').insert(itemsReclas);
                }

                ocultarLoading();
                toast(`Procesado: ${totalEmpacado} empacadas, ${totalReclas} a reclasificaci√≥n`, 'success');
                cerrarModal('modalPacking');
                await cargarDatos();
            } catch (e) {
                ocultarLoading();
                toast('Error: ' + e.message, 'error');
            }
        }

        function filtrarHistorialPacking() {
            renderizarPacking();
        }

        function limpiarFiltrosPacking() {
            document.getElementById('buscarOrdenPacking').value = '';
            document.getElementById('filtroFechaDesde').value = '';
            document.getElementById('filtroFechaHasta').value = '';
            renderizarPacking();
        }

        async function completarPacking(id) {
            const pack = packing.find(p => p.id === id);
            if (!pack) return;

            // Detectar productos NO EMPACADOS (encontrados en picking pero no empacados)
            const pickingRelacionado = picking.find(p => p.orden_id === pack.orden_id && p.parte === pack.parte);
            const productosNoEmpacados = [];
            
            if (pickingRelacionado && pickingRelacionado.items) {
                pickingRelacionado.items.forEach(itemPicking => {
                    const cantidadEncontrada = itemPicking.cantidad_encontrada || 0;
                    
                    // Buscar cu√°nto se empac√≥ de esta variante
                    const itemEmpacado = (pack.items_empacados || []).find(e => e.variante === itemPicking.variante);
                    const cantidadEmpacada = itemEmpacado ? itemEmpacado.cantidad : 0;
                    
                    // Si hay diferencia, se debe reclasificar
                    const diferencia = cantidadEncontrada - cantidadEmpacada;
                    
                    if (diferencia > 0) {
                        const prod = productos.find(p => p.variante === itemPicking.variante);
                        productosNoEmpacados.push({
                            variante: itemPicking.variante,
                            descripcion: prod?.descripcion || 'Sin descripci√≥n',
                            cantidad: diferencia,
                            ubicacion: itemPicking.ubicacion || '',
                            genero: prod?.genero || '',
                            linea: prod?.linea || '',
                            talla: prod?.talla || ''
                        });
                    }
                });
            }
            
            // Si hay productos no empacados, mostrar modal de reclasificaci√≥n
            if (productosNoEmpacados.length > 0) {
                window.packingIdParaCompletar = id;
                window.productosNoEmpacadosTemp = productosNoEmpacados;
                mostrarModalReclasificacion(productosNoEmpacados);
                return;
            }

            // Si no hay productos no empacados, completar normalmente
            await confirmarCompletarPacking(id);
        }
        
        function mostrarModalReclasificacion(productosNoEmpacados) {
            let html = '';
            
            productosNoEmpacados.forEach((prod, index) => {
                html += `
                    <div class="card" style="margin-bottom:1.5rem;padding:1.5rem;background:linear-gradient(135deg, #fff5f5 0%, #ffffff 100%);border-left:4px solid var(--warning)">
                        <div style="display:grid;grid-template-columns:auto 1fr;gap:1rem;margin-bottom:1rem">
                            <div style="width:50px;height:50px;background:linear-gradient(135deg,var(--warning),var(--danger));border-radius:8px;display:flex;align-items:center;justify-content:center;color:white;font-size:1.5rem;font-weight:600">
                                ${prod.cantidad}
                            </div>
                            <div>
                                <div style="font-weight:600;font-size:1.1rem;color:var(--text);margin-bottom:0.25rem">
                                    ${prod.variante}
                                </div>
                                <div style="color:var(--text-secondary);font-size:0.9rem;margin-bottom:0.25rem">
                                    ${prod.descripcion}
                                </div>
                                <div style="display:flex;gap:0.75rem;font-size:0.85rem">
                                    <span style="color:var(--text-secondary)">üìç ${prod.ubicacion}</span>
                                    <span style="color:var(--text-secondary)">üë§ ${prod.genero}</span>
                                    <span style="color:var(--text-secondary)">üìè ${prod.talla}</span>
                                    <span style="color:var(--text-secondary)">üìÇ ${prod.linea}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-bottom:1rem">
                            <label class="form-label" style="color:var(--danger);font-weight:600">
                                ‚ö†Ô∏è Motivo de NO EMPACADO (obligatorio):
                            </label>
                            <select class="form-select" id="motivo_${index}" onchange="validarObservaciones(${index})">
                                <option value="">Seleccionar motivo...</option>
                                <option value="no_pertenece_genero">‚ùå No pertenece al g√©nero</option>
                                <option value="no_pertenece_linea">‚ùå No pertenece a la l√≠nea</option>
                                <option value="mal_estado">‚ö†Ô∏è Mal estado</option>
                                <option value="no_pertenece_descripcion">‚ùå No pertenece a la descripci√≥n</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" style="color:var(--danger);font-weight:600">
                                üìù Observaciones (obligatorio):
                            </label>
                            <textarea class="form-textarea" id="observaciones_${index}" rows="3" placeholder="Especifica el g√©nero correcto, l√≠nea correcta, descripci√≥n correcta, o detalla el mal estado..."></textarea>
                            <small style="color:var(--text-secondary);font-size:0.85rem">
                                üí° Ejemplo: "El g√©nero es MUJER, no HOMBRE" o "Tiene manchas en la parte frontal"
                            </small>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('listaProductosNoEmpacados').innerHTML = html;
            abrirModal('modalReclasificarNoEmpacados');
            renderIcons();
        }
        
        function validarObservaciones(index) {
            const motivo = document.getElementById(`motivo_${index}`).value;
            const observaciones = document.getElementById(`observaciones_${index}`);
            
            if (motivo) {
                observaciones.style.borderColor = 'var(--danger)';
            }
        }
        
        function cerrarModalReclasificacion() {
            if (confirm('¬øSeguro que deseas cancelar? Los productos no empacados NO se reclasificar√°n.')) {
                cerrarModal('modalReclasificarNoEmpacados');
                window.packingIdParaCompletar = null;
                window.productosNoEmpacadosTemp = null;
            }
        }
        
        async function guardarReclasificacionYCompletar() {
            const productosNoEmpacados = window.productosNoEmpacadosTemp;
            if (!productosNoEmpacados) return;
            
            // Validar que todos tengan motivo y observaciones
            const registrosReclasificacion = [];
            let todosValidos = true;
            
            for (let i = 0; i < productosNoEmpacados.length; i++) {
                const motivo = document.getElementById(`motivo_${i}`).value;
                const observaciones = document.getElementById(`observaciones_${i}`).value.trim();
                
                if (!motivo) {
                    toast(`‚ö†Ô∏è Falta seleccionar motivo para ${productosNoEmpacados[i].variante}`, 'error');
                    todosValidos = false;
                    break;
                }
                
                if (!observaciones) {
                    toast(`‚ö†Ô∏è Falta especificar observaciones para ${productosNoEmpacados[i].variante}`, 'error');
                    todosValidos = false;
                    break;
                }
                
                registrosReclasificacion.push({
                    variante: productosNoEmpacados[i].variante,
                    descripcion: productosNoEmpacados[i].descripcion,
                    cantidad: productosNoEmpacados[i].cantidad,
                    ubicacion: productosNoEmpacados[i].ubicacion,
                    motivo: motivo,
                    observaciones: observaciones,
                    genero_original: productosNoEmpacados[i].genero,
                    linea_original: productosNoEmpacados[i].linea,
                    talla_original: productosNoEmpacados[i].talla
                });
            }
            
            if (!todosValidos) return;
            
            // Guardar en tabla de reclasificaci√≥n
            const pack = packing.find(p => p.id === window.packingIdParaCompletar);
            const orden = ordenes.find(o => o.id === pack.orden_id);
            
            mostrarLoading('Guardando reclasificaci√≥n...');
            
            try {
                // Insertar registros de reclasificaci√≥n
                for (const registro of registrosReclasificacion) {
                    const reclasId = 'RECLAS-' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substr(2, 5).toUpperCase();
                    
                    const estadoInicial = registro.motivo === 'mal_estado' ? 'Pendiente Ubicaci√≥n Picking' : 'Pendiente Correcci√≥n Producto';
                    
                    await supabase.from('reclasificacion').insert([{
                        id: reclasId,
                        orden_id: pack.orden_id,
                        orden_nombre: orden?.nombre || '',
                        parte: pack.parte,
                        variante: registro.variante,
                        descripcion: registro.descripcion,
                        cantidad: registro.cantidad,
                        ubicacion_origen: registro.ubicacion,
                        ubicacion_destino: null,
                        motivo: registro.motivo,
                        observaciones: registro.observaciones,
                        estado: estadoInicial,
                        genero_original: registro.genero_original,
                        linea_original: registro.linea_original,
                        talla_original: registro.talla_original,
                        genero_corregido: null,
                        linea_corregida: null,
                        talla_corregida: null,
                        descripcion_corregida: null,
                        variante_corregida: null,
                        fecha: new Date().toISOString()
                    }]);
                }
                
                // Cerrar modal
                cerrarModal('modalReclasificarNoEmpacados');
                
                // Ahora s√≠ completar el packing
                await confirmarCompletarPacking(window.packingIdParaCompletar);
                
                window.packingIdParaCompletar = null;
                window.productosNoEmpacadosTemp = null;
                
            } catch (e) {
                ocultarLoading();
                toast('Error al guardar reclasificaci√≥n: ' + e.message, 'error');
                console.error(e);
            }
        }
        
        async function confirmarCompletarPacking(id) {
            const pack = packing.find(p => p.id === id);
            if (!pack) return;

            mostrarLoading('Completando packing...');
            try {
                const tiempoFinal = (pack.tiempo_minutos || 0) + (pack.fecha_inicio ? Math.round((new Date() - new Date(pack.fecha_inicio)) / 60000) : 0);
                
                await supabase.from('packing').update({
                    estado: 'Completado',
                    fecha_fin: new Date().toISOString(),
                    tiempo_minutos: tiempoFinal
                }).eq('id', id);

                const orden = ordenes.find(o => o.id === pack.orden_id);
                if (orden) {
                    const historial = orden.historial || [];
                    historial.push({
                        fecha: new Date().toISOString(),
                        accion: `Packing Parte ${pack.parte} completado`,
                        detalle: `${pack.total_empacado || 0} empacados, ${pack.total_reclasificado || 0} reclasificados, ${tiempoFinal} min`
                    });

                    let montoPacking = 0;
                    (pack.items_empacados || []).forEach(i => {
                        const prod = productos.find(p => p.variante === i.variante);
                        montoPacking += (prod?.kardex || 0) * i.cantidad;
                    });

                    const nuevoMontoOrden = (parseFloat(orden.monto_packing) || 0) + montoPacking;
                    const nuevasUnidadesEmp = (orden.unidades_empacadas || 0) + (pack.total_empacado || 0);
                    const nuevasUnidadesReclas = (orden.unidades_reclasificadas || 0) + (pack.total_reclasificado || 0);

                    const packingsOrden = packing.filter(p => p.orden_id === orden.id);
                    const todosCompletados = packingsOrden.every(p => p.id === id || p.estado === 'Completado');

                    await supabase.from('ordenes').update({
                        historial,
                        monto_packing: nuevoMontoOrden,
                        monto_final: nuevoMontoOrden,
                        unidades_empacadas: nuevasUnidadesEmp,
                        unidades_reclasificadas: nuevasUnidadesReclas,
                        estado: todosCompletados ? 'Completada' : orden.estado,
                        fecha_fin_packing: todosCompletados ? new Date().toISOString() : null,
                        fecha_cierre: todosCompletados ? new Date().toISOString() : null
                    }).eq('id', orden.id);

                    if (todosCompletados) {
                        for (const item of pack.items_empacados || []) {
                            const inv = inventario.find(i => i.variante === item.variante);
                            if (inv) {
                                const nuevoStockFisico = Math.max(0, (parseInt(inv.stock_fisico) || 0) - item.cantidad);
                                
                                await supabase.from('inventario').update({
                                    stock_fisico: nuevoStockFisico,
                                    stock_bloqueado: Math.max(0, (parseInt(inv.stock_bloqueado) || 0) - item.cantidad)
                                }).eq('variante', item.variante).eq('ubicacion', inv.ubicacion);
                                
                                // üóëÔ∏è NUEVO: Eliminar autom√°ticamente si stock lleg√≥ a 0
                                if (nuevoStockFisico === 0) {
                                    console.log(`üóëÔ∏è Eliminando ${item.variante} de ${inv.ubicacion} (stock = 0)`);
                                    await supabase.from('inventario')
                                        .delete()
                                        .eq('variante', item.variante)
                                        .eq('ubicacion', inv.ubicacion);
                                }
                            }
                        }
                        
                        // Limpiar cualquier otro registro con stock 0 que pueda existir
                        console.log('üßπ Limpiando otros registros con stock 0...');
                        const { data: eliminados } = await supabase.from('inventario')
                            .delete()
                            .eq('stock_fisico', 0);
                        
                        if (eliminados && eliminados.length > 0) {
                            console.log(`‚úÖ ${eliminados.length} registros con stock 0 eliminados`);
                        }
                    }
                }

                ocultarLoading();
                toast('‚úÖ Packing completado exitosamente', 'success');
                await cargarDatos();
            } catch (e) {
                ocultarLoading();
                toast('Error: ' + e.message, 'error');
            }
        }

        function verDetallePacking(id) {
            const pack = packing.find(p => p.id === id);
            if (!pack) return;
            
            const orden = ordenes.find(o => o.id === pack.orden_id);
            
            let html = `
                <div class="detail-grid" style="margin-bottom:1rem">
                    <div class="detail-item"><div class="detail-label">Orden</div><div class="detail-value">${orden?.nombre || pack.orden_id}</div></div>
                    <div class="detail-item"><div class="detail-label">Parte</div><div class="detail-value">PT${pack.parte}</div></div>
                    <div class="detail-item"><div class="detail-label">Equipo</div><div class="detail-value">${pack.equipo_nombre || '-'}</div></div>
                    <div class="detail-item"><div class="detail-label">Tiempo</div><div class="detail-value">${calcularTiempoTrabajado(pack)}</div></div>
                    <div class="detail-item"><div class="detail-label">Recibido</div><div class="detail-value">${pack.total_recibido}</div></div>
                    <div class="detail-item"><div class="detail-label">Empacado</div><div class="detail-value" style="color:var(--success)">${pack.total_empacado}</div></div>
                    <div class="detail-item"><div class="detail-label">Reclasificado</div><div class="detail-value" style="color:var(--warning)">${pack.total_reclasificado}</div></div>
                </div>
                <h4 style="margin:1rem 0">Distribuci√≥n por Tienda</h4>
                <div class="chips">
                    ${Object.entries(pack.distribucion_tiendas || {}).map(([t, c]) => `<div class="chip"><strong>${t}:</strong> ${c}</div>`).join('') || '<span style="color:var(--text-secondary)">Sin distribuci√≥n registrada</span>'}
                </div>
            `;
            
            document.getElementById('packingContent').innerHTML = html;
            document.getElementById('packingFooter').innerHTML = '<button class="btn btn-outline" onclick="cerrarModal(&apos;modalPacking&apos;)">Cerrar</button>';
            document.getElementById('tituloModalPacking').textContent = 'Detalle de Packing';
            abrirModal('modalPacking');
        }

        function exportarHistorialPacking() {
            const completados = packing.filter(p => p.estado === 'Completado');
            if (!completados.length) { toast('No hay historial', 'warning'); return; }
            
            const data = completados.map(p => {
                const orden = ordenes.find(o => o.id === p.orden_id);
                return {
                    Orden: orden?.nombre || p.orden_id,
                    Parte: `PT${p.parte}`,
                    Equipo: p.equipo_nombre || '',
                    Integrantes: (p.integrantes || []).join(', '),
                    Recibido: p.total_recibido,
                    Empacado: p.total_empacado,
                    Reclasificado: p.total_reclasificado,
                    TiempoMinutos: p.tiempo_minutos,
                    FechaInicio: formatFechaHora(p.fecha_inicio),
                    FechaFin: formatFechaHora(p.fecha_fin),
                    ...Object.fromEntries(Object.entries(p.distribucion_tiendas || {}).map(([k, v]) => [`Tienda_${k}`, v]))
                };
            });
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'HistorialPacking');
            XLSX.writeFile(wb, `Historial_Packing_${new Date().toISOString().split('T')[0]}.xlsx`);
            toast('Historial exportado', 'success');
        }

        function descargarHojaPacking(id) {
            const pack = packing.find(p => p.id === id);
            if (!pack) {
                toast('Error: Packing no encontrado', 'error');
                return;
            }
            
            if (!pack.items_recibidos || pack.items_recibidos.length === 0) {
                toast('Error: No hay items recibidos para descargar', 'error');
                return;
            }
            
            const orden = ordenes.find(o => o.id === pack.orden_id);

            const data = (pack.items_recibidos || []).map(i => {
                const prod = productos.find(p => p.variante === i.variante);
                
                // Buscar item original de la orden para obtener distribuci√≥n
                const itemOriginal = orden?.items?.find(oi => oi.variante === i.variante);
                
                // Buscar ubicaci√≥n del picking
                const pickingRelacionado = picking.find(p => p.orden_id === pack.orden_id && p.parte === pack.parte);
                const itemPicking = pickingRelacionado?.items?.find(pi => pi.variante === i.variante);
                
                const row = {
                    // ORDEN (solo PT1, PT2, etc.)
                    'Parte': `PT${pack.parte}`,
                    
                    // UBICACI√ìN (del picking o del item original)
                    'Ubicaci√≥n': i.ubicacion || itemPicking?.ubicacion || itemOriginal?.ubicacion || '',
                    
                    // PRODUCTO COMPLETO
                    'Variante': i.variante,
                    'C√≥digo Comercial': prod?.codigo_comercial || '',
                    'Descripci√≥n': prod?.descripcion || '',
                    'Marca': prod?.marca || '',
                    'G√©nero': prod?.genero || '',
                    'L√≠nea': prod?.linea || '',
                    'Talla': prod?.talla || '',
                    'Color': prod?.color || '',
                    'Kardex': prod?.kardex || 0,
                    'PVP': prod?.pvp || 0,
                    'PVP Regular': prod?.pvp_regular || 0,
                    
                    // CANTIDADES
                    'Solicitado': itemOriginal?.cantidad || i.cantidad_solicitada || 0,
                    'Encontrado': i.cantidad_encontrada || 0
                };
                
                // Primero identificar qu√© tiendas tienen distribuci√≥n para este item
                const tiendasConDistribucion = [];
                TIENDAS_BASE.forEach(t => {
                    if (itemOriginal?.distribucion && itemOriginal.distribucion[t] && itemOriginal.distribucion[t] > 0) {
                        tiendasConDistribucion.push(t);
                    }
                });
                
                // Si hay distribuci√≥n, solo agregar esas tiendas
                // Si no hay distribuci√≥n, agregar todas con 0
                const tiendasAMostrar = tiendasConDistribucion.length > 0 ? tiendasConDistribucion : TIENDAS_BASE;
                
                tiendasAMostrar.forEach(t => {
                    const nombreTienda = t.replace('LUKERS ', '');
                    if (itemOriginal?.distribucion && itemOriginal.distribucion[t]) {
                        row[nombreTienda] = itemOriginal.distribucion[t];
                    } else {
                        row[nombreTienda] = 0; // Poner 0 en lugar de vac√≠o
                    }
                });
                
                return row;
            });

            if (data.length === 0) {
                toast('Error: No hay datos para descargar', 'error');
                return;
            }

            const ws = XLSX.utils.json_to_sheet(data);
            
            // Ajustar anchos de columnas
            const colWidths = [
                {wch: 8},  // Parte
                {wch: 15}, // Ubicaci√≥n
                {wch: 15}, // Variante
                {wch: 15}, // C√≥digo Comercial
                {wch: 40}, // Descripci√≥n
                {wch: 15}, // Marca
                {wch: 10}, // G√©nero
                {wch: 15}, // L√≠nea
                {wch: 8},  // Talla
                {wch: 12}, // Color
                {wch: 8},  // Kardex
                {wch: 10}, // PVP
                {wch: 12}, // PVP Regular
                {wch: 12}, // Solicitado
                {wch: 12}  // Encontrado
            ];
            
            // Agregar anchos para tiendas (din√°mico seg√∫n TIENDAS_BASE)
            TIENDAS_BASE.forEach(() => colWidths.push({wch: 14}));
            ws['!cols'] = colWidths;
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'HojaPacking');
            const filename = `Packing_${orden?.nombre || pack.orden_id}_PT${pack.parte}.xlsx`;
            
            try {
                XLSX.writeFile(wb, filename);
                console.log('‚úÖ Archivo descargado:', filename);
                toast('‚úÖ Hoja descargada exitosamente', 'success');
            } catch (e) {
                console.error('‚ùå Error al descargar:', e);
                toast('Error al descargar: ' + e.message, 'error');
            }
        }

        // ============================================
        // RECLASIFICACI√ìN
        // ============================================
        function cambiarTabReclas(tab) {
            tabReclasActual = tab;
            document.querySelectorAll('#tabsReclas .tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab);
            });
            renderizarReclasificacion();
        }

        function renderizarReclasificacion() {
            let filtradas = reclasificacion;
            if (tabReclasActual === 'pendientes') {
                filtradas = reclasificacion.filter(r => r.estado !== 'Completada');
            } else if (tabReclasActual === 'completadas') {
                filtradas = reclasificacion.filter(r => r.estado === 'Completada');
            }

            document.getElementById('tablaReclasificacion').innerHTML = filtradas.length === 0
                ? '<tr><td colspan="8" class="empty-state">No hay reclasificaciones</td></tr>'
                : filtradas.map(r => {
                    // Determinar badge seg√∫n motivo
                    let badgeMotivo = '';
                    switch(r.motivo) {
                        case 'no_pertenece_genero':
                            badgeMotivo = '<span class="badge badge-danger">‚ùå No pertenece al g√©nero</span>';
                            break;
                        case 'no_pertenece_linea':
                            badgeMotivo = '<span class="badge badge-danger">‚ùå No pertenece a la l√≠nea</span>';
                            break;
                        case 'mal_estado':
                            badgeMotivo = '<span class="badge badge-warning">‚ö†Ô∏è Mal estado</span>';
                            break;
                        case 'no_pertenece_descripcion':
                            badgeMotivo = '<span class="badge badge-danger">‚ùå No pertenece a la descripci√≥n</span>';
                            break;
                        default:
                            badgeMotivo = `<span class="badge badge-secondary">${r.motivo}</span>`;
                    }
                    
                    // Determinar badge seg√∫n estado
                    let badgeEstado = '';
                    let botonAccion = '';
                    
                    if (r.estado === 'Pendiente Correcci√≥n Producto') {
                        badgeEstado = '<span class="badge badge-purple">üîÑ Pendiente Producto</span>';
                        botonAccion = `<button class="btn btn-primary btn-icon btn-sm" onclick="corregirProducto('${r.id}')" title='Corregir Informaci√≥n'><i data-lucide="edit" style="width:14px;height:14px"></i></button>`;
                    } else if (r.estado === 'Pendiente Ubicaci√≥n Picking') {
                        badgeEstado = '<span class="badge badge-warning">üìç Pendiente Picking</span>';
                        botonAccion = `<button class="btn btn-success btn-icon btn-sm" onclick="asignarUbicacion('${r.id}')" title='Asignar Ubicaci√≥n'><i data-lucide="map-pin" style="width:14px;height:14px"></i></button>`;
                    } else if (r.estado === 'Completada') {
                        badgeEstado = '<span class="badge badge-success">‚úÖ Completada</span>';
                        botonAccion = `<span style="font-size:0.85rem;color:var(--text-secondary)">${r.ubicacion_destino || 'Procesada'}</span>`;
                    }
                    
                    return `<tr>
                        <td><strong style="font-size:0.9rem">${r.orden_nombre || r.orden_id || '-'}</strong></td>
                        <td><span class="badge badge-info">PT${r.parte}</span></td>
                        <td><strong>${r.variante}</strong><br><small style="color:var(--text-secondary)">${r.descripcion || ''}</small></td>
                        <td><strong style="color:var(--primary)">${r.cantidad}</strong></td>
                        <td>${badgeMotivo}</td>
                        <td class="td-wrap" style="max-width:250px;font-size:0.85rem">${r.observaciones || '-'}</td>
                        <td>${badgeEstado}</td>
                        <td>${botonAccion}</td>
                    </tr>`;
                }).join('');
            renderIcons();
        }

        function exportarReclasificacionesPendientes() {
            const pendientes = reclasificacion.filter(r => r.estado === 'Pendiente');
            if (!pendientes.length) { toast('No hay pendientes', 'warning'); return; }

            const data = pendientes.map(r => {
                const prod = productos.find(p => p.variante === r.variante_original);
                return {
                    ID: r.id,
                    Orden: r.orden_id || '',
                    VarianteOriginal: r.variante_original,
                    NuevaVariante: r.nueva_variante || '',
                    Ubicacion: r.ubicacion_original || '',
                    Cantidad: r.cantidad,
                    Motivo: r.motivo,
                    Comentario: r.comentario || '',
                    Descripcion: prod?.descripcion || '',
                    Genero: prod?.genero || '',
                    Talla: prod?.talla || '',
                    Fecha: formatFechaHora(r.fecha)
                };
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ReclasificacionesPendientes');
            XLSX.writeFile(wb, `Reclasificaciones_Pendientes_${new Date().toISOString().split('T')[0]}.xlsx`);
            toast('Exportado', 'success');
        }

        function abrirCompletarReclas(id) {
            reclasActual = reclasificacion.find(r => r.id === id);
            if (!reclasActual) return;

            const prod = productos.find(p => p.variante === reclasActual.variante_original);

            document.getElementById('completarReclasContent').innerHTML = `
                <div class="detail-grid">
                    <div class="detail-item"><div class="detail-label">Variante</div><div class="detail-value">${reclasActual.variante_original}</div></div>
                    <div class="detail-item"><div class="detail-label">Cantidad</div><div class="detail-value">${reclasActual.cantidad}</div></div>
                    <div class="detail-item"><div class="detail-label">Motivo</div><div class="detail-value">${reclasActual.motivo}</div></div>
                    <div class="detail-item" style="grid-column:span 2"><div class="detail-label">Descripci√≥n</div><div class="detail-value">${prod?.descripcion || '-'}</div></div>
                </div>
                <div class="form-group" style="margin-top:1rem">
                    <label class="form-label">Ubicaci√≥n Final</label>
                    <input type="text" id="ubicacionFinalReclas" class="form-input" placeholder="Ej: A001-01-03">
                </div>
            `;
            abrirModal('modalCompletarReclas');
        }

        async function confirmarCompletarReclas() {
            const ubi = normalizarTexto(document.getElementById('ubicacionFinalReclas')?.value);
            if (!ubi) { toast('Ingresa la ubicaci√≥n', 'error'); return; }
            if (!reclasActual) return;

            mostrarLoading('Completando...');
            try {
                const varFinal = reclasActual.nueva_variante || reclasActual.variante_original;
                const invExiste = inventario.find(i => i.variante === varFinal && i.ubicacion === ubi);
                
                if (invExiste) {
                    await supabase.from('inventario').update({
                        stock_fisico: (parseInt(invExiste.stock_fisico) || 0) + reclasActual.cantidad
                    }).eq('variante', varFinal).eq('ubicacion', ubi);
                } else {
                    await supabase.from('inventario').insert([{
                        variante: varFinal,
                        ubicacion: ubi,
                        stock_fisico: reclasActual.cantidad,
                        stock_bloqueado: 0
                    }]);
                }

                await supabase.from('reclasificacion').update({
                    estado: 'Completada',
                    nueva_ubicacion: ubi,
                    fecha_completado: new Date().toISOString()
                }).eq('id', reclasActual.id);

                ocultarLoading();
                toast('Reclasificaci√≥n completada', 'success');
                cerrarModal('modalCompletarReclas');
                await cargarDatos();
            } catch (e) {
                ocultarLoading();
                toast('Error: ' + e.message, 'error');
            }
        }
        
        // NUEVAS FUNCIONES - FLUJO DE RECLASIFICACI√ìN
        // ============================================
        
        function corregirProducto(id) {
            reclasActual = reclasificacion.find(r => r.id === id);
            if (!reclasActual) return;
            
            document.getElementById('completarReclasContent').innerHTML = `
                <div class="alert alert-info" style="margin-bottom:1.5rem">
                    <i data-lucide="info"></i>
                    <span><strong>Rol: PRODUCTO</strong> - Corrige la informaci√≥n incorrecta del producto</span>
                </div>
                
                <div style="background:#f8fafc;padding:1rem;border-radius:8px;margin-bottom:1.5rem">
                    <div style="font-weight:600;margin-bottom:0.5rem;color:var(--text-secondary)">üì¶ Informaci√≥n Original:</div>
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:0.75rem;font-size:0.9rem">
                        <div><strong>Variante:</strong> ${reclasActual.variante}</div>
                        <div><strong>Cantidad:</strong> ${reclasActual.cantidad}</div>
                        <div><strong>G√©nero:</strong> ${reclasActual.genero_original || '-'}</div>
                        <div><strong>L√≠nea:</strong> ${reclasActual.linea_original || '-'}</div>
                        <div><strong>Talla:</strong> ${reclasActual.talla_original || '-'}</div>
                        <div><strong>Descripci√≥n:</strong> ${reclasActual.descripcion || '-'}</div>
                    </div>
                    <div style="margin-top:0.75rem;padding:0.75rem;background:var(--warning);color:white;border-radius:4px;font-size:0.9rem">
                        <strong>Motivo:</strong> ${reclasActual.motivo}<br>
                        <strong>Observaciones:</strong> ${reclasActual.observaciones}
                    </div>
                </div>
                
                <h4 style="margin-bottom:1rem;color:var(--primary)">‚úèÔ∏è Informaci√≥n Corregida:</h4>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Variante Correcta *</label>
                        <input type="text" id="varianteCorregida" class="form-input" value="${reclasActual.variante}" placeholder="Ej: SKU-12345">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Descripci√≥n Correcta *</label>
                        <input type="text" id="descripcionCorregida" class="form-input" value="${reclasActual.descripcion || ''}" placeholder="Descripci√≥n del producto">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">G√©nero Correcto *</label>
                        <select id="generoCorregido" class="form-select">
                            <option value="">Seleccionar...</option>
                            <option value="HOMBRE" ${reclasActual.genero_original === 'HOMBRE' ? 'selected' : ''}>HOMBRE</option>
                            <option value="MUJER" ${reclasActual.genero_original === 'MUJER' ? 'selected' : ''}>MUJER</option>
                            <option value="NI√ëO" ${reclasActual.genero_original === 'NI√ëO' ? 'selected' : ''}>NI√ëO</option>
                            <option value="NI√ëA" ${reclasActual.genero_original === 'NI√ëA' ? 'selected' : ''}>NI√ëA</option>
                            <option value="BEBE" ${reclasActual.genero_original === 'BEBE' ? 'selected' : ''}>BEBE</option>
                            <option value="UNISEX" ${reclasActual.genero_original === 'UNISEX' ? 'selected' : ''}>UNISEX</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">L√≠nea Correcta *</label>
                        <input type="text" id="lineaCorregida" class="form-input" value="${reclasActual.linea_original || ''}" placeholder="Ej: CASUAL, DEPORTIVO">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Talla Correcta</label>
                    <input type="text" id="tallaCorregida" class="form-input" value="${reclasActual.talla_original || ''}" placeholder="Ej: M, 42, XL">
                </div>
            `;
            
            document.getElementById('tituloModalEquipo').textContent = '‚úèÔ∏è Corregir Informaci√≥n - PRODUCTO';
            
            // Reemplazar footer con nuevo bot√≥n
            const modal = document.getElementById('modalCompletarReclas');
            const footer = modal.querySelector('.modal-footer');
            footer.innerHTML = `
                <button class="btn btn-outline" onclick="cerrarModal('modalCompletarReclas')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarCorreccionProducto()">‚úÖ Guardar y Enviar a PICKING</button>
            `;
            
            abrirModal('modalCompletarReclas');
            renderIcons();
        }
        
        async function guardarCorreccionProducto() {
            if (!reclasActual) return;
            
            const varianteCorregida = document.getElementById('varianteCorregida').value.trim();
            const descripcionCorregida = document.getElementById('descripcionCorregida').value.trim();
            const generoCorregido = document.getElementById('generoCorregido').value;
            const lineaCorregida = document.getElementById('lineaCorregida').value.trim();
            const tallaCorregida = document.getElementById('tallaCorregida').value.trim();
            
            if (!varianteCorregida || !descripcionCorregida || !generoCorregido || !lineaCorregida) {
                toast('‚ö†Ô∏è Completa todos los campos obligatorios', 'error');
                return;
            }
            
            mostrarLoading('Guardando correcci√≥n...');
            
            try {
                // Actualizar registro de reclasificaci√≥n
                await supabase.from('reclasificacion').update({
                    variante_corregida: varianteCorregida,
                    descripcion_corregida: descripcionCorregida,
                    genero_corregido: generoCorregido,
                    linea_corregida: lineaCorregida,
                    talla_corregida: tallaCorregida,
                    estado: 'Pendiente Ubicaci√≥n Picking',
                    fecha_correccion_producto: new Date().toISOString()
                }).eq('id', reclasActual.id);
                
                ocultarLoading();
                toast('‚úÖ Informaci√≥n corregida. Ahora PICKING debe asignar ubicaci√≥n', 'success');
                cerrarModal('modalCompletarReclas');
                await cargarDatos();
                
            } catch (e) {
                ocultarLoading();
                toast('Error: ' + e.message, 'error');
                console.error(e);
            }
        }
        
        function asignarUbicacion(id) {
            reclasActual = reclasificacion.find(r => r.id === id);
            if (!reclasActual) return;
            
            // Determinar si viene de correcci√≥n o de mal estado
            const vieneDeCorreccion = reclasActual.variante_corregida != null;
            
            document.getElementById('completarReclasContent').innerHTML = `
                <div class="alert alert-success" style="margin-bottom:1.5rem">
                    <i data-lucide="map-pin"></i>
                    <span><strong>Rol: PICKING</strong> - Asigna la ubicaci√≥n correcta para el producto</span>
                </div>
                
                <div style="background:#f8fafc;padding:1rem;border-radius:8px;margin-bottom:1.5rem">
                    <div style="font-weight:600;margin-bottom:0.5rem;color:var(--text-secondary)">
                        üì¶ ${vieneDeCorreccion ? 'Informaci√≥n Corregida' : 'Informaci√≥n del Producto'}:
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:0.75rem;font-size:0.9rem">
                        <div><strong>Variante:</strong> ${reclasActual.variante_corregida || reclasActual.variante}</div>
                        <div><strong>Cantidad:</strong> ${reclasActual.cantidad}</div>
                        <div><strong>Descripci√≥n:</strong> ${reclasActual.descripcion_corregida || reclasActual.descripcion || '-'}</div>
                        <div><strong>G√©nero:</strong> ${reclasActual.genero_corregido || reclasActual.genero_original || '-'}</div>
                        <div><strong>L√≠nea:</strong> ${reclasActual.linea_corregida || reclasActual.linea_original || '-'}</div>
                        <div><strong>Talla:</strong> ${reclasActual.talla_corregida || reclasActual.talla_original || '-'}</div>
                    </div>
                    ${reclasActual.motivo === 'mal_estado' ? `
                        <div style="margin-top:0.75rem;padding:0.75rem;background:var(--warning);color:white;border-radius:4px;font-size:0.9rem">
                            <strong>‚ö†Ô∏è MAL ESTADO:</strong> ${reclasActual.observaciones}<br>
                            <small>Asignar a zona de productos da√±ados o con defectos</small>
                        </div>
                    ` : ''}
                </div>
                
                <div class="form-group">
                    <label class="form-label" style="font-weight:600;color:var(--primary)">
                        üìç Ubicaci√≥n Destino en Inventario *
                    </label>
                    <input type="text" id="ubicacionDestino" class="form-input" placeholder="Ej: A001-01-03 o DA√ëADOS-01">
                    <small style="color:var(--text-secondary);font-size:0.85rem;display:block;margin-top:0.5rem">
                        üí° ${reclasActual.motivo === 'mal_estado' ? 'Usa una ubicaci√≥n espec√≠fica para productos da√±ados' : 'Ubicaci√≥n donde quedar√° almacenado el producto corregido'}
                    </small>
                </div>
            `;
            
            // Reemplazar footer con nuevo bot√≥n
            const modal = document.getElementById('modalCompletarReclas');
            const footer = modal.querySelector('.modal-footer');
            footer.innerHTML = `
                <button class="btn btn-outline" onclick="cerrarModal('modalCompletarReclas')">Cancelar</button>
                <button class="btn btn-success" onclick="guardarUbicacionYCompletarReclasificacion()">‚úÖ Asignar y Regresar a Inventario</button>
            `;
            
            abrirModal('modalCompletarReclas');
            renderIcons();
        }
        
        async function guardarUbicacionYCompletarReclasificacion() {
            if (!reclasActual) return;
            
            const ubicacionDestino = document.getElementById('ubicacionDestino').value.trim().toUpperCase();
            
            if (!ubicacionDestino) {
                toast('‚ö†Ô∏è Ingresa la ubicaci√≥n destino', 'error');
                return;
            }
            
            mostrarLoading('Completando reclasificaci√≥n...');
            
            try {
                // Usar variante corregida si existe, sino la original
                const varianteFinal = reclasActual.variante_corregida || reclasActual.variante;
                const descripcionFinal = reclasActual.descripcion_corregida || reclasActual.descripcion;
                const generoFinal = reclasActual.genero_corregido || reclasActual.genero_original;
                const lineaFinal = reclasActual.linea_corregida || reclasActual.linea_original;
                const tallaFinal = reclasActual.talla_corregida || reclasActual.talla_original;
                
                // Verificar si ya existe en inventario
                const invExiste = inventario.find(i => i.variante === varianteFinal && i.ubicacion === ubicacionDestino);
                
                if (invExiste) {
                    // Actualizar stock existente
                    await supabase.from('inventario').update({
                        stock_fisico: (parseInt(invExiste.stock_fisico) || 0) + reclasActual.cantidad,
                        descripcion: descripcionFinal,
                        genero: generoFinal,
                        linea: lineaFinal,
                        talla: tallaFinal
                    }).eq('variante', varianteFinal).eq('ubicacion', ubicacionDestino);
                } else {
                    // Crear nuevo registro en inventario
                    await supabase.from('inventario').insert([{
                        variante: varianteFinal,
                        descripcion: descripcionFinal,
                        ubicacion: ubicacionDestino,
                        stock_fisico: reclasActual.cantidad,
                        stock_bloqueado: 0,
                        genero: generoFinal,
                        linea: lineaFinal,
                        talla: tallaFinal,
                        punto_reorden: 0
                    }]);
                }
                
                // Actualizar registro de reclasificaci√≥n como completado
                await supabase.from('reclasificacion').update({
                    ubicacion_destino: ubicacionDestino,
                    estado: 'Completada',
                    fecha_completado: new Date().toISOString()
                }).eq('id', reclasActual.id);
                
                ocultarLoading();
                toast('‚úÖ Reclasificaci√≥n completada. Producto regres√≥ a inventario correctamente', 'success');
                cerrarModal('modalCompletarReclas');
                await cargarDatos();
                
            } catch (e) {
                ocultarLoading();
                toast('Error: ' + e.message, 'error');
                console.error(e);
            }
        }

        // ============================================
        // EQUIPOS
        // ============================================
        function cambiarTabEquipos(tipo) {
            tabEquiposActual = tipo;
            document.querySelectorAll('#vista-equipos .tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tipo === tipo);
            });
            renderizarEquipos();
        }

        function renderizarEquipos() {
            const filtrados = equipos.filter(e => e.tipo === tabEquiposActual);
            
            document.getElementById('tablaEquipos').innerHTML = filtrados.length === 0
                ? '<tr><td colspan="5" class="empty-state">No hay equipos</td></tr>'
                : filtrados.map(e => `<tr>
                    <td><strong>${e.nombre}</strong></td>
                    <td class="td-wrap">${(e.integrantes || []).join(', ') || '-'}</td>
                    <td><span class="badge badge-${e.tipo === 'picking' ? 'info' : 'purple'}">${e.tipo}</span></td>
                    <td>${e.activo ? '<span class="badge badge-success">Activo</span>' : '<span class="badge badge-danger">Inactivo</span>'}</td>
                    <td>
                        <button class="btn btn-info btn-icon btn-sm" onclick="editarEquipo(${e.id})" title='Editar'><i data-lucide="edit" style="width:14px;height:14px"></i></button>
                        <button class="btn btn-danger btn-icon btn-sm" onclick="eliminarEquipo(${e.id})" title='Eliminar'><i data-lucide="trash-2" style="width:14px;height:14px"></i></button>
                    </td>
                </tr>`).join('');
            renderIcons();
        }

        function editarEquipo(id) {
            equipoActual = equipos.find(e => e.id === id);
            if (!equipoActual) return;
            
            document.getElementById('tituloModalEquipo').textContent = 'Editar Equipo';
            document.getElementById('equipoNombre').value = equipoActual.nombre;
            document.getElementById('equipoTipo').value = equipoActual.tipo;
            document.getElementById('equipoIntegrantes').value = (equipoActual.integrantes || []).join('\n');
            abrirModal('modalCrearEquipo');
        }

        async function guardarEquipo() {
            const nombre = document.getElementById('equipoNombre').value.trim();
            const tipo = document.getElementById('equipoTipo').value;
            const integrantes = document.getElementById('equipoIntegrantes').value.split('\n').map(s => s.trim()).filter(Boolean);

            if (!nombre) { toast('Ingresa el nombre', 'error'); return; }

            mostrarLoading('Guardando...');
            try {
                if (equipoActual) {
                    await supabase.from('equipos').update({ nombre, tipo, integrantes }).eq('id', equipoActual.id);
                } else {
                    await supabase.from('equipos').insert([{ nombre, tipo, integrantes, activo: true }]);
                }
                ocultarLoading();
                toast('Equipo guardado', 'success');
                cerrarModal('modalCrearEquipo');
                equipoActual = null;
                document.getElementById('tituloModalEquipo').textContent = 'Nuevo Equipo';
                document.getElementById('equipoNombre').value = '';
                document.getElementById('equipoIntegrantes').value = '';
                await cargarDatos();
            } catch (e) {
                ocultarLoading();
                toast('Error: ' + e.message, 'error');
            }
        }

        async function eliminarEquipo(id) {
            if (!confirm('¬øEliminar este equipo?')) return;
            mostrarLoading('Eliminando...');
            await supabase.from('equipos').delete().eq('id', id);
            ocultarLoading();
            toast('Equipo eliminado', 'success');
            await cargarDatos();
        }

        function cambiarPagina(tipo, dir) {
            if (tipo === 'inventario') { paginaInv += dir; renderizarInventario(); }
            else if (tipo === 'productos') { paginaProd += dir; renderizarProductos(); }
        }

        // =========== FUNCIONES DE CONFIGURACI√ìN ===========
        function cambiarTabConfig(tab) {
            document.querySelectorAll('#vista-configuracion .tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`#vista-configuracion .tab[data-config="${tab}"]`)?.classList.add('active');
            
            document.querySelectorAll('.config-section').forEach(s => s.style.display = 'none');
            const seccion = document.getElementById(`config${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
            if (seccion) seccion.style.display = 'block';
            
            if (tab === 'tiendas') renderizarListaTiendas();
            if (tab === 'horarios') calcularTiempoEfectivo();
        }

        function renderizarListaTiendas() {
            const lista = document.getElementById('listaTiendas');
            if (lista) {
                lista.innerHTML = TIENDAS_BASE.map(t => `
                    <div class="chip">
                        ${t}
                        <button class="chip-remove" onclick="eliminarTienda('${t}')"><i data-lucide="x" style="width:12px;height:12px"></i></button>
                    </div>
                `).join('');
                renderIcons();
            }
        }

        function agregarTienda() {
            const input = document.getElementById('inputNuevaTienda');
            const nombre = input?.value.trim().toUpperCase();
            if (!nombre) { toast('Ingresa un nombre', 'warning'); return; }
            if (TIENDAS_BASE.includes(nombre)) { toast('La tienda ya existe', 'warning'); return; }
            TIENDAS_BASE.push(nombre);
            input.value = '';
            renderizarListaTiendas();
            toast('Tienda agregada', 'success');
        }

        function eliminarTienda(nombre) {
            const idx = TIENDAS_BASE.indexOf(nombre);
            if (idx > -1) {
                TIENDAS_BASE.splice(idx, 1);
                renderizarListaTiendas();
                toast('Tienda eliminada', 'success');
            }
        }

        function calcularTiempoEfectivo() {
            const inicio = document.getElementById('horaInicio')?.value || '08:30';
            const fin = document.getElementById('horaFin')?.value || '19:00';
            const almuerzo = parseInt(document.getElementById('duracionAlmuerzo')?.value) || 60;
            
            const [h1, m1] = inicio.split(':').map(Number);
            const [h2, m2] = fin.split(':').map(Number);
            const minutosTrabajo = (h2 * 60 + m2) - (h1 * 60 + m1) - almuerzo;
            const horas = (minutosTrabajo / 60).toFixed(1);
            
            const el = document.getElementById('tiempoEfectivo');
            if (el) el.textContent = `${horas} horas`;
        }

        function guardarConfigColumnas() {
            toast('Configuraci√≥n de columnas guardada', 'success');
        }

        async function guardarConfigTiendas() {
            mostrarLoading('Guardando tiendas...');
            try {
                // Guardar primero en localStorage (inmediato)
                localStorage.setItem('mawi_tiendas', JSON.stringify(TIENDAS_BASE));
                
                // Intentar guardar en Supabase
                const config = {
                    tipo: 'tiendas',
                    data: TIENDAS_BASE,
                    fecha_actualizacion: new Date().toISOString()
                };
                
                // Verificar si existe configuraci√≥n
                const { data: existing, error: selectError } = await supabase
                    .from('configuraciones')
                    .select('id')
                    .eq('tipo', 'tiendas')
                    .single();
                
                if (existing) {
                    // Actualizar
                    const { error: updateError } = await supabase
                        .from('configuraciones')
                        .update({ data: TIENDAS_BASE, fecha_actualizacion: new Date().toISOString() })
                        .eq('tipo', 'tiendas');
                    
                    if (updateError) console.warn('Error actualizando en Supabase:', updateError);
                } else {
                    // Insertar
                    const { error: insertError } = await supabase
                        .from('configuraciones')
                        .insert([config]);
                    
                    if (insertError) console.warn('Error insertando en Supabase:', insertError);
                }
                
                ocultarLoading();
                toast('Tiendas guardadas correctamente', 'success');
                await cargarDatos(); // Recargar para sincronizar
            } catch (error) {
                ocultarLoading();
                console.error('Error al guardar tiendas:', error);
                // Aunque falle Supabase, localStorage ya guard√≥
                toast('Tiendas guardadas localmente', 'success');
            }
        }

        async function guardarConfigHorarios() {
            const inicio = document.getElementById('horarioInicio')?.value || '08:30';
            const fin = document.getElementById('horarioFin')?.value || '19:00';
            
            mostrarLoading('Guardando horarios...');
            try {
                const config = {
                    tipo: 'horarios',
                    data: { inicio, fin },
                    fecha_actualizacion: new Date().toISOString()
                };
                
                const { data: existing } = await supabase
                    .from('configuraciones')
                    .select('id')
                    .eq('tipo', 'horarios')
                    .single();
                
                if (existing) {
                    await supabase
                        .from('configuraciones')
                        .update({ data: config.data, fecha_actualizacion: new Date().toISOString() })
                        .eq('tipo', 'horarios');
                } else {
                    await supabase
                        .from('configuraciones')
                        .insert([config]);
                }
                
                ocultarLoading();
                toast('Horarios guardados correctamente', 'success');
            } catch (error) {
                ocultarLoading();
                console.error('Error al guardar horarios:', error);
                toast('Error al guardar: ' + error.message, 'error');
            }
        }

        async function guardarConfigGeneral() {
            // Recoger columnas seleccionadas para PICKING
            const columnasPicking = [];
            document.querySelectorAll('#columnasPickingCheckboxes input[type="checkbox"]:checked').forEach(cb => {
                columnasPicking.push(cb.value);
            });
            
            // Recoger columnas seleccionadas para PACKING
            const columnasPacking = [];
            document.querySelectorAll('#columnasPackingCheckboxes input[type="checkbox"]:checked').forEach(cb => {
                columnasPacking.push(cb.value);
            });
            
            mostrarLoading('Guardando configuraci√≥n...');
            try {
                const config = {
                    tipo: 'columnas',
                    data: {
                        picking: columnasPicking,
                        packing: columnasPacking
                    },
                    fecha_actualizacion: new Date().toISOString()
                };
                
                const { data: existing } = await supabase
                    .from('configuraciones')
                    .select('id')
                    .eq('tipo', 'columnas')
                    .single();
                
                if (existing) {
                    await supabase
                        .from('configuraciones')
                        .update({ data: config.data, fecha_actualizacion: new Date().toISOString() })
                        .eq('tipo', 'columnas');
                } else {
                    await supabase
                        .from('configuraciones')
                        .insert([config]);
                }
                
                ocultarLoading();
                toast('Configuraci√≥n guardada correctamente', 'success');
            } catch (error) {
                ocultarLoading();
                console.error('Error al guardar configuraci√≥n:', error);
                toast('Error al guardar: ' + error.message, 'error');
            }
        }

        function restablecerColumnas() {
            if (!confirm('¬øRestablecer columnas a configuraci√≥n predeterminada?')) return;
            
            // Marcar todos los checkboxes de picking
            document.querySelectorAll('#columnasPickingCheckboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
            
            // Marcar todos los checkboxes de packing
            document.querySelectorAll('#columnasPackingCheckboxes input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
            });
            
            toast('Columnas restablecidas (recuerda Guardar)', 'info');
        }

        function aplicarConfiguraciones() {
            // Aplicar tiendas si existen
            const configTiendas = configuraciones.find(c => c.tipo === 'tiendas');
            if (configTiendas && configTiendas.data && Array.isArray(configTiendas.data)) {
                TIENDAS_BASE.length = 0;
                TIENDAS_BASE.push(...configTiendas.data);
                renderizarListaTiendas();
            } else {
                // Si no hay en Supabase, intentar cargar de localStorage
                const localTiendas = localStorage.getItem('mawi_tiendas');
                if (localTiendas) {
                    try {
                        const tiendas = JSON.parse(localTiendas);
                        if (Array.isArray(tiendas) && tiendas.length > 0) {
                            TIENDAS_BASE.length = 0;
                            TIENDAS_BASE.push(...tiendas);
                            renderizarListaTiendas();
                        }
                    } catch (e) {
                        console.error('Error cargando tiendas de localStorage:', e);
                    }
                }
            }
            
            // Aplicar columnas si existen
            const configColumnas = configuraciones.find(c => c.tipo === 'columnas');
            if (configColumnas && configColumnas.data) {
                // Aplicar columnas de picking
                if (configColumnas.data.picking && Array.isArray(configColumnas.data.picking)) {
                    document.querySelectorAll('#columnasPickingCheckboxes input[type="checkbox"]').forEach(cb => {
                        cb.checked = configColumnas.data.picking.includes(cb.value);
                    });
                }
                
                // Aplicar columnas de packing
                if (configColumnas.data.packing && Array.isArray(configColumnas.data.packing)) {
                    document.querySelectorAll('#columnasPackingCheckboxes input[type="checkbox"]').forEach(cb => {
                        cb.checked = configColumnas.data.packing.includes(cb.value);
                    });
                }
            }
            
            // Aplicar horarios si existen
            const configHorarios = configuraciones.find(c => c.tipo === 'horarios');
            if (configHorarios && configHorarios.data) {
                if (configHorarios.data.inicio) {
                    const inputInicio = document.getElementById('horaInicio');
                    if (inputInicio) inputInicio.value = configHorarios.data.inicio;
                }
                if (configHorarios.data.fin) {
                    const inputFin = document.getElementById('horaFin');
                    if (inputFin) inputFin.value = configHorarios.data.fin;
                }
            }
        }

        async function limpiarOrdenesAntiguas() {
            if (!confirm('¬øEliminar √≥rdenes completadas de hace m√°s de 30 d√≠as?')) return;
            mostrarLoading('Limpiando...');
            const fechaLimite = new Date();
            fechaLimite.setDate(fechaLimite.getDate() - 30);
            
            const ordenesAntiguas = ordenes.filter(o => 
                o.estado === 'Completada' && 
                o.fecha_cierre && 
                new Date(o.fecha_cierre) < fechaLimite
            );
            
            for (const o of ordenesAntiguas) {
                await supabase.from('picking').delete().eq('orden_id', o.id);
                await supabase.from('packing').delete().eq('orden_id', o.id);
                await supabase.from('ordenes').delete().eq('id', o.id);
            }
            
            ocultarLoading();
            toast(`${ordenesAntiguas.length} √≥rdenes eliminadas`, 'success');
            await cargarDatos();
        }

        async function exportarBackup() {
            mostrarLoading('Generando backup...');
            const backup = {
                fecha: new Date().toISOString(),
                inventario: inventario,
                productos: productos,
                ordenes: ordenes,
                picking: picking,
                packing: packing,
                reclasificacion: reclasificacion,
                equipos: equipos
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `MAWI_Backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            ocultarLoading();
            toast('Backup exportado', 'success');
        }

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('üîµ DOMContentLoaded - Iniciando sistema...');
            
            // Reintentar inicializar Supabase si no se hizo antes
            if (!supabase) {
                console.log('‚ö†Ô∏è Supabase no inicializado, reintentando...');
                const exito = inicializarSupabase();
                
                if (!exito) {
                    console.error('‚ùå No se pudo inicializar Supabase');
                    toast('Error: No se pudo conectar con la base de datos. Verifica tu conexi√≥n.', 'error');
                    
                    // Mostrar modal de error
                    document.body.innerHTML = `
                        <div style="display:flex;align-items:center;justify-content:center;min-height:100vh;background:#f5f5f5;padding:20px">
                            <div style="background:white;padding:40px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.1);max-width:500px;text-align:center">
                                <h1 style="color:#dc3545;margin-bottom:20px">‚ö†Ô∏è Error de Conexi√≥n</h1>
                                <p style="margin-bottom:20px;color:#666">No se pudo cargar Supabase. Esto puede deberse a:</p>
                                <ul style="text-align:left;margin-bottom:20px;color:#666">
                                    <li>Conexi√≥n a internet inestable</li>
                                    <li>Firewall bloqueando CDN</li>
                                    <li>Extensiones del navegador (AdBlock, etc.)</li>
                                </ul>
                                <button onclick="location.reload()" style="background:#6366f1;color:white;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;font-size:16px">
                                    üîÑ Reintentar
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }
            }
            
            console.log('‚úÖ Supabase disponible, continuando...');
            
            renderIcons();
            await verificarSesion();
            document.getElementById('loginPassword')?.addEventListener('keypress', e => {
                if (e.key === 'Enter') iniciarSesion();
            });
            
            console.log('‚úÖ Sistema inicializado correctamente');
        });

        // ============================================
        // CUBITO LUKERS - VERTICALIZACI√ìN
        // ============================================

        // Funciones auxiliares para CUBITO
        function cubitoFormatDate(date, format = "DD.MM.YYYY") {
            const d = date instanceof Date ? date : new Date(date);
            const dd = String(d.getDate()).padStart(2, "0");
            const mm = String(d.getMonth() + 1).padStart(2, "0");
            const yyyy = d.getFullYear();
            switch (format) {
                case "YYYY-MM-DD": return `${yyyy}-${mm}-${dd}`;
                case "MM/DD/YYYY": return `${mm}/${dd}/${yyyy}`;
                case "DD.MM.YYYY":
                default: return `${dd}.${mm}.${yyyy}`;
            }
        }

        function cubitoAddDaysToDate(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        // Funci√≥n de diagn√≥stico para probar diferentes consultas
        async function diagnosticarProblemaPackings() {
            console.log('üîç ============ DIAGN√ìSTICO CUBITO ============');
            
            // Prueba 1: Obtener estructura de tabla (columnas disponibles)
            console.log('\nüìã Prueba 1: Listando primeros registros sin filtro...');
            try {
                const { data, error } = await supabase
                    .from('packing')
                    .select('*')
                    .limit(3);
                
                if (error) {
                    console.error('‚ùå Error en Prueba 1:', error.message || error);
                } else if (data && data.length > 0) {
                    console.log('‚úÖ Columnas disponibles:', Object.keys(data[0]));
                    console.log('‚úÖ Primer registro:', data[0]);
                } else {
                    console.warn('‚ö†Ô∏è No hay registros en la tabla packing');
                }
            } catch (e) {
                console.error('‚ùå Excepci√≥n en Prueba 1:', e.message);
            }
            
            // Prueba 2: Verificar valores del campo "estado"
            console.log('\nüìä Prueba 2: Valores √∫nicos de estado...');
            try {
                const { data, error } = await supabase
                    .from('packing')
                    .select('estado')
                    .limit(20);
                
                if (error) {
                    console.error('‚ùå Error en Prueba 2:', error.message || error);
                } else {
                    const estados = [...new Set(data.map(p => p.estado))];
                    console.log('‚úÖ Estados encontrados:', estados);
                }
            } catch (e) {
                console.error('‚ùå Excepci√≥n en Prueba 2:', e.message);
            }
            
            // Prueba 3: Contar registros totales
            console.log('\nüî¢ Prueba 3: Contando registros totales...');
            try {
                const { count, error } = await supabase
                    .from('packing')
                    .select('*', { count: 'exact', head: true });
                
                if (error) {
                    console.error('‚ùå Error en Prueba 3:', error.message || error);
                } else {
                    console.log('‚úÖ Total de registros en packing:', count);
                }
            } catch (e) {
                console.error('‚ùå Excepci√≥n en Prueba 3:', e.message);
            }
            
            console.log('\nüîç ============ FIN DIAGN√ìSTICO ============\n');
        }

        // Cargar packings con m√∫ltiples estrategias
        async function cargarPackingsCompletados() {
            try {
                console.log('üîÑ Iniciando carga de packings...');
                
                let packingsData = [];
                let estrategiaUsada = '';
                
                // ESTRATEGIA 1: Intentar con "Completado" (con may√∫scula)
                console.log('üì¶ Estrategia 1: Buscando estado = "Completado"');
                try {
                    const { data, error } = await supabase
                        .from('packing')
                        .select('*')
                        .eq('estado', 'Completado');
                    
                    if (error) {
                        console.warn('‚ö†Ô∏è Estrategia 1 fall√≥:', error.message || error);
                    } else if (data && data.length > 0) {
                        packingsData = data;
                        estrategiaUsada = 'estado="Completado"';
                        console.log('‚úÖ Estrategia 1 exitosa:', packingsData.length, 'registros');
                    } else {
                        console.log('‚ö†Ô∏è Estrategia 1: Sin resultados');
                    }
                } catch (e) {
                    console.error('‚ùå Estrategia 1 excepci√≥n:', e.message);
                }
                
                // ESTRATEGIA 2: Intentar con "completado" (min√∫sculas)
                if (packingsData.length === 0) {
                    console.log('üì¶ Estrategia 2: Buscando estado = "completado"');
                    try {
                        const { data, error } = await supabase
                            .from('packing')
                            .select('*')
                            .eq('estado', 'completado');
                        
                        if (!error && data && data.length > 0) {
                            packingsData = data;
                            estrategiaUsada = 'estado="completado"';
                            console.log('‚úÖ Estrategia 2 exitosa:', packingsData.length, 'registros');
                        }
                    } catch (e) {
                        console.error('‚ùå Estrategia 2 excepci√≥n:', e.message);
                    }
                }
                
                // ESTRATEGIA 3: Intentar con ILIKE (case insensitive)
                if (packingsData.length === 0) {
                    console.log('üì¶ Estrategia 3: Buscando con ILIKE "%completado%"');
                    try {
                        const { data, error } = await supabase
                            .from('packing')
                            .select('*')
                            .ilike('estado', '%completado%');
                        
                        if (!error && data && data.length > 0) {
                            packingsData = data;
                            estrategiaUsada = 'estado ILIKE "%completado%"';
                            console.log('‚úÖ Estrategia 3 exitosa:', packingsData.length, 'registros');
                        }
                    } catch (e) {
                        console.error('‚ùå Estrategia 3 excepci√≥n:', e.message);
                    }
                }
                
                // ESTRATEGIA 4: Traer TODOS los registros y filtrar manualmente
                if (packingsData.length === 0) {
                    console.log('üì¶ Estrategia 4: Cargando TODOS los registros (sin filtro)');
                    try {
                        const { data, error } = await supabase
                            .from('packing')
                            .select('*')
                            .limit(100);
                        
                        if (!error && data && data.length > 0) {
                            // Filtrar manualmente por estado
                            packingsData = data.filter(p => 
                                p.estado && 
                                p.estado.toLowerCase().includes('completado')
                            );
                            estrategiaUsada = 'Sin filtro + filtrado manual';
                            console.log('‚úÖ Estrategia 4: Filtrados', packingsData.length, 'de', data.length, 'registros');
                            
                            // Mostrar estados encontrados
                            const estadosUnicos = [...new Set(data.map(p => p.estado))];
                            console.log('üìä Estados √∫nicos encontrados:', estadosUnicos);
                        }
                    } catch (e) {
                        console.error('‚ùå Estrategia 4 excepci√≥n:', e.message);
                    }
                }
                
                // Si ninguna estrategia funcion√≥, ejecutar diagn√≥stico
                if (packingsData.length === 0) {
                    console.error('‚ùå TODAS LAS ESTRATEGIAS FALLARON');
                    console.log('üîß Ejecutando diagn√≥stico completo...');
                    await diagnosticarProblemaPackings();
                    
                    const select = document.getElementById('cubitoSelectPacking');
                    if (select) {
                        select.innerHTML = '<option value="">No hay packings completados (ver consola)</option>';
                    }
                    toast('No se encontraron packings. Revisa la consola para diagn√≥stico.', 'warning');
                    cubitoPackingsCompletados = [];
                    return;
                }
                
                console.log(`‚úÖ √âXITO: ${packingsData.length} packings encontrados usando: ${estrategiaUsada}`);
                
                // ============================================
                // NUEVA SECCI√ìN: CARGAR √ìRDENES CON M√öLTIPLES INTENTOS
                // ============================================
                
                const ordenIds = [...new Set(packingsData.map(p => p.orden_id).filter(id => id))];
                console.log('üìã Cargando', ordenIds.length, '√≥rdenes relacionadas...');
                
                let ordenesData = [];
                if (ordenIds.length > 0) {
                    // INTENTO 1: Con items_solicitados
                    console.log('üîÑ Intento 1: Consultando √≥rdenes con items_solicitados');
                    try {
                        const { data, error } = await supabase
                            .from('ordenes')
                            .select('id, nombre, items_solicitados')
                            .in('id', ordenIds);
                        
                        if (error) {
                            console.warn('‚ö†Ô∏è Intento 1 fall√≥:', error.message);
                        } else {
                            ordenesData = data || [];
                            console.log('‚úÖ Intento 1 exitoso:', ordenesData.length, '√≥rdenes');
                        }
                    } catch (e) {
                        console.error('‚ùå Intento 1 excepci√≥n:', e.message);
                    }
                    
                    // INTENTO 2: Solo id y nombre (sin items_solicitados)
                    if (ordenesData.length === 0) {
                        console.log('üîÑ Intento 2: Consultando √≥rdenes sin items_solicitados');
                        try {
                            const { data, error } = await supabase
                                .from('ordenes')
                                .select('id, nombre')
                                .in('id', ordenIds);
                            
                            if (error) {
                                console.warn('‚ö†Ô∏è Intento 2 fall√≥:', error.message);
                            } else {
                                ordenesData = data || [];
                                console.log('‚úÖ Intento 2 exitoso:', ordenesData.length, '√≥rdenes (sin items_solicitados)');
                            }
                        } catch (e) {
                            console.error('‚ùå Intento 2 excepci√≥n:', e.message);
                        }
                    }
                    
                    // INTENTO 3: Consultar estructura de la tabla ordenes
                    if (ordenesData.length === 0) {
                        console.log('üîÑ Intento 3: Consultando estructura de tabla ordenes');
                        try {
                            const { data, error } = await supabase
                                .from('ordenes')
                                .select('*')
                                .limit(1);
                            
                            if (!error && data && data.length > 0) {
                                console.log('‚úÖ Columnas disponibles en ordenes:', Object.keys(data[0]));
                                
                                // Intentar cargar con todas las columnas
                                const { data: allData, error: allError } = await supabase
                                    .from('ordenes')
                                    .select('*')
                                    .in('id', ordenIds);
                                
                                if (!allError) {
                                    ordenesData = allData || [];
                                    console.log('‚úÖ Intento 3 exitoso:', ordenesData.length, '√≥rdenes (todas las columnas)');
                                }
                            }
                        } catch (e) {
                            console.error('‚ùå Intento 3 excepci√≥n:', e.message);
                        }
                    }
                    
                    // Si todos los intentos fallan, continuar sin √≥rdenes
                    if (ordenesData.length === 0) {
                        console.warn('‚ö†Ô∏è No se pudieron cargar √≥rdenes. Continuando sin datos de √≥rdenes.');
                        toast('Packings cargados, pero sin informaci√≥n de √≥rdenes', 'warning');
                    }
                }
                
                // Mapear √≥rdenes
                const ordenesMap = {};
                ordenesData.forEach(orden => {
                    ordenesMap[orden.id] = orden;
                });
                
                // Combinar y ordenar datos
                cubitoPackingsCompletados = packingsData
                    .map(pack => ({
                        ...pack,
                        ordenes: ordenesMap[pack.orden_id] || { 
                            nombre: `Orden ${pack.orden_id}`,
                            items_solicitados: []
                        }
                    }))
                    .sort((a, b) => {
                        // Usar fecha_completado si existe, sino usar created_at
                        const fechaA = a.fecha_completado 
                            ? new Date(a.fecha_completado) 
                            : (a.created_at ? new Date(a.created_at) : new Date(0));
                        const fechaB = b.fecha_completado 
                            ? new Date(b.fecha_completado) 
                            : (b.created_at ? new Date(b.created_at) : new Date(0));
                        return fechaB - fechaA;  // M√°s reciente primero
                    });
                
                // Poblar dropdown
                const select = document.getElementById('cubitoSelectPacking');
                if (!select) {
                    console.error('‚ùå Elemento cubitoSelectPacking no encontrado en el DOM');
                    return;
                }
                
                select.innerHTML = '<option value="">Selecciona un packing terminado</option>';
                
                console.log('üìã Poblando dropdown con', cubitoPackingsCompletados.length, 'packings');
                console.log('üìã IDs de packings:', cubitoPackingsCompletados.map(p => ({ id: p.id, tipo: typeof p.id })));
                
                cubitoPackingsCompletados.forEach((pack, index) => {
                    const orden = pack.ordenes;
                    const nombreOrden = orden?.nombre || `Orden ${pack.orden_id || 'sin ID'}`;
                    const parteNum = pack.parte || '?';
                    
                    let fecha = 'Sin fecha';
                    // Usar fecha_completado si existe, sino usar created_at
                    const fechaAUsar = pack.fecha_completado || pack.created_at;
                    if (fechaAUsar) {
                        try {
                            fecha = new Date(fechaAUsar).toLocaleDateString('es-PE', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric'
                            });
                            // Agregar indicador si es fecha de creaci√≥n en lugar de completado
                            if (!pack.fecha_completado && pack.created_at) {
                                fecha += ' (creado)';
                            }
                        } catch (e) {
                            fecha = 'Fecha inv√°lida';
                        }
                    }
                    
                    const option = document.createElement('option');
                    // Convertir expl√≠citamente a string para asegurar comparaci√≥n correcta
                    option.value = String(pack.id);
                    option.textContent = `${nombreOrden} - Parte ${parteNum} (${fecha})`;
                    
                    // Agregar data attribute con el √≠ndice como respaldo
                    option.setAttribute('data-index', index);
                    
                    select.appendChild(option);
                    
                    console.log(`  ‚úì Opci√≥n ${index + 1}: value="${option.value}", ID real="${pack.id}"`);
                });
                
                console.log(`‚úÖ‚úÖ‚úÖ CARGA EXITOSA: ${cubitoPackingsCompletados.length} packings disponibles`);
                toast(`‚úÖ ${cubitoPackingsCompletados.length} packings cargados (${estrategiaUsada})`, 'success');
                
            } catch (error) {
                console.error('‚ùå‚ùå‚ùå ERROR CR√çTICO en cargarPackingsCompletados');
                console.error('Error:', error);
                console.error('Mensaje:', error.message);
                console.error('Stack:', error.stack);
                
                // Ejecutar diagn√≥stico
                console.log('üîß Ejecutando diagn√≥stico de emergencia...');
                await diagnosticarProblemaPackings();
                
                const select = document.getElementById('cubitoSelectPacking');
                if (select) {
                    select.innerHTML = '<option value="">Error cr√≠tico (ver consola)</option>';
                }
                
                cubitoPackingsCompletados = [];
                toast('Error cr√≠tico al cargar packings. Revisa la consola.', 'error');
            }
        }

        // Cargar datos del packing seleccionado
        async function cargarDatosPacking() {
            const selectPacking = document.getElementById('cubitoSelectPacking');
            const packingId = selectPacking.value;
            
            console.log('üîÑ cargarDatosPacking() llamado');
            console.log('  üìã packingId del dropdown:', packingId, 'tipo:', typeof packingId);
            
            if (!packingId) {
                console.log('‚ö†Ô∏è No hay packing seleccionado, reseteando vista');
                document.getElementById('cubitoProcesar').disabled = true;
                cubitoPackingSeleccionado = null;
                
                // Reset estad√≠sticas
                document.getElementById('cubitoTotalTiendas').textContent = '0';
                document.getElementById('cubitoTotalProductos').textContent = '0';
                document.getElementById('cubitoTotalRegistros').textContent = '0';
                
                // Reset tabla
                const tbody = document.getElementById('cubitoTablaResumen');
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--text-secondary)">Seleccione un packing para ver el resumen</td></tr>';
                document.getElementById('cubitoTotalCantidad').innerHTML = '<strong>0</strong>';
                
                return;
            }

            mostrarLoading('Cargando datos del packing...');
            console.log('üì¶ Buscando packing en lista de', cubitoPackingsCompletados.length, 'packings');

            try {
                // Verificar que cubitoPackingsCompletados no est√© vac√≠o
                if (!cubitoPackingsCompletados || cubitoPackingsCompletados.length === 0) {
                    throw new Error('La lista de packings est√° vac√≠a. Intenta recargar la p√°gina.');
                }
                
                // Mostrar IDs disponibles vs buscado
                const idsDisponibles = cubitoPackingsCompletados.map(p => String(p.id));
                console.log('  üìã IDs disponibles:', idsDisponibles);
                console.log('  üîç ID buscado:', packingId);
                
                // M√âTODO 1: Buscar por ID convertido a string
                let pack = cubitoPackingsCompletados.find(p => String(p.id) === String(packingId));
                
                // M√âTODO 2: Si no se encuentra, intentar por √≠ndice (data-index)
                if (!pack) {
                    console.warn('‚ö†Ô∏è No encontrado por ID, intentando por √≠ndice');
                    const selectedOption = selectPacking.options[selectPacking.selectedIndex];
                    const dataIndex = selectedOption?.getAttribute('data-index');
                    
                    if (dataIndex !== null) {
                        const index = parseInt(dataIndex);
                        if (!isNaN(index) && index >= 0 && index < cubitoPackingsCompletados.length) {
                            pack = cubitoPackingsCompletados[index];
                            console.log('‚úÖ Encontrado por √≠ndice:', index);
                        }
                    }
                }
                
                // M√âTODO 3: Buscar comparando sin conversi√≥n (√∫ltimo recurso)
                if (!pack) {
                    console.warn('‚ö†Ô∏è No encontrado por √≠ndice, intentando comparaci√≥n directa');
                    pack = cubitoPackingsCompletados.find(p => p.id == packingId); // == en lugar de ===
                    if (pack) {
                        console.log('‚úÖ Encontrado con comparaci√≥n flexible (==)');
                    }
                }
                
                if (!pack) {
                    console.error('‚ùå Packing NO encontrado despu√©s de 3 intentos');
                    console.error('üìã Lista completa de packings:', cubitoPackingsCompletados);
                    throw new Error(`Packing no encontrado. IDs disponibles: ${idsDisponibles.join(', ')}. ID buscado: ${packingId}`);
                }

                cubitoPackingSeleccionado = pack;
                console.log('‚úÖ Packing encontrado:', pack.id);
                console.log('üì¶ Datos del packing:', {
                    id: pack.id,
                    orden_id: pack.orden_id,
                    parte: pack.parte,
                    items_count: pack.items_empacados?.length || 0
                });
                
                // Obtener items empacados
                const itemsEmpacados = pack.items_empacados || [];
                console.log('üì¶ Items empacados:', itemsEmpacados.length);
                
                if (itemsEmpacados.length === 0) {
                    ocultarLoading();
                    toast('Este packing no tiene items empacados', 'warning');
                    console.warn('‚ö†Ô∏è Packing sin items empacados');
                    return;
                }
                
                // Mostrar estructura del primer item
                console.log('üîç Estructura del primer item:', itemsEmpacados[0]);
                console.log('üîë Campos disponibles:', Object.keys(itemsEmpacados[0]));

                // =================================================================
                // LEER items_empacados con estructura: distribucion: {tienda: cantidad}
                // =================================================================
                console.log('üìä LEYENDO DISTRIBUCI√ìN DESDE item.distribucion');
                
                const resumenPorTienda = {};
                let totalItems = 0;
                let itemsValidos = 0;
                let itemsInvalidos = 0;

                itemsEmpacados.forEach((item, index) => {
                    const variante = item.variante || item.Variante || item.VARIANTE;
                    const distribucion = item.distribucion || item.Distribucion || item.DISTRIBUCION || {};
                    
                    console.log(`  üìã Item ${index + 1}:`, {
                        variante,
                        cantidad_total: item.cantidad,
                        num_tiendas: Object.keys(distribucion).length,
                        distribucion
                    });

                    // Verificar que tenga distribuci√≥n
                    if (!distribucion || Object.keys(distribucion).length === 0) {
                        console.warn(`    ‚ö†Ô∏è Item ${index + 1}: Sin distribuci√≥n`);
                        itemsInvalidos++;
                        return;
                    }

                    // Recorrer cada tienda en la distribuci√≥n
                    let itemTieneAlgunaValida = false;
                    Object.entries(distribucion).forEach(([tienda, cantidad]) => {
                        const cantidadNum = Number(cantidad);
                        
                        // Validar tienda y cantidad
                        if (CUBITO_TIENDA_MAPPING[tienda] && cantidadNum > 0) {
                            if (!resumenPorTienda[tienda]) {
                                resumenPorTienda[tienda] = 0;
                            }
                            resumenPorTienda[tienda] += cantidadNum;
                            totalItems += cantidadNum;
                            itemTieneAlgunaValida = true;
                            
                            console.log(`    ‚úÖ ${tienda} ‚Üí ${cantidadNum} unidades de ${variante}`);
                        } else {
                            if (!CUBITO_TIENDA_MAPPING[tienda]) {
                                console.warn(`    ‚ö†Ô∏è Tienda "${tienda}" no est√° en CUBITO_TIENDA_MAPPING`);
                            } else if (cantidadNum <= 0) {
                                console.warn(`    ‚ö†Ô∏è Cantidad inv√°lida para ${tienda}: ${cantidad}`);
                            }
                        }
                    });

                    if (itemTieneAlgunaValida) {
                        itemsValidos++;
                    } else {
                        itemsInvalidos++;
                    }
                });

                console.log('üìä Resumen de procesamiento:');
                console.log(`  ‚úÖ Items con distribuci√≥n v√°lida: ${itemsValidos}`);
                console.log(`  ‚ö†Ô∏è Items sin distribuci√≥n v√°lida: ${itemsInvalidos}`);
                console.log(`  üì¶ Total unidades: ${totalItems}`);
                console.log('üìä Resumen por tienda:', resumenPorTienda);

                // Validar que hay datos v√°lidos
                if (Object.keys(resumenPorTienda).length === 0 || totalItems === 0) {
                    ocultarLoading();
                    
                    let errorMsg = `No se encontraron items v√°lidos.\n\n`;
                    errorMsg += `Items procesados: ${itemsEmpacados.length}\n`;
                    errorMsg += `Items con distribuci√≥n v√°lida: ${itemsValidos}\n`;
                    errorMsg += `Items sin distribuci√≥n v√°lida: ${itemsInvalidos}\n\n`;
                    
                    if (itemsInvalidos > 0) {
                        errorMsg += 'Revisa la consola para ver detalles.\n\n';
                        errorMsg += 'Posibles causas:\n';
                        errorMsg += '- Tiendas no configuradas en CUBITO_TIENDA_MAPPING\n';
                        errorMsg += '- Cantidades en 0 o negativas\n';
                        errorMsg += '- Campo "distribucion" vac√≠o o inexistente';
                    }
                    
                    toast(errorMsg, 'error');
                    console.error('‚ùå No hay items v√°lidos');
                    return;
                }

                // Actualizar estad√≠sticas
                const numTiendas = Object.keys(resumenPorTienda).length;
                const numProductos = new Set(itemsEmpacados
                    .map(i => i.variante || i.Variante || i.VARIANTE)
                    .filter(v => v)
                ).size;
                
                // Contar registros totales (cada variante x cada tienda donde est√°)
                let numRegistros = 0;
                itemsEmpacados.forEach(item => {
                    const distribucion = item.distribucion || {};
                    Object.entries(distribucion).forEach(([tienda, cantidad]) => {
                        if (CUBITO_TIENDA_MAPPING[tienda] && Number(cantidad) > 0) {
                            numRegistros++;
                        }
                    });
                });

                console.log('üìä Estad√≠sticas finales:', {
                    tiendas: numTiendas,
                    productos: numProductos,
                    registros: numRegistros
                });

                document.getElementById('cubitoTotalTiendas').textContent = numTiendas;
                document.getElementById('cubitoTotalProductos').textContent = numProductos;
                document.getElementById('cubitoTotalRegistros').textContent = numRegistros;

                // Actualizar resumen en tabla
                actualizarResumenTiendas(resumenPorTienda);

                // Habilitar bot√≥n de procesar
                document.getElementById('cubitoProcesar').disabled = false;

                ocultarLoading();
                console.log('‚úÖ Packing cargado correctamente');
                toast(`‚úÖ Packing cargado: ${numRegistros} registros de ${numProductos} productos en ${numTiendas} tiendas`, 'success');

            } catch (error) {
                console.error('‚ùå Error en cargarDatosPacking:', error);
                console.error('Tipo:', error.name);
                console.error('Mensaje:', error.message);
                console.error('Stack:', error.stack);
                
                ocultarLoading();
                toast('Error: ' + error.message, 'error');
                
                // Reset estado
                document.getElementById('cubitoProcesar').disabled = true;
                cubitoPackingSeleccionado = null;
            }
        }

        // Actualizar tabla de resumen de tiendas
        function actualizarResumenTiendas(resumenPorTienda) {
            const tbody = document.getElementById('cubitoTablaResumen');
            tbody.innerHTML = '';
            
            const totalCantidad = Object.values(resumenPorTienda).reduce((sum, cant) => sum + cant, 0);
            
            if (totalCantidad === 0) {
                tbody.innerHTML = `<tr>
                    <td colspan="4" style="text-align:center;padding:3rem;color:#a0aec0;background:white">
                        <div style="font-size:2rem;margin-bottom:0.5rem">‚ÑπÔ∏è</div>
                        <div style="font-size:0.9rem">No hay datos disponibles</div>
                    </td>
                </tr>`;
                document.getElementById('cubitoTotalCantidad').textContent = '0';
                return;
            }
            
            Object.entries(resumenPorTienda)
                .sort((a, b) => b[1] - a[1])
                .forEach(([tienda, cantidad]) => {
                    const config = CUBITO_TIENDA_MAPPING[tienda];
                    if (!config) return;
                    
                    const sociedad = config.Sociedad;
                    const porcentaje = ((cantidad / totalCantidad) * 100).toFixed(2);
                    
                    // Badge simple seg√∫n imagen
                    const badgeStyle = sociedad === 'R050' 
                        ? 'background:#6366f1;color:white;padding:0.35rem 0.75rem;border-radius:12px;font-size:0.75rem;font-weight:600;display:inline-block'
                        : 'background:#ec4899;color:white;padding:0.35rem 0.75rem;border-radius:12px;font-size:0.75rem;font-weight:600;display:inline-block';
                    
                    const tr = document.createElement('tr');
                    tr.style.background = 'white';
                    tr.style.borderBottom = '1px solid #f1f5f9';
                    
                    tr.innerHTML = `
                        <td style="padding:0.85rem;color:#2d3748;font-size:0.85rem">
                            <div style="display:flex;align-items:center;gap:0.5rem">
                                <span style="font-size:1.1rem">üè™</span>
                                <strong>${tienda}</strong>
                            </div>
                        </td>
                        <td style="padding:0.85rem;text-align:center">
                            <span style="${badgeStyle}">${sociedad}</span>
                        </td>
                        <td style="padding:0.85rem;text-align:center;color:#2d3748;font-weight:700;font-size:0.95rem">${cantidad.toLocaleString()}</td>
                        <td style="padding:0.85rem;text-align:center;color:#2d3748;font-weight:600;font-size:0.9rem">${porcentaje}%</td>
                    `;
                    tbody.appendChild(tr);
                });
            
            document.getElementById('cubitoTotalCantidad').textContent = totalCantidad.toLocaleString();
        }

        // Filtrar tabla de resumen
        function filtrarResumenTiendas() {
            const searchTerm = document.getElementById('cubitoSearchResumen').value.toLowerCase();
            const rows = document.querySelectorAll('#cubitoTablaResumen tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // Procesar verticalizaci√≥n
        async function procesarVerticalizado() {
            if (!cubitoPackingSeleccionado) {
                toast('No hay packing seleccionado', 'error');
                return;
            }

            mostrarLoading('Verticalizando datos...');
            console.log('üîÑ Iniciando verticalizaci√≥n...');

            try {
                const textoCabecera = document.getElementById('cubitoTextoCabecera').value.trim();
                const fechaActual = document.getElementById('cubitoFecha').value;
                let fechaEntregaR050 = document.getElementById('cubitoFechaR050').value;
                let fechaEntregaR040 = document.getElementById('cubitoFechaR040').value;

                // Validar y calcular fechas si no est√°n definidas
                if (!fechaEntregaR050) {
                    fechaEntregaR050 = cubitoFormatDate(cubitoAddDaysToDate(new Date(), 15), "YYYY-MM-DD");
                    document.getElementById('cubitoFechaR050').value = fechaEntregaR050;
                }
                if (!fechaEntregaR040) {
                    fechaEntregaR040 = cubitoFormatDate(cubitoAddDaysToDate(new Date(), 26), "YYYY-MM-DD");
                    document.getElementById('cubitoFechaR040').value = fechaEntregaR040;
                }

                console.log('üìÖ Fechas configuradas:');
                console.log('  - Actual:', fechaActual);
                console.log('  - R050:', fechaEntregaR050);
                console.log('  - R040:', fechaEntregaR040);

                const itemsEmpacados = cubitoPackingSeleccionado.items_empacados || [];
                const orden = cubitoPackingSeleccionado.ordenes;
                const itemsSolicitados = orden?.items_solicitados || [];

                if (itemsEmpacados.length === 0) {
                    throw new Error('No hay items empacados en este packing');
                }

                console.log('üì¶ Items a procesar:', itemsEmpacados.length);

                // Crear estructura de datos para verticalizaci√≥n
                cubitoOutputData = [];

                // =================================================================
                // LEER items_empacados con estructura: item.distribucion = {tienda: cantidad}
                // =================================================================
                console.log('üìä GENERANDO REGISTROS SAP DESDE item.distribucion');

                let registrosGenerados = 0;
                let registrosInvalidos = 0;
                
                itemsEmpacados.forEach((item, index) => {
                    const variante = item.variante || item.Variante || item.VARIANTE;
                    const distribucion = item.distribucion || item.Distribucion || item.DISTRIBUCION || {};
                    
                    // üîÑ NUEVO: Usar variante unificada si existe (solo para Cubito)
                    const varianteUnificada = item.variante_unificada || item.Variante_Unificada;
                    const varianteParaCubito = varianteUnificada || variante;  // Prioridad a unificada
                    
                    if (varianteUnificada) {
                        console.log(`üîÑ Usando variante unificada: ${variante} ‚Üí ${varianteUnificada}`);
                    }
                    
                    // Validar que tenga variante
                    if (!variante) {
                        console.warn(`‚ö†Ô∏è Item ${index + 1}: Sin variante`, item);
                        registrosInvalidos++;
                        return;
                    }
                    
                    // Validar que tenga distribuci√≥n
                    if (!distribucion || Object.keys(distribucion).length === 0) {
                        console.warn(`‚ö†Ô∏è Item ${index + 1}: Sin distribuci√≥n`, item);
                        registrosInvalidos++;
                        return;
                    }
                    
                    // Procesar cada tienda en la distribuci√≥n
                    Object.entries(distribucion).forEach(([tienda, cantidad]) => {
                        const cantidadNum = Number(cantidad);
                        
                        // Validar tienda
                        if (!CUBITO_TIENDA_MAPPING[tienda]) {
                            console.warn(`‚ö†Ô∏è Item ${index + 1}: Tienda "${tienda}" no configurada`);
                            registrosInvalidos++;
                            return;
                        }
                        
                        // Validar cantidad
                        if (cantidadNum <= 0) {
                            console.warn(`‚ö†Ô∏è Item ${index + 1}: Cantidad inv√°lida para ${tienda}: ${cantidad}`);
                            registrosInvalidos++;
                            return;
                        }
                        
                        // Generar registro SAP
                        const config = CUBITO_TIENDA_MAPPING[tienda];
                        const fechaEntrega = config.Sociedad === "R050"
                            ? cubitoFormatDate(new Date(fechaEntregaR050), "DD.MM.YYYY")
                            : cubitoFormatDate(new Date(fechaEntregaR040), "DD.MM.YYYY");

                        cubitoOutputData.push({
                            TIENDAS: tienda,
                            Ind: "",
                            Clase: config.Clase,
                            Proveedor: config.Proveedor,
                            FechaDocCompra: fechaActual,
                            OrgCompra: config.OrgCompra,
                            GrupoCompra: config.GrupoCompra,
                            Sociedad: config.Sociedad,
                            CondPago: config.CondPago,
                            TextoCabecera: textoCabecera,
                            Material: varianteParaCubito,  // ‚úÖ USA VARIANTE UNIFICADA SI EXISTE
                            Cantidad: cantidadNum,
                            PrecioNeto: config.PrecioNeto,
                            CentroTienda: config.CentroTienda,
                            Almacen: config.Almacen,
                            Solicitante: config.Solicitante,
                            AlmacenProcedencia: config.AlmacenProcedencia,
                            FechaEntrega: fechaEntrega
                        });
                        
                        registrosGenerados++;
                        
                        if (registrosGenerados <= 5) {  // Mostrar primeros 5 para debugging
                            console.log(`  ‚úÖ Registro ${registrosGenerados}:`, {
                                tienda,
                                variante_original: variante,
                                variante_cubito: varianteParaCubito,
                                cantidad: cantidadNum,
                                sociedad: config.Sociedad
                            });
                        }
                    });
                });

                console.log('üìä Resumen de generaci√≥n:');
                console.log(`  ‚úÖ Registros generados: ${registrosGenerados}`);
                console.log(`  ‚ö†Ô∏è Registros inv√°lidos: ${registrosInvalidos}`);

                if (cubitoOutputData.length === 0) {
                    throw new Error('No se generaron registros. Verifica la distribuci√≥n.');
                }

                // Ordenar por tienda y material
                cubitoOutputData.sort((a, b) => {
                    const tiendaCmp = a.TIENDAS.localeCompare(b.TIENDAS);
                    if (tiendaCmp !== 0) return tiendaCmp;
                    return a.Material.localeCompare(b.Material);
                });

                // Marcar indicadores H/D
                let currentTienda = "";
                cubitoOutputData.forEach(row => {
                    row.Ind = row.TIENDAS !== currentTienda ? "H" : "D";
                    currentTienda = row.TIENDAS;
                });

                console.log('‚úÖ Verticalizaci√≥n completada:', cubitoOutputData.length, 'registros');

                // Habilitar botones
                document.getElementById('cubitoVisualizarBtn').disabled = false;
                document.getElementById('btnExportarCubito').disabled = false;

                ocultarLoading();
                toast(`‚úÖ ${cubitoOutputData.length} registros verticalizados correctamente`, 'success');

            } catch (error) {
                console.error('‚ùå Error al verticalizar:', error);
                ocultarLoading();
                toast('Error al procesar verticalizaci√≥n: ' + error.message, 'error');
            }
        }

        // Visualizar datos verticalizados
        // Funci√≥n para abrir modal de selecci√≥n de sociedad
        function abrirModalSeleccionSociedad() {
            if (cubitoOutputData.length === 0) {
                toast('No hay datos para visualizar', 'warning');
                return;
            }
            abrirModal('modalSeleccionSociedad');
        }
        
        // Funci√≥n para visualizar datos filtrados por sociedad (Estilo Excel)
        function visualizarDatosVerticalizados(sociedadFiltro) {
            if (cubitoOutputData.length === 0) {
                toast('No hay datos para visualizar', 'warning');
                return;
            }

            console.log(`üëÅÔ∏è Visualizando sociedad: ${sociedadFiltro}`);

            // Filtrar datos seg√∫n sociedad
            let datosFiltrados;
            if (sociedadFiltro === 'R050') {
                datosFiltrados = cubitoOutputData.filter(row => row.Sociedad === 'R050');
            } else if (sociedadFiltro === 'R040') {
                datosFiltrados = cubitoOutputData.filter(row => row.Sociedad === 'R040');
            } else {
                datosFiltrados = cubitoOutputData;
            }

            console.log(`üìä Mostrando ${datosFiltrados.length} registros de ${sociedadFiltro}`);

            if (datosFiltrados.length === 0) {
                toast(`No hay registros para la sociedad ${sociedadFiltro}`, 'info');
                return;
            }

            // Preparar tabla modal
            const table = document.getElementById('cubitoTablaModal');
            const headers = Object.keys(datosFiltrados[0]);
            
            // Crear encabezado de tabla estilo Excel
            const crearEncabezado = () => headers.map(h => `
                <th style="
                    padding:0.75rem 0.875rem;
                    background:#f7fafc;
                    color:#4a5568;
                    font-weight:700;
                    font-size:0.75rem;
                    text-transform:uppercase;
                    letter-spacing:0.5px;
                    border:1px solid #e2e8f0;
                    text-align:left;
                    white-space:nowrap;
                    position:sticky;
                    top:0;
                    z-index:10
                ">${h}</th>
            `).join("");
            
            // Crear filas de datos
            const crearFilas = () => {
                return datosFiltrados.map((row, index) => {
                    const bgColor = index % 2 === 0 ? '#ffffff' : '#f9fafb';
                    return `<tr style="
                        background:${bgColor};
                        transition:background 0.15s ease
                    " onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='${bgColor}'">
                        ${headers.map(h => {
                            let cellStyle = 'padding:0.65rem 0.875rem;font-size:0.8rem;border:1px solid #e2e8f0;color:#1f2937';
                            let content = row[h] || '';
                            
                            // Estilos especiales por columna
                            if (h === 'TIENDAS') {
                                cellStyle += ';font-weight:700;color:#1e40af';
                            } else if (h === 'Material') {
                                cellStyle += ';font-weight:600;color:#7c3aed;font-family:Consolas,monospace';
                            } else if (h === 'Cantidad') {
                                cellStyle += ';font-weight:700;color:#059669;text-align:center';
                            } else if (h === 'Sociedad') {
                                const isR050 = row[h] === 'R050';
                                const badgeColor = isR050 
                                    ? 'background:#dbeafe;color:#1e40af'
                                    : 'background:#fef3c7;color:#d97706';
                                content = `<span style="${badgeColor};padding:0.25rem 0.75rem;border-radius:6px;font-weight:700;font-size:0.75rem;display:inline-block">${row[h]}</span>`;
                                cellStyle += ';text-align:center';
                            } else if (h === 'Ind') {
                                if (row[h] && row[h] !== '') {
                                    const indColor = row[h] === 'H' 
                                        ? 'background:#d1fae5;color:#065f46'
                                        : 'background:#f3f4f6;color:#6b7280';
                                    content = `<span style="${indColor};padding:0.25rem 0.625rem;border-radius:4px;font-weight:700;font-size:0.7rem;display:inline-block">${row[h]}</span>`;
                                }
                                cellStyle += ';text-align:center';
                            } else if (h === 'PrecioNeto') {
                                cellStyle += ';font-weight:600;text-align:right;font-family:Consolas,monospace';
                            }
                            
                            return `<td style="${cellStyle}">${content}</td>`;
                        }).join("")}
                    </tr>`;
                }).join("");
            };
            
            // Construir tabla completa estilo Excel
            table.innerHTML = `
                <thead>
                    <tr>${crearEncabezado()}</tr>
                </thead>
                <tbody>
                    ${crearFilas()}
                </tbody>
            `;

            cubitoCurrentFilteredData = [...datosFiltrados];
            abrirModal('modalCubitoVisualizacion');
            
            // Reiniciar lucide icons
            setTimeout(() => renderIcons(), 100);
        }
        
        // Funci√≥n para filtrar datos en el modal con b√∫squeda
        function filtrarDatosModal() {
            const searchTerm = document.getElementById('cubitoSearchModal').value.toLowerCase();
            const tbody = document.getElementById('cubitoTablaModal').getElementsByTagName('tbody')[0];
            const rows = tbody.getElementsByTagName('tr');
            
            for (let row of rows) {
                const cells = row.getElementsByTagName('td');
                let found = false;
                
                for (let cell of cells) {
                    if (cell.textContent.toLowerCase().includes(searchTerm)) {
                        found = true;
                        break;
                    }
                }
                
                row.style.display = found ? '' : 'none';
            }
        }

        // Filtrar tabla modal
        function filtrarTablaModal() {
            const searchTerm = document.getElementById('cubitoSearchModal').value.toLowerCase();
            const rows = document.querySelectorAll('#cubitoTablaModal tbody tr');
            
            let visibleCount = 0;
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                const isVisible = text.includes(searchTerm);
                row.style.display = isVisible ? '' : 'none';
                if (isVisible) visibleCount++;
            });
            
            // Actualizar contador
            const contador = document.getElementById('cubitoContadorRegistros');
            if (contador) {
                if (searchTerm) {
                    contador.textContent = `${visibleCount} de ${rows.length} registros`;
                } else {
                    contador.textContent = `${rows.length} registros`;
                }
            }
        }

        // Copiar datos del cubito
        function copiarDatosCubito() {
            if (cubitoOutputData.length === 0) {
                toast('No hay datos para copiar', 'warning');
                return;
            }

            try {
                const headers = Object.keys(cubitoOutputData[0]);
                const dataHeaders = headers.slice(1); // Sin columna TIENDAS
                
                let tableText = "";
                cubitoOutputData.forEach(row => {
                    const values = dataHeaders.map(h => row[h] || '');
                    tableText += values.join("\t") + "\n";
                });

                if (navigator.clipboard) {
                    navigator.clipboard.writeText(tableText).then(() => {
                        toast("‚úÖ Datos copiados al portapapeles (sin tiendas)", "success");
                    }).catch(() => {
                        fallbackCopyTextCubito(tableText);
                    });
                } else {
                    fallbackCopyTextCubito(tableText);
                }
            } catch (error) {
                console.error('Error copiando datos:', error);
                toast('Error al copiar datos', 'error');
            }
        }

        // Copiar datos del modal
        function copiarDatosCubitoModal() {
            if (cubitoCurrentFilteredData.length === 0) {
                toast('No hay datos para copiar', 'warning');
                return;
            }

            try {
                const headers = Object.keys(cubitoCurrentFilteredData[0]);
                const dataHeaders = headers.slice(1);
                
                let tableText = "";
                cubitoCurrentFilteredData.forEach(row => {
                    const values = dataHeaders.map(h => row[h] || '');
                    tableText += values.join("\t") + "\n";
                });

                if (navigator.clipboard) {
                    navigator.clipboard.writeText(tableText).then(() => {
                        toast("‚úÖ Datos copiados al portapapeles", "success");
                    }).catch(() => {
                        fallbackCopyTextCubito(tableText);
                    });
                } else {
                    fallbackCopyTextCubito(tableText);
                }
            } catch (error) {
                console.error('Error copiando datos:', error);
                toast('Error al copiar datos', 'error');
            }
        }

        // Fallback para copiar texto
        function fallbackCopyTextCubito(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.top = "-9999px";
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand("copy");
                toast("‚úÖ Datos copiados al portapapeles", "success");
            } catch (error) {
                toast('No se pudieron copiar los datos', 'error');
            }
            document.body.removeChild(textArea);
        }

        // Exportar datos verticalizados
        function exportarVerticalizados() {
            if (cubitoOutputData.length === 0) {
                toast('No hay datos para exportar', 'warning');
                return;
            }

            try {
                const ws = XLSX.utils.json_to_sheet(cubitoOutputData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Datos Verticalizados");
                
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-');
                const nombreOrden = cubitoPackingSeleccionado?.ordenes?.nombre || 'Packing';
                XLSX.writeFile(wb, `Cubito_${nombreOrden}_${timestamp}.xlsx`);
                
                toast('‚úÖ Archivo Excel descargado correctamente', 'success');
            } catch (error) {
                console.error('Error exportando:', error);
                toast('Error al exportar archivo', 'error');
            }
        }

        // Inicializar fecha actual del cubito
        function inicializarCubito() {
            const hoy = new Date();
            document.getElementById('cubitoFecha').value = cubitoFormatDate(hoy, "DD.MM.YYYY");
            
            // Calcular fechas de entrega
            const r050Input = document.getElementById("cubitoFechaR050");
            const r040Input = document.getElementById("cubitoFechaR040");
            if (!r050Input.value) r050Input.value = cubitoFormatDate(cubitoAddDaysToDate(hoy, 15), "YYYY-MM-DD");
            if (!r040Input.value) r040Input.value = cubitoFormatDate(cubitoAddDaysToDate(hoy, 26), "YYYY-MM-DD");
        }

        console.log('‚úÖ MAWI v7.3 - Sistema con notificaciones y optimizaci√≥n');
        
        // Iniciar sistema de verificaci√≥n autom√°tica despu√©s de cargar datos
        cargarDatos().then(() => {
            iniciarVerificacionAutomatica();
            console.log('üîî Sistema de notificaciones activo (verifica cada 30s)');
        });
    </script>
</body>
</html>
