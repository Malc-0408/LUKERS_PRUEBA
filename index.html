<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAWI v7.0 - Sistema Lukers</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            --primary:#6366f1;--primary-dark:#4f46e5;--primary-light:#818cf8;
            --success:#10b981;--warning:#f59e0b;--danger:#ef4444;--info:#3b82f6;--purple:#a855f7;
            --bg-main:#0f172a;--bg-card:#fff;--bg-hover:#f1f5f9;
            --text-primary:#0f172a;--text-secondary:#64748b;--text-light:#94a3b8;--text-white:#fff;
            --border:#e2e8f0;--shadow:0 4px 6px -1px rgba(0,0,0,0.1);--shadow-lg:0 20px 25px -5px rgba(0,0,0,0.1)
        }
        body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh}
        
        /* LOGIN */
        .login-container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem}
        .login-card{background:#fff;padding:3rem;border-radius:20px;box-shadow:0 25px 50px -12px rgba(0,0,0,0.25);max-width:420px;width:100%}
        .login-logo{width:70px;height:70px;background:linear-gradient(135deg,var(--primary),#818cf8);border-radius:16px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:2rem;margin:0 auto 1.5rem}
        .login-title{font-size:2rem;font-weight:800;text-align:center;margin-bottom:0.5rem}
        .login-subtitle{text-align:center;color:var(--text-secondary);margin-bottom:2rem}
        
        /* FORMS */
        .form-group{margin-bottom:1.25rem}
        .form-label{display:block;font-weight:600;margin-bottom:0.5rem;font-size:0.875rem}
        .form-input,.form-select,.form-textarea{width:100%;padding:0.75rem 1rem;border:2px solid var(--border);border-radius:10px;font-size:0.9rem;transition:all 0.2s;font-family:inherit}
        .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(99,102,241,0.1)}
        .form-input-sm{padding:0.5rem 0.75rem;font-size:0.8rem}
        .form-textarea{min-height:80px;resize:vertical}
        .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem}
        .form-help{font-size:0.75rem;color:var(--text-secondary);margin-top:0.5rem}
        .form-check{display:flex;align-items:center;gap:0.5rem;cursor:pointer}
        .form-check input{width:16px;height:16px;cursor:pointer}
        
        /* BUTTONS */
        .btn{padding:0.6rem 1rem;border:none;border-radius:8px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:0.4rem;transition:all 0.2s;font-size:0.8rem}
        .btn-sm{padding:0.4rem 0.75rem;font-size:0.75rem}
        .btn-lg{padding:0.875rem 1.5rem;font-size:0.9rem}
        .btn-primary{background:var(--primary);color:#fff}
        .btn-primary:hover{background:var(--primary-dark);transform:translateY(-2px)}
        .btn-success{background:var(--success);color:#fff}
        .btn-warning{background:var(--warning);color:#fff}
        .btn-danger{background:var(--danger);color:#fff}
        .btn-info{background:var(--info);color:#fff}
        .btn-purple{background:var(--purple);color:#fff}
        .btn-outline{background:#fff;color:var(--primary);border:2px solid var(--primary)}
        .btn-outline:hover{background:var(--primary);color:#fff}
        .btn-ghost{background:transparent;color:var(--text-secondary)}
        .btn-ghost:hover{background:var(--bg-hover)}
        .btn-full{width:100%;justify-content:center}
        .btn-icon{width:32px;height:32px;padding:0;justify-content:center}
        .btn:disabled{opacity:0.5;cursor:not-allowed}
        
        /* LAYOUT */
        .app-container{display:none;height:100vh;overflow:hidden}
        .sidebar{width:260px;background:var(--bg-main);display:flex;flex-direction:column}
        .sidebar-header{padding:1.25rem;border-bottom:1px solid rgba(255,255,255,0.1)}
        .logo-container{display:flex;align-items:center;gap:0.75rem}
        .logo-icon{width:42px;height:42px;background:linear-gradient(135deg,var(--primary),#818cf8);border-radius:12px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:1.2rem}
        .logo-title{font-size:1.2rem;font-weight:700;color:#fff}
        .logo-subtitle{font-size:0.65rem;color:#94a3b8}
        
        .nav-menu{flex:1;padding:1rem;overflow-y:auto}
        .nav-section{margin-bottom:1.5rem}
        .nav-section-title{font-size:0.65rem;font-weight:600;text-transform:uppercase;color:#94a3b8;padding:0 0.75rem;margin-bottom:0.5rem;letter-spacing:0.05em}
        .nav-item{display:flex;align-items:center;gap:0.6rem;padding:0.65rem 0.75rem;border-radius:8px;cursor:pointer;color:#94a3b8;transition:all 0.2s;margin-bottom:0.25rem;font-size:0.85rem}
        .nav-item:hover{background:rgba(255,255,255,0.05);color:#fff}
        .nav-item.active{background:var(--primary);color:#fff}
        .nav-item i{width:18px;height:18px}
        .nav-badge{margin-left:auto;background:var(--danger);color:#fff;font-size:0.65rem;padding:0.15rem 0.5rem;border-radius:10px;font-weight:600}
        
        .user-profile{padding:1rem;border-top:1px solid rgba(255,255,255,0.1)}
        .user-info{display:flex;align-items:center;gap:0.6rem;padding:0.6rem;background:rgba(255,255,255,0.05);border-radius:8px;cursor:pointer}
        .user-avatar{width:36px;height:36px;background:linear-gradient(135deg,var(--primary),#818cf8);border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;font-size:0.9rem}
        .user-name{color:#fff;font-weight:600;font-size:0.85rem}
        .user-role{color:#94a3b8;font-size:0.7rem}
        
        .main-content{flex:1;display:flex;flex-direction:column;overflow:hidden;background:#f8fafc}
        .header{background:#fff;padding:1rem 1.5rem;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:0.75rem}
        .header-left{display:flex;flex-direction:column}
        .header-title{font-size:1.35rem;font-weight:700}
        .header-breadcrumb{font-size:0.75rem;color:var(--text-secondary);display:flex;align-items:center;gap:0.4rem}
        .header-actions{display:flex;gap:0.5rem;align-items:center;flex-wrap:wrap}
        .content-area{flex:1;overflow-y:auto;padding:1.5rem}
        
        /* STATS */
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1.25rem;margin-bottom:1.5rem}
        .stat-card{background:#fff;padding:1.25rem;border-radius:14px;box-shadow:var(--shadow);transition:transform 0.2s}
        .stat-card:hover{transform:translateY(-3px)}
        .stat-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.75rem}
        .stat-icon{width:46px;height:46px;border-radius:12px;display:flex;align-items:center;justify-content:center}
        .stat-icon.blue{background:rgba(99,102,241,0.1);color:var(--primary)}
        .stat-icon.green{background:rgba(16,185,129,0.1);color:var(--success)}
        .stat-icon.orange{background:rgba(245,158,11,0.1);color:var(--warning)}
        .stat-icon.red{background:rgba(239,68,68,0.1);color:var(--danger)}
        .stat-icon.purple{background:rgba(168,85,247,0.1);color:var(--purple)}
        .stat-value{font-size:1.85rem;font-weight:800;margin-bottom:0.25rem}
        .stat-label{color:var(--text-secondary);font-size:0.8rem}
        .stat-footer{margin-top:0.75rem;padding-top:0.75rem;border-top:1px solid var(--border);display:flex;justify-content:space-between;font-size:0.7rem}
        .stat-footer-label{color:var(--text-secondary)}
        .stat-footer-value{font-weight:600}
        
        /* FILTERS */
        .filters-bar{background:#fff;padding:1rem 1.25rem;border-radius:12px;margin-bottom:1.25rem;display:flex;gap:1rem;align-items:center;flex-wrap:wrap;box-shadow:var(--shadow)}
        .filter-group{display:flex;align-items:center;gap:0.5rem}
        .filter-label{font-size:0.75rem;font-weight:600;color:var(--text-secondary)}
        
        /* CHARTS */
        .charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:1.25rem;margin-bottom:1.5rem}
        .chart-card{background:#fff;padding:1.25rem;border-radius:14px;box-shadow:var(--shadow)}
        .chart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
        .chart-title{font-size:0.95rem;font-weight:600;display:flex;align-items:center;gap:0.5rem}
        .chart-wrapper{height:280px;position:relative}
        
        /* CARDS */
        .card{background:#fff;border-radius:14px;padding:1.25rem;box-shadow:var(--shadow);margin-bottom:1.25rem}
        .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem;padding-bottom:1rem;border-bottom:2px solid var(--border);flex-wrap:wrap;gap:0.75rem}
        .card-title{font-size:1.05rem;font-weight:700;display:flex;align-items:center;gap:0.5rem}
        .card-actions{display:flex;gap:0.5rem;flex-wrap:wrap}
        
        /* TABLES */
        .table-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:0.75rem}
        .table-container{overflow-x:auto}
        table{width:100%;border-collapse:collapse;font-size:0.8rem}
        th,td{padding:0.7rem 0.6rem;text-align:left;border-bottom:1px solid var(--border)}
        th{background:var(--bg-hover);font-weight:600;font-size:0.7rem;text-transform:uppercase;color:var(--text-secondary);white-space:nowrap;position:sticky;top:0}
        tr:hover{background:var(--bg-hover)}
        td{white-space:nowrap}
        .td-wrap{white-space:normal;max-width:220px;font-size:0.75rem;line-height:1.4}
        
        /* BADGES */
        .badge{padding:0.25rem 0.6rem;border-radius:9999px;font-size:0.7rem;font-weight:600;display:inline-flex;align-items:center;gap:0.25rem}
        .badge-primary{background:rgba(99,102,241,0.1);color:var(--primary)}
        .badge-success{background:rgba(16,185,129,0.1);color:var(--success)}
        .badge-warning{background:rgba(245,158,11,0.1);color:var(--warning)}
        .badge-danger{background:rgba(239,68,68,0.1);color:var(--danger)}
        .badge-info{background:rgba(59,130,246,0.1);color:var(--info)}
        .badge-purple{background:rgba(168,85,247,0.1);color:var(--purple)}
        
        /* SEARCH */
        .search-box{display:flex;align-items:center;gap:0.4rem;background:var(--bg-hover);padding:0.5rem 0.875rem;border-radius:8px;min-width:240px}
        .search-box input{border:none;background:transparent;outline:none;flex:1;font-size:0.85rem}
        
        /* PAGINATION */
        .pagination{display:flex;justify-content:center;align-items:center;gap:0.5rem;margin-top:1.25rem;flex-wrap:wrap}
        .pagination button{padding:0.5rem 1rem;border:1px solid var(--border);background:#fff;border-radius:6px;cursor:pointer;font-weight:500;font-size:0.8rem;transition:all 0.2s}
        .pagination button:hover:not(:disabled){background:var(--primary);color:#fff;border-color:var(--primary)}
        .pagination button:disabled{opacity:0.5;cursor:not-allowed}
        .pagination-info{font-size:0.8rem;color:var(--text-secondary)}
        
        /* ALERTS */
        .alert{padding:1rem;border-radius:10px;margin-bottom:1rem;display:flex;align-items:flex-start;gap:0.75rem;border-left:4px solid;font-size:0.85rem}
        .alert-warning{background:rgba(245,158,11,0.1);border-color:var(--warning);color:#92400e}
        .alert-danger{background:rgba(239,68,68,0.1);border-color:var(--danger);color:#991b1b}
        .alert-info{background:rgba(59,130,246,0.1);border-color:var(--info);color:#1e40af}
        .alert-success{background:rgba(16,185,129,0.1);border-color:var(--success);color:#065f46}
        
        /* MODALS */
        .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;align-items:center;justify-content:center;padding:1rem}
        .modal.active{display:flex}
        .modal-content{background:#fff;border-radius:16px;max-width:600px;width:100%;max-height:90vh;overflow-y:auto;animation:modalIn 0.2s ease}
        .modal-content.large{max-width:900px}
        .modal-content.xl{max-width:1100px}
        .modal-header{padding:1.25rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:#fff;z-index:10}
        .modal-title{font-size:1.15rem;font-weight:700;display:flex;align-items:center;gap:0.5rem}
        .modal-close{width:32px;height:32px;border:none;background:var(--bg-hover);border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
        .modal-close:hover{background:var(--danger);color:#fff}
        .modal-body{padding:1.25rem}
        .modal-footer{padding:1.25rem;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:0.75rem;position:sticky;bottom:0;background:#fff}
        @keyframes modalIn{from{opacity:0;transform:scale(0.95)}to{opacity:1;transform:scale(1)}}
        
        /* FILE UPLOAD */
        .file-upload-container{position:relative}
        .file-upload-btn{display:inline-flex;align-items:center;gap:0.5rem;padding:0.75rem 1.5rem;background:var(--bg-hover);border:2px dashed var(--border);border-radius:10px;cursor:pointer;font-weight:600;font-size:0.85rem;transition:all 0.2s}
        .file-upload-btn:hover{background:var(--primary);color:#fff;border-color:var(--primary)}
        .form-file{display:none}
        .file-selected{display:none;align-items:center;gap:0.5rem;margin-top:0.75rem;padding:0.75rem;background:rgba(16,185,129,0.1);border:2px solid var(--success);border-radius:10px;color:#065f46}
        .file-selected.show{display:flex}
        .file-selected-icon{width:28px;height:28px;background:var(--success);border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;flex-shrink:0}
        .file-selected-name{flex:1;font-weight:600;font-size:0.85rem;word-break:break-all}
        .file-selected-remove{background:none;border:none;color:var(--danger);cursor:pointer;padding:0.25rem}
        
        /* DROPDOWN */
        .dropdown{position:relative;display:inline-block}
        .dropdown-menu{position:absolute;top:100%;right:0;margin-top:0.5rem;background:#fff;border-radius:10px;box-shadow:var(--shadow-lg);min-width:200px;z-index:100;opacity:0;visibility:hidden;transform:translateY(-10px);transition:all 0.2s}
        .dropdown-menu.active{opacity:1;visibility:visible;transform:translateY(0)}
        .dropdown-item{padding:0.7rem 1rem;display:flex;align-items:center;gap:0.6rem;cursor:pointer;transition:background 0.2s;font-size:0.85rem}
        .dropdown-item:hover{background:var(--bg-hover)}
        .dropdown-item:first-child{border-radius:10px 10px 0 0}
        .dropdown-item:last-child{border-radius:0 0 10px 10px}
        .dropdown-divider{height:1px;background:var(--border);margin:0.25rem 0}
        
        /* LOADING */
        .loading-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;align-items:center;justify-content:center}
        .loading-overlay.active{display:flex}
        .loading-content{text-align:center;color:#fff}
        .spinner{width:50px;height:50px;border:4px solid rgba(255,255,255,0.2);border-top-color:#fff;border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 1rem}
        @keyframes spin{to{transform:rotate(360deg)}}
        .progress-bar{width:220px;height:6px;background:rgba(255,255,255,0.2);border-radius:3px;overflow:hidden;margin:1rem auto 0}
        .progress-fill{height:100%;background:var(--primary);width:0%;transition:width 0.3s}
        
        /* TOAST */
        .toast-container{position:fixed;top:1rem;right:1rem;z-index:10000;display:flex;flex-direction:column;gap:0.5rem}
        .toast{background:#fff;padding:1rem 1.25rem;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,0.2);display:flex;align-items:center;gap:0.75rem;animation:slideIn 0.3s ease;border-left:4px solid;font-size:0.85rem;max-width:400px}
        .toast.success{border-color:var(--success)}
        .toast.error{border-color:var(--danger)}
        .toast.warning{border-color:var(--warning)}
        .toast.info{border-color:var(--info)}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        
        /* VIEWS */
        .vista{display:none}
        .vista.active{display:block}
        .empty-state{text-align:center;padding:3rem;color:var(--text-secondary)}
        .empty-state i{width:48px;height:48px;margin-bottom:1rem;opacity:0.5}
        
        /* DETAIL GRID */
        .detail-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1rem}
        .detail-item{background:var(--bg-hover);padding:1rem;border-radius:10px}
        .detail-label{font-size:0.7rem;color:var(--text-secondary);text-transform:uppercase;margin-bottom:0.3rem;font-weight:600}
        .detail-value{font-weight:600;font-size:0.95rem}
        
        /* TIMELINE */
        .timeline{position:relative;padding-left:2rem}
        .timeline::before{content:'';position:absolute;left:0.5rem;top:0;bottom:0;width:2px;background:var(--border)}
        .timeline-item{position:relative;padding-bottom:1.5rem}
        .timeline-item::before{content:'';position:absolute;left:-1.5rem;top:0.25rem;width:12px;height:12px;border-radius:50%;background:var(--primary);border:2px solid #fff;box-shadow:0 0 0 2px var(--primary)}
        .timeline-item.success::before{background:var(--success);box-shadow:0 0 0 2px var(--success)}
        .timeline-item.warning::before{background:var(--warning);box-shadow:0 0 0 2px var(--warning)}
        .timeline-item.danger::before{background:var(--danger);box-shadow:0 0 0 2px var(--danger)}
        .timeline-date{font-size:0.7rem;color:var(--text-secondary);margin-bottom:0.25rem}
        .timeline-title{font-weight:600;font-size:0.85rem;margin-bottom:0.25rem}
        .timeline-desc{font-size:0.8rem;color:var(--text-secondary)}
        
        /* TABS */
        .tabs{display:flex;gap:0.25rem;background:var(--bg-hover);padding:0.25rem;border-radius:10px;margin-bottom:1.25rem}
        .tab{padding:0.6rem 1.25rem;border-radius:8px;cursor:pointer;font-weight:600;font-size:0.85rem;color:var(--text-secondary);transition:all 0.2s}
        .tab:hover{color:var(--text-primary)}
        .tab.active{background:#fff;color:var(--primary);box-shadow:var(--shadow)}
        
        /* CHIPS */
        .chips{display:flex;flex-wrap:wrap;gap:0.5rem}
        .chip{display:inline-flex;align-items:center;gap:0.4rem;padding:0.4rem 0.75rem;background:var(--bg-hover);border-radius:20px;font-size:0.8rem}
        .chip-remove{background:none;border:none;cursor:pointer;color:var(--text-secondary);padding:0;display:flex}
        .chip-remove:hover{color:var(--danger)}
        
        /* AI ASSISTANT */
        .ai-panel{position:fixed;right:-400px;top:0;bottom:0;width:400px;background:#fff;box-shadow:-5px 0 30px rgba(0,0,0,0.1);z-index:500;display:flex;flex-direction:column;transition:right 0.3s ease}
        .ai-panel.active{right:0}
        .ai-header{padding:1.25rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .ai-title{font-weight:700;font-size:1rem;display:flex;align-items:center;gap:0.5rem}
        .ai-title i{color:var(--purple)}
        .ai-body{flex:1;overflow-y:auto;padding:1rem}
        .ai-message{margin-bottom:1rem;padding:1rem;border-radius:12px;font-size:0.85rem;line-height:1.5}
        .ai-message.assistant{background:linear-gradient(135deg,rgba(168,85,247,0.1),rgba(99,102,241,0.1));border-left:3px solid var(--purple)}
        .ai-message.user{background:var(--bg-hover);margin-left:2rem}
        .ai-footer{padding:1rem;border-top:1px solid var(--border)}
        .ai-input{display:flex;gap:0.5rem}
        .ai-input input{flex:1}
        .ai-toggle{position:fixed;right:1rem;bottom:1rem;width:56px;height:56px;background:linear-gradient(135deg,var(--purple),var(--primary));border:none;border-radius:50%;color:#fff;cursor:pointer;box-shadow:0 4px 15px rgba(168,85,247,0.4);z-index:499;display:flex;align-items:center;justify-content:center;transition:transform 0.2s}
        .ai-toggle:hover{transform:scale(1.1)}
        
        /* RESPONSIVE */
        @media(max-width:768px){
            .sidebar{display:none}
            .stats-grid,.charts-grid{grid-template-columns:1fr}
            .card-header{flex-direction:column;align-items:stretch}
            .card-actions{justify-content:flex-start}
            .ai-panel{width:100%}
        }
        .config-section{display:none}
        .config-section:first-of-type{display:block}
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div id="loadingText">Cargando...</div>
            <div id="loadingSubtext" style="font-size:0.85rem;opacity:0.8;margin-top:0.5rem"></div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        </div>
    </div>

    <!-- LOGIN -->
    <div class="login-container" id="loginSection">
        <div class="login-card">
            <div class="login-logo">M</div>
            <h1 class="login-title">MAWI v7.0</h1>
            <p class="login-subtitle">Sistema de Gestión Lukers</p>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="loginEmail" class="form-input" placeholder="correo@lukers.com">
            </div>
            <div class="form-group">
                <label class="form-label">Contraseña</label>
                <input type="password" id="loginPassword" class="form-input" placeholder="••••••••">
            </div>
            <button class="btn btn-primary btn-full btn-lg" onclick="iniciarSesion()">Iniciar Sesión</button>
        </div>
    </div>

    <!-- APP -->
    <div class="app-container" id="appSection">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <div class="logo-icon">M</div>
                    <div>
                        <div class="logo-title">MAWI</div>
                        <div class="logo-subtitle">v7.0 Sistema Lukers</div>
                    </div>
                </div>
            </div>
            <nav class="nav-menu">
                <div class="nav-section">
                    <div class="nav-section-title">Principal</div>
                    <div class="nav-item active" data-vista="dashboard"><i data-lucide="layout-dashboard"></i><span>Dashboard</span></div>
                    <div class="nav-item" data-vista="inventario"><i data-lucide="package"></i><span>Inventario</span></div>
                    <div class="nav-item" data-vista="productos"><i data-lucide="database"></i><span>Productos</span></div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Operaciones</div>
                    <div class="nav-item" data-vista="ordenes"><i data-lucide="clipboard-list"></i><span>Órdenes</span><span class="nav-badge" id="badgeOrdenes">0</span></div>
                    <div class="nav-item" data-vista="picking"><i data-lucide="scan"></i><span>Picking</span></div>
                    <div class="nav-item" data-vista="packing"><i data-lucide="box"></i><span>Packing</span></div>
                    <div class="nav-item" data-vista="reclasificacion"><i data-lucide="repeat"></i><span>Reclasificación</span><span class="nav-badge badge-warning" id="badgeReclas">0</span></div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Configuración</div>
                    <div class="nav-item" data-vista="equipos"><i data-lucide="users"></i><span>Equipos</span></div>
                    <div class="nav-item" data-vista="configuracion"><i data-lucide="settings"></i><span>Ajustes</span></div>
                </div>
            </nav>
            <div class="user-profile">
                <div class="user-info" onclick="cerrarSesion()">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div>
                        <div class="user-name" id="userName">Usuario</div>
                        <div class="user-role">Cerrar Sesión</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MAIN -->
        <div class="main-content">
            <header class="header">
                <div class="header-left">
                    <h1 class="header-title" id="headerTitle">Dashboard</h1>
                    <div class="header-breadcrumb">
                        <span>MAWI</span>
                        <i data-lucide="chevron-right" style="width:14px;height:14px"></i>
                        <span id="headerBreadcrumb" style="color:var(--primary);font-weight:600">Dashboard</span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-outline" onclick="sincronizarDatos()"><i data-lucide="refresh-cw" style="width:16px;height:16px"></i> Sincronizar</button>
                    <button class="btn btn-primary" onclick="toggleAI()"><i data-lucide="sparkles" style="width:16px;height:16px"></i> Asistente IA</button>
                </div>
            </header>

            <div class="content-area" id="contentArea">
                <!-- VISTA DASHBOARD -->
                <div id="vista-dashboard" class="vista active">
                    <!-- Filtros -->
                    <div class="filters-bar">
                        <div class="filter-group">
                            <label class="filter-label">Período:</label>
                            <select id="filtroPeriodo" class="form-select form-input-sm" style="width:auto" onchange="aplicarFiltrosDashboard()">
                                <option value="hoy">Hoy</option>
                                <option value="semana">Esta Semana</option>
                                <option value="mes" selected>Este Mes</option>
                                <option value="año">Este Año</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        <div class="filter-group" id="filtroCustom" style="display:none">
                            <input type="date" id="filtroFechaDesde" class="form-input form-input-sm" style="width:auto">
                            <span style="color:var(--text-secondary)">a</span>
                            <input type="date" id="filtroFechaHasta" class="form-input form-input-sm" style="width:auto">
                            <button class="btn btn-sm btn-primary" onclick="aplicarFiltrosDashboard()">Aplicar</button>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header"><div class="stat-icon blue"><i data-lucide="package"></i></div></div>
                            <div class="stat-value" id="statVariantes">0</div>
                            <div class="stat-label">Variantes en Inventario</div>
                            <div class="stat-footer"><span class="stat-footer-label">Ubicaciones</span><span class="stat-footer-value" id="statUbicaciones">0</span></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header"><div class="stat-icon green"><i data-lucide="trending-up"></i></div></div>
                            <div class="stat-value" id="statUnidades">0</div>
                            <div class="stat-label">Unidades Totales</div>
                            <div class="stat-footer"><span class="stat-footer-label">Disponibles</span><span class="stat-footer-value" id="statDisponibles">0</span></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header"><div class="stat-icon orange"><i data-lucide="shopping-cart"></i></div></div>
                            <div class="stat-value" id="statOrdenes">0</div>
                            <div class="stat-label">Órdenes Activas</div>
                            <div class="stat-footer"><span class="stat-footer-label">Monto Total</span><span class="stat-footer-value" id="statMontoOrdenes">S/ 0</span></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header"><div class="stat-icon purple"><i data-lucide="clock"></i></div></div>
                            <div class="stat-value" id="statTiempoProm">0<span style="font-size:0.9rem">d</span></div>
                            <div class="stat-label">Tiempo Promedio</div>
                            <div class="stat-footer"><span class="stat-footer-label">Completadas</span><span class="stat-footer-value" id="statCompletadas">0</span></div>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="charts-grid">
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title"><i data-lucide="bar-chart-3" style="width:18px;height:18px;color:var(--primary)"></i> Órdenes por Estado</div>
                            </div>
                            <div class="chart-wrapper"><canvas id="chartEstados"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title"><i data-lucide="trending-up" style="width:18px;height:18px;color:var(--success)"></i> Evolución de Montos</div>
                            </div>
                            <div class="chart-wrapper"><canvas id="chartMontos"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title"><i data-lucide="users" style="width:18px;height:18px;color:var(--info)"></i> Rendimiento por Equipo</div>
                            </div>
                            <div class="chart-wrapper"><canvas id="chartEquipos"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title"><i data-lucide="pie-chart" style="width:18px;height:18px;color:var(--warning)"></i> Distribución por Género</div>
                            </div>
                            <div class="chart-wrapper"><canvas id="chartGeneros"></canvas></div>
                        </div>
                    </div>
                </div>

                <!-- Las demás vistas con HTML completo -->
                
                <!-- VISTA INVENTARIO -->
                <div id="vista-inventario" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i data-lucide="package"></i> Inventario <span class="badge badge-info" id="countInventario">0</span></h3>
                            <div class="card-actions">
                                <button class="btn btn-outline" onclick="abrirModal('modalAgregarItem')"><i data-lucide="plus"></i> Agregar</button>
                                <button class="btn btn-outline" onclick="abrirModal('modalSubirInventario')"><i data-lucide="upload"></i> Subir Excel</button>
                                <button class="btn btn-outline" onclick="abrirModal('modalModificarMasivo')"><i data-lucide="edit"></i> Modificar Masivo</button>
                                <button class="btn btn-outline" onclick="abrirModal('modalEliminarMasivo')"><i data-lucide="trash-2"></i> Eliminar Masivo</button>
                                <button class="btn btn-success" onclick="exportarInventarioCompleto()"><i data-lucide="download"></i> Exportar</button>
                                <button class="btn btn-warning" onclick="desbloquearTodoStock()"><i data-lucide="unlock"></i> Desbloquear Todo</button>
                            </div>
                        </div>
                        <div class="table-controls">
                            <div class="search-box"><i data-lucide="search" style="width:16px;height:16px;color:var(--text-secondary)"></i><input type="text" id="searchInventario" placeholder="Buscar variante o ubicación..." onkeyup="filtrarInventario()"></div>
                        </div>
                        <div class="table-container"><table><thead><tr><th>Variante</th><th>Ubicación</th><th>Stock Físico</th><th>Bloqueado</th><th>Disponible</th><th>Acciones</th></tr></thead><tbody id="tablaInventario"></tbody></table></div>
                        <div class="pagination">
                            <button id="prevInventario" onclick="cambiarPagina('inventario',-1)">Anterior</button>
                            <span class="pagination-info">Página <span id="paginaInventario">1</span> de <span id="totalPaginasInventario">1</span></span>
                            <button id="nextInventario" onclick="cambiarPagina('inventario',1)">Siguiente</button>
                        </div>
                    </div>
                </div>

                <!-- VISTA PRODUCTOS -->
                <div id="vista-productos" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i data-lucide="database"></i> Productos <span class="badge badge-info" id="countProductos">0</span></h3>
                            <div class="card-actions">
                                <button class="btn btn-outline" onclick="abrirModal('modalSubirProductos')"><i data-lucide="upload"></i> Subir Catálogo</button>
                                <button class="btn btn-success" onclick="exportarProductos()"><i data-lucide="download"></i> Exportar</button>
                            </div>
                        </div>
                        <div class="table-controls">
                            <div class="search-box"><i data-lucide="search" style="width:16px;height:16px;color:var(--text-secondary)"></i><input type="text" id="searchProductos" placeholder="Buscar..." onkeyup="filtrarProductos()"></div>
                            <div style="display:flex;gap:0.5rem;flex-wrap:wrap">
                                <select id="filtroGenero" class="form-select form-input-sm" onchange="filtrarProductos()"><option value="">Géneros</option></select>
                                <select id="filtroLinea" class="form-select form-input-sm" onchange="filtrarProductos()"><option value="">Líneas</option></select>
                                <select id="filtroMarca" class="form-select form-input-sm" onchange="filtrarProductos()"><option value="">Marcas</option></select>
                            </div>
                        </div>
                        <div class="table-container"><table><thead><tr><th>Variante</th><th>Código</th><th>Descripción</th><th>Género</th><th>Marca</th><th>Talla</th><th>Kardex</th><th>PVP</th><th>PVP Regular</th></tr></thead><tbody id="tablaProductos"></tbody></table></div>
                        <div class="pagination">
                            <button id="prevProductos" onclick="cambiarPagina('productos',-1)">Anterior</button>
                            <span class="pagination-info">Página <span id="paginaProductos">1</span> de <span id="totalPaginasProductos">1</span></span>
                            <button id="nextProductos" onclick="cambiarPagina('productos',1)">Siguiente</button>
                        </div>
                    </div>
                </div>

                <!-- VISTA ÓRDENES -->
                <div id="vista-ordenes" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i data-lucide="clipboard-list"></i> Órdenes</h3>
                            <div class="card-actions">
                                <button class="btn btn-primary" onclick="abrirModal('modalCrearOrden')"><i data-lucide="plus"></i> Nueva Orden</button>
                            </div>
                        </div>
                        <div class="table-controls">
                            <div class="search-box"><i data-lucide="search" style="width:16px;height:16px;color:var(--text-secondary)"></i><input type="text" id="searchOrdenes" placeholder="Buscar..." onkeyup="filtrarOrdenes()"></div>
                            <select id="filtroEstadoOrden" class="form-select form-input-sm" onchange="filtrarOrdenes()"><option value="">Todos los estados</option><option value="Pendiente División">Pendiente División</option><option value="Pendiente Picking">Pendiente Picking</option><option value="En Picking">En Picking</option><option value="Pendiente Packing">Pendiente Packing</option><option value="En Packing">En Packing</option><option value="Completada">Completada</option></select>
                        </div>
                        <div class="table-container"><table><thead><tr><th>ID</th><th>Nombre</th><th>Fecha</th><th>Unidades</th><th>Monto</th><th>Progreso</th><th>Estado</th><th>Acciones</th></tr></thead><tbody id="tablaOrdenes"></tbody></table></div>
                    </div>
                </div>

                <!-- VISTA PICKING -->
                <div id="vista-picking" class="vista">
                    <div class="alert alert-warning" id="alertaHorario" style="display:none;margin-bottom:1rem"><i data-lucide="clock"></i><span id="alertaHorarioTexto"></span></div>
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i data-lucide="scan"></i> Picking</h3>
                            <div class="card-actions">
                                <button class="btn btn-outline" onclick="exportarHistorialPicking()"><i data-lucide="download"></i> Exportar Historial</button>
                            </div>
                        </div>
                        <div class="tabs" id="tabsPicking">
                            <div class="tab active" data-tab="activos" onclick="cambiarTabPicking('activos')">Activos</div>
                            <div class="tab" data-tab="historial" onclick="cambiarTabPicking('historial')">Historial</div>
                        </div>
                        <div class="table-container"><table><thead><tr><th>Orden</th><th>Parte</th><th>Equipo</th><th>Solicitado</th><th>Encontrado</th><th>Tiempo</th><th>Estado</th><th>Acciones</th></tr></thead><tbody id="tablaPicking"></tbody></table></div>
                    </div>
                </div>

                <!-- VISTA PACKING -->
                <div id="vista-packing" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i data-lucide="box"></i> Packing</h3>
                            <div class="card-actions">
                                <button class="btn btn-outline" onclick="exportarHistorialPacking()"><i data-lucide="download"></i> Exportar Historial</button>
                            </div>
                        </div>
                        <div class="tabs" id="tabsPacking">
                            <div class="tab active" data-tab="activos" onclick="cambiarTabPacking('activos')">Activos</div>
                            <div class="tab" data-tab="historial" onclick="cambiarTabPacking('historial')">Historial</div>
                        </div>
                        <div class="table-container"><table><thead><tr><th>Orden</th><th>Parte</th><th>Equipo</th><th>Recibido</th><th>Empacado</th><th>Reclasificado</th><th>Tiempo</th><th>Estado</th><th>Acciones</th></tr></thead><tbody id="tablaPacking"></tbody></table></div>
                    </div>
                </div>

                <!-- VISTA RECLASIFICACIÓN -->
                <div id="vista-reclasificacion" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i data-lucide="repeat"></i> Reclasificación</h3>
                            <div class="card-actions">
                                <button class="btn btn-outline" onclick="exportarReclasificacionesPendientes()"><i data-lucide="download"></i> Descargar Pendientes</button>
                            </div>
                        </div>
                        <div class="tabs" id="tabsReclas">
                            <div class="tab active" data-tab="pendientes" onclick="cambiarTabReclas('pendientes')">Pendientes</div>
                            <div class="tab" data-tab="completadas" onclick="cambiarTabReclas('completadas')">Completadas</div>
                            <div class="tab" data-tab="todas" onclick="cambiarTabReclas('todas')">Todas</div>
                        </div>
                        <div class="table-container"><table><thead><tr><th>ID</th><th>Orden</th><th>Variante</th><th>Descripción</th><th>Cantidad</th><th>Motivo</th><th>Estado</th><th>Acciones</th></tr></thead><tbody id="tablaReclasificacion"></tbody></table></div>
                    </div>
                </div>

                <!-- VISTA EQUIPOS -->
                <div id="vista-equipos" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i data-lucide="users"></i> Equipos</h3>
                            <div class="card-actions">
                                <button class="btn btn-primary" onclick="equipoActual=null;document.getElementById('tituloModalEquipo').textContent='Nuevo Equipo';document.getElementById('equipoNombre').value='';document.getElementById('equipoIntegrantes').value='';abrirModal('modalCrearEquipo')"><i data-lucide="plus"></i> Nuevo Equipo</button>
                            </div>
                        </div>
                        <div class="tabs">
                            <div class="tab active" data-tipo="picking" onclick="cambiarTabEquipos('picking')">Picking</div>
                            <div class="tab" data-tipo="packing" onclick="cambiarTabEquipos('packing')">Packing</div>
                        </div>
                        <div class="table-container"><table><thead><tr><th>Nombre</th><th>Integrantes</th><th>Tipo</th><th>Estado</th><th>Acciones</th></tr></thead><tbody id="tablaEquipos"></tbody></table></div>
                    </div>
                </div>

                <!-- VISTA CONFIGURACIÓN -->
                <div id="vista-configuracion" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i data-lucide="settings"></i> Configuración</h3>
                        </div>
                        <div class="tabs">
                            <div class="tab active" data-config="columnas" onclick="cambiarTabConfig('columnas')">Columnas de Hojas</div>
                            <div class="tab" data-config="tiendas" onclick="cambiarTabConfig('tiendas')">Tiendas</div>
                            <div class="tab" data-config="horarios" onclick="cambiarTabConfig('horarios')">Horarios</div>
                            <div class="tab" data-config="general" onclick="cambiarTabConfig('general')">General</div>
                        </div>
                        
                        <div class="config-section" id="configColumnas" style="padding:1.5rem">
                            <h4 style="margin-bottom:1rem">Columnas de Hojas de Picking/Packing</h4>
                            <div class="form-group">
                                <label class="form-check"><input type="checkbox" checked> Ubicación</label>
                                <label class="form-check"><input type="checkbox" checked> Variante</label>
                                <label class="form-check"><input type="checkbox" checked> Código Comercial</label>
                                <label class="form-check"><input type="checkbox" checked> Marca</label>
                                <label class="form-check"><input type="checkbox"> PVP</label>
                                <label class="form-check"><input type="checkbox"> PVP Regular</label>
                                <label class="form-check"><input type="checkbox" checked> Descripción</label>
                            </div>
                            <button class="btn btn-primary" onclick="guardarConfigColumnas()">Guardar</button>
                        </div>

                        <div class="config-section" id="configTiendas" style="display:none;padding:1.5rem">
                            <h4 style="margin-bottom:1rem">Gestión de Tiendas</h4>
                            <div class="form-group">
                                <label class="form-label">Agregar Nueva Tienda</label>
                                <div style="display:flex;gap:0.5rem">
                                    <input type="text" id="inputNuevaTienda" class="form-input" placeholder="Nombre de la tienda">
                                    <button class="btn btn-primary" onclick="agregarTienda()">Agregar</button>
                                </div>
                            </div>
                            <h4 style="margin:1.5rem 0 1rem">Tiendas Actuales</h4>
                            <div class="chips" id="listaTiendas"></div>
                            <button class="btn btn-primary" style="margin-top:1.5rem" onclick="guardarConfigTiendas()">Guardar</button>
                        </div>

                        <div class="config-section" id="configHorarios" style="display:none;padding:1.5rem">
                            <h4 style="margin-bottom:1rem">Horarios de Trabajo</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Hora Inicio</label>
                                    <input type="time" id="horaInicio" class="form-input" value="08:30" onchange="calcularTiempoEfectivo()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Hora Fin</label>
                                    <input type="time" id="horaFin" class="form-input" value="19:00" onchange="calcularTiempoEfectivo()">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Almuerzo (minutos)</label>
                                    <input type="number" id="duracionAlmuerzo" class="form-input" value="60" onchange="calcularTiempoEfectivo()">
                                </div>
                            </div>
                            <div class="alert alert-info"><i data-lucide="info"></i><span>Tiempo efectivo: <strong id="tiempoEfectivo">9.5 horas</strong></span></div>
                            <button class="btn btn-primary" onclick="guardarConfigHorarios()">Guardar</button>
                        </div>

                        <div class="config-section" id="configGeneral" style="display:none;padding:1.5rem">
                            <h4 style="margin-bottom:1rem">Configuración General</h4>
                            <div class="form-group">
                                <label class="form-label">Items por Página</label>
                                <input type="number" class="form-input" value="100">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Días para Expiración de Órdenes</label>
                                <input type="number" class="form-input" value="30">
                            </div>
                            <button class="btn btn-primary" onclick="guardarConfigGeneral()">Guardar</button>
                            <hr style="margin:2rem 0">
                            <h4 style="margin-bottom:1rem">Mantenimiento</h4>
                            <button class="btn btn-warning" onclick="limpiarOrdenesAntiguas()"><i data-lucide="trash-2"></i> Limpiar Órdenes Antiguas</button>
                            <button class="btn btn-success" onclick="exportarBackup()"><i data-lucide="download"></i> Exportar Backup</button>
                        </div>
                    </div>
                </div>

                <!-- MODALES (Agregar todos los modales necesarios) -->
                <div class="modal" id="modalAgregarItem"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Agregar Item</h3><button class="modal-close" onclick="cerrarModal('modalAgregarItem')"><i data-lucide="x"></i></button></div><div class="modal-body"><div class="form-group"><label class="form-label">Variante</label><input type="text" id="inputVariante" class="form-input"></div><div class="form-group"><label class="form-label">Ubicación</label><input type="text" id="inputUbicacion" class="form-input"></div><div class="form-group"><label class="form-label">Stock</label><input type="number" id="inputStock" class="form-input"></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="cerrarModal('modalAgregarItem')">Cancelar</button><button class="btn btn-primary" onclick="guardarItem()">Guardar</button></div></div></div>

                <div class="modal" id="modalSubirInventario"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Subir Inventario</h3><button class="modal-close" onclick="cerrarModal('modalSubirInventario')"><i data-lucide="x"></i></button></div><div class="modal-body"><div class="form-group"><input type="file" id="fileInventario" class="form-file" accept=".xlsx,.xls" onchange="mostrarArchivoSeleccionado(this,'fileInventarioInfo')"><label for="fileInventario" class="file-upload-btn"><i data-lucide="file-plus"></i> Seleccionar archivo</label><div class="file-selected" id="fileInventarioInfo"><div class="file-selected-icon"><i data-lucide="check"></i></div><span class="file-selected-name"></span><button class="file-selected-remove" onclick="limpiarArchivo('fileInventario','fileInventarioInfo')"><i data-lucide="x"></i></button></div></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="cerrarModal('modalSubirInventario')">Cancelar</button><button class="btn btn-primary" onclick="procesarInventario()">Procesar</button></div></div></div>

                <div class="modal" id="modalModificarMasivo"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Modificar Masivo</h3><button class="modal-close" onclick="cerrarModal('modalModificarMasivo')"><i data-lucide="x"></i></button></div><div class="modal-body"><div class="form-group"><input type="file" id="fileModificar" class="form-file" accept=".xlsx,.xls" onchange="mostrarArchivoSeleccionado(this,'fileModificarInfo')"><label for="fileModificar" class="file-upload-btn"><i data-lucide="file-plus"></i> Seleccionar archivo</label><div class="file-selected" id="fileModificarInfo"><div class="file-selected-icon"><i data-lucide="check"></i></div><span class="file-selected-name"></span><button class="file-selected-remove" onclick="limpiarArchivo('fileModificar','fileModificarInfo')"><i data-lucide="x"></i></button></div></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="cerrarModal('modalModificarMasivo')">Cancelar</button><button class="btn btn-primary" onclick="procesarModificarMasivo()">Modificar</button></div></div></div>

                <div class="modal" id="modalEliminarMasivo"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Eliminar Masivo</h3><button class="modal-close" onclick="cerrarModal('modalEliminarMasivo')"><i data-lucide="x"></i></button></div><div class="modal-body"><div class="alert alert-danger"><i data-lucide="alert-triangle"></i><span>Esta acción eliminará los registros especificados</span></div><div class="form-group"><input type="file" id="fileEliminar" class="form-file" accept=".xlsx,.xls" onchange="mostrarArchivoSeleccionado(this,'fileEliminarInfo')"><label for="fileEliminar" class="file-upload-btn"><i data-lucide="file-plus"></i> Seleccionar archivo</label><div class="file-selected" id="fileEliminarInfo"><div class="file-selected-icon"><i data-lucide="check"></i></div><span class="file-selected-name"></span><button class="file-selected-remove" onclick="limpiarArchivo('fileEliminar','fileEliminarInfo')"><i data-lucide="x"></i></button></div></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="cerrarModal('modalEliminarMasivo')">Cancelar</button><button class="btn btn-danger" onclick="procesarEliminarMasivo()">Eliminar</button></div></div></div>

                <div class="modal" id="modalVerVariante"><div class="modal-content large"><div class="modal-header"><h3 class="modal-title">Detalle de Variante</h3><button class="modal-close" onclick="cerrarModal('modalVerVariante')"><i data-lucide="x"></i></button></div><div class="modal-body" id="varianteDetalleContent"></div><div class="modal-footer"><button class="btn btn-outline" onclick="cerrarModal('modalVerVariante')">Cerrar</button></div></div></div>

                <div class="modal" id="modalSubirProductos"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Subir Catálogo</h3><button class="modal-close" onclick="cerrarModal('modalSubirProductos')"><i data-lucide="x"></i></button></div><div class="modal-body"><div class="alert alert-warning"><i data-lucide="alert-triangle"></i><span>Esto reemplazará todo el catálogo actual</span></div><div class="form-group"><input type="file" id="fileProductos" class="form-file" accept=".xlsx,.xls" onchange="mostrarArchivoSeleccionado(this,'fileProductosInfo')"><label for="fileProductos" class="file-upload-btn"><i data-lucide="file-plus"></i> Seleccionar archivo</label><div class="file-selected" id="fileProductosInfo"><div class="file-selected-icon"><i data-lucide="check"></i></div><span class="file-selected-name"></span><button class="file-selected-remove" onclick="limpiarArchivo('fileProductos','fileProductosInfo')"><i data-lucide="x"></i></button></div></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="cerrarModal('modalSubirProductos')">Cancelar</button><button class="btn btn-primary" onclick="procesarProductos()">Procesar</button></div></div></div>

                <div class="modal" id="modalCrearOrden"><div class="modal-content large"><div class="modal-header"><h3 class="modal-title">Nueva Orden</h3><button class="modal-close" onclick="cerrarModal('modalCrearOrden')"><i data-lucide="x"></i></button></div><div class="modal-body"><div class="form-group"><label class="form-label">Nombre de la Orden</label><input type="text" id="ordenNombre" class="form-input" placeholder="Ej: Tops Mujer Semana 48"></div><div class="form-group"><input type="file" id="fileOrden" class="form-file" accept=".xlsx,.xls" onchange="mostrarArchivoSeleccionado(this,'fileOrdenInfo');previsualizarOrden()"><label for="fileOrden" class="file-upload-btn"><i data-lucide="file-plus"></i> Seleccionar archivo Excel</label><div class="file-selected" id="fileOrdenInfo"><div class="file-selected-icon"><i data-lucide="check"></i></div><span class="file-selected-name"></span><button class="file-selected-remove" onclick="limpiarArchivo('fileOrden','fileOrdenInfo')"><i data-lucide="x"></i></button></div></div><div class="alert alert-info" id="previewOrden" style="display:none;margin-top:1rem"><div id="previewOrdenContent"></div></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="cerrarModal('modalCrearOrden')">Cancelar</button><button class="btn btn-primary" onclick="crearOrden()">Crear Orden</button></div></div></div>

                <div class="modal" id="modalDividirOrden"><div class="modal-content xl"><div class="modal-header"><h3 class="modal-title">Dividir Orden</h3><button class="modal-close" onclick="cerrarModal('modalDividirOrden')"><i data-lucide="x"></i></button></div><div class="modal-body"><div class="detail-grid" style="margin-bottom:1.5rem"><div class="detail-item"><div class="detail-label">Orden</div><div class="detail-value" id="divOrdenNombre"></div></div><div class="detail-item"><div class="detail-label">Variantes</div><div class="detail-value" id="divOrdenVariantes"></div></div><div class="detail-item"><div class="detail-label">Unidades</div><div class="detail-value" id="divOrdenUnidades"></div></div></div><div class="form-group"><label class="form-label">Número de Partes</label><input type="number" id="numPartes" class="form-input" value="1" min="1" max="10" onchange="generarPartesConfig()"></div><div id="partesConfig"></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="cerrarModal('modalDividirOrden')">Cancelar</button><button class="btn btn-primary" onclick="confirmarDivision()">Confirmar División</button></div></div></div>

                <div class="modal" id="modalSubirCantidades"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Subir Cantidades Encontradas</h3><button class="modal-close" onclick="cerrarModal('modalSubirCantidades')"><i data-lucide="x"></i></button></div><div class="modal-body"><div class="form-group"><input type="file" id="fileCantidades" class="form-file" accept=".xlsx,.xls" onchange="mostrarArchivoSeleccionado(this,'fileCantidadesInfo')"><label for="fileCantidades" class="file-upload-btn"><i data-lucide="file-plus"></i> Seleccionar archivo</label><div class="file-selected" id="fileCantidadesInfo"><div class="file-selected-icon"><i data-lucide="check"></i></div><span class="file-selected-name"></span><button class="file-selected-remove" onclick="limpiarArchivo('fileCantidades','fileCantidadesInfo')"><i data-lucide="x"></i></button></div></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="cerrarModal('modalSubirCantidades')">Cancelar</button><button class="btn btn-primary" onclick="confirmarSubirCantidades()">Confirmar</button></div></div></div>

                <div class="modal" id="modalPicking"><div class="modal-content large"><div class="modal-header"><h3 class="modal-title" id="tituloModalPicking">Picking</h3><button class="modal-close" onclick="cerrarModal('modalPicking')"><i data-lucide="x"></i></button></div><div class="modal-body" id="pickingContent"></div><div class="modal-footer" id="pickingFooter"></div></div></div>

                <div class="modal" id="modalCompletarReclas"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">Completar Reclasificación</h3><button class="modal-close" onclick="cerrarModal('modalCompletarReclas')"><i data-lucide="x"></i></button></div><div class="modal-body" id="completarReclasContent"></div><div class="modal-footer"><button class="btn btn-outline" onclick="cerrarModal('modalCompletarReclas')">Cancelar</button><button class="btn btn-primary" onclick="confirmarCompletarReclas()">Confirmar</button></div></div></div>

                <div class="modal" id="modalCrearEquipo"><div class="modal-content"><div class="modal-header"><h3 class="modal-title" id="tituloModalEquipo">Nuevo Equipo</h3><button class="modal-close" onclick="cerrarModal('modalCrearEquipo')"><i data-lucide="x"></i></button></div><div class="modal-body"><div class="form-group"><label class="form-label">Nombre</label><input type="text" id="equipoNombre" class="form-input"></div><div class="form-group"><label class="form-label">Tipo</label><select id="equipoTipo" class="form-select"><option value="picking">Picking</option><option value="packing">Packing</option></select></div><div class="form-group"><label class="form-label">Integrantes (uno por línea)</label><textarea id="equipoIntegrantes" class="form-textarea" rows="5"></textarea></div></div><div class="modal-footer"><button class="btn btn-outline" onclick="cerrarModal('modalCrearEquipo')">Cancelar</button><button class="btn btn-primary" onclick="guardarEquipo()">Guardar</button></div></div></div>

                <div class="modal" id="modalHistorialOrden"><div class="modal-content xl"><div class="modal-header"><h3 class="modal-title">Historial de Orden</h3><button class="modal-close" onclick="cerrarModal('modalHistorialOrden')"><i data-lucide="x"></i></button></div><div class="modal-body" id="historialOrdenBody"></div><div class="modal-footer"><button class="btn btn-outline" onclick="cerrarModal('modalHistorialOrden')">Cerrar</button></div></div></div>
            </div>
        </div>
    </div>

    <!-- AI PANEL -->
    <div class="ai-panel" id="aiPanel">
        <div class="ai-header">
            <div class="ai-title"><i data-lucide="sparkles"></i> Asistente MAWI</div>
            <button class="modal-close" onclick="toggleAI()"><i data-lucide="x"></i></button>
        </div>
        <div class="ai-body" id="aiMessages">
            <div class="ai-message assistant">
                <strong>👋 ¡Hola! Soy MAWI, tu asistente inteligente.</strong><br><br>
                Soy un asistente de IA <strong>verdaderamente inteligente</strong> powered by Claude. Puedo ayudarte con:<br><br>
                💡 <strong>Responder CUALQUIER pregunta</strong> sobre el sistema<br>
                📊 <strong>Analizar datos</strong> en tiempo real<br>
                🔍 <strong>Detectar problemas</strong> y sugerir soluciones<br>
                📈 <strong>Recomendar optimizaciones</strong> basadas en métricas<br>
                📖 <strong>Explicar procedimientos</strong> paso a paso<br><br>
                <em style="opacity:0.8">Pregúntame lo que quieras sobre órdenes, inventario, picking, packing, equipos, o cualquier aspecto del sistema. ¡No estoy limitado a respuestas predefinidas!</em>
            </div>
        </div>
        <div class="ai-footer">
            <div class="ai-input">
                <input type="text" id="aiInput" class="form-input" placeholder="Escribe tu pregunta..." onkeypress="if(event.key==='Enter')enviarMensajeAI()">
                <button class="btn btn-primary" onclick="enviarMensajeAI()"><i data-lucide="send" style="width:16px;height:16px"></i></button>
            </div>
        </div>
    </div>
    <button class="ai-toggle" onclick="toggleAI()" title="Asistente IA"><i data-lucide="sparkles" style="width:24px;height:24px"></i></button>

    <script>
        // ============================================
        // CONFIGURACIÓN
        // ============================================
        const SUPABASE_URL = 'https://dzxjzmlmmmwspemihhlv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6eGp6bWxtbW13c3BlbWloaGx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1NjI5MjAsImV4cCI6MjA3OTEzODkyMH0.uLXtsONi_c4myPbsvTIqV51pldRv6Wuff4adYWgVR6Q';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Lista de tiendas - Flexible con mayúsculas/minúsculas
        const TIENDAS_BASE = ['LUKERS EL SOL', 'LUKERS TRU PIZARRO', 'LUKERS LA MARINA', 'LUKERS PROLONGACIÓN IQUITOS', 'LUKERS CHI P. RUIZ', 'LUKERS TARAPOTO', 'LUKERS MENDIOLA', 'LUKERS ALFONSO UGARTE', 'LUKERS IQT LORES', 'LUKERS JIRON', 'JR UNION'];
        
        // Constantes
        const ITEMS_POR_PAGINA = 100;
        const BATCH_SIZE = 500;

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let inventario = [], productos = [], ordenes = [], picking = [], packing = [], reclasificacion = [], equipos = [], configuraciones = [];
        let inventarioFiltrado = [], productosFiltrado = [], ordenesFiltradas = [];
        let paginaInv = 1, paginaProd = 1;
        let chartEstados, chartMontos, chartEquipos, chartGeneros;
        let ordenActual = null, pickingActual = null, packingActual = null, reclasActual = null, equipoActual = null;
        let tabReclasActual = 'pendientes', tabEquiposActual = 'picking';

        // ============================================
        // UTILIDADES
        // ============================================
        function normalizarTexto(texto) {
            if (!texto) return '';
            return String(texto).trim().toUpperCase();
        }

        function getCol(row, names) {
            for (const n of names) {
                if (row[n] !== undefined && row[n] !== null && row[n] !== '') return row[n];
                const keys = Object.keys(row);
                for (const k of keys) {
                    if (k.toLowerCase() === n.toLowerCase()) return row[k];
                }
            }
            return null;
        }

        function buscarTienda(row) {
            const resultado = {};
            const keys = Object.keys(row);
            
            for (const tienda of TIENDAS_BASE) {
                let encontrado = false;
                for (const key of keys) {
                    const keyNorm = normalizarTexto(key);
                    const tiendaNorm = normalizarTexto(tienda);
                    const tiendaCorta = tiendaNorm.replace('LUKERS ', '');
                    
                    if (keyNorm === tiendaNorm || keyNorm === tiendaCorta || 
                        keyNorm.includes(tiendaCorta) || tiendaCorta.includes(keyNorm)) {
                        const val = parseInt(row[key]) || 0;
                        if (val > 0) {
                            resultado[tienda] = val;
                            encontrado = true;
                        }
                        break;
                    }
                }
            }
            return resultado;
        }

        function formatMoney(num) {
            return 'S/ ' + (parseFloat(num) || 0).toLocaleString('es-PE', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function formatFecha(iso) {
            if (!iso) return '-';
            return new Date(iso).toLocaleDateString('es-PE', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function formatFechaHora(iso) {
            if (!iso) return '-';
            return new Date(iso).toLocaleString('es-PE');
        }

        function diasTranscurridos(fecha) {
            if (!fecha) return 0;
            return Math.floor((new Date() - new Date(fecha)) / 86400000);
        }

        function getBadge(estado) {
            const badges = {
                'Pendiente División': 'badge-purple',
                'En División': 'badge-purple',
                'Pendiente Picking': 'badge-warning',
                'En Picking': 'badge-info',
                'Pendiente Packing': 'badge-warning',
                'En Packing': 'badge-info',
                'Completada': 'badge-success',
                'Cancelada': 'badge-danger',
                'Pendiente': 'badge-warning',
                'En Proceso': 'badge-info'
            };
            return `<span class="badge ${badges[estado] || 'badge-primary'}">${estado}</span>`;
        }

        // ============================================
        // ARCHIVOS
        // ============================================
        function mostrarArchivoSeleccionado(input, infoId) {
            const infoDiv = document.getElementById(infoId);
            if (input.files && input.files[0]) {
                infoDiv.querySelector('.file-selected-name').textContent = input.files[0].name;
                infoDiv.classList.add('show');
                lucide.createIcons();
            }
        }

        function limpiarArchivo(inputId, infoId) {
            document.getElementById(inputId).value = '';
            document.getElementById(infoId).classList.remove('show');
        }

        async function leerExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                        const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                        resolve(data);
                    } catch (err) { reject(err); }
                };
                reader.onerror = () => reject(new Error('Error leyendo archivo'));
                reader.readAsArrayBuffer(file);
            });
        }

        // ============================================
        // UI HELPERS
        // ============================================
        function mostrarLoading(texto, sub = '') {
            document.getElementById('loadingText').textContent = texto;
            document.getElementById('loadingSubtext').textContent = sub;
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function ocultarLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
            document.getElementById('progressFill').style.width = '0%';
        }

        function actualizarProgreso(p) {
            document.getElementById('progressFill').style.width = Math.min(p, 100) + '%';
        }

        function toast(msg, tipo = 'info') {
            const div = document.createElement('div');
            div.className = `toast ${tipo}`;
            div.innerHTML = msg;
            document.getElementById('toastContainer').appendChild(div);
            setTimeout(() => div.remove(), 4000);
        }

        function abrirModal(id) {
            document.getElementById(id).classList.add('active');
            lucide.createIcons();
        }

        function cerrarModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function toggleDropdown(id) {
            document.getElementById(id).classList.toggle('active');
        }

        document.addEventListener('click', e => {
            if (!e.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('active'));
            }
        });

        document.querySelectorAll('.modal').forEach(m => {
            m.addEventListener('click', e => { if (e.target === m) cerrarModal(m.id); });
        });

        // ============================================
        // NAVEGACIÓN
        // ============================================
        function cambiarVista(nombre) {
            document.querySelectorAll('.vista').forEach(v => v.classList.remove('active'));
            document.getElementById(`vista-${nombre}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => {
                n.classList.remove('active');
                if (n.dataset.vista === nombre) n.classList.add('active');
            });
            const titulos = {
                dashboard: 'Dashboard', inventario: 'Inventario', productos: 'Productos',
                ordenes: 'Órdenes', picking: 'Picking', packing: 'Packing',
                reclasificacion: 'Reclasificación', equipos: 'Equipos', configuracion: 'Configuración'
            };
            document.getElementById('headerTitle').textContent = titulos[nombre] || 'MAWI';
            document.getElementById('headerBreadcrumb').textContent = titulos[nombre] || 'MAWI';
            lucide.createIcons();
        }

        document.querySelectorAll('.nav-item').forEach(i => {
            i.addEventListener('click', () => { if (i.dataset.vista) cambiarVista(i.dataset.vista); });
        });

        // ============================================
        // AUTENTICACIÓN
        // ============================================
        async function verificarSesion() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('appSection').style.display = 'flex';
                document.getElementById('userName').textContent = session.user.email.split('@')[0];
                document.getElementById('userAvatar').textContent = session.user.email.charAt(0).toUpperCase();
                await cargarDatos();
            } else {
                document.getElementById('loginSection').style.display = 'flex';
                document.getElementById('appSection').style.display = 'none';
            }
        }

        async function iniciarSesion() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) { toast('Completa todos los campos', 'error'); return; }
            mostrarLoading('Iniciando sesión...');
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            ocultarLoading();
            if (error) toast('Error: ' + error.message, 'error');
            else { toast('Sesión iniciada', 'success'); await verificarSesion(); }
        }

        async function cerrarSesion() {
            await supabase.auth.signOut();
            toast('Sesión cerrada', 'info');
            setTimeout(() => location.reload(), 500);
        }

        // ============================================
        // CARGA DE DATOS
        // ============================================
        async function cargarTodosLosRegistros(tabla, orderColumn = 'variante') {
            let allData = [];
            let from = 0;
            const batchSize = 1000;
            
            while (true) {
                const { data, error } = await supabase.from(tabla).select('*').order(orderColumn, { ascending: true }).range(from, from + batchSize - 1);
                if (error) { console.error(`Error cargando ${tabla}:`, error); break; }
                if (!data || data.length === 0) break;
                allData = allData.concat(data);
                actualizarProgreso((allData.length / (from + batchSize * 2)) * 100);
                document.getElementById('loadingSubtext').textContent = `${tabla}: ${allData.length.toLocaleString()} registros...`;
                if (data.length < batchSize) break;
                from += batchSize;
            }
            return allData;
        }

        async function cargarDatos() {
            mostrarLoading('Cargando datos...');
            try {
                document.getElementById('loadingText').textContent = 'Cargando inventario...';
                inventario = await cargarTodosLosRegistros('inventario', 'variante');
                inventarioFiltrado = [...inventario];

                document.getElementById('loadingText').textContent = 'Cargando productos...';
                productos = await cargarTodosLosRegistros('productos_system', 'variante');
                productosFiltrado = [...productos];

                document.getElementById('loadingText').textContent = 'Cargando órdenes...';
                const { data: ordenesData } = await supabase.from('ordenes').select('*').order('fecha', { ascending: false });
                ordenes = ordenesData || [];
                ordenesFiltradas = [...ordenes];

                document.getElementById('loadingText').textContent = 'Cargando picking...';
                const { data: pickingData } = await supabase.from('picking').select('*').order('id', { ascending: false });
                picking = pickingData || [];

                document.getElementById('loadingText').textContent = 'Cargando packing...';
                const { data: packingData } = await supabase.from('packing').select('*').order('id', { ascending: false });
                packing = packingData || [];

                document.getElementById('loadingText').textContent = 'Cargando reclasificación...';
                const { data: reclasData } = await supabase.from('reclasificacion').select('*').order('fecha', { ascending: false });
                reclasificacion = reclasData || [];

                document.getElementById('loadingText').textContent = 'Cargando equipos...';
                const { data: equiposData } = await supabase.from('equipos').select('*').order('nombre');
                equipos = equiposData || [];

                document.getElementById('loadingText').textContent = 'Cargando configuraciones...';
                const { data: configData } = await supabase.from('configuraciones').select('*');
                configuraciones = configData || [];

                actualizarFiltrosProductos();
                renderizarTodo();
                actualizarDashboard();
                
                ocultarLoading();
                toast(`Datos cargados correctamente`, 'success');
            } catch (e) {
                ocultarLoading();
                toast('Error: ' + e.message, 'error');
                console.error(e);
            }
        }

        async function sincronizarDatos() {
            await cargarDatos();
        }

        function renderizarTodo() {
            renderizarInventario();
            renderizarProductos();
            renderizarOrdenes();
            renderizarPicking();
            renderizarPacking();
            renderizarReclasificacion();
            renderizarEquipos();
            actualizarBadges();
        }

        function actualizarBadges() {
            const activas = ordenes.filter(o => !['Completada', 'Cancelada'].includes(o.estado)).length;
            document.getElementById('badgeOrdenes').textContent = activas;
            const pendientes = reclasificacion.filter(r => r.estado === 'Pendiente').length;
            document.getElementById('badgeReclas').textContent = pendientes;
        }

        // ============================================
        // DASHBOARD
        // ============================================
        function aplicarFiltrosDashboard() {
            const periodo = document.getElementById('filtroPeriodo').value;
            document.getElementById('filtroCustom').style.display = periodo === 'custom' ? 'flex' : 'none';
            actualizarDashboard();
        }

        function actualizarDashboard() {
            const variantes = new Set(inventario.map(i => i.variante)).size;
            const ubicaciones = new Set(inventario.map(i => i.ubicacion)).size;
            const unidades = inventario.reduce((s, i) => s + (parseInt(i.stock_fisico) || 0), 0);
            const bloqueadas = inventario.reduce((s, i) => s + (parseInt(i.stock_bloqueado) || 0), 0);
            const activas = ordenes.filter(o => !['Completada', 'Cancelada'].includes(o.estado));
            const montoActivas = activas.reduce((s, o) => s + (parseFloat(o.monto_solicitado) || 0), 0);
            const completadas = ordenes.filter(o => o.estado === 'Completada');
            
            let tiempoProm = 0;
            if (completadas.length > 0) {
                const tiempos = completadas.map(o => {
                    if (o.fecha_cierre && o.fecha) {
                        return (new Date(o.fecha_cierre) - new Date(o.fecha)) / 86400000;
                    }
                    return 0;
                }).filter(t => t > 0);
                if (tiempos.length > 0) {
                    tiempoProm = tiempos.reduce((a, b) => a + b, 0) / tiempos.length;
                }
            }

            document.getElementById('statVariantes').textContent = variantes.toLocaleString();
            document.getElementById('statUbicaciones').textContent = ubicaciones.toLocaleString();
            document.getElementById('statUnidades').textContent = unidades.toLocaleString();
            document.getElementById('statDisponibles').textContent = (unidades - bloqueadas).toLocaleString();
            document.getElementById('statOrdenes').textContent = activas.length;
            document.getElementById('statMontoOrdenes').textContent = formatMoney(montoActivas);
            document.getElementById('statTiempoProm').innerHTML = tiempoProm.toFixed(1) + '<span style="font-size:0.9rem">d</span>';
            document.getElementById('statCompletadas').textContent = completadas.length;

            generarGraficas();
        }

        function generarGraficas() {
            const ctxEstados = document.getElementById('chartEstados');
            if (chartEstados) chartEstados.destroy();
            const estados = {};
            ordenes.forEach(o => { estados[o.estado] = (estados[o.estado] || 0) + 1; });
            chartEstados = new Chart(ctxEstados, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(estados),
                    datasets: [{
                        data: Object.values(estados),
                        backgroundColor: ['#a855f7', '#f59e0b', '#3b82f6', '#f59e0b', '#3b82f6', '#10b981', '#ef4444']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });

            const ctxMontos = document.getElementById('chartMontos');
            if (chartMontos) chartMontos.destroy();
            const labels = [], dataMontos = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const fecha = d.toISOString().split('T')[0];
                labels.push(d.toLocaleDateString('es-PE', { day: '2-digit', month: 'short' }));
                const monto = ordenes.filter(o => o.fecha && o.fecha.startsWith(fecha))
                    .reduce((s, o) => s + (parseFloat(o.monto_solicitado) || 0), 0);
                dataMontos.push(monto);
            }
            chartMontos = new Chart(ctxMontos, {
                type: 'line',
                data: { labels, datasets: [{ data: dataMontos, borderColor: '#6366f1', backgroundColor: 'rgba(99,102,241,0.1)', tension: 0.4, fill: true }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            const ctxEquipos = document.getElementById('chartEquipos');
            if (chartEquipos) chartEquipos.destroy();
            const equiposNombres = equipos.map(e => e.nombre);
            const equiposData = equipos.map(e => {
                return picking.filter(p => p.equipo_id === e.id && p.estado === 'Completado').length;
            });
            chartEquipos = new Chart(ctxEquipos, {
                type: 'bar',
                data: { labels: equiposNombres.length ? equiposNombres : ['Sin equipos'], datasets: [{ data: equiposData.length ? equiposData : [0], backgroundColor: '#3b82f6', borderRadius: 6 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            const ctxGeneros = document.getElementById('chartGeneros');
            if (chartGeneros) chartGeneros.destroy();
            const generos = {};
            productos.forEach(p => { generos[p.genero || 'Sin género'] = (generos[p.genero || 'Sin género'] || 0) + 1; });
            chartGeneros = new Chart(ctxGeneros, {
                type: 'pie',
                data: { labels: Object.keys(generos), datasets: [{ data: Object.values(generos), backgroundColor: ['#6366f1', '#ec4899', '#f59e0b', '#10b981', '#8b5cf6'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });
        }

        // ============================================
        // INVENTARIO
        // ============================================
        function renderizarInventario() {
            document.getElementById('countInventario').textContent = inventarioFiltrado.length.toLocaleString();
            const totalPag = Math.ceil(inventarioFiltrado.length / ITEMS_POR_PAGINA) || 1;
            if (paginaInv > totalPag) paginaInv = totalPag;
            const items = inventarioFiltrado.slice((paginaInv - 1) * ITEMS_POR_PAGINA, paginaInv * ITEMS_POR_PAGINA);

            document.getElementById('tablaInventario').innerHTML = items.length === 0 
                ? '<tr><td colspan="6" class="empty-state">No hay datos</td></tr>'
                : items.map(i => {
                    const bloq = parseInt(i.stock_bloqueado) || 0;
                    const disp = (parseInt(i.stock_fisico) || 0) - bloq;
                    return `<tr>
                        <td><strong>${i.variante}</strong></td>
                        <td><span class="badge badge-info">${i.ubicacion}</span></td>
                        <td>${i.stock_fisico || 0}</td>
                        <td>${bloq > 0 ? `<strong style="color:var(--warning)">${bloq}</strong>` : '0'}</td>
                        <td><strong style="color:${disp > 0 ? 'var(--success)' : 'var(--danger)'}">${disp}</strong></td>
                        <td>
                            <button class="btn btn-info btn-icon btn-sm" onclick="verVariante('${i.variante}','${i.ubicacion}')" title="Ver Info"><i data-lucide="info" style="width:14px;height:14px"></i></button>
                            ${bloq > 0 ? `<button class="btn btn-warning btn-icon btn-sm" onclick="desbloquearItem('${i.variante}','${i.ubicacion}')" title="Desbloquear"><i data-lucide="unlock" style="width:14px;height:14px"></i></button>` : ''}
                            <button class="btn btn-danger btn-icon btn-sm" onclick="eliminarItem('${i.variante}','${i.ubicacion}')" title="Eliminar"><i data-lucide="trash-2" style="width:14px;height:14px"></i></button>
                        </td>
                    </tr>`;
                }).join('');

            document.getElementById('paginaInventario').textContent = paginaInv;
            document.getElementById('totalPaginasInventario').textContent = totalPag;
            document.getElementById('prevInventario').disabled = paginaInv === 1;
            document.getElementById('nextInventario').disabled = paginaInv >= totalPag;
            lucide.createIcons();
        }

        function filtrarInventario() {
            const search = normalizarTexto(document.getElementById('searchInventario')?.value || '');
            inventarioFiltrado = inventario.filter(i => 
                normalizarTexto(i.variante).includes(search) || normalizarTexto(i.ubicacion).includes(search)
            );
            paginaInv = 1;
            renderizarInventario();
        }

        function verVariante(variante, ubicacion) {
            const inv = inventario.find(i => i.variante === variante && i.ubicacion === ubicacion);
            const prod = productos.find(p => p.variante === variante);
            
            let html = '<div class="detail-grid">';
            html += `<div class="detail-item"><div class="detail-label">Variante</div><div class="detail-value">${variante}</div></div>`;
            html += `<div class="detail-item"><div class="detail-label">Ubicación</div><div class="detail-value">${ubicacion}</div></div>`;
            
            if (inv) {
                html += `<div class="detail-item"><div class="detail-label">Stock Físico</div><div class="detail-value">${inv.stock_fisico || 0}</div></div>`;
                html += `<div class="detail-item"><div class="detail-label">Bloqueado</div><div class="detail-value">${inv.stock_bloqueado || 0}</div></div>`;
                html += `<div class="detail-item"><div class="detail-label">Disponible</div><div class="detail-value" style="color:var(--success)">${(inv.stock_fisico || 0) - (inv.stock_bloqueado || 0)}</div></div>`;
            }
            
            if (prod) {
                html += `<div class="detail-item" style="grid-column:span 2"><div class="detail-label">Descripción</div><div class="detail-value">${prod.descripcion || '-'}</div></div>`;
                html += `<div class="detail-item"><div class="detail-label">Código Comercial</div><div class="detail-value">${prod.codigo_comercial || '-'}</div></div>`;
                html += `<div class="detail-item"><div class="detail-label">Género</div><div class="detail-value">${prod.genero || '-'}</div></div>`;
                html += `<div class="detail-item"><div class="detail-label">Marca</div><div class="detail-value">${prod.marca || '-'}</div></div>`;
                html += `<div class="detail-item"><div class="detail-label">Talla</div><div class="detail-value">${prod.talla || '-'}</div></div>`;
                html += `<div class="detail-item"><div class="detail-label">Kardex</div><div class="detail-value" style="color:var(--primary)">${formatMoney(prod.kardex)}</div></div>`;
                html += `<div class="detail-item"><div class="detail-label">PVP</div><div class="detail-value" style="color:var(--success)">${formatMoney(prod.pvp)}</div></div>`;
                html += `<div class="detail-item"><div class="detail-label">PVP Regular</div><div class="detail-value">${formatMoney(prod.pvp_regular)}</div></div>`;
            } else {
                html += `<div class="detail-item" style="grid-column:span 2"><div class="detail-label">Producto</div><div class="detail-value" style="color:var(--warning)">No encontrado en catálogo</div></div>`;
            }
            html += '</div>';
            
            document.getElementById('varianteDetalleContent').innerHTML = html;
            abrirModal('modalVerVariante');
        }

        async function desbloquearItem(variante, ubicacion) {
            if (!confirm(`¿Desbloquear stock de ${variante} en ${ubicacion}?`)) return;
            mostrarLoading('Desbloqueando...');
            await supabase.from('inventario').update({ stock_bloqueado: 0 }).eq('variante', variante).eq('ubicacion', ubicacion);
            ocultarLoading();
            toast('Stock desbloqueado', 'success');
            await cargarDatos();
        }

        async function desbloquearTodoStock() {
            if (!confirm('⚠️ Esto desbloqueará TODO el stock. ¿Continuar?')) return;
            mostrarLoading('Desbloqueando todo...');
            const bloqueados = inventario.filter(i => (parseInt(i.stock_bloqueado) || 0) > 0);
            let count = 0;
            for (const item of bloqueados) {
                await supabase.from('inventario').update({ stock_bloqueado: 0 }).eq('variante', item.variante).eq('ubicacion', item.ubicacion);
                count++;
            }
            ocultarLoading();
            toast(`${count} items desbloqueados`, 'success');
            await cargarDatos();
        }

        async function eliminarItem(variante, ubicacion) {
            if (!confirm(`¿Eliminar ${variante} de ${ubicacion}?`)) return;
            mostrarLoading('Eliminando...');
            await supabase.from('inventario').delete().eq('variante', variante).eq('ubicacion', ubicacion);
            ocultarLoading();
            toast('Eliminado', 'success');
            await cargarDatos();
        }

        async function guardarItem() {
            const v = normalizarTexto(document.getElementById('inputVariante').value);
            const u = normalizarTexto(document.getElementById('inputUbicacion').value);
            const s = parseInt(document.getElementById('inputStock').value) || 0;
            if (!v || !u) { toast('Completa variante y ubicación', 'error'); return; }
            mostrarLoading('Guardando...');
            await supabase.from('inventario').upsert({ variante: v, ubicacion: u, stock_fisico: s, stock_bloqueado: 0 }, { onConflict: 'variante,ubicacion' });
            ocultarLoading();
            toast('Guardado', 'success');
            cerrarModal('modalAgregarItem');
            await cargarDatos();
        }

        async function procesarInventario() {
            const file = document.getElementById('fileInventario').files[0];
            if (!file) { toast('Selecciona un archivo', 'error'); return; }
            mostrarLoading('Procesando inventario...');
            try {
                const data = await leerExcel(file);
                const items = data.map(r => ({
                    variante: normalizarTexto(getCol(r, ['variante', 'Variante', 'VARIANTE'])),
                    ubicacion: normalizarTexto(getCol(r, ['ubicacion', 'Ubicacion', 'UBICACION', 'Ubicación'])),
                    stock_fisico: parseInt(getCol(r, ['stock_fisico', 'StockFisico', 'stockfisico', 'Stock', 'stock', 'STOCK'])) || 0,
                    stock_bloqueado: 0
                })).filter(i => i.variante && i.ubicacion);

                for (let i = 0; i < items.length; i += BATCH_SIZE) {
                    await supabase.from('inventario').upsert(items.slice(i, i + BATCH_SIZE), { onConflict: 'variante,ubicacion' });
                    actualizarProgreso((i / items.length) * 100);
                }
                ocultarLoading();
                toast(`${items.length} registros procesados`, 'success');
                cerrarModal('modalSubirInventario');
                limpiarArchivo('fileInventario', 'fileInventarioInfo');
                await cargarDatos();
            } catch (e) {
                ocultarLoading();
                toast('Error: ' + e.message, 'error');
            }
        }

        async function procesarModificarMasivo() {
            const file = document.getElementById('fileModificar').files[0];
            if (!file) { toast('Selecciona un archivo', 'error'); return; }
            mostrarLoading('Modificando...');
            const data = await leerExcel(file);
            let count = 0;
            for (const r of data) {
                const v = normalizarTexto(getCol(r, ['variante', 'Variante']));
                const u = normalizarTexto(getCol(r, ['ubicacion', 'Ubicacion']));
                const s = parseInt(getCol(r, ['stock_fisico', 'StockFisico', 'Stock'])) || 0;
                if (v && u) {
                    await supabase.from('inventario').update({ stock_fisico: s }).eq('variante', v).eq('ubicacion', u);
                    count++;
                }
            }
            ocultarLoading();
            toast(`${count} registros actualizados`, 'success');
            cerrarModal('modalModificarMasivo');
            limpiarArchivo('fileModificar', 'fileModificarInfo');
            await cargarDatos();
        }

        async function procesarEliminarMasivo() {
            const file = document.getElementById('fileEliminar').files[0];
            if (!file) { toast('Selecciona un archivo', 'error'); return; }
            if (!confirm('¿Eliminar estos productos?')) return;
            mostrarLoading('Eliminando...');
            const data = await leerExcel(file);
            let count = 0;
            for (const r of data) {
                const v = normalizarTexto(getCol(r, ['variante', 'Variante']));
                const u = normalizarTexto(getCol(r, ['ubicacion', 'Ubicacion']));
                if (v && u) {
                    await supabase.from('inventario').delete().eq('variante', v).eq('ubicacion', u);
                    count++;
                }
            }
            ocultarLoading();
            toast(`${count} eliminados`, 'success');
            cerrarModal('modalEliminarMasivo');
            limpiarArchivo('fileEliminar', 'fileEliminarInfo');
            await cargarDatos();
        }

        function exportarInventarioCompleto() {
            if (!inventario.length) { toast('Sin datos', 'warning'); return; }
            const data = inventario.map(i => {
                const prod = productos.find(p => p.variante === i.variante);
                return {
                    Variante: i.variante,
                    Ubicacion: i.ubicacion,
                    StockFisico: i.stock_fisico,
                    StockBloqueado: i.stock_bloqueado,
                    Disponible: (i.stock_fisico || 0) - (i.stock_bloqueado || 0),
                    CodigoComercial: prod?.codigo_comercial || '',
                    Descripcion: prod?.descripcion || '',
                    Genero: prod?.genero || '',
                    Marca: prod?.marca || '',
                    Talla: prod?.talla || '',
                    Kardex: prod?.kardex || 0,
                    PVP: prod?.pvp || 0,
                    PVPRegular: prod?.pvp_regular || 0
                };
            });
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'InventarioCompleto');
            XLSX.writeFile(wb, `Inventario_Completo_${new Date().toISOString().split('T')[0]}.xlsx`);
            toast('Exportado', 'success');
        }

        // ============================================
        // PRODUCTOS
        // ============================================
        function actualizarFiltrosProductos() {
            const generos = [...new Set(productos.map(p => p.genero).filter(Boolean))].sort();
            const lineas = [...new Set(productos.map(p => p.linea).filter(Boolean))].sort();
            const marcas = [...new Set(productos.map(p => p.marca).filter(Boolean))].sort();
            document.getElementById('filtroGenero').innerHTML = '<option value="">Géneros</option>' + generos.map(g => `<option value="${g}">${g}</option>`).join('');
            document.getElementById('filtroLinea').innerHTML = '<option value="">Líneas</option>' + lineas.map(l => `<option value="${l}">${l}</option>`).join('');
            document.getElementById('filtroMarca').innerHTML = '<option value="">Marcas</option>' + marcas.map(m => `<option value="${m}">${m}</option>`).join('');
        }

        function renderizarProductos() {
            document.getElementById('countProductos').textContent = productosFiltrado.length.toLocaleString();
            const totalPag = Math.ceil(productosFiltrado.length / ITEMS_POR_PAGINA) || 1;
            if (paginaProd > totalPag) paginaProd = totalPag;
            const items = productosFiltrado.slice((paginaProd - 1) * ITEMS_POR_PAGINA, paginaProd * ITEMS_POR_PAGINA);

            document.getElementById('tablaProductos').innerHTML = items.length === 0
                ? '<tr><td colspan="9" class="empty-state">No hay productos</td></tr>'
                : items.map(p => `<tr>
                    <td><strong>${p.variante}</strong></td>
                    <td>${p.codigo_comercial || '-'}</td>
                    <td class="td-wrap">${p.descripcion || '-'}</td>
                    <td>${p.genero || '-'}</td>
                    <td>${p.marca || '-'}</td>
                    <td>${p.talla || '-'}</td>
                    <td><strong style="color:var(--primary)">${formatMoney(p.kardex)}</strong></td>
                    <td><strong style="color:var(--success)">${formatMoney(p.pvp)}</strong></td>
                    <td>${formatMoney(p.pvp_regular)}</td>
                </tr>`).join('');

            document.getElementById('paginaProductos').textContent = paginaProd;
            document.getElementById('totalPaginasProductos').textContent = totalPag;
            document.getElementById('prevProductos').disabled = paginaProd === 1;
            document.getElementById('nextProductos').disabled = paginaProd >= totalPag;
        }

        function filtrarProductos() {
            const search = normalizarTexto(document.getElementById('searchProductos')?.value || '');
            const gen = document.getElementById('filtroGenero')?.value || '';
            const lin = document.getElementById('filtroLinea')?.value || '';
            const mar = document.getElementById('filtroMarca')?.value || '';
            
            productosFiltrado = productos.filter(p =>
                (normalizarTexto(p.variante).includes(search) || normalizarTexto(p.descripcion || '').includes(search) || normalizarTexto(p.codigo_comercial || '').includes(search)) &&
                (!gen || p.genero === gen) && (!lin || p.linea === lin) && (!mar || p.marca === mar)
            );
            paginaProd = 1;
            renderizarProductos();
        }

        async function procesarProductos() {
            const file = document.getElementById('fileProductos').files[0];
            if (!file) { toast('Selecciona un archivo', 'error'); return; }
            if (!confirm('Esto reemplazará el catálogo. ¿Continuar?')) return;
            mostrarLoading('Procesando catálogo...');
            await supabase.from('productos_system').delete().neq('variante', '');
            const data = await leerExcel(file);
            const items = data.map(r => ({
                variante: normalizarTexto(getCol(r, ['variante', 'Variante', 'VARIANTE'])),
                codigo_comercial: String(getCol(r, ['codigo_comercial', 'CodigoComercial', 'Codigo', 'codigo']) || '').trim(),
                descripcion: String(getCol(r, ['descripcion', 'Descripcion', 'DESCRIPCION']) || '').trim(),
                kardex: parseFloat(getCol(r, ['kardex', 'Kardex', 'KARDEX'])) || 0,
                pvp: parseFloat(getCol(r, ['pvp', 'PVP'])) || 0,
                pvp_regular: parseFloat(getCol(r, ['pvp_regular', 'PVPRegular', 'pvpregular'])) || 0,
                genero: String(getCol(r, ['genero', 'Genero', 'GENERO']) || '').trim(),
                linea: String(getCol(r, ['linea', 'Linea', 'LINEA']) || '').trim(),
                marca: String(getCol(r, ['marca', 'Marca', 'MARCA']) || '').trim(),
                talla: String(getCol(r, ['talla', 'Talla', 'TALLA']) || '').trim()
            })).filter(i => i.variante);

            for (let i = 0; i < items.length; i += BATCH_SIZE) {
                await supabase.from('productos_system').insert(items.slice(i, i + BATCH_SIZE));
                actualizarProgreso((i / items.length) * 100);
            }
            ocultarLoading();
            toast(`${items.length} productos cargados`, 'success');
            cerrarModal('modalSubirProductos');
            limpiarArchivo('fileProductos', 'fileProductosInfo');
            await cargarDatos();
        }

        function exportarProductos() {
            if (!productos.length) { toast('Sin productos', 'warning'); return; }
            const ws = XLSX.utils.json_to_sheet(productos);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Productos');
            XLSX.writeFile(wb, `Productos_${new Date().toISOString().split('T')[0]}.xlsx`);
            toast('Exportado', 'success');
        }

        // ============================================
        // ÓRDENES
        // ============================================
        function renderizarOrdenes() {
            document.getElementById('tablaOrdenes').innerHTML = ordenesFiltradas.length === 0
                ? '<tr><td colspan="8" class="empty-state">No hay órdenes</td></tr>'
                : ordenesFiltradas.map(o => {
                    const total = o.total_unidades || 1;
                    const encontrado = o.unidades_encontradas || 0;
                    const empacado = o.unidades_empacadas || 0;
                    let progreso = 0;
                    let progresoTexto = '';
                    
                    if (o.estado === 'Pendiente División') {
                        progreso = 0;
                        progresoTexto = 'Sin iniciar';
                    } else if (o.estado === 'Pendiente Picking' || o.estado === 'En Picking') {
                        progreso = Math.round((encontrado / total) * 50);
                        progresoTexto = `Picking: ${encontrado}/${total}`;
                    } else if (o.estado === 'Pendiente Packing' || o.estado === 'En Packing') {
                        progreso = 50 + Math.round((empacado / encontrado) * 50) || 50;
                        progresoTexto = `Packing: ${empacado}/${encontrado}`;
                    } else if (o.estado === 'Completada') {
                        progreso = 100;
                        progresoTexto = 'Completada';
                    }
                    
                    const colorBarra = progreso === 100 ? 'var(--success)' : progreso > 50 ? 'var(--info)' : 'var(--warning)';
                    
                    return `<tr>
                        <td><strong>${o.id}</strong></td>
                        <td class="td-wrap" style="max-width:180px">${o.nombre}</td>
                        <td>${formatFecha(o.fecha)}<br><small style="color:var(--text-secondary)">${diasTranscurridos(o.fecha)}d</small></td>
                        <td>${(o.total_unidades || 0).toLocaleString()}</td>
                        <td><strong style="color:var(--primary)">${formatMoney(o.monto_final || o.monto_solicitado)}</strong></td>
                        <td style="min-width:120px">
                            <div style="background:var(--bg-hover);border-radius:4px;height:8px;overflow:hidden">
                                <div style="width:${progreso}%;height:100%;background:${colorBarra}"></div>
                            </div>
                            <small style="color:var(--text-secondary)">${progresoTexto}</small>
                        </td>
                        <td>${getBadge(o.estado)}</td>
                        <td>
                            <button class="btn btn-info btn-icon btn-sm" onclick="verHistorialOrden('${o.id}')" title="Historial"><i data-lucide="history" style="width:14px;height:14px"></i></button>
                            ${o.estado === 'Pendiente División' ? `<button class="btn btn-purple btn-icon btn-sm" onclick="abrirDividirOrden('${o.id}')" title="Dividir"><i data-lucide="scissors" style="width:14px;height:14px"></i></button>` : ''}
                            ${['Pendiente División', 'Cancelada'].includes(o.estado) ? `<button class="btn btn-danger btn-icon btn-sm" onclick="eliminarOrden('${o.id}')" title="Eliminar"><i data-lucide="trash-2" style="width:14px;height:14px"></i></button>` : ''}
                        </td>
                    </tr>`;
                }).join('');
            lucide.createIcons();
        }

        function filtrarOrdenes() {
            const search = normalizarTexto(document.getElementById('searchOrdenes')?.value || '');
            const estado = document.getElementById('filtroEstadoOrden')?.value || '';
            ordenesFiltradas = ordenes.filter(o =>
                (normalizarTexto(o.id).includes(search) || normalizarTexto(o.nombre).includes(search)) &&
                (!estado || o.estado === estado)
            );
            renderizarOrdenes();
        }

        async function previsualizarOrden() {
            const file = document.getElementById('fileOrden').files[0];
            if (!file) return;
            try {
                const data = await leerExcel(file);
                const items = [];
                let totalUnidades = 0;
                const tiendasDetectadas = new Set();

                data.forEach(r => {
                    const v = normalizarTexto(getCol(r, ['variante', 'Variante', 'VARIANTE']));
                    const u = normalizarTexto(getCol(r, ['ubicacion', 'Ubicacion', 'UBICACION', 'Ubicación']));
                    if (!v) return;

                    const dist = buscarTienda(r);
                    const cant = Object.values(dist).reduce((a, b) => a + b, 0);
                    Object.keys(dist).forEach(t => tiendasDetectadas.add(t));

                    if (cant > 0) {
                        items.push({ variante: v, ubicacion: u || '-', cantidad: cant, distribucion: dist });
                        totalUnidades += cant;
                    }
                });

                const preview = document.getElementById('previewOrden');
                const content = document.getElementById('previewOrdenContent');
                
                if (items.length === 0) {
                    content.innerHTML = '<strong style="color:var(--danger)">⚠️ No se encontraron items válidos</strong><br>Verifica las columnas del archivo.';
                } else {
                    let monto = 0;
                    items.forEach(i => {
                        const prod = productos.find(p => p.variante === i.variante);
                        monto += (prod?.kardex || 0) * i.cantidad;
                    });

                    content.innerHTML = `
                        <strong style="color:var(--success)">✅ Archivo válido</strong><br>
                        <strong>Variantes:</strong> ${items.length}<br>
                        <strong>Unidades:</strong> ${totalUnidades.toLocaleString()}<br>
                        <strong>Monto estimado:</strong> ${formatMoney(monto)}<br>
                        <strong>Tiendas:</strong> ${Array.from(tiendasDetectadas).join(', ') || 'Ninguna detectada'}
                    `;
                }
                preview.style.display = 'block';
            } catch (e) {
                toast('Error leyendo archivo: ' + e.message, 'error');
            }
        }

        async function crearOrden() {
            const nombre = document.getElementById('ordenNombre').value.trim();
            const file = document.getElementById('fileOrden').files[0];
            
            if (!nombre) { toast('Ingresa un nombre para la orden', 'error'); return; }
            if (!file) { toast('Selecciona un archivo', 'error'); return; }

            mostrarLoading('Creando orden...');
            try {
                const data = await leerExcel(file);
                const items = [];
                let totalUnidades = 0;
                let monto = 0;

                data.forEach(r => {
                    const v = normalizarTexto(getCol(r, ['variante', 'Variante', 'VARIANTE']));
                    const u = normalizarTexto(getCol(r, ['ubicacion', 'Ubicacion', 'UBICACION', 'Ubicación']));
                    if (!v) return;

                    const dist = buscarTienda(r);
                    const cant = Object.values(dist).reduce((a, b) => a + b, 0);
                    
                    if (cant > 0) {
                        const prod = productos.find(p => p.variante === v);
                        items.push({
                            variante: v,
                            ubicacion: u || '-',
                            cantidad: cant,
                            distribucion: dist,
                            kardex: prod?.kardex || 0,
                            descripcion: prod?.descripcion || '',
                            genero: prod?.genero || '',
                            talla: prod?.talla || ''
                        });
                        totalUnidades += cant;
                        monto += (prod?.kardex || 0) * cant;
                    }
                });

                if (items.length === 0) {
                    ocultarLoading();
                    toast('No se encontraron items válidos', 'error');
                    return;
                }

                const ordenId = 'ORD-' + Date.now().toString(36).toUpperCase();
                const orden = {
                    id: ordenId,
                    nombre: nombre,
                    fecha: new Date().toISOString(),
                    estado: 'Pendiente División',
                    monto_solicitado: monto,
                    monto_picking: 0,
                    monto_packing: 0,
                    monto_final: 0,
                    total_variantes: items.length,
                    total_unidades: totalUnidades,
                    unidades_encontradas: 0,
                    unidades_empacadas: 0,
                    unidades_reclasificadas: 0,
                    partes: 1,
                    division_config: [],
                    items: items,
                    historial: [{
                        fecha: new Date().toISOString(),
                        accion: 'Orden creada',
                        detalle: `${items.length} variantes, ${totalUnidades} unidades, ${formatMoney(monto)}`
                    }]
                };

                const { error } = await supabase.from('ordenes').insert([orden]);
                if (error) throw error;

                ocultarLoading();
                toast(`Orden ${ordenId} creada exitosamente`, 'success');
                cerrarModal('modalCrearOrden');
                document.getElementById('ordenNombre').value = '';
                limpiarArchivo('fileOrden', 'fileOrdenInfo');
                document.getElementById('previewOrden').style.display = 'none';
                await cargarDatos();
            } catch (e) {
                ocultarLoading();
                toast('Error: ' + e.message, 'error');
                console.error(e);
            }
        }

        function abrirDividirOrden(id) {
            ordenActual = ordenes.find(o => o.id === id);
            if (!ordenActual) return;
            
            document.getElementById('divOrdenNombre').textContent = ordenActual.nombre;
            document.getElementById('divOrdenVariantes').textContent = ordenActual.total_variantes;
            document.getElementById('divOrdenUnidades').textContent = ordenActual.total_unidades?.toLocaleString();
            document.getElementById('numPartes').value = 1;
            generarPartesConfig();
            abrirModal('modalDividirOrden');
        }

        function generarPartesConfig() {
            const numPartes = parseInt(document.getElementById('numPartes').value) || 1;
            const unidadesTotal = ordenActual?.total_unidades || 0;
            
            let html = '';
            for (let i = 1; i <= numPartes; i++) {
                html += `
                    <div class="card" style="margin-bottom:1rem;padding:1rem">
                        <h4 style="margin-bottom:0.75rem">Parte ${i}</h4>
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Nombre</label>
                                <input type="text" class="form-input form-input-sm" id="parteNombre${i}" value="${ordenActual?.nombre || ''} PT${i}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Equipo Picking</label>
                                <select class="form-select form-input-sm" id="parteEquipoPicking${i}">
                                    <option value="">Sin asignar</option>
                                    ${equipos.filter(e => e.tipo === 'picking' && e.activo).map(e => `<option value="${e.id}">${e.nombre}</option>`).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Equipo Packing</label>
                                <select class="form-select form-input-sm" id="parteEquipoPacking${i}">
                                    <option value="">Sin asignar</option>
                                    ${equipos.filter(e => e.tipo === 'packing' && e.activo).map(e => `<option value="${e.id}">${e.nombre}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                    </div>
                `;
            }
            document.getElementById('partesConfig').innerHTML = html;
        }

        async function confirmarDivision() {
            const numPartes = parseInt(document.getElementById('numPartes').value) || 1;
            mostrarLoading('Dividiendo orden...');

            try {
                const items = ordenActual.items || [];
                const itemsPorParte = Math.ceil(items.length / numPartes);
                const divisionConfig = [];

                for (let i = 0; i < numPartes; i++) {
                    const parteNum = i + 1;
                    const nombreParte = document.getElementById(`parteNombre${parteNum}`)?.value || `${ordenActual.nombre} PT${parteNum}`;
                    const equipoPickingId = document.getElementById(`parteEquipoPicking${parteNum}`)?.value || null;
                    const equipoPackingId = document.getElementById(`parteEquipoPacking${parteNum}`)?.value || null;
                    const equipoPicking = equipos.find(e => e.id == equipoPickingId);
                    const equipoPacking = equipos.find(e => e.id == equipoPackingId);

                    const itemsParte = items.slice(i * itemsPorParte, (i + 1) * itemsPorParte);
                    const totalSolicitado = itemsParte.reduce((s, it) => s + it.cantidad, 0);

                    const pickingData = {
                        orden_id: ordenActual.id,
                        parte: parteNum,
                        nombre_parte: nombreParte,
                        equipo_id: equipoPickingId ? parseInt(equipoPickingId) : null,
                        equipo_nombre: equipoPicking?.nombre || null,
                        integrantes: equipoPicking?.integrantes || [],
                        items_asignados: itemsParte,
                        items_encontrados: [],
                        total_solicitado: totalSolicitado,
                        total_encontrado: 0,
                        estado: 'Pendiente'
                    };

                    await supabase.from('picking').insert([pickingData]);

                    const packingData = {
                        orden_id: ordenActual.id,
                        parte: parteNum,
                        nombre_parte: nombreParte,
                        equipo_id: equipoPackingId ? parseInt(equipoPackingId) : null,
                        equipo_nombre: equipoPacking?.nombre || null,
                        integrantes: equipoPacking?.integrantes || [],
                        total_recibido: 0,
                        total_empacado: 0,
                        total_reclasificado: 0,
                        estado: 'Esperando Picking'
                    };

                    await supabase.from('packing').insert([packingData]);

                    divisionConfig.push({
                        parte: parteNum,
                        nombre: nombreParte,
                        items: itemsParte.length,
                        unidades: totalSolicitado,
                        equipoPicking: equipoPicking?.nombre || 'Sin asignar',
                        equipoPacking: equipoPacking?.nombre || 'Sin asignar'
                    });
                }

                const historial = ordenActual.historial || [];
                historial.push({
                    fecha: new Date().toISOString(),
                    accion: 'Orden dividida',
                    detalle: `Dividida en ${numPartes} partes`
                });

                await supabase.from('ordenes').update({
                    estado: 'Pendiente Picking',
                    partes: numPartes,
                    division_config: divisionConfig,
                    historial: historial
                }).eq('id', ordenActual.id);

                for (const item of items) {
                    const inv = inventario.find(i => i.variante === item.variante && i.ubicacion === item.ubicacion);
                    if (inv) {
                        await supabase.from('inventario').update({
                            stock_bloqueado: (parseInt(inv.stock_bloqueado) || 0) + item.cantidad
                        }).eq('variante', item.variante).eq('ubicacion', item.ubicacion);
                    }
                }

                ocultarLoading();
                toast('Orden dividida exitosamente', 'success');
                cerrarModal('modalDividirOrden');
                await cargarDatos();
            } catch (e) {
                ocultarLoading();
                toast('Error: ' + e.message, 'error');
                console.error(e);
            }
        }

        function verHistorialOrden(id) {
            ordenActual = ordenes.find(o => o.id === id);
            if (!ordenActual) return;

            const historial = ordenActual.historial || [];
            const noEncontrados = [];
            const reclasificados = [];
            
            // Extraer items no encontrados y reclasificados
            (ordenActual.items || []).forEach(item => {
                const pickings = picking.filter(p => p.orden_id === id && p.estado === 'Completado');
                let totalEncontrado = 0;
                pickings.forEach(p => {
                    const enc = (p.items_encontrados || []).find(e => e.variante === item.variante);
                    totalEncontrado += enc?.cantidad_encontrada || 0;
                });
                
                if (totalEncontrado < item.cantidad) {
                    noEncontrados.push({
                        variante: item.variante,
                        solicitado: item.cantidad,
                        encontrado: totalEncontrado,
                        faltante: item.cantidad - totalEncontrado
                    });
                }
            });

            const reclasItems = reclasificacion.filter(r => r.orden_id === id);
            reclasItems.forEach(r => {
                reclasificados.push({
                    variante: r.variante_original,
                    cantidad: r.cantidad,
                    motivo: r.motivo,
                    estado: r.estado
                });
            });

            let htmlTabs = `
                <div class="tabs">
                    <div class="tab active" data-tab="timeline" onclick="cambiarTabHistorial('timeline')">Timeline</div>
                    <div class="tab" data-tab="noEncontrados" onclick="cambiarTabHistorial('noEncontrados')">No Encontrados <span class="badge badge-warning">${noEncontrados.length}</span></div>
                    <div class="tab" data-tab="reclasificados" onclick="cambiarTabHistorial('reclasificados')">Reclasificados <span class="badge badge-purple">${reclasificados.length}</span></div>
                    <div class="tab" data-tab="items" onclick="cambiarTabHistorial('items')">Todos los Items</div>
                </div>
                <div id="historialContent"></div>
            `;

            document.getElementById('historialOrdenBody').innerHTML = htmlTabs;
            abrirModal('modalHistorialOrden');
            cambiarTabHistorial('timeline');
        }

        let tabHistorialActual = 'timeline';
        function cambiarTabHistorial(tab) {
            tabHistorialActual = tab;
            document.querySelectorAll('#modalHistorialOrden .tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab);
            });

            const ordenActual = ordenes.find(o => o.id);
            if (!ordenActual) return;

            let html = '';
            
            if (tab === 'timeline') {
                const historial = ordenActual.historial || [];
                html = '<div class="timeline">';
                historial.forEach(h => {
                    html += `
                        <div class="timeline-item">
                            <div class="timeline-date">${formatFechaHora(h.fecha)}</div>
                            <div class="timeline-title">${h.accion}</div>
                            <div class="timeline-desc">${h.detalle || ''}</div>
                        </div>
                    `;
                });
                html += '</div>';
            } else if (tab === 'noEncontrados') {
                const noEncontrados = [];
                (ordenActual.items || []).forEach(item => {
                    const pickings = picking.filter(p => p.orden_id === ordenActual.id && p.estado === 'Completado');
                    let totalEncontrado = 0;
                    pickings.forEach(p => {
                        const enc = (p.items_encontrados || []).find(e => e.variante === item.variante);
                        totalEncontrado += enc?.cantidad_encontrada || 0;
                    });
                    
                    if (totalEncontrado < item.cantidad) {
                        noEncontrados.push({
                            variante: item.variante,
                            solicitado: item.cantidad,
                            encontrado: totalEncontrado,
                            faltante: item.cantidad - totalEncontrado
                        });
                    }
                });

                html = `<div class="table-container"><table>
                    <thead><tr><th>Variante</th><th>Solicitado</th><th>Encontrado</th><th>Faltante</th></tr></thead>
                    <tbody>`;
                noEncontrados.forEach(i => {
                    html += `<tr>
                        <td><strong>${i.variante}</strong></td>
                        <td>${i.solicitado}</td>
                        <td style="color:var(--warning)">${i.encontrado}</td>
                        <td style="color:var(--danger)">${i.faltante}</td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
            } else if (tab === 'reclasificados') {
                const reclasItems = reclasificacion.filter(r => r.orden_id === ordenActual.id);
                html = `<div class="table-container"><table>
                    <thead><tr><th>Variante</th><th>Cantidad</th><th>Motivo</th><th>Estado</th></tr></thead>
                    <tbody>`;
                reclasItems.forEach(r => {
                    html += `<tr>
                        <td><strong>${r.variante_original}</strong></td>
                        <td>${r.cantidad}</td>
                        <td><span class="badge badge-purple">${r.motivo}</span></td>
                        <td>${getBadge(r.estado)}</td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
            } else if (tab === 'items') {
                html = `<div class="table-container"><table>
                    <thead><tr><th>Variante</th><th>Ubicación</th><th>Cantidad</th><th>Distribucion</th></tr></thead>
                    <tbody>`;
                (ordenActual.items || []).forEach(i => {
                    const distStr = Object.entries(i.distribucion || {}).map(([t, c]) => `${t}: ${c}`).join(', ');
                    html += `<tr>
                        <td><strong>${i.variante}</strong></td>
                        <td><span class="badge badge-info">${i.ubicacion || '-'}</span></td>
                        <td>${i.cantidad}</td>
                        <td class="td-wrap" style="max-width:300px">${distStr || '-'}</td>
                    </tr>`;
                });
                html += '</tbody></table></div>';
            }

            document.getElementById('historialContent').innerHTML = html;
            lucide.createIcons();
        }

        async function eliminarOrden(id) {
            if (!confirm('¿Eliminar esta orden?')) return;
            mostrarLoading('Eliminando...');
            
            const orden = ordenes.find(o => o.id === id);
            if (orden?.items) {
                for (const item of orden.items) {
                    const inv = inventario.find(i => i.variante === item.variante && i.ubicacion === item.ubicacion);
                    if (inv) {
                        await supabase.from('inventario').update({
                            stock_bloqueado: Math.max(0, (parseInt(inv.stock_bloqueado) || 0) - item.cantidad)
                        }).eq('variante', item.variante).eq('ubicacion', item.ubicacion);
                    }
                }
            }

            await supabase.from('picking').delete().eq('orden_id', id);
            await supabase.from('packing').delete().eq('orden_id', id);
            await supabase.from('ordenes').delete().eq('id', id);
            
            ocultarLoading();
            toast('Orden eliminada', 'success');
            await cargarDatos();
        }

        // ============================================
        // PICKING
        // ============================================
        let tabPickingActual = 'activos';
        
        function cambiarTabPicking(tab) {
            tabPickingActual = tab;
            document.querySelectorAll('#tabsPicking .tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`#tabsPicking .tab[data-tab="${tab}"]`).classList.add('active');
            renderizarPicking();
        }

        function renderizarPicking() {
            verificarHorarioLaboral();
            
            let pickingMostrar;
            if (tabPickingActual === 'activos') {
                pickingMostrar = picking.filter(p => ['Pendiente', 'En Proceso', 'Pausado'].includes(p.estado));
            } else {
                pickingMostrar = picking.filter(p => p.estado === 'Completado');
            }
            
            document.getElementById('tablaPicking').innerHTML = pickingMostrar.length === 0
                ? `<tr><td colspan="8" class="empty-state">No hay tareas de picking ${tabPickingActual === 'activos' ? 'pendientes' : 'en historial'}</td></tr>`
                : pickingMostrar.map(p => {
                    const orden = ordenes.find(o => o.id === p.orden_id);
                    const tiempoStr = calcularTiempoTrabajado(p);
                    return `<tr>
                        <td><strong>${orden?.nombre || p.orden_id}</strong></td>
                        <td>${p.nombre_parte || 'Parte ' + p.parte}</td>
                        <td>${p.equipo_nombre || '<span style="color:var(--warning)">Sin asignar</span>'}</td>
                        <td>${p.total_solicitado || 0}</td>
                        <td>${p.total_encontrado || 0}</td>
                        <td>${tiempoStr}</td>
                        <td>${getBadge(p.estado)}</td>
                        <td style="white-space:nowrap">
                            <button class="btn btn-info btn-icon btn-sm" onclick="descargarHojaPicking(${p.id})" title="Descargar Hoja"><i data-lucide="download" style="width:14px;height:14px"></i></button>
                            ${p.estado === 'Pendiente' ? `<button class="btn btn-success btn-sm" onclick="iniciarPicking(${p.id})"><i data-lucide="play" style="width:12px;height:12px"></i> Iniciar</button>` : ''}
                            ${p.estado === 'En Proceso' ? `
                                <button class="btn btn-warning btn-sm" onclick="pausarPicking(${p.id})" title="Pausar"><i data-lucide="pause" style="width:12px;height:12px"></i></button>
                                <button class="btn btn-success btn-sm" onclick="abrirSubirCantidadesPicking(${p.id})"><i data-lucide="upload" style="width:12px;height:12px"></i> Subir</button>
                            ` : ''}
                            ${p.estado === 'Pausado' ? `<button class="btn btn-success btn-sm" onclick="reanudarPicking(${p.id})"><i data-lucide="play" style="width:12px;height:12px"></i> Reanudar</button>` : ''}
                            ${p.estado === 'Completado' ? `<button class="btn btn-purple btn-icon btn-sm" onclick="verDetallePicking(${p.id})" title="Ver Detalle"><i data-lucide="eye" style="width:14px;height:14px"></i></button>` : ''}
                        </td>
                    </tr>`;
                }).join('');
            lucide.createIcons();
        }

        function calcularTiempoTrabajado(registro) {
            if (!registro.fecha_inicio) return '-';
            
            let tiempoTotal = registro.tiempo_minutos || 0;
            
            if (registro.estado === 'En Proceso' && registro.fecha_inicio) {
                const ahora = new Date();
                const inicio = new Date(registro.fecha_inicio);
                tiempoTotal += Math.round((ahora - inicio) / 60000);
            }
            
            if (tiempoTotal < 60) return `${tiempoTotal} min`;
            return `${Math.floor(tiempoTotal / 60)}h ${tiempoTotal % 60}m`;
        }

        function verificarHorarioLaboral() {
            const ahora = new Date();
            const hora = ahora.getHours();
            const minutos = ahora.getMinutes();
            const tiempoActual = hora * 60 + minutos;
            
            const horaInicio = 8 * 60 + 30;
            const horaFin = 19 * 60;
            
            const alertaEl = document.getElementById('alertaHorario');
            if (alertaEl) {
                if (tiempoActual < horaInicio) {
                    alertaEl.style.display = 'flex';
                    document.getElementById('alertaHorarioTexto').innerHTML = `⏰ Fuera de horario. El turno inicia a las 8:30 AM`;
                } else if (tiempoActual >= horaFin) {
                    alertaEl.style.display = 'flex';
                    document.getElementById('alertaHorarioTexto').innerHTML = `⏰ Fin de jornada. Recuerda pausar las tareas activas`;
                } else {
                    alertaEl.style.display = 'none';
                }
            }
        }

        async function iniciarPicking(id) {
            mostrarLoading('Iniciando picking...');
            await supabase.from('picking').update({ 
                estado: 'En Proceso',
                fecha_inicio: new Date().toISOString()
            }).eq('id', id);
            
            const pick = picking.find(p => p.id === id);
            if (pick) {
                const orden = ordenes.find(o => o.id === pick.orden_id);
                if (orden) {
                    const historial = orden.historial || [];
                    historial.push({
                        fecha: new Date().toISOString(),
                        accion: `Picking Parte ${pick.parte} iniciado`,
                        detalle: `Equipo: ${pick.equipo_nombre || 'Sin asignar'}`
                    });
                    await supabase.from('ordenes').update({ historial, estado: 'En Picking' }).eq('id', orden.id);
                }
            }
            
            ocultarLoading();
            toast('Picking iniciado', 'success');
            await cargarDatos();
        }

        async function pausarPicking(id) {
            mostrarLoading('Pausando...');
            const pick = picking.find(p => p.id === id);
            if (pick && pick.fecha_inicio) {
                const tiempoAcumulado = (pick.tiempo_minutos || 0) + Math.round((new Date() - new Date(pick.fecha_inicio)) / 60000);
                await supabase.from('picking').update({ 
                    estado: 'Pausado',
                    tiempo_minutos: tiempoAcumulado,
                    fecha_inicio: null
                }).eq('id', id);
            }
            ocultarLoading();
            toast('Picking pausado', 'info');
            await cargarDatos();
        }

        async function reanudarPicking(id) {
            mostrarLoading('Reanudando...');
            await supabase.from('picking').update({ 
                estado: 'En Proceso',
                fecha_inicio: new Date().toISOString()
            }).eq('id', id);
            ocultarLoading();
            toast('Picking reanudado', 'success');
            await cargarDatos();
        }

        function verDetallePicking(id) {
            const pick = picking.find(p => p.id === id);
            if (!pick) return;
            
            const orden = ordenes.find(o => o.id === pick.orden_id);
            const encontrados = pick.items_encontrados || [];
            const asignados = pick.items_asignados || [];
            
            let html = `
                <div class="detail-grid" style="margin-bottom:1rem">
                    <div class="detail-item"><div class="detail-label">Orden</div><div class="detail-value">${orden?.nombre || pick.orden_id}</div></div>
                    <div class="detail-item"><div class="detail-label">Parte</div><div class="detail-value">${pick.nombre_parte}</div></div>
                    <div class="detail-item"><div class="detail-label">Equipo</div><div class="detail-value">${pick.equipo_nombre || '-'}</div></div>
                    <div class="detail-item"><div class="detail-label">Tiempo</div><div class="detail-value">${calcularTiempoTrabajado(pick)}</div></div>
                    <div class="detail-item"><div class="detail-label">Solicitado</div><div class="detail-value">${pick.total_solicitado}</div></div>
                    <div class="detail-item"><div class="detail-label">Encontrado</div><div class="detail-value" style="color:var(--success)">${pick.total_encontrado}</div></div>
                </div>
                <h4 style="margin:1rem 0">Items Encontrados</h4>
                <div class="table-container" style="max-height:300px">
                    <table>
                        <thead><tr><th>Variante</th><th>Solicitado</th><th>Encontrado</th><th>Diferencia</th></tr></thead>
                        <tbody>
                            ${asignados.map(a => {
                                const enc = encontrados.find(e => e.variante === a.variante);
                                const cantEnc = enc?.cantidad_encontrada || 0;
                                const diff = cantEnc - a.cantidad;
                                return `<tr>
                                    <td><strong>${a.variante}</strong></td>
                                    <td>${a.cantidad}</td>
                                    <td style="color:var(--success)">${cantEnc}</td>
                                    <td style="color:${diff >= 0 ? 'var(--success)' : 'var(--danger)'}">${diff >= 0 ? '+' : ''}${diff}</td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('pickingContent').innerHTML = html;
            document.getElementById('pickingFooter').innerHTML = '<button class="btn btn-outline" onclick="cerrarModal(\'modalPicking\')">Cerrar</button>';
            document.getElementById('tituloModalPicking').textContent = 'Detalle de Picking';
            abrirModal('modalPicking');
        }

        function exportarHistorialPicking() {
            const completados = picking.filter(p => p.estado === 'Completado');
            if (!completados.length) { toast('No hay historial', 'warning'); return; }
            
            const data = completados.map(p => {
                const orden = ordenes.find(o => o.id === p.orden_id);
                return {
                    Orden: orden?.nombre || p.orden_id,
                    Parte: p.nombre_parte,
                    Equipo: p.equipo_nombre || '',
                    Integrantes: (p.integrantes || []).join(', '),
                    Solicitado: p.total_solicitado,
                    Encontrado: p.total_encontrado,
                    TiempoMinutos: p.tiempo_minutos,
                    FechaInicio: formatFechaHora(p.fecha_inicio),
                    FechaFin: formatFechaHora(p.fecha_fin)
                };
            });
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'HistorialPicking');
            XLSX.writeFile(wb, `Historial_Picking_${new Date().toISOString().split('T')[0]}.xlsx`);
            toast('Historial exportado', 'success');
        }

        function descargarHojaPicking(id) {
            const pick = picking.find(p => p.id === id);
            if (!pick) return;

            const data = (pick.items_asignados || []).map(i => {
                const prod = productos.find(p => p.variante === i.variante);
                return {
                    Ubicacion: i.ubicacion,
                    Variante: i.variante,
                    CodigoComercial: prod?.codigo_comercial || '',
                    Marca: prod?.marca || '',
                    PVP: prod?.pvp || 0,
                    PVPRegular: prod?.pvp_regular || 0,
                    Descripcion: prod?.descripcion || '',
                    Cantidad: i.cantidad,
                    Encontrado: ''
                };
            });

            data.sort((a, b) => a.Ubicacion.localeCompare(b.Ubicacion));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'HojaPicking');
            XLSX.writeFile(wb, `Picking_${pick.nombre_parte || pick.orden_id}_PT${pick.parte}.xlsx`);
            toast('Hoja descargada', 'success');
        }

        function abrirSubirCantidadesPicking(id) {
            pickingActual = picking.find(p => p.id === id);
            abrirModal('modalSubirCantidades');
        }

        async function confirmarSubirCantidades() {
            const file = document.getElementById('fileCantidades').files[0];
            if (!file) { toast('Selecciona un archivo', 'error'); return; }
            if (!pickingActual) return;

            mostrarLoading('Procesando...');
            try {
                const data = await leerExcel(file);
                const itemsEncontrados = [];
                let totalEncontrado = 0;
                let montoEncontrado = 0;

                data.forEach(r => {
                    const v = normalizarTexto(getCol(r, ['variante', 'Variante']));
                    const u = normalizarTexto(getCol(r, ['ubicacion', 'Ubicacion']));
                    const enc = parseInt(getCol(r, ['encontrado', 'Encontrado', 'ENCONTRADO'])) || 0;
                    
                    if (v && enc > 0) {
                        const prod = productos.find(p => p.variante === v);
                        itemsEncontrados.push({
                            variante: v,
                            ubicacion: u,
                            cantidad_encontrada: enc,
                            kardex: prod?.kardex || 0
                        });
                        totalEncontrado += enc;
                        montoEncontrado += (prod?.kardex || 0) * enc;
                    }
                });

                const fechaFin = new Date();
                const fechaInicio = new Date(pickingActual.fecha_inicio);
                const tiempoMinutos = Math.round((fechaFin - fechaInicio) / 60000);

                await supabase.from('picking').update({
                    items_encontrados: itemsEncontrados,
                    total_encontrado: totalEncontrado,
                    fecha_fin: fechaFin.toISOString(),
                    tiempo_minutos: tiempoMinutos,
                    estado: 'Completado'
                }).eq('id', pickingActual.id);

                await supabase.from('packing').update({
                    items_recibidos: itemsEncontrados,
                    total_recibido: totalEncontrado,
                    estado: 'Pendiente'
                }).eq('orden_id', pickingActual.orden_id).eq('parte', pickingActual.parte);

                const orden = ordenes.find(o => o.id === pickingActual.orden_id);
                if (orden) {
                    const historial = orden.historial || [];
                    historial.push({
                        fecha: fechaFin.toISOString(),
                        accion: `Picking Parte ${pickingActual.parte} completado`,
                        detalle: `${totalEncontrado} unidades encontradas en ${tiempoMinutos} min`
                    });

                    await supabase.from('ordenes').update({
                        unidades_encontradas: (orden.unidades_encontradas || 0) + totalEncontrado,
                        monto_picking: (parseFloat(orden.monto_picking) || 0) + montoEncontrado,
                        historial: historial
                    }).eq('id', orden.id);

                    const pickingsOrden = picking.filter(p => p.orden_id === orden.id);
                    const todosCompletados = pickingsOrden.every(p => p.id === pickingActual.id || p.estado === 'Completado');
                    if (todosCompletados) {
                        await supabase.from('ordenes').update({
                            estado: 'Pendiente Packing',
                            fecha_fin_picking: fechaFin.toISOString()
                        }).eq('id', orden.id);
                    }
                }

                ocultarLoading();
                toast('Picking completado', 'success');
                cerrarModal('modalSubirCantidades');
                limpiarArchivo('fileCantidades', 'fileCantidadesInfo');
                await cargarDatos();
            } catch (e) {
                ocultarLoading();
                toast('Error: ' + e.message, 'error');
            }
        }

        // ============================================
        // PACKING
        // ============================================
        let tabPackingActual = 'activos';
        
        function cambiarTabPacking(tab) {
            tabPackingActual = tab;
            document.querySelectorAll('#tabsPacking .tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`#tabsPacking .tab[data-tab="${tab}"]`).classList.add('active');
            renderizarPacking();
        }

        function renderizarPacking() {
            let packingMostrar;
            if (tabPackingActual === 'activos') {
                packingMostrar = packing.filter(p => ['Pendiente', 'En Proceso', 'Pausado', 'Esperando Picking'].includes(p.estado));
            } else {
                packingMostrar = packing.filter(p => p.estado === 'Completado');
            }
            
            document.getElementById('tablaPacking').innerHTML = packingMostrar.length === 0
                ? `<tr><td colspan="9" class="empty-state">No hay tareas de packing ${tabPackingActual === 'activos' ? 'pendientes' : 'en historial'}</td></tr>`
                : packingMostrar.map(p => {
                    const orden = ordenes.find(o => o.id === p.orden_id);
                    const tiempoStr = calcularTiempoTrabajado(p);
                    return `<tr>
                        <td><strong>${orden?.nombre || p.orden_id}</strong></td>
                        <td>${p.nombre_parte || 'Parte ' + p.parte}</td>
                        <td>${p.equipo_nombre || '<span style="color:var(--warning)">Sin asignar</span>'}</td>
                        <td>${p.total_recibido || 0}</td>
                        <td style="color:var(--success)">${p.total_empacado || 0}</td>
                        <td style="color:var(--warning)">${p.total_reclasificado || 0}</td>
                        <td>${tiempoStr}</td>
                        <td>${getBadge(p.estado)}</td>
                        <td style="white-space:nowrap">
                            <button class="btn btn-info btn-icon btn-sm" onclick="descargarHojaPacking(${p.id})" title="Descargar Hoja"><i data-lucide="download" style="width:14px;height:14px"></i></button>
                            ${p.estado === 'Esperando Picking' ? '<span class="badge badge-purple">Esperando</span>' : ''}
                            ${p.estado === 'Pendiente' ? `<button class="btn btn-success btn-sm" onclick="iniciarPacking(${p.id})"><i data-lucide="play" style="width:12px;height:12px"></i> Iniciar</button>` : ''}
                            ${p.estado === 'En Proceso' ? `
                                <button class="btn btn-warning btn-sm" onclick="pausarPacking(${p.id})" title="Pausar"><i data-lucide="pause" style="width:12px;height:12px"></i></button>
                                <button class="btn btn-purple btn-sm" onclick="abrirSubirDistribucion(${p.id})"><i data-lucide="upload" style="width:12px;height:12px"></i> Subir</button>
                                <button class="btn btn-success btn-sm" onclick="completarPacking(${p.id})"><i data-lucide="check" style="width:12px;height:12px"></i></button>
                            ` : ''}
                            ${p.estado === 'Pausado' ? `<button class="btn btn-success btn-sm" onclick="reanudarPacking(${p.id})"><i data-lucide="play" style="width:12px;height:12px"></i> Reanudar</button>` : ''}
                            ${p.estado === 'Completado' ? `<button class="btn btn-purple btn-icon btn-sm" onclick="verDetallePacking(${p.id})" title="Ver Detalle"><i data-lucide="eye" style="width:14px;height:14px"></i></button>` : ''}
                        </td>
                    </tr>`;
                }).join('');
            lucide.createIcons();
        }

        async function iniciarPacking(id) {
            mostrarLoading('Iniciando packing...');
            await supabase.from('packing').update({ 
                estado: 'En Proceso',
                fecha_inicio: new Date().toISOString()
            }).eq('id', id);
            
            const pack = packing.find(p => p.id === id);
            if (pack) {
                const orden = ordenes.find(o => o.id === pack.orden_id);
                if (orden) {
                    const historial = orden.historial || [];
                    historial.push({
                        fecha: new Date().toISOString(),
                        accion: `Packing Parte ${pack.parte} iniciado`,
                        detalle: `Equipo: ${pack.equipo_nombre || 'Sin asignar'}`
                    });
                    await supabase.from('ordenes').update({ historial, estado: 'En Packing' }).eq('id', orden.id);
                }
            }
            
            ocultarLoading();
            toast('Packing iniciado', 'success');
            await cargarDatos();
        }

        async function pausarPacking(id) {
            mostrarLoading('Pausando...');
            const pack = packing.find(p => p.id === id);
            if (pack && pack.fecha_inicio) {
                const tiempoAcumulado = (pack.tiempo_minutos || 0) + Math.round((new Date() - new Date(pack.fecha_inicio)) / 60000);
                await supabase.from('packing').update({ 
                    estado: 'Pausado',
                    tiempo_minutos: tiempoAcumulado,
                    fecha_inicio: null
                }).eq('id', id);
            }
            ocultarLoading();
            toast('Packing pausado', 'info');
            await cargarDatos();
        }

        async function reanudarPacking(id) {
            mostrarLoading('Reanudando...');
            await supabase.from('packing').update({ 
                estado: 'En Proceso',
                fecha_inicio: new Date().toISOString()
            }).eq('id', id);
            ocultarLoading();
            toast('Packing reanudado', 'success');
            await cargarDatos();
        }

        function abrirSubirDistribucion(id) {
            packingActual = packing.find(p => p.id === id);
            if (!packingActual) return;
            
            document.getElementById('packingContent').innerHTML = `
                <div class="alert alert-info" style="margin-bottom:1rem">
                    <i data-lucide="info" style="width:18px;height:18px"></i>
                    <span>Sube el archivo Excel con la distribución por tienda completada</span>
                </div>
                <div class="form-group">
                    <div class="file-upload-container">
                        <input type="file" id="fileDistribucion" class="form-file" accept=".xlsx,.xls" onchange="mostrarArchivoSeleccionado(this,'fileDistribucionInfo')">
                        <label for="fileDistribucion" class="file-upload-btn"><i data-lucide="file-plus" style="width:16px;height:16px"></i> Seleccionar archivo</label>
                        <div class="file-selected" id="fileDistribucionInfo">
                            <div class="file-selected-icon"><i data-lucide="check" style="width:14px;height:14px"></i></div>
                            <span class="file-selected-name"></span>
                            <button class="file-selected-remove" onclick="limpiarArchivo('fileDistribucion','fileDistribucionInfo')"><i data-lucide="x" style="width:16px;height:16px"></i></button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('packingFooter').innerHTML = `
                <button class="btn btn-outline" onclick="cerrarModal('modalPacking')">Cancelar</button>
                <button class="btn btn-primary" onclick="procesarDistribucion()">Procesar</button>
            `;
            document.getElementById('tituloModalPacking').textContent = 'Subir Distribución';
            abrirModal('modalPacking');
            lucide.createIcons();
        }

        async function procesarDistribucion() {
            const file = document.getElementById('fileDistribucion')?.files[0];
            if (!file) { toast('Selecciona un archivo', 'error'); return; }
            if (!packingActual) return;

            mostrarLoading('Procesando distribución...');
            try {
                const data = await leerExcel(file);
                let totalEmpacado = 0;
                let totalReclas = 0;
                const itemsEmpacados = [];
                const itemsReclas = [];

                data.forEach(r => {
                    const v = normalizarTexto(getCol(r, ['variante', 'Variante']));
                    if (!v) return;

                    const dist = buscarTienda(r);
                    const cantEmpacada = Object.values(dist).reduce((a, b) => a + b, 0);
                    const recibido = packingActual.items_recibidos?.find(i => i.variante === v);
                    const cantRecibida = recibido?.cantidad_encontrada || 0;
                    const diferencia = cantRecibida - cantEmpacada;

                    if (cantEmpacada > 0) {
                        itemsEmpacados.push({ variante: v, cantidad: cantEmpacada, distribucion: dist });
                        totalEmpacado += cantEmpacada;
                    }

                    if (diferencia > 0) {
                        const prod = productos.find(p => p.variante === v);
                        itemsReclas.push({
                            orden_id: packingActual.orden_id,
                            packing_id: packingActual.id,
                            variante_original: v,
                            cantidad: diferencia,
                            motivo: 'No empacado',
                            estado: 'Pendiente',
                            fecha: new Date().toISOString(),
                            info_variante: { descripcion: prod?.descripcion, genero: prod?.genero, talla: prod?.talla }
                        });
                        totalReclas += diferencia;
                    }
                });

                await supabase.from('packing').update({
                    items_empacados: itemsEmpacados,
                    total_empacado: totalEmpacado,
                    total_reclasificado: totalReclas,
                    distribucion_tiendas: itemsEmpacados.reduce((acc, i) => {
                        Object.entries(i.distribucion).forEach(([t, c]) => {
                            acc[t] = (acc[t] || 0) + c;
                        });
                        return acc;
                    }, {})
                }).eq('id', packingActual.id);

                if (itemsReclas.length > 0) {
                    await supabase.from('reclasificacion').insert(itemsReclas);
                }

                ocultarLoading();
                toast(`Procesado: ${totalEmpacado} empacadas, ${totalReclas} a reclasificación`, 'success');
                cerrarModal('modalPacking');
                await cargarDatos();
            } catch (e) {
                ocultarLoading();
                toast('Error: ' + e.message, 'error');
            }
        }

        async function completarPacking(id) {
            const pack = packing.find(p => p.id === id);
            if (!pack) return;

            if (!confirm(`¿Completar packing de ${pack.nombre_parte}?\n\nEmpacados: ${pack.total_empacado || 0}\nReclasificados: ${pack.total_reclasificado || 0}`)) return;

            mostrarLoading('Completando packing...');
            try {
                const tiempoFinal = (pack.tiempo_minutos || 0) + (pack.fecha_inicio ? Math.round((new Date() - new Date(pack.fecha_inicio)) / 60000) : 0);
                
                await supabase.from('packing').update({
                    estado: 'Completado',
                    fecha_fin: new Date().toISOString(),
                    tiempo_minutos: tiempoFinal
                }).eq('id', id);

                const orden = ordenes.find(o => o.id === pack.orden_id);
                if (orden) {
                    const historial = orden.historial || [];
                    historial.push({
                        fecha: new Date().toISOString(),
                        accion: `Packing Parte ${pack.parte} completado`,
                        detalle: `${pack.total_empacado || 0} empacados, ${pack.total_reclasificado || 0} reclasificados, ${tiempoFinal} min`
                    });

                    let montoPacking = 0;
                    (pack.items_empacados || []).forEach(i => {
                        const prod = productos.find(p => p.variante === i.variante);
                        montoPacking += (prod?.kardex || 0) * i.cantidad;
                    });

                    const nuevoMontoOrden = (parseFloat(orden.monto_packing) || 0) + montoPacking;
                    const nuevasUnidadesEmp = (orden.unidades_empacadas || 0) + (pack.total_empacado || 0);
                    const nuevasUnidadesReclas = (orden.unidades_reclasificadas || 0) + (pack.total_reclasificado || 0);

                    const packingsOrden = packing.filter(p => p.orden_id === orden.id);
                    const todosCompletados = packingsOrden.every(p => p.id === id || p.estado === 'Completado');

                    await supabase.from('ordenes').update({
                        historial,
                        monto_packing: nuevoMontoOrden,
                        monto_final: nuevoMontoOrden,
                        unidades_empacadas: nuevasUnidadesEmp,
                        unidades_reclasificadas: nuevasUnidadesReclas,
                        estado: todosCompletados ? 'Completada' : orden.estado,
                        fecha_fin_packing: todosCompletados ? new Date().toISOString() : null,
                        fecha_cierre: todosCompletados ? new Date().toISOString() : null
                    }).eq('id', orden.id);

                    if (todosCompletados) {
                        for (const item of pack.items_empacados || []) {
                            const inv = inventario.find(i => i.variante === item.variante);
                            if (inv) {
                                await supabase.from('inventario').update({
                                    stock_fisico: Math.max(0, (parseInt(inv.stock_fisico) || 0) - item.cantidad),
                                    stock_bloqueado: Math.max(0, (parseInt(inv.stock_bloqueado) || 0) - item.cantidad)
                                }).eq('variante', item.variante).eq('ubicacion', inv.ubicacion);
                            }
                        }
                    }
                }

                ocultarLoading();
                toast('Packing completado', 'success');
                await cargarDatos();
            } catch (e) {
                ocultarLoading();
                toast('Error: ' + e.message, 'error');
            }
        }

        function verDetallePacking(id) {
            const pack = packing.find(p => p.id === id);
            if (!pack) return;
            
            const orden = ordenes.find(o => o.id === pack.orden_id);
            
            let html = `
                <div class="detail-grid" style="margin-bottom:1rem">
                    <div class="detail-item"><div class="detail-label">Orden</div><div class="detail-value">${orden?.nombre || pack.orden_id}</div></div>
                    <div class="detail-item"><div class="detail-label">Parte</div><div class="detail-value">${pack.nombre_parte}</div></div>
                    <div class="detail-item"><div class="detail-label">Equipo</div><div class="detail-value">${pack.equipo_nombre || '-'}</div></div>
                    <div class="detail-item"><div class="detail-label">Tiempo</div><div class="detail-value">${calcularTiempoTrabajado(pack)}</div></div>
                    <div class="detail-item"><div class="detail-label">Recibido</div><div class="detail-value">${pack.total_recibido}</div></div>
                    <div class="detail-item"><div class="detail-label">Empacado</div><div class="detail-value" style="color:var(--success)">${pack.total_empacado}</div></div>
                    <div class="detail-item"><div class="detail-label">Reclasificado</div><div class="detail-value" style="color:var(--warning)">${pack.total_reclasificado}</div></div>
                </div>
                <h4 style="margin:1rem 0">Distribución por Tienda</h4>
                <div class="chips">
                    ${Object.entries(pack.distribucion_tiendas || {}).map(([t, c]) => `<div class="chip"><strong>${t}:</strong> ${c}</div>`).join('') || '<span style="color:var(--text-secondary)">Sin distribución registrada</span>'}
                </div>
            `;
            
            document.getElementById('packingContent').innerHTML = html;
            document.getElementById('packingFooter').innerHTML = '<button class="btn btn-outline" onclick="cerrarModal(\'modalPacking\')">Cerrar</button>';
            document.getElementById('tituloModalPacking').textContent = 'Detalle de Packing';
            abrirModal('modalPacking');
        }

        function exportarHistorialPacking() {
            const completados = packing.filter(p => p.estado === 'Completado');
            if (!completados.length) { toast('No hay historial', 'warning'); return; }
            
            const data = completados.map(p => {
                const orden = ordenes.find(o => o.id === p.orden_id);
                return {
                    Orden: orden?.nombre || p.orden_id,
                    Parte: p.nombre_parte,
                    Equipo: p.equipo_nombre || '',
                    Integrantes: (p.integrantes || []).join(', '),
                    Recibido: p.total_recibido,
                    Empacado: p.total_empacado,
                    Reclasificado: p.total_reclasificado,
                    TiempoMinutos: p.tiempo_minutos,
                    FechaInicio: formatFechaHora(p.fecha_inicio),
                    FechaFin: formatFechaHora(p.fecha_fin),
                    ...Object.fromEntries(Object.entries(p.distribucion_tiendas || {}).map(([k, v]) => [`Tienda_${k}`, v]))
                };
            });
            
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'HistorialPacking');
            XLSX.writeFile(wb, `Historial_Packing_${new Date().toISOString().split('T')[0]}.xlsx`);
            toast('Historial exportado', 'success');
        }

        function descargarHojaPacking(id) {
            const pack = packing.find(p => p.id === id);
            if (!pack) return;

            const data = (pack.items_recibidos || []).map(i => {
                const prod = productos.find(p => p.variante === i.variante);
                const row = {
                    Variante: i.variante,
                    Descripcion: prod?.descripcion || '',
                    Marca: prod?.marca || '',
                    Genero: prod?.genero || '',
                    Talla: prod?.talla || '',
                    Kardex: prod?.kardex || 0,
                    Encontrado: i.cantidad_encontrada || 0
                };
                TIENDAS_BASE.forEach(t => {
                    row[t.replace('LUKERS ', '')] = '';
                });
                return row;
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'HojaPacking');
            XLSX.writeFile(wb, `Packing_${pack.nombre_parte || pack.orden_id}_PT${pack.parte}.xlsx`);
            toast('Hoja descargada', 'success');
        }

        // ============================================
        // RECLASIFICACIÓN
        // ============================================
        function cambiarTabReclas(tab) {
            tabReclasActual = tab;
            document.querySelectorAll('#tabsReclas .tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab);
            });
            renderizarReclasificacion();
        }

        function renderizarReclasificacion() {
            let filtradas = reclasificacion;
            if (tabReclasActual === 'pendientes') {
                filtradas = reclasificacion.filter(r => r.estado === 'Pendiente');
            } else if (tabReclasActual === 'completadas') {
                filtradas = reclasificacion.filter(r => r.estado === 'Completada');
            }

            document.getElementById('tablaReclasificacion').innerHTML = filtradas.length === 0
                ? '<tr><td colspan="8" class="empty-state">No hay reclasificaciones</td></tr>'
                : filtradas.map(r => {
                    const prod = productos.find(p => p.variante === r.variante_original);
                    return `<tr>
                        <td>#${r.id}</td>
                        <td>${r.orden_id || '-'}</td>
                        <td><strong>${r.variante_original}</strong></td>
                        <td class="td-wrap">${prod?.descripcion || r.info_variante?.descripcion || '-'}</td>
                        <td>${r.cantidad}</td>
                        <td><span class="badge badge-purple">${r.motivo}</span></td>
                        <td>${getBadge(r.estado)}</td>
                        <td>
                            ${r.estado === 'Pendiente' ? `<button class="btn btn-success btn-icon btn-sm" onclick="abrirCompletarReclas(${r.id})" title="Completar"><i data-lucide="check" style="width:14px;height:14px"></i></button>` : ''}
                            ${r.estado === 'Completada' ? `<span class="badge badge-info">${r.nueva_ubicacion || '-'}</span>` : ''}
                        </td>
                    </tr>`;
                }).join('');
            lucide.createIcons();
        }

        function exportarReclasificacionesPendientes() {
            const pendientes = reclasificacion.filter(r => r.estado === 'Pendiente');
            if (!pendientes.length) { toast('No hay pendientes', 'warning'); return; }

            const data = pendientes.map(r => {
                const prod = productos.find(p => p.variante === r.variante_original);
                return {
                    ID: r.id,
                    Orden: r.orden_id || '',
                    VarianteOriginal: r.variante_original,
                    NuevaVariante: r.nueva_variante || '',
                    Ubicacion: r.ubicacion_original || '',
                    Cantidad: r.cantidad,
                    Motivo: r.motivo,
                    Comentario: r.comentario || '',
                    Descripcion: prod?.descripcion || '',
                    Genero: prod?.genero || '',
                    Talla: prod?.talla || '',
                    Fecha: formatFechaHora(r.fecha)
                };
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'ReclasificacionesPendientes');
            XLSX.writeFile(wb, `Reclasificaciones_Pendientes_${new Date().toISOString().split('T')[0]}.xlsx`);
            toast('Exportado', 'success');
        }

        function abrirCompletarReclas(id) {
            reclasActual = reclasificacion.find(r => r.id === id);
            if (!reclasActual) return;

            const prod = productos.find(p => p.variante === reclasActual.variante_original);

            document.getElementById('completarReclasContent').innerHTML = `
                <div class="detail-grid">
                    <div class="detail-item"><div class="detail-label">Variante</div><div class="detail-value">${reclasActual.variante_original}</div></div>
                    <div class="detail-item"><div class="detail-label">Cantidad</div><div class="detail-value">${reclasActual.cantidad}</div></div>
                    <div class="detail-item"><div class="detail-label">Motivo</div><div class="detail-value">${reclasActual.motivo}</div></div>
                    <div class="detail-item" style="grid-column:span 2"><div class="detail-label">Descripción</div><div class="detail-value">${prod?.descripcion || '-'}</div></div>
                </div>
                <div class="form-group" style="margin-top:1rem">
                    <label class="form-label">Ubicación Final</label>
                    <input type="text" id="ubicacionFinalReclas" class="form-input" placeholder="Ej: A001-01-03">
                </div>
            `;
            abrirModal('modalCompletarReclas');
        }

        async function confirmarCompletarReclas() {
            const ubi = normalizarTexto(document.getElementById('ubicacionFinalReclas')?.value);
            if (!ubi) { toast('Ingresa la ubicación', 'error'); return; }
            if (!reclasActual) return;

            mostrarLoading('Completando...');
            try {
                const varFinal = reclasActual.nueva_variante || reclasActual.variante_original;
                const invExiste = inventario.find(i => i.variante === varFinal && i.ubicacion === ubi);
                
                if (invExiste) {
                    await supabase.from('inventario').update({
                        stock_fisico: (parseInt(invExiste.stock_fisico) || 0) + reclasActual.cantidad
                    }).eq('variante', varFinal).eq('ubicacion', ubi);
                } else {
                    await supabase.from('inventario').insert([{
                        variante: varFinal,
                        ubicacion: ubi,
                        stock_fisico: reclasActual.cantidad,
                        stock_bloqueado: 0
                    }]);
                }

                await supabase.from('reclasificacion').update({
                    estado: 'Completada',
                    nueva_ubicacion: ubi,
                    fecha_completado: new Date().toISOString()
                }).eq('id', reclasActual.id);

                ocultarLoading();
                toast('Reclasificación completada', 'success');
                cerrarModal('modalCompletarReclas');
                await cargarDatos();
            } catch (e) {
                ocultarLoading();
                toast('Error: ' + e.message, 'error');
            }
        }

        // ============================================
        // EQUIPOS
        // ============================================
        function cambiarTabEquipos(tipo) {
            tabEquiposActual = tipo;
            document.querySelectorAll('#vista-equipos .tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tipo === tipo);
            });
            renderizarEquipos();
        }

        function renderizarEquipos() {
            const filtrados = equipos.filter(e => e.tipo === tabEquiposActual);
            
            document.getElementById('tablaEquipos').innerHTML = filtrados.length === 0
                ? '<tr><td colspan="5" class="empty-state">No hay equipos</td></tr>'
                : filtrados.map(e => `<tr>
                    <td><strong>${e.nombre}</strong></td>
                    <td class="td-wrap">${(e.integrantes || []).join(', ') || '-'}</td>
                    <td><span class="badge badge-${e.tipo === 'picking' ? 'info' : 'purple'}">${e.tipo}</span></td>
                    <td>${e.activo ? '<span class="badge badge-success">Activo</span>' : '<span class="badge badge-danger">Inactivo</span>'}</td>
                    <td>
                        <button class="btn btn-info btn-icon btn-sm" onclick="editarEquipo(${e.id})" title="Editar"><i data-lucide="edit" style="width:14px;height:14px"></i></button>
                        <button class="btn btn-danger btn-icon btn-sm" onclick="eliminarEquipo(${e.id})" title="Eliminar"><i data-lucide="trash-2" style="width:14px;height:14px"></i></button>
                    </td>
                </tr>`).join('');
            lucide.createIcons();
        }

        function editarEquipo(id) {
            equipoActual = equipos.find(e => e.id === id);
            if (!equipoActual) return;
            
            document.getElementById('tituloModalEquipo').textContent = 'Editar Equipo';
            document.getElementById('equipoNombre').value = equipoActual.nombre;
            document.getElementById('equipoTipo').value = equipoActual.tipo;
            document.getElementById('equipoIntegrantes').value = (equipoActual.integrantes || []).join('\n');
            abrirModal('modalCrearEquipo');
        }

        async function guardarEquipo() {
            const nombre = document.getElementById('equipoNombre').value.trim();
            const tipo = document.getElementById('equipoTipo').value;
            const integrantes = document.getElementById('equipoIntegrantes').value.split('\n').map(s => s.trim()).filter(Boolean);

            if (!nombre) { toast('Ingresa el nombre', 'error'); return; }

            mostrarLoading('Guardando...');
            try {
                if (equipoActual) {
                    await supabase.from('equipos').update({ nombre, tipo, integrantes }).eq('id', equipoActual.id);
                } else {
                    await supabase.from('equipos').insert([{ nombre, tipo, integrantes, activo: true }]);
                }
                ocultarLoading();
                toast('Equipo guardado', 'success');
                cerrarModal('modalCrearEquipo');
                equipoActual = null;
                document.getElementById('tituloModalEquipo').textContent = 'Nuevo Equipo';
                document.getElementById('equipoNombre').value = '';
                document.getElementById('equipoIntegrantes').value = '';
                await cargarDatos();
            } catch (e) {
                ocultarLoading();
                toast('Error: ' + e.message, 'error');
            }
        }

        async function eliminarEquipo(id) {
            if (!confirm('¿Eliminar este equipo?')) return;
            mostrarLoading('Eliminando...');
            await supabase.from('equipos').delete().eq('id', id);
            ocultarLoading();
            toast('Equipo eliminado', 'success');
            await cargarDatos();
        }

        function cambiarPagina(tipo, dir) {
            if (tipo === 'inventario') { paginaInv += dir; renderizarInventario(); }
            else if (tipo === 'productos') { paginaProd += dir; renderizarProductos(); }
        }

        function toggleAI() {
            document.getElementById('aiPanel').classList.toggle('active');
        }

        async function enviarMensajeAI() {
            const input = document.getElementById('aiInput');
            const mensaje = input.value.trim();
            if (!mensaje) return;

            const messagesDiv = document.getElementById('aiMessages');
            
            // Agregar mensaje del usuario
            messagesDiv.innerHTML += `<div class="ai-message user">${mensaje}</div>`;
            input.value = '';
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            // Mostrar indicador de escritura
            const loadingId = 'ai-loading-' + Date.now();
            messagesDiv.innerHTML += `<div class="ai-message assistant" id="${loadingId}"><em style="opacity:0.6">Claude está pensando...</em></div>`;
            messagesDiv.scrollTop = messagesDiv.scrollHeight;

            try {
                // Preparar contexto del sistema
                const contexto = prepararContextoSistema();
                
                // Llamar a la API de Claude
                const respuesta = await llamarClaudeAPI(mensaje, contexto);
                
                // Reemplazar el indicador de carga con la respuesta
                document.getElementById(loadingId).innerHTML = respuesta;
            } catch (error) {
                console.error('Error en API:', error);
                document.getElementById(loadingId).innerHTML = `<strong style="color:var(--danger)">⚠️ Error al conectar con Claude</strong><br><br>
                    Ha ocurrido un error temporal. Intenta nuevamente.<br><br>
                    <em style="font-size:0.8rem;opacity:0.7">Error: ${error.message}</em>`;
            }
            
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function prepararContextoSistema() {
            // Preparar datos actuales del sistema para el contexto
            const ordenesActivas = ordenes.filter(o => !['Completada', 'Cancelada'].includes(o.estado));
            const pickingActivo = picking.filter(pk => ['En Proceso', 'Pausado'].includes(pk.estado));
            const packingActivo = packing.filter(pk => ['En Proceso', 'Pausado'].includes(pk.estado));
            const reclasPendientes = reclasificacion.filter(r => r.estado === 'Pendiente');
            const stockTotal = inventario.reduce((s, i) => s + (parseInt(i.stock_fisico) || 0), 0);
            const stockBloqueado = inventario.reduce((s, i) => s + (parseInt(i.stock_bloqueado) || 0), 0);
            
            // Calcular estadísticas de rendimiento
            const pickingCompletados = picking.filter(pk => pk.estado === 'Completado');
            const packingCompletados = packing.filter(pk => pk.estado === 'Completado');
            const tiempoPromPicking = pickingCompletados.length > 0 
                ? (pickingCompletados.reduce((s, pk) => s + (pk.tiempo_minutos || 0), 0) / pickingCompletados.length).toFixed(0)
                : 0;
            const tiempoPromPacking = packingCompletados.length > 0 
                ? (packingCompletados.reduce((s, pk) => s + (pk.tiempo_minutos || 0), 0) / packingCompletados.length).toFixed(0)
                : 0;

            // Top 5 productos más solicitados
            const productosConteo = {};
            ordenes.forEach(o => {
                (o.items || []).forEach(item => {
                    productosConteo[item.variante] = (productosConteo[item.variante] || 0) + item.cantidad;
                });
            });
            const topProductos = Object.entries(productosConteo)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([v, c]) => `${v}: ${c} unidades`);

            // Problemas detectados
            const problemas = [];
            const ordenesEstancadas = ordenes.filter(o => {
                if (['Completada', 'Cancelada'].includes(o.estado)) return false;
                return diasTranscurridos(o.fecha) > 3;
            });
            if (ordenesEstancadas.length > 0) problemas.push(`${ordenesEstancadas.length} órdenes estancadas +3 días`);
            if (stockBloqueado > 1000) problemas.push(`Stock bloqueado alto: ${stockBloqueado.toLocaleString()} unidades`);
            if (reclasPendientes.length > 20) problemas.push(`${reclasPendientes.length} reclasificaciones pendientes`);

            return {
                fecha: new Date().toLocaleDateString('es-PE'),
                hora: new Date().toLocaleTimeString('es-PE'),
                sistema: {
                    inventario: {
                        totalRegistros: inventario.length,
                        stockTotal: stockTotal,
                        stockDisponible: stockTotal - stockBloqueado,
                        stockBloqueado: stockBloqueado,
                        ubicaciones: new Set(inventario.map(i => i.ubicacion)).size
                    },
                    productos: {
                        totalCatalogo: productos.length,
                        generos: [...new Set(productos.map(p => p.genero).filter(Boolean))],
                        marcas: [...new Set(productos.map(p => p.marca).filter(Boolean))].length
                    },
                    ordenes: {
                        total: ordenes.length,
                        activas: ordenesActivas.length,
                        completadas: ordenes.filter(o => o.estado === 'Completada').length,
                        pendientesDivision: ordenes.filter(o => o.estado === 'Pendiente División').length,
                        enPicking: ordenes.filter(o => o.estado === 'En Picking').length,
                        enPacking: ordenes.filter(o => o.estado === 'En Packing').length,
                        listaActivas: ordenesActivas.slice(0, 5).map(o => ({
                            id: o.id,
                            nombre: o.nombre,
                            estado: o.estado,
                            unidades: o.total_unidades,
                            dias: diasTranscurridos(o.fecha)
                        }))
                    },
                    picking: {
                        activos: pickingActivo.length,
                        completados: pickingCompletados.length,
                        tiempoPromedio: tiempoPromPicking + ' minutos'
                    },
                    packing: {
                        activos: packingActivo.length,
                        completados: packingCompletados.length,
                        tiempoPromedio: tiempoPromPacking + ' minutos'
                    },
                    reclasificacion: {
                        pendientes: reclasPendientes.length,
                        completadas: reclasificacion.filter(r => r.estado === 'Completada').length
                    },
                    equipos: {
                        total: equipos.length,
                        picking: equipos.filter(e => e.tipo === 'picking').length,
                        packing: equipos.filter(e => e.tipo === 'packing').length
                    }
                },
                estadisticas: {
                    topProductos: topProductos,
                    tiempoPromPicking: tiempoPromPicking,
                    tiempoPromPacking: tiempoPromPacking
                },
                problemas: problemas,
                configuracion: {
                    tiendas: TIENDAS_BASE,
                    itemsPorPagina: ITEMS_POR_PAGINA,
                    horarioLaboral: '8:30 AM - 7:00 PM'
                }
            };
        }

        async function llamarClaudeAPI(pregunta, contexto) {
            // NOTA: Si no funciona, el usuario puede obtener su propia API key en console.anthropic.com
            const CLAUDE_API_KEY = 'sk-ant-api03-CnMZqiKILf0Gk4Wf0YYaYXDH5gXQJLz5F3PJFvLOT9j_WtQxhM1rGvMCJl4VvGkVkBFV_9LVLQpXvXBUKHVdJw-ysqOIQAA';
            
            // Sistema prompt con contexto completo
            const systemPrompt = `Eres MAWI, el asistente inteligente del sistema de gestión de almacén de Lukers. Eres experto en operaciones de almacén, logística y análisis de datos en tiempo real.

📅 CONTEXTO ACTUAL (${contexto.fecha} ${contexto.hora}):

📦 INVENTARIO:
- Registros: ${contexto.sistema.inventario.totalRegistros.toLocaleString()}
- Stock total: ${contexto.sistema.inventario.stockTotal.toLocaleString()} unidades
- Disponible: ${contexto.sistema.inventario.stockDisponible.toLocaleString()} unidades
- Bloqueado: ${contexto.sistema.inventario.stockBloqueado.toLocaleString()} unidades
- Ubicaciones: ${contexto.sistema.inventario.ubicaciones}

🛍️ PRODUCTOS:
- Catálogo: ${contexto.sistema.productos.totalCatalogo.toLocaleString()} productos
- Géneros: ${contexto.sistema.productos.generos.join(', ')}
- Marcas: ${contexto.sistema.productos.marcas}

📋 ÓRDENES:
- Total: ${contexto.sistema.ordenes.total}
- Activas: ${contexto.sistema.ordenes.activas}
- Completadas: ${contexto.sistema.ordenes.completadas}
- Pendientes División: ${contexto.sistema.ordenes.pendientesDivision}
- En Picking: ${contexto.sistema.ordenes.enPicking}
- En Packing: ${contexto.sistema.ordenes.enPacking}

${contexto.sistema.ordenes.listaActivas.length > 0 ? 'ÓRDENES ACTIVAS RECIENTES:\n' + contexto.sistema.ordenes.listaActivas.map(o => `  • ${o.nombre} (${o.estado}, ${o.unidades} unidades, ${o.dias} días)`).join('\n') : ''}

🔍 OPERACIONES:
- Picking activos: ${contexto.sistema.picking.activos} | Completados: ${contexto.sistema.picking.completados} | Tiempo promedio: ${contexto.sistema.picking.tiempoPromedio}
- Packing activos: ${contexto.sistema.packing.activos} | Completados: ${contexto.sistema.packing.completados} | Tiempo promedio: ${contexto.sistema.packing.tiempoPromedio}

🔄 RECLASIFICACIÓN:
- Pendientes: ${contexto.sistema.reclasificacion.pendientes}
- Completadas: ${contexto.sistema.reclasificacion.completadas}

👥 EQUIPOS:
- Total: ${contexto.sistema.equipos.total} (${contexto.sistema.equipos.picking} picking, ${contexto.sistema.equipos.packing} packing)

📊 TOP 5 PRODUCTOS:
${contexto.estadisticas.topProductos.length > 0 ? contexto.estadisticas.topProductos.join('\n') : 'Sin datos'}

${contexto.problemas.length > 0 ? '⚠️ ALERTAS:\n' + contexto.problemas.map(p => `• ${p}`).join('\n') : '✅ Sistema operando normalmente'}

⚙️ CONFIGURACIÓN:
- Tiendas: ${contexto.configuracion.tiendas.length} configuradas
- Horario: ${contexto.configuracion.horarioLaboral}

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

TU ROL:
Eres un asistente IA VERDADERAMENTE INTELIGENTE que puede responder CUALQUIER pregunta sobre el sistema. No estás limitado a respuestas predefinidas.

CAPACIDADES:
✓ Analizar el estado del sistema en tiempo real
✓ Detectar problemas y sugerir soluciones
✓ Explicar procedimientos paso a paso
✓ Comparar rendimiento de equipos
✓ Recomendar optimizaciones basadas en datos
✓ Responder preguntas sobre funcionalidades
✓ Proporcionar insights y tendencias
✓ Ayudar con decisiones operativas

ESTILO:
• Responde en español de forma profesional pero amigable
• Usa los datos del contexto para respuestas precisas
• Formato HTML (<strong>, <br>, <ul>, <li>)  
• Usa emojis ocasionalmente (📊 📦 ✅ ⚠️ 💡)
• Si no sabes algo, sé honesto
• Sé conciso pero completo

FUNCIONALIDADES QUE DOMINAS:
- Inventario: CRUD, Excel, modificación masiva, exportación, desbloqueo
- Productos: Catálogo, filtros, carga/exportación
- Órdenes: Crear, dividir, asignar equipos, historial, bloqueo automático
- Picking: Control tiempo real, pausar/reanudar, subir cantidades
- Packing: Distribución tiendas, reclasificación automática
- Reclasificación: Gestionar items no empacados
- Equipos: Crear/gestionar con métricas rendimiento
- Configuración: Tiendas, horarios, backup

Recuerda: Puedes responder CUALQUIER pregunta, hacer análisis profundos y proporcionar recomendaciones inteligentes basadas en el estado actual del sistema.`;

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': CLAUDE_API_KEY,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 2048,
                        system: systemPrompt,
                        messages: [{
                            role: 'user',
                            content: pregunta
                        }]
                    })
                });

                if (!response.ok) {
                    console.error('Error en API de Claude:', response.status);
                    return generarRespuestaFallback(pregunta, contexto);
                }

                const data = await response.json();
                return data.content[0].text;
            } catch (error) {
                console.error('Error llamando API:', error);
                return generarRespuestaFallback(pregunta, contexto);
            }
        }

        function generarRespuestaFallback(pregunta, contexto) {
            // Sistema de respaldo cuando la API no está disponible
            const p = pregunta.toLowerCase();
            
            if (p.includes('estado') || p.includes('resumen') || p.includes('cómo va') || p.includes('como va')) {
                return `<strong>📊 Estado Actual del Sistema:</strong><br><br>
                    <strong>Inventario:</strong> ${contexto.sistema.inventario.totalRegistros.toLocaleString()} registros, ${contexto.sistema.inventario.stockDisponible.toLocaleString()} unidades disponibles<br>
                    <strong>Órdenes Activas:</strong> ${contexto.sistema.ordenes.activas}<br>
                    <strong>Picking en Proceso:</strong> ${contexto.sistema.picking.activos}<br>
                    <strong>Packing en Proceso:</strong> ${contexto.sistema.packing.activos}<br>
                    <strong>Reclasificaciones Pendientes:</strong> ${contexto.sistema.reclasificacion.pendientes}<br><br>
                    ${contexto.problemas.length > 0 ? '⚠️ <strong>Alertas:</strong><br>' + contexto.problemas.join('<br>') : '✅ Sistema operando normalmente'}<br><br>
                    <em style="font-size:0.85em;opacity:0.8">💡 Configura tu API key de Claude para respuestas más inteligentes</em>`;
            }

            return `<strong>Preguntaste:</strong> "${pregunta}"<br><br>
                Para respuestas inteligentes y personalizadas, necesitas configurar tu API key de Claude.<br><br>
                <strong>¿Cómo configurarla?</strong><br>
                1. Obtén tu API key en <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a><br>
                2. En el código, busca <code>CLAUDE_API_KEY</code><br>
                3. Reemplaza 'TU_API_KEY_AQUI' con tu key real<br><br>
                Mientras tanto, puedo responderte con datos del sistema:<br>
                📊 ${contexto.sistema.ordenes.activas} órdenes activas<br>
                📦 ${contexto.sistema.inventario.totalRegistros.toLocaleString()} registros en inventario<br>
                ⏱️ Tiempo promedio picking: ${contexto.estadisticas.tiempoPromPicking} min`;
        }

        // =========== FUNCIONES DE CONFIGURACIÓN ===========
        function cambiarTabConfig(tab) {
            document.querySelectorAll('#vista-configuracion .tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`#vista-configuracion .tab[data-config="${tab}"]`)?.classList.add('active');
            
            document.querySelectorAll('.config-section').forEach(s => s.style.display = 'none');
            const seccion = document.getElementById(`config${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
            if (seccion) seccion.style.display = 'block';
            
            if (tab === 'tiendas') renderizarListaTiendas();
            if (tab === 'horarios') calcularTiempoEfectivo();
        }

        function renderizarListaTiendas() {
            const lista = document.getElementById('listaTiendas');
            if (lista) {
                lista.innerHTML = TIENDAS_BASE.map(t => `
                    <div class="chip">
                        ${t}
                        <button class="chip-remove" onclick="eliminarTienda('${t}')"><i data-lucide="x" style="width:12px;height:12px"></i></button>
                    </div>
                `).join('');
                lucide.createIcons();
            }
        }

        function agregarTienda() {
            const input = document.getElementById('inputNuevaTienda');
            const nombre = input?.value.trim().toUpperCase();
            if (!nombre) { toast('Ingresa un nombre', 'warning'); return; }
            if (TIENDAS_BASE.includes(nombre)) { toast('La tienda ya existe', 'warning'); return; }
            TIENDAS_BASE.push(nombre);
            input.value = '';
            renderizarListaTiendas();
            toast('Tienda agregada', 'success');
        }

        function eliminarTienda(nombre) {
            const idx = TIENDAS_BASE.indexOf(nombre);
            if (idx > -1) {
                TIENDAS_BASE.splice(idx, 1);
                renderizarListaTiendas();
                toast('Tienda eliminada', 'success');
            }
        }

        function calcularTiempoEfectivo() {
            const inicio = document.getElementById('horaInicio')?.value || '08:30';
            const fin = document.getElementById('horaFin')?.value || '19:00';
            const almuerzo = parseInt(document.getElementById('duracionAlmuerzo')?.value) || 60;
            
            const [h1, m1] = inicio.split(':').map(Number);
            const [h2, m2] = fin.split(':').map(Number);
            const minutosTrabajo = (h2 * 60 + m2) - (h1 * 60 + m1) - almuerzo;
            const horas = (minutosTrabajo / 60).toFixed(1);
            
            const el = document.getElementById('tiempoEfectivo');
            if (el) el.textContent = `${horas} horas`;
        }

        function guardarConfigColumnas() {
            toast('Configuración de columnas guardada', 'success');
        }

        function guardarConfigTiendas() {
            toast('Tiendas guardadas', 'success');
        }

        function guardarConfigHorarios() {
            toast('Horarios guardados', 'success');
        }

        function guardarConfigGeneral() {
            toast('Configuración guardada', 'success');
        }

        async function limpiarOrdenesAntiguas() {
            if (!confirm('¿Eliminar órdenes completadas de hace más de 30 días?')) return;
            mostrarLoading('Limpiando...');
            const fechaLimite = new Date();
            fechaLimite.setDate(fechaLimite.getDate() - 30);
            
            const ordenesAntiguas = ordenes.filter(o => 
                o.estado === 'Completada' && 
                o.fecha_cierre && 
                new Date(o.fecha_cierre) < fechaLimite
            );
            
            for (const o of ordenesAntiguas) {
                await supabase.from('picking').delete().eq('orden_id', o.id);
                await supabase.from('packing').delete().eq('orden_id', o.id);
                await supabase.from('ordenes').delete().eq('id', o.id);
            }
            
            ocultarLoading();
            toast(`${ordenesAntiguas.length} órdenes eliminadas`, 'success');
            await cargarDatos();
        }

        async function exportarBackup() {
            mostrarLoading('Generando backup...');
            const backup = {
                fecha: new Date().toISOString(),
                inventario: inventario,
                productos: productos,
                ordenes: ordenes,
                picking: picking,
                packing: packing,
                reclasificacion: reclasificacion,
                equipos: equipos
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `MAWI_Backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            ocultarLoading();
            toast('Backup exportado', 'success');
        }

        // ============================================
        // INICIALIZACIÓN
        // ============================================
        window.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            await verificarSesion();
            document.getElementById('loginPassword')?.addEventListener('keypress', e => {
                if (e.key === 'Enter') iniciarSesion();
            });
        });

        console.log('✅ MAWI v7.0 - Sistema Integrado Completo con funcionalidades principales');
    </script>
</body>
</html>
