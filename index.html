<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAWI v6.0 - Sistema Lukers</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#6366f1;--primary-dark:#4f46e5;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--info:#3b82f6;--purple:#a855f7;--bg-main:#0f172a;--bg-card:#fff;--bg-hover:#f1f5f9;--text-primary:#0f172a;--text-secondary:#64748b;--text-white:#fff;--border:#e2e8f0;--shadow:0 4px 6px -1px rgba(0,0,0,0.1)}
        body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh}
        
        /* LOGIN */
        .login-container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem}
        .login-card{background:#fff;padding:3rem;border-radius:20px;box-shadow:0 25px 50px -12px rgba(0,0,0,0.25);max-width:420px;width:100%}
        .login-logo{width:70px;height:70px;background:linear-gradient(135deg,var(--primary),#818cf8);border-radius:16px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:2rem;margin:0 auto 1.5rem}
        .login-title{font-size:2rem;font-weight:800;text-align:center;margin-bottom:0.5rem}
        .login-subtitle{text-align:center;color:var(--text-secondary);margin-bottom:2rem}
        
        /* FORMS */
        .form-group{margin-bottom:1.25rem}
        .form-label{display:block;font-weight:600;margin-bottom:0.5rem;font-size:0.875rem}
        .form-input,.form-select{width:100%;padding:0.75rem 1rem;border:2px solid var(--border);border-radius:10px;font-size:1rem;transition:all 0.2s}
        .form-input:focus,.form-select:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(99,102,241,0.1)}
        
        /* BUTTONS */
        .btn{padding:0.75rem 1.5rem;border:none;border-radius:10px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:0.5rem;transition:all 0.2s;font-size:0.875rem}
        .btn-primary{background:var(--primary);color:#fff}
        .btn-primary:hover{background:var(--primary-dark);transform:translateY(-2px)}
        .btn-success{background:var(--success);color:#fff}
        .btn-warning{background:var(--warning);color:#fff}
        .btn-danger{background:var(--danger);color:#fff}
        .btn-outline{background:#fff;color:var(--primary);border:2px solid var(--primary)}
        .btn-full{width:100%;justify-content:center}
        .btn-icon{width:36px;height:36px;padding:0;justify-content:center}
        
        /* APP LAYOUT */
        .app-container{display:none;height:100vh;overflow:hidden}
        .sidebar{width:260px;background:var(--bg-main);display:flex;flex-direction:column}
        .sidebar-header{padding:1.5rem;border-bottom:1px solid rgba(255,255,255,0.1)}
        .logo-container{display:flex;align-items:center;gap:0.75rem}
        .logo-icon{width:40px;height:40px;background:linear-gradient(135deg,var(--primary),#818cf8);border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
        .logo-title{font-size:1.25rem;font-weight:700;color:#fff}
        .logo-subtitle{font-size:0.7rem;color:#94a3b8}
        
        /* NAV */
        .nav-menu{flex:1;padding:1rem;overflow-y:auto}
        .nav-section{margin-bottom:1.5rem}
        .nav-section-title{font-size:0.7rem;font-weight:600;text-transform:uppercase;color:#94a3b8;padding:0 1rem;margin-bottom:0.5rem;letter-spacing:0.05em}
        .nav-item{display:flex;align-items:center;gap:0.75rem;padding:0.75rem 1rem;border-radius:10px;cursor:pointer;color:#94a3b8;transition:all 0.2s;margin-bottom:0.25rem}
        .nav-item:hover{background:rgba(255,255,255,0.05);color:#fff}
        .nav-item.active{background:var(--primary);color:#fff}
        .nav-item i{width:20px;height:20px}
        .nav-badge{margin-left:auto;background:var(--danger);color:#fff;font-size:0.7rem;padding:0.15rem 0.5rem;border-radius:10px}
        
        /* USER PROFILE */
        .user-profile{padding:1rem;border-top:1px solid rgba(255,255,255,0.1)}
        .user-info{display:flex;align-items:center;gap:0.75rem;padding:0.75rem;background:rgba(255,255,255,0.05);border-radius:10px;cursor:pointer}
        .user-avatar{width:36px;height:36px;background:linear-gradient(135deg,var(--primary),#818cf8);border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600}
        .user-name{color:#fff;font-weight:600;font-size:0.875rem}
        .user-role{color:#94a3b8;font-size:0.75rem}
        
        /* MAIN CONTENT */
        .main-content{flex:1;display:flex;flex-direction:column;overflow:hidden;background:#f8fafc}
        .header{background:#fff;padding:1rem 2rem;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
        .header-title{font-size:1.5rem;font-weight:700}
        .header-actions{display:flex;gap:0.75rem;align-items:center}
        .content-area{flex:1;overflow-y:auto;padding:2rem}
        
        /* STATS */
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1.5rem;margin-bottom:2rem}
        .stat-card{background:#fff;padding:1.5rem;border-radius:16px;box-shadow:var(--shadow)}
        .stat-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1rem}
        .stat-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center}
        .stat-icon.blue{background:rgba(99,102,241,0.1);color:var(--primary)}
        .stat-icon.green{background:rgba(16,185,129,0.1);color:var(--success)}
        .stat-icon.orange{background:rgba(245,158,11,0.1);color:var(--warning)}
        .stat-icon.red{background:rgba(239,68,68,0.1);color:var(--danger)}
        .stat-value{font-size:2rem;font-weight:800;margin-bottom:0.25rem}
        .stat-label{color:var(--text-secondary);font-size:0.875rem}
        
        /* KPI CONTAINER */
        .kpi-container{background:linear-gradient(135deg,#667eea,#764ba2);padding:1.5rem;border-radius:16px;margin-bottom:2rem}
        .kpi-title{color:#fff;font-size:1.1rem;font-weight:700;margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem}
        .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem}
        .kpi-item{background:rgba(255,255,255,0.15);padding:1rem;border-radius:10px}
        .kpi-label{color:rgba(255,255,255,0.9);font-size:0.7rem;text-transform:uppercase;margin-bottom:0.25rem}
        .kpi-value{color:#fff;font-size:1.5rem;font-weight:800}
        .kpi-unit{font-size:0.75rem;opacity:0.8}
        
        /* CHARTS */
        .charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:1.5rem;margin-bottom:2rem}
        .chart-card{background:#fff;padding:1.5rem;border-radius:16px;box-shadow:var(--shadow)}
        .chart-title{font-size:1rem;font-weight:600;margin-bottom:1rem}
        .chart-wrapper{height:250px;position:relative}
        
        /* CARDS */
        .card{background:#fff;border-radius:16px;padding:1.5rem;box-shadow:var(--shadow);margin-bottom:1.5rem}
        .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:2px solid var(--border);flex-wrap:wrap;gap:1rem}
        .card-title{font-size:1.1rem;font-weight:700;display:flex;align-items:center;gap:0.5rem}
        .card-actions{display:flex;gap:0.5rem;flex-wrap:wrap}
        
        /* TABLES */
        .table-container{overflow-x:auto}
        table{width:100%;border-collapse:collapse}
        th,td{padding:0.875rem 1rem;text-align:left;border-bottom:1px solid var(--border)}
        th{background:var(--bg-hover);font-weight:600;font-size:0.75rem;text-transform:uppercase;color:var(--text-secondary)}
        tr:hover{background:var(--bg-hover)}
        
        /* BADGES */
        .badge{padding:0.25rem 0.75rem;border-radius:9999px;font-size:0.75rem;font-weight:600}
        .badge-primary{background:rgba(99,102,241,0.1);color:var(--primary)}
        .badge-success{background:rgba(16,185,129,0.1);color:var(--success)}
        .badge-warning{background:rgba(245,158,11,0.1);color:var(--warning)}
        .badge-danger{background:rgba(239,68,68,0.1);color:var(--danger)}
        .badge-info{background:rgba(59,130,246,0.1);color:var(--info)}
        .badge-purple{background:rgba(168,85,247,0.1);color:var(--purple)}
        
        /* SEARCH BOX */
        .search-box{display:flex;align-items:center;gap:0.5rem;background:var(--bg-hover);padding:0.5rem 1rem;border-radius:10px;min-width:250px}
        .search-box input{border:none;background:transparent;outline:none;flex:1;font-size:0.875rem}
        
        /* PAGINATION */
        .pagination{display:flex;justify-content:center;gap:0.5rem;margin-top:1.5rem}
        .pagination button{padding:0.5rem 1rem;border:1px solid var(--border);background:#fff;border-radius:8px;cursor:pointer;font-weight:500}
        .pagination button:hover:not(:disabled){background:var(--primary);color:#fff;border-color:var(--primary)}
        .pagination button:disabled{opacity:0.5;cursor:not-allowed}
        
        /* MODALS */
        .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;align-items:center;justify-content:center;padding:1rem}
        .modal.active{display:flex}
        .modal-content{background:#fff;border-radius:16px;max-width:600px;width:100%;max-height:90vh;overflow-y:auto}
        .modal-header{padding:1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .modal-title{font-size:1.25rem;font-weight:700;display:flex;align-items:center;gap:0.5rem}
        .modal-close{width:32px;height:32px;border:none;background:var(--bg-hover);border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .modal-body{padding:1.5rem}
        .modal-footer{padding:1.5rem;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:0.75rem}
        
        /* FILE UPLOAD */
        .file-upload-btn{display:inline-flex;align-items:center;gap:0.5rem;padding:0.75rem 1.5rem;background:var(--bg-hover);border:2px dashed var(--border);border-radius:10px;cursor:pointer;font-weight:600}
        .file-upload-btn:hover{background:var(--primary);color:#fff;border-color:var(--primary)}
        .form-file{display:none}
        .form-help{font-size:0.75rem;color:var(--text-secondary);margin-top:0.5rem}
        
        /* ALERTS */
        .alert{padding:1rem;border-radius:10px;margin-bottom:1rem;display:flex;align-items:flex-start;gap:0.75rem;border-left:4px solid}
        .alert-warning{background:rgba(245,158,11,0.1);border-color:var(--warning)}
        .alert-danger{background:rgba(239,68,68,0.1);border-color:var(--danger)}
        .alert-info{background:rgba(59,130,246,0.1);border-color:var(--info)}
        .alert-success{background:rgba(16,185,129,0.1);border-color:var(--success)}
        
        /* LOADING */
        .loading-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;align-items:center;justify-content:center}
        .loading-overlay.active{display:flex}
        .loading-content{text-align:center;color:#fff}
        .spinner{width:50px;height:50px;border:4px solid rgba(255,255,255,0.2);border-top-color:#fff;border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 1rem}
        @keyframes spin{to{transform:rotate(360deg)}}
        .progress-bar{width:200px;height:6px;background:rgba(255,255,255,0.2);border-radius:3px;overflow:hidden;margin:1rem auto 0}
        .progress-fill{height:100%;background:var(--primary);width:0%;transition:width 0.3s}
        
        /* TOAST */
        .toast-container{position:fixed;top:1rem;right:1rem;z-index:10000;display:flex;flex-direction:column;gap:0.5rem}
        .toast{background:#fff;padding:1rem 1.5rem;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.2);display:flex;align-items:center;gap:0.75rem;animation:slideIn 0.3s ease;border-left:4px solid}
        .toast.success{border-color:var(--success)}
        .toast.error{border-color:var(--danger)}
        .toast.warning{border-color:var(--warning)}
        .toast.info{border-color:var(--info)}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        
        /* VISTAS */
        .vista{display:none}
        .vista.active{display:block}
        
        /* RESPONSIVE */
        @media(max-width:768px){
            .sidebar{display:none}
            .stats-grid{grid-template-columns:1fr}
            .charts-grid{grid-template-columns:1fr}
            .card-header{flex-direction:column;align-items:flex-start}
        }
        
        /* EMPTY STATE */
        .empty-state{text-align:center;padding:3rem;color:var(--text-secondary)}
        .empty-state i{width:48px;height:48px;margin-bottom:1rem;opacity:0.5}
    </style>
</head>
<body>
    <!-- TOAST -->
    <div class="toast-container" id="toastContainer"></div>
    
    <!-- LOADING -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div id="loadingText">Cargando...</div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        </div>
    </div>

    <!-- LOGIN -->
    <div class="login-container" id="loginSection">
        <div class="login-card">
            <div class="login-logo">M</div>
            <h1 class="login-title">MAWI v6.0</h1>
            <p class="login-subtitle">Sistema de Gesti√≥n Lukers</p>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="loginEmail" class="form-input" placeholder="correo@lukers.com">
            </div>
            <div class="form-group">
                <label class="form-label">Contrase√±a</label>
                <input type="password" id="loginPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button class="btn btn-primary btn-full" onclick="iniciarSesion()">Iniciar Sesi√≥n</button>
        </div>
    </div>

    <!-- APP -->
    <div class="app-container" id="appSection">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <div class="logo-icon">M</div>
                    <div>
                        <div class="logo-title">MAWI</div>
                        <div class="logo-subtitle">v6.0 Sistema Lukers</div>
                    </div>
                </div>
            </div>
            <nav class="nav-menu">
                <div class="nav-section">
                    <div class="nav-section-title">Principal</div>
                    <div class="nav-item active" data-vista="dashboard">
                        <i data-lucide="layout-dashboard"></i><span>Dashboard</span>
                    </div>
                    <div class="nav-item" data-vista="inventario">
                        <i data-lucide="package"></i><span>Inventario</span>
                    </div>
                    <div class="nav-item" data-vista="productos">
                        <i data-lucide="database"></i><span>Productos System</span>
                    </div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Operaciones</div>
                    <div class="nav-item" data-vista="ordenes">
                        <i data-lucide="shopping-cart"></i><span>√ìrdenes</span>
                        <span class="nav-badge" id="badgeOrdenes">0</span>
                    </div>
                    <div class="nav-item" data-vista="picking">
                        <i data-lucide="scan"></i><span>Picking</span>
                    </div>
                    <div class="nav-item" data-vista="packing">
                        <i data-lucide="box"></i><span>Packing</span>
                    </div>
                    <div class="nav-item" data-vista="reclasificacion">
                        <i data-lucide="repeat"></i><span>Reclasificaci√≥n</span>
                    </div>
                </div>
            </nav>
            <div class="user-profile">
                <div class="user-info" onclick="cerrarSesion()">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div>
                        <div class="user-name" id="userName">Usuario</div>
                        <div class="user-role">Cerrar Sesi√≥n</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MAIN -->
        <div class="main-content">
            <header class="header">
                <h1 class="header-title" id="headerTitle">Dashboard</h1>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="sincronizarDatos()">
                        <i data-lucide="refresh-cw" style="width:16px;height:16px"></i> Sincronizar
                    </button>
                </div>
            </header>
            
            <div class="content-area">
                <!-- DASHBOARD -->
                <div id="vista-dashboard" class="vista active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon blue"><i data-lucide="package"></i></div>
                            </div>
                            <div class="stat-value" id="statVariantes">0</div>
                            <div class="stat-label">Variantes en Inventario</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon green"><i data-lucide="trending-up"></i></div>
                            </div>
                            <div class="stat-value" id="statUnidades">0</div>
                            <div class="stat-label">Unidades Totales</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon orange"><i data-lucide="lock"></i></div>
                            </div>
                            <div class="stat-value" id="statBloqueadas">0</div>
                            <div class="stat-label">Unidades Bloqueadas</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon red"><i data-lucide="shopping-cart"></i></div>
                            </div>
                            <div class="stat-value" id="statOrdenes">0</div>
                            <div class="stat-label">√ìrdenes Activas</div>
                        </div>
                    </div>

                    <div class="kpi-container">
                        <div class="kpi-title"><i data-lucide="activity" style="width:20px;height:20px"></i> KPIs del Sistema</div>
                        <div class="kpi-grid">
                            <div class="kpi-item">
                                <div class="kpi-label">Productos System</div>
                                <div class="kpi-value" id="kpiProductos">0</div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-label">√ìrdenes Completadas</div>
                                <div class="kpi-value" id="kpiCompletadas">0</div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-label">En Reclasificaci√≥n</div>
                                <div class="kpi-value" id="kpiReclasificacion">0</div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-label">Stock Disponible</div>
                                <div class="kpi-value" id="kpiDisponible">0</div>
                            </div>
                        </div>
                    </div>

                    <div class="charts-grid">
                        <div class="chart-card">
                            <div class="chart-title">üìä Distribuci√≥n de Stock</div>
                            <div class="chart-wrapper"><canvas id="chartStock"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-title">üìà Estados de √ìrdenes</div>
                            <div class="chart-wrapper"><canvas id="chartOrdenes"></canvas></div>
                        </div>
                    </div>
                </div>

                <!-- INVENTARIO -->
                <div id="vista-inventario" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i data-lucide="package" style="width:20px;height:20px;color:var(--primary)"></i> Gesti√≥n de Inventario</h3>
                            <div class="card-actions">
                                <button class="btn btn-primary" onclick="abrirModal('modalSubirInventario')">
                                    <i data-lucide="upload" style="width:16px;height:16px"></i> Subir Excel
                                </button>
                                <button class="btn btn-success" onclick="abrirModal('modalAgregarItem')">
                                    <i data-lucide="plus" style="width:16px;height:16px"></i> Agregar
                                </button>
                                <button class="btn btn-outline" onclick="exportarInventario()">
                                    <i data-lucide="download" style="width:16px;height:16px"></i> Exportar
                                </button>
                            </div>
                        </div>
                        <div style="margin-bottom:1rem;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem">
                            <div class="search-box">
                                <i data-lucide="search" style="width:18px;height:18px;color:var(--text-secondary)"></i>
                                <input type="text" id="searchInventario" placeholder="Buscar variante o ubicaci√≥n...">
                            </div>
                            <span style="color:var(--text-secondary)">Total: <strong id="countInventario">0</strong> registros</span>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Variante</th>
                                        <th>Ubicaci√≥n</th>
                                        <th>Stock F√≠sico</th>
                                        <th>Bloqueado</th>
                                        <th>Disponible</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaInventario"></tbody>
                            </table>
                        </div>
                        <div class="pagination">
                            <button onclick="cambiarPagina('inventario',-1)" id="prevInventario">Anterior</button>
                            <span>P√°gina <strong id="paginaInventario">1</strong></span>
                            <button onclick="cambiarPagina('inventario',1)" id="nextInventario">Siguiente</button>
                        </div>
                    </div>
                </div>

                <!-- PRODUCTOS -->
                <div id="vista-productos" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i data-lucide="database" style="width:20px;height:20px;color:var(--primary)"></i> Cat√°logo de Productos</h3>
                            <div class="card-actions">
                                <button class="btn btn-primary" onclick="abrirModal('modalSubirProductos')">
                                    <i data-lucide="upload" style="width:16px;height:16px"></i> Subir Cat√°logo
                                </button>
                                <button class="btn btn-outline" onclick="exportarProductos()">
                                    <i data-lucide="download" style="width:16px;height:16px"></i> Exportar
                                </button>
                            </div>
                        </div>
                        <div style="margin-bottom:1rem;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:1rem">
                            <div class="search-box">
                                <i data-lucide="search" style="width:18px;height:18px;color:var(--text-secondary)"></i>
                                <input type="text" id="searchProductos" placeholder="Buscar variante...">
                            </div>
                            <span style="color:var(--text-secondary)">Total: <strong id="countProductos">0</strong> productos</span>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Variante</th>
                                        <th>G√©nero</th>
                                        <th>L√≠nea</th>
                                        <th>Marca</th>
                                        <th>Talla</th>
                                        <th>Kardex</th>
                                        <th>PVP</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaProductos"></tbody>
                            </table>
                        </div>
                        <div class="pagination">
                            <button onclick="cambiarPagina('productos',-1)" id="prevProductos">Anterior</button>
                            <span>P√°gina <strong id="paginaProductos">1</strong></span>
                            <button onclick="cambiarPagina('productos',1)" id="nextProductos">Siguiente</button>
                        </div>
                    </div>
                </div>

                <!-- √ìRDENES -->
                <div id="vista-ordenes" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i data-lucide="shopping-cart" style="width:20px;height:20px;color:var(--primary)"></i> Gesti√≥n de √ìrdenes</h3>
                            <div class="card-actions">
                                <button class="btn btn-primary" onclick="abrirModal('modalCrearOrden')">
                                    <i data-lucide="plus" style="width:16px;height:16px"></i> Nueva Orden
                                </button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Fecha</th>
                                        <th>Items</th>
                                        <th>Unidades</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaOrdenes"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- PICKING -->
                <div id="vista-picking" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i data-lucide="scan" style="width:20px;height:20px;color:var(--primary)"></i> M√≥dulo de Picking</h3>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID Orden</th>
                                        <th>Fecha</th>
                                        <th>Items</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaPicking"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- PACKING -->
                <div id="vista-packing" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i data-lucide="box" style="width:20px;height:20px;color:var(--primary)"></i> M√≥dulo de Packing</h3>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID Orden</th>
                                        <th>Fecha</th>
                                        <th>Encontrado</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaPacking"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- RECLASIFICACI√ìN -->
                <div id="vista-reclasificacion" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i data-lucide="repeat" style="width:20px;height:20px;color:var(--primary)"></i> Reclasificaci√≥n</h3>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Variante Original</th>
                                        <th>Nueva Variante</th>
                                        <th>Cantidad</th>
                                        <th>Motivo</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaReclasificacion"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALES -->
    <!-- Modal Subir Inventario -->
    <div id="modalSubirInventario" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i data-lucide="upload"></i> Subir Inventario</h3>
                <button class="modal-close" onclick="cerrarModal('modalSubirInventario')"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Archivo Excel</label>
                    <input type="file" id="fileInventario" class="form-file" accept=".xlsx,.xls">
                    <label for="fileInventario" class="file-upload-btn">
                        <i data-lucide="file-plus" style="width:18px;height:18px"></i> Seleccionar archivo
                    </label>
                    <p class="form-help">Columnas: Variante, Ubicacion, StockFisico</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="cerrarModal('modalSubirInventario')">Cancelar</button>
                <button class="btn btn-primary" onclick="procesarInventario()">Procesar</button>
            </div>
        </div>
    </div>

    <!-- Modal Agregar Item -->
    <div id="modalAgregarItem" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i data-lucide="plus"></i> Agregar Producto</h3>
                <button class="modal-close" onclick="cerrarModal('modalAgregarItem')"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Variante</label>
                    <input type="text" id="inputVariante" class="form-input" placeholder="Ej: 10001-01-M">
                </div>
                <div class="form-group">
                    <label class="form-label">Ubicaci√≥n</label>
                    <input type="text" id="inputUbicacion" class="form-input" placeholder="Ej: A1">
                </div>
                <div class="form-group">
                    <label class="form-label">Stock F√≠sico</label>
                    <input type="number" id="inputStock" class="form-input" placeholder="0" min="0">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="cerrarModal('modalAgregarItem')">Cancelar</button>
                <button class="btn btn-success" onclick="guardarItem()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modal Subir Productos -->
    <div id="modalSubirProductos" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i data-lucide="database"></i> Subir Cat√°logo</h3>
                <button class="modal-close" onclick="cerrarModal('modalSubirProductos')"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i data-lucide="alert-triangle" style="width:20px;height:20px"></i>
                    <span>Esto reemplazar√° todo el cat√°logo actual</span>
                </div>
                <div class="form-group">
                    <label class="form-label">Archivo Excel</label>
                    <input type="file" id="fileProductos" class="form-file" accept=".xlsx,.xls">
                    <label for="fileProductos" class="file-upload-btn">
                        <i data-lucide="file-plus" style="width:18px;height:18px"></i> Seleccionar archivo
                    </label>
                    <p class="form-help">Columnas: variante, kardex, pvp, genero, linea, marca, talla</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="cerrarModal('modalSubirProductos')">Cancelar</button>
                <button class="btn btn-primary" onclick="procesarProductos()">Procesar</button>
            </div>
        </div>
    </div>

    <!-- Modal Crear Orden -->
    <div id="modalCrearOrden" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i data-lucide="shopping-cart"></i> Nueva Orden</h3>
                <button class="modal-close" onclick="cerrarModal('modalCrearOrden')"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Archivo Excel con Hoja de Ruta</label>
                    <input type="file" id="fileOrden" class="form-file" accept=".xlsx,.xls">
                    <label for="fileOrden" class="file-upload-btn">
                        <i data-lucide="file-plus" style="width:18px;height:18px"></i> Seleccionar archivo
                    </label>
                    <p class="form-help">Columnas: Variante, Ubicacion, y columnas por tienda</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="cerrarModal('modalCrearOrden')">Cancelar</button>
                <button class="btn btn-primary" onclick="procesarOrden()">Crear Orden</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURACI√ìN SUPABASE
        // ============================================
        const SUPABASE_URL = 'https://dzxjzmlmmmwspemihhlv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6eGp6bWxtbW13c3BlbWloaGx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1NjI5MjAsImV4cCI6MjA3OTEzODkyMH0.uLXtsONi_c4myPbsvTIqV51pldRv6Wuff4adYWgVR6Q';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let inventario = [];
        let productos = [];
        let ordenes = [];
        let reclasificacion = [];
        
        let paginaInventario = 1;
        let paginaProductos = 1;
        const ITEMS_POR_PAGINA = 50;

        const TIENDAS = ['LUKERS EL SOL','LUKERS TRU PIZARRO','LUKERS LA MARINA','LUKERS PROLONGACI√ìN IQUITOS','LUKERS CHI P. RUIZ','LUKERS TARAPOTO','LUKERS MENDIOLA','LUKERS ALFONSO UGARTE','LUKERS IQT LORES','LUKERS JIRON'];

        // Charts
        let chartStock, chartOrdenes;

        // ============================================
        // AUTENTICACI√ìN
        // ============================================
        async function verificarSesion() {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('appSection').style.display = 'flex';
                document.getElementById('userName').textContent = session.user.email.split('@')[0];
                document.getElementById('userAvatar').textContent = session.user.email.charAt(0).toUpperCase();
                await cargarDatos();
            } else {
                document.getElementById('loginSection').style.display = 'flex';
                document.getElementById('appSection').style.display = 'none';
            }
        }

        async function iniciarSesion() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                toast('Completa todos los campos', 'error');
                return;
            }

            mostrarLoading('Iniciando sesi√≥n...');

            const { data, error } = await supabase.auth.signInWithPassword({ email, password });

            ocultarLoading();

            if (error) {
                toast('Error: ' + error.message, 'error');
            } else {
                toast('Sesi√≥n iniciada', 'success');
                await verificarSesion();
            }
        }

        async function cerrarSesion() {
            await supabase.auth.signOut();
            toast('Sesi√≥n cerrada', 'info');
            setTimeout(() => location.reload(), 500);
        }

        // ============================================
        // CARGA DE DATOS
        // ============================================
        async function cargarDatos() {
            mostrarLoading('Cargando datos...');

            try {
                await Promise.all([
                    cargarInventario(),
                    cargarProductos(),
                    cargarOrdenes(),
                    cargarReclasificacion()
                ]);
                actualizarDashboard();
                ocultarLoading();
                toast('Datos cargados', 'success');
            } catch (error) {
                ocultarLoading();
                toast('Error: ' + error.message, 'error');
            }
        }

        async function sincronizarDatos() {
            await cargarDatos();
        }

        async function cargarInventario() {
            const { data, error } = await supabase.from('inventario').select('*').order('variante');
            if (!error) {
                inventario = data || [];
                renderizarInventario();
            }
        }

        async function cargarProductos() {
            const { data, error } = await supabase.from('productos_system').select('*').order('variante');
            if (!error) {
                productos = data || [];
                renderizarProductos();
            }
        }

        async function cargarOrdenes() {
            const { data, error } = await supabase.from('ordenes').select('*').order('fecha', { ascending: false });
            if (!error) {
                ordenes = data || [];
                renderizarOrdenes();
                renderizarPicking();
                renderizarPacking();
            }
        }

        async function cargarReclasificacion() {
            const { data, error } = await supabase.from('reclasificacion').select('*').order('fecha', { ascending: false });
            if (!error) {
                reclasificacion = data || [];
                renderizarReclasificacion();
            }
        }

        // ============================================
        // DASHBOARD
        // ============================================
        function actualizarDashboard() {
            const variantesUnicas = new Set(inventario.map(i => i.variante)).size;
            const unidades = inventario.reduce((s, i) => s + (i.stock_fisico || 0), 0);
            const bloqueadas = inventario.reduce((s, i) => s + (i.stock_bloqueado || 0), 0);
            const ordenesActivas = ordenes.filter(o => !['Completada', 'Cancelada'].includes(o.estado)).length;

            document.getElementById('statVariantes').textContent = variantesUnicas.toLocaleString();
            document.getElementById('statUnidades').textContent = unidades.toLocaleString();
            document.getElementById('statBloqueadas').textContent = bloqueadas.toLocaleString();
            document.getElementById('statOrdenes').textContent = ordenesActivas;
            document.getElementById('badgeOrdenes').textContent = ordenesActivas;

            // KPIs
            document.getElementById('kpiProductos').textContent = productos.length.toLocaleString();
            document.getElementById('kpiCompletadas').textContent = ordenes.filter(o => o.estado === 'Completada').length;
            document.getElementById('kpiReclasificacion').textContent = reclasificacion.filter(r => r.estado === 'Pendiente').length;
            document.getElementById('kpiDisponible').textContent = (unidades - bloqueadas).toLocaleString();

            generarGraficas();
        }

        function generarGraficas() {
            // Chart Stock
            const ctxStock = document.getElementById('chartStock');
            if (ctxStock) {
                if (chartStock) chartStock.destroy();
                const disponible = inventario.reduce((s, i) => s + (i.stock_fisico || 0) - (i.stock_bloqueado || 0), 0);
                const bloqueado = inventario.reduce((s, i) => s + (i.stock_bloqueado || 0), 0);
                
                chartStock = new Chart(ctxStock, {
                    type: 'doughnut',
                    data: {
                        labels: ['Disponible', 'Bloqueado'],
                        datasets: [{
                            data: [disponible, bloqueado],
                            backgroundColor: ['rgba(16, 185, 129, 0.8)', 'rgba(245, 158, 11, 0.8)']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            // Chart √ìrdenes
            const ctxOrdenes = document.getElementById('chartOrdenes');
            if (ctxOrdenes) {
                if (chartOrdenes) chartOrdenes.destroy();
                const estados = {};
                ordenes.forEach(o => { estados[o.estado] = (estados[o.estado] || 0) + 1; });
                
                chartOrdenes = new Chart(ctxOrdenes, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(estados),
                        datasets: [{
                            label: '√ìrdenes',
                            data: Object.values(estados),
                            backgroundColor: 'rgba(99, 102, 241, 0.8)',
                            borderRadius: 8
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            }
        }

        // ============================================
        // INVENTARIO
        // ============================================
        function renderizarInventario() {
            const search = document.getElementById('searchInventario')?.value.toLowerCase() || '';
            let filtrado = inventario.filter(i => 
                i.variante.toLowerCase().includes(search) || 
                i.ubicacion.toLowerCase().includes(search)
            );

            document.getElementById('countInventario').textContent = filtrado.length;

            const inicio = (paginaInventario - 1) * ITEMS_POR_PAGINA;
            const items = filtrado.slice(inicio, inicio + ITEMS_POR_PAGINA);

            const tbody = document.getElementById('tablaInventario');
            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><i data-lucide="inbox"></i><br>No hay datos</td></tr>';
            } else {
                tbody.innerHTML = items.map(item => {
                    const disponible = (item.stock_fisico || 0) - (item.stock_bloqueado || 0);
                    return `<tr>
                        <td><strong>${item.variante}</strong></td>
                        <td><span class="badge badge-info">${item.ubicacion}</span></td>
                        <td>${item.stock_fisico || 0}</td>
                        <td>${item.stock_bloqueado || 0}</td>
                        <td><strong style="color:var(--success)">${disponible}</strong></td>
                        <td><button class="btn btn-danger btn-icon" onclick="eliminarItem('${item.variante}','${item.ubicacion}')"><i data-lucide="trash-2" style="width:14px;height:14px"></i></button></td>
                    </tr>`;
                }).join('');
            }

            document.getElementById('paginaInventario').textContent = paginaInventario;
            document.getElementById('prevInventario').disabled = paginaInventario === 1;
            document.getElementById('nextInventario').disabled = inicio + ITEMS_POR_PAGINA >= filtrado.length;

            lucide.createIcons();
        }

        document.getElementById('searchInventario')?.addEventListener('input', () => {
            paginaInventario = 1;
            renderizarInventario();
        });

        async function guardarItem() {
            const variante = document.getElementById('inputVariante').value.trim().toUpperCase();
            const ubicacion = document.getElementById('inputUbicacion').value.trim().toUpperCase();
            const stock = parseInt(document.getElementById('inputStock').value) || 0;

            if (!variante || !ubicacion) {
                toast('Completa los campos', 'error');
                return;
            }

            mostrarLoading('Guardando...');

            const { error } = await supabase.from('inventario').upsert({
                variante, ubicacion, stock_fisico: stock, stock_bloqueado: 0
            }, { onConflict: 'variante,ubicacion' });

            ocultarLoading();

            if (error) {
                toast('Error: ' + error.message, 'error');
            } else {
                toast('Guardado correctamente', 'success');
                cerrarModal('modalAgregarItem');
                await cargarInventario();
                actualizarDashboard();
            }
        }

        async function eliminarItem(variante, ubicacion) {
            if (!confirm(`¬øEliminar ${variante} de ${ubicacion}?`)) return;

            mostrarLoading('Eliminando...');
            const { error } = await supabase.from('inventario').delete().eq('variante', variante).eq('ubicacion', ubicacion);
            ocultarLoading();

            if (error) {
                toast('Error: ' + error.message, 'error');
            } else {
                toast('Eliminado', 'success');
                await cargarInventario();
                actualizarDashboard();
            }
        }

        async function procesarInventario() {
            const file = document.getElementById('fileInventario').files[0];
            if (!file) { toast('Selecciona un archivo', 'error'); return; }

            mostrarLoading('Procesando Excel...');

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, { type: 'array' });
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

                    const items = json.map(row => ({
                        variante: String(row.Variante || row.variante || '').trim().toUpperCase(),
                        ubicacion: String(row.Ubicacion || row.ubicacion || '').trim().toUpperCase(),
                        stock_fisico: parseInt(row.StockFisico || row.stock_fisico || 0),
                        stock_bloqueado: 0
                    })).filter(i => i.variante && i.ubicacion);

                    for (let i = 0; i < items.length; i += 500) {
                        const batch = items.slice(i, i + 500);
                        await supabase.from('inventario').upsert(batch, { onConflict: 'variante,ubicacion' });
                        actualizarProgreso((i / items.length) * 100);
                    }

                    ocultarLoading();
                    toast(`${items.length} registros procesados`, 'success');
                    cerrarModal('modalSubirInventario');
                    await cargarInventario();
                    actualizarDashboard();
                } catch (err) {
                    ocultarLoading();
                    toast('Error: ' + err.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function exportarInventario() {
            if (inventario.length === 0) { toast('No hay datos', 'warning'); return; }
            const ws = XLSX.utils.json_to_sheet(inventario.map(i => ({
                Variante: i.variante, Ubicacion: i.ubicacion, StockFisico: i.stock_fisico,
                StockBloqueado: i.stock_bloqueado, Disponible: (i.stock_fisico || 0) - (i.stock_bloqueado || 0)
            })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Inventario');
            XLSX.writeFile(wb, `Inventario_${new Date().toISOString().split('T')[0]}.xlsx`);
            toast('Exportado', 'success');
        }

        // ============================================
        // PRODUCTOS
        // ============================================
        function renderizarProductos() {
            const search = document.getElementById('searchProductos')?.value.toLowerCase() || '';
            let filtrado = productos.filter(p => p.variante.toLowerCase().includes(search));

            document.getElementById('countProductos').textContent = filtrado.length;

            const inicio = (paginaProductos - 1) * ITEMS_POR_PAGINA;
            const items = filtrado.slice(inicio, inicio + ITEMS_POR_PAGINA);

            const tbody = document.getElementById('tablaProductos');
            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><i data-lucide="inbox"></i><br>No hay productos</td></tr>';
            } else {
                tbody.innerHTML = items.map(p => `<tr>
                    <td><strong>${p.variante}</strong></td>
                    <td>${p.genero || '-'}</td>
                    <td>${p.linea || '-'}</td>
                    <td>${p.marca || '-'}</td>
                    <td>${p.talla || '-'}</td>
                    <td><strong style="color:var(--primary)">S/ ${parseFloat(p.kardex || 0).toFixed(2)}</strong></td>
                    <td><strong style="color:var(--success)">S/ ${parseFloat(p.pvp || 0).toFixed(2)}</strong></td>
                </tr>`).join('');
            }

            document.getElementById('paginaProductos').textContent = paginaProductos;
            document.getElementById('prevProductos').disabled = paginaProductos === 1;
            document.getElementById('nextProductos').disabled = inicio + ITEMS_POR_PAGINA >= filtrado.length;

            lucide.createIcons();
        }

        document.getElementById('searchProductos')?.addEventListener('input', () => {
            paginaProductos = 1;
            renderizarProductos();
        });

        async function procesarProductos() {
            const file = document.getElementById('fileProductos').files[0];
            if (!file) { toast('Selecciona un archivo', 'error'); return; }

            if (!confirm('Esto eliminar√° el cat√°logo actual. ¬øContinuar?')) return;

            mostrarLoading('Procesando cat√°logo...');

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, { type: 'array' });
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

                    await supabase.from('productos_system').delete().neq('variante', '');

                    const items = json.map(row => ({
                        variante: String(row.variante || row.Variante || '').trim().toUpperCase(),
                        kardex: parseFloat(row.kardex || row.Kardex || 0),
                        pvp: parseFloat(row.pvp || row.PVP || 0),
                        genero: String(row.genero || row.Genero || '').trim(),
                        linea: String(row.linea || row.Linea || '').trim(),
                        marca: String(row.marca || row.Marca || '').trim(),
                        talla: String(row.talla || row.Talla || '').trim()
                    })).filter(i => i.variante);

                    for (let i = 0; i < items.length; i += 500) {
                        const batch = items.slice(i, i + 500);
                        await supabase.from('productos_system').insert(batch);
                        actualizarProgreso((i / items.length) * 100);
                    }

                    ocultarLoading();
                    toast(`${items.length} productos cargados`, 'success');
                    cerrarModal('modalSubirProductos');
                    await cargarProductos();
                    actualizarDashboard();
                } catch (err) {
                    ocultarLoading();
                    toast('Error: ' + err.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function exportarProductos() {
            if (productos.length === 0) { toast('No hay productos', 'warning'); return; }
            const ws = XLSX.utils.json_to_sheet(productos);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Productos');
            XLSX.writeFile(wb, `Productos_${new Date().toISOString().split('T')[0]}.xlsx`);
            toast('Exportado', 'success');
        }

        // ============================================
        // √ìRDENES
        // ============================================
        function renderizarOrdenes() {
            const tbody = document.getElementById('tablaOrdenes');
            if (ordenes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><i data-lucide="inbox"></i><br>No hay √≥rdenes</td></tr>';
            } else {
                tbody.innerHTML = ordenes.map(o => {
                    const items = o.items ? o.items.length : 0;
                    const unidades = calcularUnidades(o);
                    const badge = getBadgeEstado(o.estado);
                    return `<tr>
                        <td><strong>${o.id}</strong></td>
                        <td>${formatFecha(o.fecha)}</td>
                        <td>${items}</td>
                        <td>${unidades}</td>
                        <td>${badge}</td>
                        <td>
                            ${o.estado === 'Pendiente Picking' ? `<button class="btn btn-danger btn-icon" onclick="eliminarOrden('${o.id}')"><i data-lucide="trash-2" style="width:14px;height:14px"></i></button>` : ''}
                        </td>
                    </tr>`;
                }).join('');
            }
            lucide.createIcons();
        }

        function renderizarPicking() {
            const items = ordenes.filter(o => ['Pendiente Picking', 'En Picking'].includes(o.estado));
            const tbody = document.getElementById('tablaPicking');
            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><i data-lucide="inbox"></i><br>No hay √≥rdenes en picking</td></tr>';
            } else {
                tbody.innerHTML = items.map(o => `<tr>
                    <td><strong>${o.id}</strong></td>
                    <td>${formatFecha(o.fecha)}</td>
                    <td>${o.items ? o.items.length : 0}</td>
                    <td>${getBadgeEstado(o.estado)}</td>
                    <td>
                        <button class="btn btn-primary" onclick="descargarHojaPicking('${o.id}')"><i data-lucide="download" style="width:14px;height:14px"></i> Descargar</button>
                        ${o.estado === 'Pendiente Picking' ? `<button class="btn btn-success" onclick="iniciarPicking('${o.id}')">Iniciar</button>` : ''}
                    </td>
                </tr>`).join('');
            }
            lucide.createIcons();
        }

        function renderizarPacking() {
            const items = ordenes.filter(o => o.estado === 'Pendiente Packing');
            const tbody = document.getElementById('tablaPacking');
            if (items.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><i data-lucide="inbox"></i><br>No hay √≥rdenes en packing</td></tr>';
            } else {
                tbody.innerHTML = items.map(o => `<tr>
                    <td><strong>${o.id}</strong></td>
                    <td>${formatFecha(o.fecha)}</td>
                    <td>${Object.values(o.cantidadesEncontradas || {}).reduce((a, b) => a + b, 0)}</td>
                    <td>${getBadgeEstado(o.estado)}</td>
                    <td><button class="btn btn-success" onclick="completarOrden('${o.id}')">Completar</button></td>
                </tr>`).join('');
            }
            lucide.createIcons();
        }

        function renderizarReclasificacion() {
            const tbody = document.getElementById('tablaReclasificacion');
            if (reclasificacion.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><i data-lucide="inbox"></i><br>No hay reclasificaciones</td></tr>';
            } else {
                tbody.innerHTML = reclasificacion.map(r => `<tr>
                    <td>#${r.id}</td>
                    <td>${r.varianteOriginal}</td>
                    <td>${r.nuevaVariante || '-'}</td>
                    <td>${r.cantidad}</td>
                    <td><span class="badge badge-purple">${r.motivo}</span></td>
                    <td>${r.estado === 'Completada' ? '<span class="badge badge-success">Completada</span>' : '<span class="badge badge-warning">Pendiente</span>'}</td>
                    <td></td>
                </tr>`).join('');
            }
            lucide.createIcons();
        }

        async function procesarOrden() {
            const file = document.getElementById('fileOrden').files[0];
            if (!file) { toast('Selecciona un archivo', 'error'); return; }

            mostrarLoading('Creando orden...');

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, { type: 'array' });
                    const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

                    const items = json.map(row => ({
                        variante: String(row.Variante || '').trim().toUpperCase(),
                        ubicacion: String(row.Ubicacion || '').trim().toUpperCase(),
                        cantidad: TIENDAS.reduce((s, t) => s + (parseInt(row[t]) || 0), 0)
                    })).filter(i => i.variante && i.cantidad > 0);

                    const orden = {
                        id: 'ORD-' + Date.now().toString(36).toUpperCase(),
                        fecha: new Date().toISOString(),
                        estado: 'Pendiente Picking',
                        items: items,
                        cantidadesEncontradas: {}
                    };

                    const { error } = await supabase.from('ordenes').insert(orden);

                    if (error) throw error;

                    // Bloquear stock
                    for (const item of items) {
                        const inv = inventario.find(i => i.variante === item.variante && i.ubicacion === item.ubicacion);
                        if (inv) {
                            await supabase.from('inventario').update({
                                stock_bloqueado: (inv.stock_bloqueado || 0) + item.cantidad
                            }).eq('variante', item.variante).eq('ubicacion', item.ubicacion);
                        }
                    }

                    ocultarLoading();
                    toast('Orden creada', 'success');
                    cerrarModal('modalCrearOrden');
                    await cargarOrdenes();
                    await cargarInventario();
                    actualizarDashboard();
                } catch (err) {
                    ocultarLoading();
                    toast('Error: ' + err.message, 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        async function eliminarOrden(id) {
            if (!confirm('¬øEliminar esta orden?')) return;
            
            mostrarLoading('Eliminando...');
            await supabase.from('ordenes').delete().eq('id', id);
            ocultarLoading();
            toast('Orden eliminada', 'success');
            await cargarOrdenes();
        }

        async function iniciarPicking(id) {
            await supabase.from('ordenes').update({ estado: 'En Picking' }).eq('id', id);
            toast('Picking iniciado', 'success');
            await cargarOrdenes();
        }

        function descargarHojaPicking(id) {
            const orden = ordenes.find(o => o.id === id);
            if (!orden) return;

            const data = orden.items.map(i => ({
                Variante: i.variante,
                Ubicacion: i.ubicacion,
                Solicitado: i.cantidad,
                Encontrado: ''
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'HojaRuta');
            XLSX.writeFile(wb, `HojaPicking_${id}.xlsx`);
            toast('Descargado', 'success');
        }

        async function completarOrden(id) {
            if (!confirm('¬øCompletar esta orden?')) return;

            await supabase.from('ordenes').update({
                estado: 'Completada',
                fechaCierre: new Date().toISOString()
            }).eq('id', id);

            toast('Orden completada', 'success');
            await cargarOrdenes();
            actualizarDashboard();
        }

        // ============================================
        // UTILIDADES
        // ============================================
        function calcularUnidades(orden) {
            if (!orden.items) return 0;
            return orden.items.reduce((s, i) => s + (i.cantidad || 0), 0);
        }

        function getBadgeEstado(estado) {
            const badges = {
                'Pendiente Picking': '<span class="badge badge-warning">Pendiente Picking</span>',
                'En Picking': '<span class="badge badge-info">En Picking</span>',
                'Pendiente Packing': '<span class="badge badge-purple">Pendiente Packing</span>',
                'Completada': '<span class="badge badge-success">Completada</span>'
            };
            return badges[estado] || `<span class="badge badge-primary">${estado}</span>`;
        }

        function formatFecha(iso) {
            return new Date(iso).toLocaleDateString('es-PE');
        }

        function cambiarPagina(tipo, dir) {
            if (tipo === 'inventario') {
                paginaInventario += dir;
                renderizarInventario();
            } else if (tipo === 'productos') {
                paginaProductos += dir;
                renderizarProductos();
            }
        }

        // ============================================
        // NAVEGACI√ìN
        // ============================================
        function cambiarVista(nombre) {
            document.querySelectorAll('.vista').forEach(v => v.classList.remove('active'));
            document.getElementById(`vista-${nombre}`).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(n => {
                n.classList.remove('active');
                if (n.dataset.vista === nombre) n.classList.add('active');
            });

            const titulos = {
                dashboard: 'Dashboard', inventario: 'Inventario', productos: 'Productos System',
                ordenes: '√ìrdenes', picking: 'Picking', packing: 'Packing', reclasificacion: 'Reclasificaci√≥n'
            };
            document.getElementById('headerTitle').textContent = titulos[nombre] || 'Sistema';
            
            lucide.createIcons();
        }

        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                const vista = item.dataset.vista;
                if (vista) cambiarVista(vista);
            });
        });

        // ============================================
        // MODALES
        // ============================================
        function abrirModal(id) {
            document.getElementById(id).classList.add('active');
            lucide.createIcons();
        }

        function cerrarModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        document.querySelectorAll('.modal').forEach(m => {
            m.addEventListener('click', e => { if (e.target === m) cerrarModal(m.id); });
        });

        // ============================================
        // LOADING & TOAST
        // ============================================
        function mostrarLoading(texto = 'Cargando...') {
            document.getElementById('loadingText').textContent = texto;
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function ocultarLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
            document.getElementById('progressFill').style.width = '0%';
        }

        function actualizarProgreso(pct) {
            document.getElementById('progressFill').style.width = pct + '%';
        }

        function toast(msg, tipo = 'info') {
            const container = document.getElementById('toastContainer');
            const div = document.createElement('div');
            div.className = `toast ${tipo}`;
            div.innerHTML = `<span>${msg}</span>`;
            container.appendChild(div);
            setTimeout(() => div.remove(), 4000);
        }

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        window.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            await verificarSesion();
            
            document.getElementById('loginPassword')?.addEventListener('keypress', e => {
                if (e.key === 'Enter') iniciarSesion();
            });
        });

        console.log('‚úÖ MAWI v6.0 - Sistema Lukers cargado correctamente');
    </script>
</body>
</html>
