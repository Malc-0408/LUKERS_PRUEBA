<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAWI v6.0 - Sistema Lukers</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{--primary:#6366f1;--primary-dark:#4f46e5;--primary-light:#818cf8;--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--info:#3b82f6;--purple:#a855f7;--bg-main:#0f172a;--bg-card:#fff;--bg-hover:#f1f5f9;--text-primary:#0f172a;--text-secondary:#64748b;--text-light:#94a3b8;--text-white:#fff;--border:#e2e8f0;--shadow:0 4px 6px -1px rgba(0,0,0,0.1);--shadow-lg:0 20px 25px -5px rgba(0,0,0,0.1)}
        body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh}
        
        /* LOGIN */
        .login-container{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:2rem}
        .login-card{background:#fff;padding:3rem;border-radius:20px;box-shadow:0 25px 50px -12px rgba(0,0,0,0.25);max-width:420px;width:100%}
        .login-logo{width:70px;height:70px;background:linear-gradient(135deg,var(--primary),#818cf8);border-radius:16px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:2rem;margin:0 auto 1.5rem}
        .login-title{font-size:2rem;font-weight:800;text-align:center;margin-bottom:0.5rem}
        .login-subtitle{text-align:center;color:var(--text-secondary);margin-bottom:2rem}
        
        /* FORMS */
        .form-group{margin-bottom:1.25rem}
        .form-label{display:block;font-weight:600;margin-bottom:0.5rem;font-size:0.875rem}
        .form-input,.form-select,.form-textarea{width:100%;padding:0.75rem 1rem;border:2px solid var(--border);border-radius:10px;font-size:0.9rem;transition:all 0.2s;font-family:inherit}
        .form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(99,102,241,0.1)}
        .form-textarea{min-height:80px;resize:vertical}
        .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1rem}
        .form-help{font-size:0.75rem;color:var(--text-secondary);margin-top:0.5rem}
        
        /* BUTTONS */
        .btn{padding:0.75rem 1.25rem;border:none;border-radius:10px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;gap:0.5rem;transition:all 0.2s;font-size:0.875rem}
        .btn-primary{background:var(--primary);color:#fff}
        .btn-primary:hover{background:var(--primary-dark);transform:translateY(-2px)}
        .btn-success{background:var(--success);color:#fff}
        .btn-warning{background:var(--warning);color:#fff}
        .btn-danger{background:var(--danger);color:#fff}
        .btn-info{background:var(--info);color:#fff}
        .btn-outline{background:#fff;color:var(--primary);border:2px solid var(--primary)}
        .btn-outline:hover{background:var(--primary);color:#fff}
        .btn-full{width:100%;justify-content:center}
        .btn-icon{width:36px;height:36px;padding:0;justify-content:center}
        .btn:disabled{opacity:0.5;cursor:not-allowed}
        
        /* APP LAYOUT */
        .app-container{display:none;height:100vh;overflow:hidden}
        .sidebar{width:260px;background:var(--bg-main);display:flex;flex-direction:column}
        .sidebar-header{padding:1.5rem;border-bottom:1px solid rgba(255,255,255,0.1)}
        .logo-container{display:flex;align-items:center;gap:0.75rem}
        .logo-icon{width:40px;height:40px;background:linear-gradient(135deg,var(--primary),#818cf8);border-radius:10px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
        .logo-title{font-size:1.25rem;font-weight:700;color:#fff}
        .logo-subtitle{font-size:0.7rem;color:#94a3b8}
        
        /* NAV */
        .nav-menu{flex:1;padding:1rem;overflow-y:auto}
        .nav-section{margin-bottom:1.5rem}
        .nav-section-title{font-size:0.7rem;font-weight:600;text-transform:uppercase;color:#94a3b8;padding:0 1rem;margin-bottom:0.5rem;letter-spacing:0.05em}
        .nav-item{display:flex;align-items:center;gap:0.75rem;padding:0.75rem 1rem;border-radius:10px;cursor:pointer;color:#94a3b8;transition:all 0.2s;margin-bottom:0.25rem}
        .nav-item:hover{background:rgba(255,255,255,0.05);color:#fff}
        .nav-item.active{background:var(--primary);color:#fff}
        .nav-item i{width:20px;height:20px}
        .nav-badge{margin-left:auto;background:var(--danger);color:#fff;font-size:0.7rem;padding:0.15rem 0.5rem;border-radius:10px}
        
        /* USER */
        .user-profile{padding:1rem;border-top:1px solid rgba(255,255,255,0.1)}
        .user-info{display:flex;align-items:center;gap:0.75rem;padding:0.75rem;background:rgba(255,255,255,0.05);border-radius:10px;cursor:pointer}
        .user-avatar{width:36px;height:36px;background:linear-gradient(135deg,var(--primary),#818cf8);border-radius:8px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600}
        .user-name{color:#fff;font-weight:600;font-size:0.875rem}
        .user-role{color:#94a3b8;font-size:0.75rem}
        
        /* MAIN */
        .main-content{flex:1;display:flex;flex-direction:column;overflow:hidden;background:#f8fafc}
        .header{background:#fff;padding:1rem 2rem;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);flex-wrap:wrap;gap:1rem}
        .header-left{display:flex;flex-direction:column}
        .header-title{font-size:1.5rem;font-weight:700}
        .header-breadcrumb{font-size:0.8rem;color:var(--text-secondary);display:flex;align-items:center;gap:0.5rem}
        .header-actions{display:flex;gap:0.75rem;align-items:center}
        .content-area{flex:1;overflow-y:auto;padding:2rem}
        
        /* STATS */
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1.5rem;margin-bottom:2rem}
        .stat-card{background:#fff;padding:1.5rem;border-radius:16px;box-shadow:var(--shadow);transition:transform 0.2s}
        .stat-card:hover{transform:translateY(-4px)}
        .stat-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1rem}
        .stat-icon{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center}
        .stat-icon.blue{background:rgba(99,102,241,0.1);color:var(--primary)}
        .stat-icon.green{background:rgba(16,185,129,0.1);color:var(--success)}
        .stat-icon.orange{background:rgba(245,158,11,0.1);color:var(--warning)}
        .stat-icon.red{background:rgba(239,68,68,0.1);color:var(--danger)}
        .stat-value{font-size:2rem;font-weight:800;margin-bottom:0.25rem}
        .stat-label{color:var(--text-secondary);font-size:0.875rem}
        .stat-footer{margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border);display:flex;justify-content:space-between;font-size:0.75rem}
        .stat-footer-label{color:var(--text-secondary)}
        .stat-footer-value{font-weight:600}
        
        /* KPI */
        .kpi-container{background:linear-gradient(135deg,#667eea,#764ba2);padding:1.5rem;border-radius:16px;margin-bottom:2rem}
        .kpi-title{color:#fff;font-size:1.1rem;font-weight:700;margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem}
        .kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:1rem}
        .kpi-item{background:rgba(255,255,255,0.15);padding:1rem;border-radius:10px;backdrop-filter:blur(10px)}
        .kpi-label{color:rgba(255,255,255,0.9);font-size:0.7rem;text-transform:uppercase;margin-bottom:0.25rem;letter-spacing:0.05em}
        .kpi-value{color:#fff;font-size:1.5rem;font-weight:800;display:flex;align-items:baseline;gap:0.25rem}
        .kpi-unit{font-size:0.75rem;opacity:0.8}
        
        /* CHARTS */
        .charts-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:1.5rem;margin-bottom:2rem}
        .chart-card{background:#fff;padding:1.5rem;border-radius:16px;box-shadow:var(--shadow)}
        .chart-title{font-size:1rem;font-weight:600;margin-bottom:1rem}
        .chart-wrapper{height:280px;position:relative}
        
        /* CARDS */
        .card{background:#fff;border-radius:16px;padding:1.5rem;box-shadow:var(--shadow);margin-bottom:1.5rem}
        .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:2px solid var(--border);flex-wrap:wrap;gap:1rem}
        .card-title{font-size:1.1rem;font-weight:700;display:flex;align-items:center;gap:0.5rem}
        .card-actions{display:flex;gap:0.5rem;flex-wrap:wrap}
        
        /* TABLES */
        .table-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:1rem}
        .table-container{overflow-x:auto}
        table{width:100%;border-collapse:collapse}
        th,td{padding:0.875rem 1rem;text-align:left;border-bottom:1px solid var(--border)}
        th{background:var(--bg-hover);font-weight:600;font-size:0.75rem;text-transform:uppercase;color:var(--text-secondary)}
        tr:hover{background:var(--bg-hover)}
        
        /* BADGES */
        .badge{padding:0.25rem 0.75rem;border-radius:9999px;font-size:0.75rem;font-weight:600}
        .badge-primary{background:rgba(99,102,241,0.1);color:var(--primary)}
        .badge-success{background:rgba(16,185,129,0.1);color:var(--success)}
        .badge-warning{background:rgba(245,158,11,0.1);color:var(--warning)}
        .badge-danger{background:rgba(239,68,68,0.1);color:var(--danger)}
        .badge-info{background:rgba(59,130,246,0.1);color:var(--info)}
        .badge-purple{background:rgba(168,85,247,0.1);color:var(--purple)}
        
        /* SEARCH */
        .search-box{display:flex;align-items:center;gap:0.5rem;background:var(--bg-hover);padding:0.5rem 1rem;border-radius:10px;min-width:250px}
        .search-box input{border:none;background:transparent;outline:none;flex:1;font-size:0.875rem}
        
        /* PAGINATION */
        .pagination{display:flex;justify-content:center;gap:0.5rem;margin-top:1.5rem}
        .pagination button{padding:0.5rem 1rem;border:1px solid var(--border);background:#fff;border-radius:8px;cursor:pointer;font-weight:500}
        .pagination button:hover:not(:disabled){background:var(--primary);color:#fff;border-color:var(--primary)}
        .pagination button:disabled{opacity:0.5;cursor:not-allowed}
        
        /* ALERTS */
        .alert{padding:1rem;border-radius:10px;margin-bottom:1rem;display:flex;align-items:flex-start;gap:0.75rem;border-left:4px solid}
        .alert-warning{background:rgba(245,158,11,0.1);border-color:var(--warning);color:#92400e}
        .alert-danger{background:rgba(239,68,68,0.1);border-color:var(--danger);color:#991b1b}
        .alert-info{background:rgba(59,130,246,0.1);border-color:var(--info);color:#1e40af}
        .alert-success{background:rgba(16,185,129,0.1);border-color:var(--success);color:#065f46}
        
        /* MODALS */
        .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:1000;align-items:center;justify-content:center;padding:1rem}
        .modal.active{display:flex}
        .modal-content{background:#fff;border-radius:16px;max-width:600px;width:100%;max-height:90vh;overflow-y:auto}
        .modal-content.large{max-width:900px}
        .modal-header{padding:1.5rem;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
        .modal-title{font-size:1.25rem;font-weight:700;display:flex;align-items:center;gap:0.5rem}
        .modal-close{width:32px;height:32px;border:none;background:var(--bg-hover);border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .modal-close:hover{background:var(--danger);color:#fff}
        .modal-body{padding:1.5rem}
        .modal-footer{padding:1.5rem;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:0.75rem}
        
        /* FILE UPLOAD */
        .file-upload-btn{display:inline-flex;align-items:center;gap:0.5rem;padding:0.75rem 1.5rem;background:var(--bg-hover);border:2px dashed var(--border);border-radius:10px;cursor:pointer;font-weight:600}
        .file-upload-btn:hover{background:var(--primary);color:#fff;border-color:var(--primary)}
        .form-file{display:none}
        
        /* DROPDOWN */
        .dropdown{position:relative;display:inline-block}
        .dropdown-menu{position:absolute;top:100%;right:0;margin-top:0.5rem;background:#fff;border-radius:12px;box-shadow:var(--shadow-lg);min-width:200px;z-index:100;opacity:0;visibility:hidden;transform:translateY(-10px);transition:all 0.2s}
        .dropdown-menu.active{opacity:1;visibility:visible;transform:translateY(0)}
        .dropdown-item{padding:0.75rem 1rem;display:flex;align-items:center;gap:0.75rem;cursor:pointer;transition:background 0.2s}
        .dropdown-item:hover{background:var(--bg-hover)}
        .dropdown-item:first-child{border-radius:12px 12px 0 0}
        .dropdown-item:last-child{border-radius:0 0 12px 12px}
        
        /* LOADING */
        .loading-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9999;align-items:center;justify-content:center}
        .loading-overlay.active{display:flex}
        .loading-content{text-align:center;color:#fff}
        .spinner{width:50px;height:50px;border:4px solid rgba(255,255,255,0.2);border-top-color:#fff;border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 1rem}
        @keyframes spin{to{transform:rotate(360deg)}}
        .progress-bar{width:200px;height:6px;background:rgba(255,255,255,0.2);border-radius:3px;overflow:hidden;margin:1rem auto 0}
        .progress-fill{height:100%;background:var(--primary);width:0%;transition:width 0.3s}
        
        /* TOAST */
        .toast-container{position:fixed;top:1rem;right:1rem;z-index:10000;display:flex;flex-direction:column;gap:0.5rem}
        .toast{background:#fff;padding:1rem 1.5rem;border-radius:12px;box-shadow:0 10px 40px rgba(0,0,0,0.2);display:flex;align-items:center;gap:0.75rem;animation:slideIn 0.3s ease;border-left:4px solid}
        .toast.success{border-color:var(--success)}
        .toast.error{border-color:var(--danger)}
        .toast.warning{border-color:var(--warning)}
        .toast.info{border-color:var(--info)}
        @keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
        
        /* VISTAS */
        .vista{display:none}
        .vista.active{display:block}
        
        /* EMPTY */
        .empty-state{text-align:center;padding:3rem;color:var(--text-secondary)}
        
        /* RESPONSIVE */
        @media(max-width:768px){
            .sidebar{display:none}
            .stats-grid,.charts-grid{grid-template-columns:1fr}
            .card-header{flex-direction:column;align-items:stretch}
            .card-actions{justify-content:flex-start}
        }
    </style>
</head>
<body>
    <div class="toast-container" id="toastContainer"></div>
    
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div id="loadingText">Cargando...</div>
            <div id="loadingSubtext" style="font-size:0.875rem;opacity:0.8;margin-top:0.5rem"></div>
            <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
        </div>
    </div>

    <!-- LOGIN -->
    <div class="login-container" id="loginSection">
        <div class="login-card">
            <div class="login-logo">M</div>
            <h1 class="login-title">MAWI v6.0</h1>
            <p class="login-subtitle">Sistema de Gesti√≥n Lukers</p>
            <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" id="loginEmail" class="form-input" placeholder="correo@lukers.com">
            </div>
            <div class="form-group">
                <label class="form-label">Contrase√±a</label>
                <input type="password" id="loginPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            <button class="btn btn-primary btn-full" onclick="iniciarSesion()">Iniciar Sesi√≥n</button>
        </div>
    </div>

    <!-- APP -->
    <div class="app-container" id="appSection">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <div class="logo-icon">M</div>
                    <div>
                        <div class="logo-title">MAWI</div>
                        <div class="logo-subtitle">v6.0 Sistema Lukers</div>
                    </div>
                </div>
            </div>
            <nav class="nav-menu">
                <div class="nav-section">
                    <div class="nav-section-title">Principal</div>
                    <div class="nav-item active" data-vista="dashboard"><i data-lucide="layout-dashboard"></i><span>Dashboard</span></div>
                    <div class="nav-item" data-vista="inventario"><i data-lucide="package"></i><span>Inventario</span></div>
                    <div class="nav-item" data-vista="productos"><i data-lucide="database"></i><span>Productos System</span></div>
                </div>
                <div class="nav-section">
                    <div class="nav-section-title">Operaciones</div>
                    <div class="nav-item" data-vista="ordenes"><i data-lucide="shopping-cart"></i><span>√ìrdenes</span><span class="nav-badge" id="badgeOrdenes">0</span></div>
                    <div class="nav-item" data-vista="picking"><i data-lucide="scan"></i><span>Picking</span></div>
                    <div class="nav-item" data-vista="packing"><i data-lucide="box"></i><span>Packing</span></div>
                    <div class="nav-item" data-vista="reclasificacion"><i data-lucide="repeat"></i><span>Reclasificaci√≥n</span></div>
                </div>
            </nav>
            <div class="user-profile">
                <div class="user-info" onclick="cerrarSesion()">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div>
                        <div class="user-name" id="userName">Usuario</div>
                        <div class="user-role">Cerrar Sesi√≥n</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <header class="header">
                <div class="header-left">
                    <h1 class="header-title" id="headerTitle">Dashboard</h1>
                    <div class="header-breadcrumb">
                        <span>Principal</span>
                        <i data-lucide="chevron-right" style="width:14px;height:14px"></i>
                        <span id="headerBreadcrumb" style="color:var(--primary);font-weight:600">Dashboard</span>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="sincronizarDatos()">
                        <i data-lucide="refresh-cw" style="width:16px;height:16px"></i> Sincronizar
                    </button>
                </div>
            </header>
            
            <div class="content-area">
                <!-- DASHBOARD -->
                <div id="vista-dashboard" class="vista active">
                    <!-- Alerta √≥rdenes pr√≥ximas -->
                    <div id="alertaOrdenes" class="alert alert-warning" style="display:none">
                        <i data-lucide="alert-triangle" style="width:20px;height:20px;flex-shrink:0"></i>
                        <div>
                            <strong id="alertaOrdenesTexto"></strong>
                            <div style="font-size:0.875rem;margin-top:0.25rem">Revisa el listado para tomar acci√≥n</div>
                        </div>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header"><div class="stat-icon blue"><i data-lucide="package"></i></div></div>
                            <div class="stat-value" id="statVariantes">0</div>
                            <div class="stat-label">Variantes en Inventario</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header"><div class="stat-icon green"><i data-lucide="trending-up"></i></div></div>
                            <div class="stat-value" id="statUnidades">0</div>
                            <div class="stat-label">Unidades Totales</div>
                            <div class="stat-footer">
                                <span class="stat-footer-label">Disponibles</span>
                                <span class="stat-footer-value" id="statDisponibles">0</span>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header"><div class="stat-icon orange"><i data-lucide="lock"></i></div></div>
                            <div class="stat-value" id="statBloqueadas">0</div>
                            <div class="stat-label">Unidades Bloqueadas</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-header"><div class="stat-icon red"><i data-lucide="shopping-cart"></i></div></div>
                            <div class="stat-value" id="statOrdenes">0</div>
                            <div class="stat-label">√ìrdenes Activas</div>
                        </div>
                    </div>

                    <div class="kpi-container">
                        <div class="kpi-title"><i data-lucide="clock" style="width:20px;height:20px"></i> KPIs de Tiempo y Eficiencia</div>
                        <div class="kpi-grid">
                            <div class="kpi-item">
                                <div class="kpi-label">D√≠as Prom. Picking</div>
                                <div class="kpi-value"><span id="kpiPicking">0.0</span><span class="kpi-unit">d√≠as</span></div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-label">D√≠as Prom. Packing</div>
                                <div class="kpi-value"><span id="kpiPacking">0.0</span><span class="kpi-unit">d√≠as</span></div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-label">Tiempo Total Prom.</div>
                                <div class="kpi-value"><span id="kpiTotal">0.0</span><span class="kpi-unit">d√≠as</span></div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-label">Tasa Cumplimiento</div>
                                <div class="kpi-value"><span id="kpiCumplimiento">0</span><span class="kpi-unit">%</span></div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-label">√ìrdenes a Tiempo</div>
                                <div class="kpi-value"><span id="kpiATiempo">0/0</span></div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-label">Prod. Rechazados</div>
                                <div class="kpi-value"><span id="kpiRechazados">0</span><span class="kpi-unit">%</span></div>
                            </div>
                        </div>
                    </div>

                    <div class="charts-grid">
                        <div class="chart-card">
                            <div class="chart-title">üìä Monto por G√©nero del Mes</div>
                            <div class="chart-wrapper"><canvas id="chartGeneros"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-title">üìà Evoluci√≥n de √ìrdenes (7 d√≠as)</div>
                            <div class="chart-wrapper"><canvas id="chartEvolucion"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-title">üç© Estados de √ìrdenes</div>
                            <div class="chart-wrapper"><canvas id="chartEstados"></canvas></div>
                        </div>
                        <div class="chart-card">
                            <div class="chart-title">üè™ Rendimiento por Tienda</div>
                            <div class="chart-wrapper"><canvas id="chartTiendas"></canvas></div>
                        </div>
                    </div>
                </div>

                <!-- INVENTARIO -->
                <div id="vista-inventario" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i data-lucide="package" style="width:20px;height:20px;color:var(--primary)"></i> Gesti√≥n de Inventario</h3>
                            <div class="card-actions">
                                <button class="btn btn-primary" onclick="abrirModal('modalSubirInventario')"><i data-lucide="upload" style="width:16px;height:16px"></i> Subir Excel</button>
                                <button class="btn btn-success" onclick="abrirModal('modalAgregarItem')"><i data-lucide="plus" style="width:16px;height:16px"></i> Agregar</button>
                                <button class="btn btn-outline" onclick="exportarInventario()"><i data-lucide="download" style="width:16px;height:16px"></i> Exportar</button>
                                <div class="dropdown">
                                    <button class="btn btn-outline" onclick="toggleDropdown('dropdownInventario')"><i data-lucide="more-horizontal" style="width:16px;height:16px"></i></button>
                                    <div class="dropdown-menu" id="dropdownInventario">
                                        <div class="dropdown-item" onclick="abrirModal('modalModificarMasivo')"><i data-lucide="edit" style="width:16px;height:16px"></i> Modificar Masivo</div>
                                        <div class="dropdown-item" onclick="abrirModal('modalEliminarMasivo')"><i data-lucide="trash-2" style="width:16px;height:16px"></i> Eliminar Masivo</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="table-controls">
                            <div class="search-box">
                                <i data-lucide="search" style="width:18px;height:18px;color:var(--text-secondary)"></i>
                                <input type="text" id="searchInventario" placeholder="Buscar variante o ubicaci√≥n..." oninput="filtrarInventario()">
                            </div>
                            <span style="color:var(--text-secondary)">Total: <strong id="countInventario">0</strong> registros</span>
                        </div>
                        <div class="table-container">
                            <table><thead><tr><th>Variante</th><th>Ubicaci√≥n</th><th>Stock F√≠sico</th><th>Bloqueado</th><th>Disponible</th><th>Acciones</th></tr></thead>
                            <tbody id="tablaInventario"></tbody></table>
                        </div>
                        <div class="pagination">
                            <button onclick="cambiarPagina('inventario',-1)" id="prevInventario">Anterior</button>
                            <span>P√°gina <strong id="paginaInventario">1</strong> de <strong id="totalPaginasInventario">1</strong></span>
                            <button onclick="cambiarPagina('inventario',1)" id="nextInventario">Siguiente</button>
                        </div>
                    </div>
                </div>

                <!-- PRODUCTOS -->
                <div id="vista-productos" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i data-lucide="database" style="width:20px;height:20px;color:var(--primary)"></i> Cat√°logo de Productos</h3>
                            <div class="card-actions">
                                <button class="btn btn-primary" onclick="abrirModal('modalSubirProductos')"><i data-lucide="upload" style="width:16px;height:16px"></i> Subir Cat√°logo</button>
                                <button class="btn btn-outline" onclick="exportarProductos()"><i data-lucide="download" style="width:16px;height:16px"></i> Exportar</button>
                            </div>
                        </div>
                        <div class="table-controls">
                            <div class="form-row" style="flex:1;max-width:800px">
                                <select id="filtroGenero" class="form-select" onchange="aplicarFiltrosProductos()"><option value="">Todos los G√©neros</option></select>
                                <select id="filtroLinea" class="form-select" onchange="aplicarFiltrosProductos()"><option value="">Todas las L√≠neas</option></select>
                                <select id="filtroMarca" class="form-select" onchange="aplicarFiltrosProductos()"><option value="">Todas las Marcas</option></select>
                                <select id="filtroTalla" class="form-select" onchange="aplicarFiltrosProductos()"><option value="">Todas las Tallas</option></select>
                            </div>
                            <div class="search-box" style="min-width:200px">
                                <i data-lucide="search" style="width:18px;height:18px;color:var(--text-secondary)"></i>
                                <input type="text" id="searchProductos" placeholder="Buscar..." oninput="filtrarProductos()">
                            </div>
                        </div>
                        <div class="table-container">
                            <table><thead><tr><th>Variante</th><th>G√©nero</th><th>L√≠nea</th><th>Marca</th><th>Talla</th><th>Kardex</th><th>PVP</th></tr></thead>
                            <tbody id="tablaProductos"></tbody></table>
                        </div>
                        <div class="pagination">
                            <button onclick="cambiarPagina('productos',-1)" id="prevProductos">Anterior</button>
                            <span>P√°gina <strong id="paginaProductos">1</strong> de <strong id="totalPaginasProductos">1</strong></span>
                            <button onclick="cambiarPagina('productos',1)" id="nextProductos">Siguiente</button>
                        </div>
                    </div>
                </div>

                <!-- √ìRDENES -->
                <div id="vista-ordenes" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i data-lucide="shopping-cart" style="width:20px;height:20px;color:var(--primary)"></i> Gesti√≥n de √ìrdenes</h3>
                            <div class="card-actions">
                                <button class="btn btn-primary" onclick="abrirModal('modalCrearOrden')"><i data-lucide="plus" style="width:16px;height:16px"></i> Nueva Orden</button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table><thead><tr><th>ID</th><th>Fecha</th><th>Variantes</th><th>Unidades</th><th>D√≠as</th><th>Estado</th><th>Acciones</th></tr></thead>
                            <tbody id="tablaOrdenes"></tbody></table>
                        </div>
                    </div>
                </div>

                <!-- PICKING -->
                <div id="vista-picking" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i data-lucide="scan" style="width:20px;height:20px;color:var(--primary)"></i> M√≥dulo de Picking</h3>
                        </div>
                        <div class="table-container">
                            <table><thead><tr><th>ID Orden</th><th>Fecha</th><th>Variantes</th><th>Unidades</th><th>Estado</th><th>Acciones</th></tr></thead>
                            <tbody id="tablaPicking"></tbody></table>
                        </div>
                    </div>
                </div>

                <!-- PACKING -->
                <div id="vista-packing" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i data-lucide="box" style="width:20px;height:20px;color:var(--primary)"></i> M√≥dulo de Packing</h3>
                        </div>
                        <div class="table-container">
                            <table><thead><tr><th>ID Orden</th><th>Fecha</th><th>Variantes Enc.</th><th>Unidades Enc.</th><th>Estado</th><th>Acciones</th></tr></thead>
                            <tbody id="tablaPacking"></tbody></table>
                        </div>
                    </div>
                </div>

                <!-- RECLASIFICACI√ìN -->
                <div id="vista-reclasificacion" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title"><i data-lucide="repeat" style="width:20px;height:20px;color:var(--primary)"></i> Productos en Reclasificaci√≥n</h3>
                        </div>
                        <div class="table-controls">
                            <div class="search-box">
                                <i data-lucide="search" style="width:18px;height:18px;color:var(--text-secondary)"></i>
                                <input type="text" id="searchReclasificacion" placeholder="Buscar..." oninput="filtrarReclasificacion()">
                            </div>
                        </div>
                        <div class="table-container">
                            <table><thead><tr><th>ID</th><th>Variante Original</th><th>Nueva Variante</th><th>Ubicaci√≥n</th><th>Cantidad</th><th>Motivo</th><th>Estado</th><th>Acciones</th></tr></thead>
                            <tbody id="tablaReclasificacion"></tbody></table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALES -->
    <!-- Subir Inventario -->
    <div id="modalSubirInventario" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i data-lucide="upload"></i> Subir Inventario</h3>
                <button class="modal-close" onclick="cerrarModal('modalSubirInventario')"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Archivo Excel</label>
                    <input type="file" id="fileInventario" class="form-file" accept=".xlsx,.xls">
                    <label for="fileInventario" class="file-upload-btn"><i data-lucide="file-plus" style="width:18px;height:18px"></i> Seleccionar archivo</label>
                    <p class="form-help">Columnas: Variante, Ubicacion, StockFisico</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="cerrarModal('modalSubirInventario')">Cancelar</button>
                <button class="btn btn-primary" onclick="procesarInventario()">Procesar</button>
            </div>
        </div>
    </div>

    <!-- Agregar Item -->
    <div id="modalAgregarItem" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i data-lucide="plus"></i> Agregar Producto</h3>
                <button class="modal-close" onclick="cerrarModal('modalAgregarItem')"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Variante</label><input type="text" id="inputVariante" class="form-input" placeholder="Ej: 10001-01-M"></div>
                <div class="form-group"><label class="form-label">Ubicaci√≥n</label><input type="text" id="inputUbicacion" class="form-input" placeholder="Ej: A1"></div>
                <div class="form-group"><label class="form-label">Stock F√≠sico</label><input type="number" id="inputStock" class="form-input" placeholder="0" min="0"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="cerrarModal('modalAgregarItem')">Cancelar</button>
                <button class="btn btn-success" onclick="guardarItem()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Modificar Masivo -->
    <div id="modalModificarMasivo" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i data-lucide="edit"></i> Modificar Stock Masivo</h3>
                <button class="modal-close" onclick="cerrarModal('modalModificarMasivo')"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Archivo Excel</label>
                    <input type="file" id="fileModificar" class="form-file" accept=".xlsx,.xls">
                    <label for="fileModificar" class="file-upload-btn"><i data-lucide="file-plus" style="width:18px;height:18px"></i> Seleccionar archivo</label>
                    <p class="form-help">Columnas: Variante, Ubicacion, StockFisico (nuevo valor)</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="cerrarModal('modalModificarMasivo')">Cancelar</button>
                <button class="btn btn-warning" onclick="procesarModificarMasivo()">Modificar</button>
            </div>
        </div>
    </div>

    <!-- Eliminar Masivo -->
    <div id="modalEliminarMasivo" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i data-lucide="trash-2"></i> Eliminar Productos Masivo</h3>
                <button class="modal-close" onclick="cerrarModal('modalEliminarMasivo')"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger"><i data-lucide="alert-triangle" style="width:20px;height:20px"></i><div><strong>Acci√≥n Irreversible</strong><br>Los registros se eliminar√°n permanentemente</div></div>
                <div class="form-group">
                    <label class="form-label">Archivo Excel</label>
                    <input type="file" id="fileEliminar" class="form-file" accept=".xlsx,.xls">
                    <label for="fileEliminar" class="file-upload-btn"><i data-lucide="file-plus" style="width:18px;height:18px"></i> Seleccionar archivo</label>
                    <p class="form-help">Columnas: Variante, Ubicacion</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="cerrarModal('modalEliminarMasivo')">Cancelar</button>
                <button class="btn btn-danger" onclick="procesarEliminarMasivo()">Eliminar</button>
            </div>
        </div>
    </div>

    <!-- Subir Productos -->
    <div id="modalSubirProductos" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i data-lucide="database"></i> Subir Cat√°logo</h3>
                <button class="modal-close" onclick="cerrarModal('modalSubirProductos')"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info"><i data-lucide="info" style="width:20px;height:20px"></i><span>Esto reemplazar√° todo el cat√°logo actual</span></div>
                <div class="form-group">
                    <label class="form-label">Archivo Excel</label>
                    <input type="file" id="fileProductos" class="form-file" accept=".xlsx,.xls">
                    <label for="fileProductos" class="file-upload-btn"><i data-lucide="file-plus" style="width:18px;height:18px"></i> Seleccionar archivo</label>
                    <p class="form-help">Columnas: variante, kardex, pvp, genero, linea, marca, talla</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="cerrarModal('modalSubirProductos')">Cancelar</button>
                <button class="btn btn-primary" onclick="procesarProductos()">Procesar</button>
            </div>
        </div>
    </div>

    <!-- Crear Orden -->
    <div id="modalCrearOrden" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 class="modal-title"><i data-lucide="shopping-cart"></i> Nueva Orden</h3>
                <button class="modal-close" onclick="cerrarModal('modalCrearOrden')"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Archivo Excel con Hoja de Ruta</label>
                    <input type="file" id="fileOrden" class="form-file" accept=".xlsx,.xls">
                    <label for="fileOrden" class="file-upload-btn"><i data-lucide="file-plus" style="width:18px;height:18px"></i> Seleccionar archivo</label>
                    <p class="form-help">Columnas: Variante, Ubicacion, y columnas por tienda con cantidades</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="cerrarModal('modalCrearOrden')">Cancelar</button>
                <button class="btn btn-primary" onclick="procesarOrden()">Crear Orden</button>
            </div>
        </div>
    </div>

    <!-- Ver Orden -->
    <div id="modalVerOrden" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 class="modal-title"><i data-lucide="file-text"></i> Detalle de Orden <span id="ordenDetalleId"></span></h3>
                <button class="modal-close" onclick="cerrarModal('modalVerOrden')"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body" id="ordenDetalleContenido"></div>
        </div>
    </div>

    <!-- Subir Cantidades Picking -->
    <div id="modalSubirCantidades" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i data-lucide="scan"></i> Confirmar Cantidades Encontradas</h3>
                <button class="modal-close" onclick="cerrarModal('modalSubirCantidades')"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom:1rem;color:var(--text-secondary)">Sube el Excel con las cantidades realmente encontradas</p>
                <div class="form-group">
                    <input type="file" id="fileCantidades" class="form-file" accept=".xlsx,.xls">
                    <label for="fileCantidades" class="file-upload-btn"><i data-lucide="file-plus" style="width:18px;height:18px"></i> Seleccionar archivo</label>
                    <p class="form-help">Columnas: Variante, Ubicacion, Encontrado</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="cerrarModal('modalSubirCantidades')">Cancelar</button>
                <button class="btn btn-success" onclick="confirmarSubirCantidades()">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Subir Packing Real -->
    <div id="modalSubirPacking" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i data-lucide="box"></i> Subir Distribuci√≥n Real</h3>
                <button class="modal-close" onclick="cerrarModal('modalSubirPacking')"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info"><i data-lucide="info" style="width:20px;height:20px"></i><span>Sube el Excel con la distribuci√≥n REAL por tienda</span></div>
                <div class="form-group">
                    <input type="file" id="filePackingReal" class="form-file" accept=".xlsx,.xls">
                    <label for="filePackingReal" class="file-upload-btn"><i data-lucide="file-plus" style="width:18px;height:18px"></i> Seleccionar archivo</label>
                    <p class="form-help">Columnas: Variante, Ubicacion, y columnas por tienda</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="cerrarModal('modalSubirPacking')">Cancelar</button>
                <button class="btn btn-success" onclick="confirmarSubirPacking()">Procesar</button>
            </div>
        </div>
    </div>

    <!-- Reclasificaci√≥n Inmediata -->
    <div id="modalReclasificacion" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i data-lucide="alert-circle" style="color:var(--warning)"></i> Reclasificaci√≥n Obligatoria</h3>
                <button class="modal-close" onclick="cancelarReclasificacion()"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning"><i data-lucide="alert-triangle" style="width:20px;height:20px"></i><span>Clasifica los productos no empaquetados</span></div>
                <div style="background:var(--bg-hover);padding:1rem;border-radius:10px;margin-bottom:1rem">
                    <div style="display:flex;justify-content:space-between"><span>Progreso:</span><strong id="progresoReclas">1/1</strong></div>
                </div>
                <div class="form-group"><label class="form-label">Variante</label><input type="text" id="reclasVariante" class="form-input" readonly></div>
                <div class="form-group"><label class="form-label">Ubicaci√≥n</label><input type="text" id="reclasUbicacion" class="form-input" readonly></div>
                <div class="form-group"><label class="form-label">Cantidad</label><input type="text" id="reclasCantidad" class="form-input" readonly></div>
                <div class="form-group">
                    <label class="form-label">Motivo de Rechazo</label>
                    <select id="reclasMotivo" class="form-select" onchange="toggleNuevaVariante()">
                        <option value="">Seleccionar...</option>
                        <option value="mal_estado">Mal Estado / Defectuoso</option>
                        <option value="no_corresponde_linea">No Corresponde a L√≠nea</option>
                        <option value="no_corresponde_genero">No Corresponde a G√©nero</option>
                        <option value="no_corresponde_talla">No Corresponde a Talla</option>
                    </select>
                </div>
                <div class="form-group" id="grupoNuevaVariante" style="display:none">
                    <label class="form-label">Nueva Variante Correcta</label>
                    <input type="text" id="reclasNuevaVariante" class="form-input" placeholder="Variante correcta">
                    <p class="form-help">Se asignar√° a ubicaci√≥n 999-PENDIENTE</p>
                </div>
                <div id="grupoMalEstado" class="alert alert-danger" style="display:none"><i data-lucide="x-circle" style="width:20px;height:20px"></i><span>Se asignar√° a ubicaci√≥n <strong>191</strong></span></div>
                <div class="form-group"><label class="form-label">Comentario</label><textarea id="reclasComentario" class="form-textarea" placeholder="Describe el motivo..."></textarea></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="cancelarReclasificacion()">Cancelar</button>
                <button class="btn btn-primary" onclick="procesarReclasificacionItem()"><span id="btnReclasTexto">Siguiente</span></button>
            </div>
        </div>
    </div>

    <!-- Completar Reclasificaci√≥n -->
    <div id="modalCompletarReclas" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i data-lucide="check-circle"></i> Completar Reclasificaci√≥n</h3>
                <button class="modal-close" onclick="cerrarModal('modalCompletarReclas')"><i data-lucide="x"></i></button>
            </div>
            <div class="modal-body">
                <div id="infoCompletarReclas"></div>
                <div class="form-group" style="margin-top:1rem">
                    <label class="form-label">Ubicaci√≥n Final</label>
                    <input type="text" id="ubicacionFinalReclas" class="form-input" placeholder="Ej: A1, B2">
                    <p class="form-help">Ubicaci√≥n definitiva donde se almacenar√°</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="cerrarModal('modalCompletarReclas')">Cancelar</button>
                <button class="btn btn-success" onclick="confirmarCompletarReclas()">Completar</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURACI√ìN
        // ============================================
        const SUPABASE_URL = 'https://dzxjzmlmmmwspemihhlv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6eGp6bWxtbW13c3BlbWloaGx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1NjI5MjAsImV4cCI6MjA3OTEzODkyMH0.uLXtsONi_c4myPbsvTIqV51pldRv6Wuff4adYWgVR6Q';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const TIENDAS = ['LUKERS EL SOL','LUKERS TRU PIZARRO','LUKERS LA MARINA','LUKERS PROLONGACI√ìN IQUITOS','LUKERS CHI P. RUIZ','LUKERS TARAPOTO','LUKERS MENDIOLA','LUKERS ALFONSO UGARTE','LUKERS IQT LORES','LUKERS JIRON'];
        const DIAS_EXPIRACION = 7;
        const DIAS_ALERTA = 3;
        const ITEMS_POR_PAGINA = 50;
        const BATCH_SIZE = 500;

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let inventario = [], productos = [], ordenes = [], reclasificacion = [];
        let paginaInv = 1, paginaProd = 1;
        let chartGeneros, chartEvolucion, chartEstados, chartTiendas;
        let ordenActualPicking = null, ordenActualPacking = null;
        let variantesNoEmpaquetadas = [], indiceReclas = 0;
        let reclasActual = null;

        // ============================================
        // AUTENTICACI√ìN
        // ============================================
        async function verificarSesion() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('appSection').style.display = 'flex';
                document.getElementById('userName').textContent = session.user.email.split('@')[0];
                document.getElementById('userAvatar').textContent = session.user.email.charAt(0).toUpperCase();
                await cargarDatos();
            } else {
                document.getElementById('loginSection').style.display = 'flex';
                document.getElementById('appSection').style.display = 'none';
            }
        }

        async function iniciarSesion() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) { toast('Completa los campos', 'error'); return; }
            mostrarLoading('Iniciando sesi√≥n...');
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            ocultarLoading();
            if (error) toast('Error: ' + error.message, 'error');
            else { toast('Sesi√≥n iniciada', 'success'); await verificarSesion(); }
        }

        async function cerrarSesion() {
            await supabase.auth.signOut();
            toast('Sesi√≥n cerrada', 'info');
            setTimeout(() => location.reload(), 500);
        }

        // ============================================
        // CARGA DE DATOS
        // ============================================
        async function cargarDatos() {
            mostrarLoading('Cargando datos...');
            try {
                await Promise.all([cargarInventario(), cargarProductos(), cargarOrdenes(), cargarReclasificacion()]);
                actualizarDashboard();
                ocultarLoading();
                toast('Datos cargados', 'success');
            } catch (e) { ocultarLoading(); toast('Error: ' + e.message, 'error'); }
        }

        async function sincronizarDatos() { await cargarDatos(); }

        async function cargarInventario() {
            const { data } = await supabase.from('inventario').select('*').order('variante');
            inventario = data || [];
            renderizarInventario();
        }

        async function cargarProductos() {
            const { data } = await supabase.from('productos_system').select('*').order('variante');
            productos = data || [];
            actualizarFiltros();
            renderizarProductos();
        }

        async function cargarOrdenes() {
            const { data } = await supabase.from('ordenes').select('*').order('fecha', { ascending: false });
            ordenes = data || [];
            renderizarOrdenes();
            renderizarPicking();
            renderizarPacking();
            verificarOrdenesProximas();
        }

        async function cargarReclasificacion() {
            const { data } = await supabase.from('reclasificacion').select('*').order('fecha', { ascending: false });
            reclasificacion = data || [];
            renderizarReclasificacion();
        }

        // ============================================
        // DASHBOARD
        // ============================================
        function actualizarDashboard() {
            const variantes = new Set(inventario.map(i => i.variante)).size;
            const unidades = inventario.reduce((s, i) => s + (i.stock_fisico || 0), 0);
            const bloqueadas = inventario.reduce((s, i) => s + (i.stock_bloqueado || 0), 0);
            const activas = ordenes.filter(o => !['Completada', 'Cancelada', 'Expirada'].includes(o.estado)).length;

            document.getElementById('statVariantes').textContent = variantes.toLocaleString();
            document.getElementById('statUnidades').textContent = unidades.toLocaleString();
            document.getElementById('statDisponibles').textContent = (unidades - bloqueadas).toLocaleString();
            document.getElementById('statBloqueadas').textContent = bloqueadas.toLocaleString();
            document.getElementById('statOrdenes').textContent = activas;
            document.getElementById('badgeOrdenes').textContent = activas;

            actualizarKPIs();
            generarGraficas();
        }

        function actualizarKPIs() {
            const completadas = ordenes.filter(o => o.estado === 'Completada' && o.fechaCierre);
            if (completadas.length === 0) {
                ['kpiPicking','kpiPacking','kpiTotal','kpiCumplimiento','kpiATiempo','kpiRechazados'].forEach(id => {
                    document.getElementById(id).textContent = id === 'kpiATiempo' ? '0/0' : '0';
                });
                return;
            }

            let diasPicking = 0, diasPacking = 0, aTiempo = 0, rechazados = 0, totalProd = 0;
            completadas.forEach(o => {
                const dias = diasTranscurridos(o.fecha);
                diasPicking += dias * 0.6;
                diasPacking += dias * 0.4;
                if (dias <= DIAS_EXPIRACION) aTiempo++;
                rechazados += o.prendasRechazadas || 0;
                if (o.hojaPacking) o.hojaPacking.forEach(f => { TIENDAS.forEach(t => { totalProd += f[t] || 0; }); });
            });

            document.getElementById('kpiPicking').textContent = (diasPicking / completadas.length).toFixed(1);
            document.getElementById('kpiPacking').textContent = (diasPacking / completadas.length).toFixed(1);
            document.getElementById('kpiTotal').textContent = ((diasPicking + diasPacking) / completadas.length).toFixed(1);
            document.getElementById('kpiCumplimiento').textContent = ((aTiempo / completadas.length) * 100).toFixed(1);
            document.getElementById('kpiATiempo').textContent = `${aTiempo}/${completadas.length}`;
            document.getElementById('kpiRechazados').textContent = totalProd > 0 ? ((rechazados / totalProd) * 100).toFixed(1) : '0';
        }

        function generarGraficas() {
            // Gr√°fica G√©neros
            const ctxG = document.getElementById('chartGeneros');
            if (chartGeneros) chartGeneros.destroy();
            let montoH = 0, montoM = 0, montoI = 0;
            const mesActual = new Date().getMonth();
            ordenes.filter(o => o.estado === 'Completada' && o.fechaCierre && new Date(o.fechaCierre).getMonth() === mesActual).forEach(o => {
                if (o.hojaPacking) o.hojaPacking.forEach(f => {
                    let cant = 0; TIENDAS.forEach(t => { cant += f[t] || 0; });
                    const prod = productos.find(p => p.variante === f.variante);
                    const monto = cant * (f.kardex || 0);
                    const gen = (prod?.genero || '').toUpperCase();
                    if (gen === 'H') montoH += monto;
                    else if (gen === 'M' || gen === 'OTROS') montoM += monto;
                    else montoI += monto;
                });
            });
            chartGeneros = new Chart(ctxG, { type: 'bar', data: { labels: ['Hombre', 'Mujer', 'Infantil'], datasets: [{ data: [montoH, montoM, montoI], backgroundColor: ['rgba(99,102,241,0.8)', 'rgba(236,72,153,0.8)', 'rgba(245,158,11,0.8)'], borderRadius: 8 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });

            // Gr√°fica Evoluci√≥n
            const ctxE = document.getElementById('chartEvolucion');
            if (chartEvolucion) chartEvolucion.destroy();
            const labels = [], dataE = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                labels.push(d.toLocaleDateString('es-PE', { day: '2-digit', month: 'short' }));
                dataE.push(ordenes.filter(o => (o.fechaCierre || o.fecha).startsWith(d.toISOString().split('T')[0])).length);
            }
            chartEvolucion = new Chart(ctxE, { type: 'line', data: { labels, datasets: [{ data: dataE, borderColor: 'rgba(99,102,241,1)', backgroundColor: 'rgba(99,102,241,0.1)', tension: 0.4, fill: true }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });

            // Gr√°fica Estados
            const ctxS = document.getElementById('chartEstados');
            if (chartEstados) chartEstados.destroy();
            const estados = {};
            ordenes.forEach(o => { estados[o.estado] = (estados[o.estado] || 0) + 1; });
            const colores = { 'Pendiente Picking': 'rgba(245,158,11,0.8)', 'En Picking': 'rgba(59,130,246,0.8)', 'Pendiente Packing': 'rgba(168,85,247,0.8)', 'Completada': 'rgba(16,185,129,0.8)', 'Expirada': 'rgba(239,68,68,0.8)' };
            chartEstados = new Chart(ctxS, { type: 'doughnut', data: { labels: Object.keys(estados), datasets: [{ data: Object.values(estados), backgroundColor: Object.keys(estados).map(e => colores[e] || 'rgba(100,100,100,0.8)') }] }, options: { responsive: true, maintainAspectRatio: false } });

            // Gr√°fica Tiendas
            const ctxT = document.getElementById('chartTiendas');
            if (chartTiendas) chartTiendas.destroy();
            const unidadesTienda = {};
            TIENDAS.forEach(t => { unidadesTienda[t] = 0; });
            ordenes.filter(o => o.estado === 'Completada' && o.hojaPacking).forEach(o => {
                o.hojaPacking.forEach(f => { TIENDAS.forEach(t => { unidadesTienda[t] += f[t] || 0; }); });
            });
            chartTiendas = new Chart(ctxT, { type: 'bar', data: { labels: TIENDAS.map(t => t.replace('LUKERS ', '')), datasets: [{ data: Object.values(unidadesTienda), backgroundColor: 'rgba(99,102,241,0.8)', borderRadius: 8 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
        }

        function verificarOrdenesProximas() {
            const proximas = ordenes.filter(o => ['Pendiente Picking', 'En Picking', 'Pendiente Packing'].includes(o.estado) && diasTranscurridos(o.fecha) >= DIAS_ALERTA);
            const alerta = document.getElementById('alertaOrdenes');
            if (proximas.length > 0) {
                alerta.style.display = 'flex';
                document.getElementById('alertaOrdenesTexto').textContent = `${proximas.length} orden(es) pr√≥xima(s) a expirar`;
            } else alerta.style.display = 'none';
        }

        // ============================================
        // INVENTARIO
        // ============================================
        function renderizarInventario() {
            const search = document.getElementById('searchInventario')?.value.toLowerCase() || '';
            let filtrado = inventario.filter(i => i.variante.toLowerCase().includes(search) || i.ubicacion.toLowerCase().includes(search));
            document.getElementById('countInventario').textContent = filtrado.length;

            const totalPag = Math.ceil(filtrado.length / ITEMS_POR_PAGINA) || 1;
            const items = filtrado.slice((paginaInv - 1) * ITEMS_POR_PAGINA, paginaInv * ITEMS_POR_PAGINA);

            const tbody = document.getElementById('tablaInventario');
            tbody.innerHTML = items.length === 0 ? '<tr><td colspan="6" class="empty-state">No hay datos</td></tr>' :
                items.map(i => {
                    const disp = (i.stock_fisico || 0) - (i.stock_bloqueado || 0);
                    return `<tr><td><strong>${i.variante}</strong></td><td><span class="badge badge-info">${i.ubicacion}</span></td><td>${i.stock_fisico || 0}</td><td>${i.stock_bloqueado || 0}</td><td><strong style="color:var(--success)">${disp}</strong></td><td><button class="btn btn-danger btn-icon" onclick="eliminarItem('${i.variante}','${i.ubicacion}')"><i data-lucide="trash-2" style="width:14px;height:14px"></i></button></td></tr>`;
                }).join('');

            document.getElementById('paginaInventario').textContent = paginaInv;
            document.getElementById('totalPaginasInventario').textContent = totalPag;
            document.getElementById('prevInventario').disabled = paginaInv === 1;
            document.getElementById('nextInventario').disabled = paginaInv >= totalPag;
            lucide.createIcons();
        }

        function filtrarInventario() { paginaInv = 1; renderizarInventario(); }

        async function guardarItem() {
            const v = document.getElementById('inputVariante').value.trim().toUpperCase();
            const u = document.getElementById('inputUbicacion').value.trim().toUpperCase();
            const s = parseInt(document.getElementById('inputStock').value) || 0;
            if (!v || !u) { toast('Completa los campos', 'error'); return; }
            mostrarLoading('Guardando...');
            const { error } = await supabase.from('inventario').upsert({ variante: v, ubicacion: u, stock_fisico: s, stock_bloqueado: 0 }, { onConflict: 'variante,ubicacion' });
            ocultarLoading();
            if (error) toast('Error: ' + error.message, 'error');
            else { toast('Guardado', 'success'); cerrarModal('modalAgregarItem'); await cargarInventario(); actualizarDashboard(); }
        }

        async function eliminarItem(v, u) {
            if (!confirm(`¬øEliminar ${v} de ${u}?`)) return;
            mostrarLoading('Eliminando...');
            await supabase.from('inventario').delete().eq('variante', v).eq('ubicacion', u);
            ocultarLoading();
            toast('Eliminado', 'success');
            await cargarInventario();
            actualizarDashboard();
        }

        async function procesarInventario() {
            const file = document.getElementById('fileInventario').files[0];
            if (!file) { toast('Selecciona archivo', 'error'); return; }
            mostrarLoading('Procesando...');
            const data = await leerExcel(file);
            const items = data.map(r => ({ variante: String(r.Variante || r.variante || '').trim().toUpperCase(), ubicacion: String(r.Ubicacion || r.ubicacion || '').trim().toUpperCase(), stock_fisico: parseInt(r.StockFisico || r.stock_fisico || 0), stock_bloqueado: 0 })).filter(i => i.variante && i.ubicacion);
            for (let i = 0; i < items.length; i += BATCH_SIZE) {
                await supabase.from('inventario').upsert(items.slice(i, i + BATCH_SIZE), { onConflict: 'variante,ubicacion' });
                actualizarProgreso((i / items.length) * 100);
            }
            ocultarLoading();
            toast(`${items.length} registros procesados`, 'success');
            cerrarModal('modalSubirInventario');
            await cargarInventario();
            actualizarDashboard();
        }

        async function procesarModificarMasivo() {
            const file = document.getElementById('fileModificar').files[0];
            if (!file) { toast('Selecciona archivo', 'error'); return; }
            mostrarLoading('Modificando...');
            const data = await leerExcel(file);
            for (const r of data) {
                const v = String(r.Variante || '').trim().toUpperCase();
                const u = String(r.Ubicacion || '').trim().toUpperCase();
                const s = parseInt(r.StockFisico || 0);
                if (v && u) await supabase.from('inventario').update({ stock_fisico: s }).eq('variante', v).eq('ubicacion', u);
            }
            ocultarLoading();
            toast('Stock actualizado', 'success');
            cerrarModal('modalModificarMasivo');
            await cargarInventario();
        }

        async function procesarEliminarMasivo() {
            const file = document.getElementById('fileEliminar').files[0];
            if (!file) { toast('Selecciona archivo', 'error'); return; }
            if (!confirm('¬øEliminar estos productos?')) return;
            mostrarLoading('Eliminando...');
            const data = await leerExcel(file);
            for (const r of data) {
                const v = String(r.Variante || '').trim().toUpperCase();
                const u = String(r.Ubicacion || '').trim().toUpperCase();
                if (v && u) await supabase.from('inventario').delete().eq('variante', v).eq('ubicacion', u);
            }
            ocultarLoading();
            toast('Eliminados', 'success');
            cerrarModal('modalEliminarMasivo');
            await cargarInventario();
            actualizarDashboard();
        }

        function exportarInventario() {
            if (!inventario.length) { toast('Sin datos', 'warning'); return; }
            const ws = XLSX.utils.json_to_sheet(inventario.map(i => ({ Variante: i.variante, Ubicacion: i.ubicacion, StockFisico: i.stock_fisico, StockBloqueado: i.stock_bloqueado, Disponible: (i.stock_fisico || 0) - (i.stock_bloqueado || 0) })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Inventario');
            XLSX.writeFile(wb, `Inventario_${new Date().toISOString().split('T')[0]}.xlsx`);
            toast('Exportado', 'success');
        }

        // ============================================
        // PRODUCTOS
        // ============================================
        function actualizarFiltros() {
            const generos = [...new Set(productos.map(p => p.genero).filter(Boolean))].sort();
            const lineas = [...new Set(productos.map(p => p.linea).filter(Boolean))].sort();
            const marcas = [...new Set(productos.map(p => p.marca).filter(Boolean))].sort();
            const tallas = [...new Set(productos.map(p => p.talla).filter(Boolean))].sort();
            document.getElementById('filtroGenero').innerHTML = '<option value="">Todos</option>' + generos.map(g => `<option value="${g}">${g}</option>`).join('');
            document.getElementById('filtroLinea').innerHTML = '<option value="">Todas</option>' + lineas.map(l => `<option value="${l}">${l}</option>`).join('');
            document.getElementById('filtroMarca').innerHTML = '<option value="">Todas</option>' + marcas.map(m => `<option value="${m}">${m}</option>`).join('');
            document.getElementById('filtroTalla').innerHTML = '<option value="">Todas</option>' + tallas.map(t => `<option value="${t}">${t}</option>`).join('');
        }

        function renderizarProductos() {
            const search = document.getElementById('searchProductos')?.value.toLowerCase() || '';
            const gen = document.getElementById('filtroGenero')?.value || '';
            const lin = document.getElementById('filtroLinea')?.value || '';
            const mar = document.getElementById('filtroMarca')?.value || '';
            const tal = document.getElementById('filtroTalla')?.value || '';
            let filtrado = productos.filter(p => p.variante.toLowerCase().includes(search) && (!gen || p.genero === gen) && (!lin || p.linea === lin) && (!mar || p.marca === mar) && (!tal || p.talla == tal));

            const totalPag = Math.ceil(filtrado.length / ITEMS_POR_PAGINA) || 1;
            const items = filtrado.slice((paginaProd - 1) * ITEMS_POR_PAGINA, paginaProd * ITEMS_POR_PAGINA);

            document.getElementById('tablaProductos').innerHTML = items.length === 0 ? '<tr><td colspan="7" class="empty-state">No hay productos</td></tr>' :
                items.map(p => `<tr><td><strong>${p.variante}</strong></td><td>${p.genero || '-'}</td><td>${p.linea || '-'}</td><td>${p.marca || '-'}</td><td>${p.talla || '-'}</td><td><strong style="color:var(--primary)">S/ ${parseFloat(p.kardex || 0).toFixed(2)}</strong></td><td><strong style="color:var(--success)">S/ ${parseFloat(p.pvp || 0).toFixed(2)}</strong></td></tr>`).join('');

            document.getElementById('paginaProductos').textContent = paginaProd;
            document.getElementById('totalPaginasProductos').textContent = totalPag;
            document.getElementById('prevProductos').disabled = paginaProd === 1;
            document.getElementById('nextProductos').disabled = paginaProd >= totalPag;
        }

        function filtrarProductos() { paginaProd = 1; renderizarProductos(); }
        function aplicarFiltrosProductos() { paginaProd = 1; renderizarProductos(); }

        async function procesarProductos() {
            const file = document.getElementById('fileProductos').files[0];
            if (!file) { toast('Selecciona archivo', 'error'); return; }
            if (!confirm('Esto reemplazar√° el cat√°logo. ¬øContinuar?')) return;
            mostrarLoading('Procesando cat√°logo...');
            await supabase.from('productos_system').delete().neq('variante', '');
            const data = await leerExcel(file);
            const items = data.map(r => ({ variante: String(r.variante || r.Variante || '').trim().toUpperCase(), kardex: parseFloat(r.kardex || r.Kardex || 0), pvp: parseFloat(r.pvp || r.PVP || 0), genero: String(r.genero || r.Genero || '').trim(), linea: String(r.linea || r.Linea || '').trim(), marca: String(r.marca || r.Marca || '').trim(), talla: String(r.talla || r.Talla || '').trim() })).filter(i => i.variante);
            for (let i = 0; i < items.length; i += BATCH_SIZE) {
                await supabase.from('productos_system').insert(items.slice(i, i + BATCH_SIZE));
                actualizarProgreso((i / items.length) * 100);
            }
            ocultarLoading();
            toast(`${items.length} productos cargados`, 'success');
            cerrarModal('modalSubirProductos');
            await cargarProductos();
            actualizarDashboard();
        }

        function exportarProductos() {
            if (!productos.length) { toast('Sin productos', 'warning'); return; }
            const ws = XLSX.utils.json_to_sheet(productos);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Productos');
            XLSX.writeFile(wb, `Productos_${new Date().toISOString().split('T')[0]}.xlsx`);
            toast('Exportado', 'success');
        }

        // ============================================
        // √ìRDENES
        // ============================================
        function renderizarOrdenes() {
            const tbody = document.getElementById('tablaOrdenes');
            tbody.innerHTML = ordenes.length === 0 ? '<tr><td colspan="7" class="empty-state">No hay √≥rdenes</td></tr>' :
                ordenes.map(o => {
                    const dias = diasTranscurridos(o.fecha);
                    const badge = getBadge(o.estado);
                    const diasBadge = dias > DIAS_EXPIRACION ? 'badge-danger' : dias > DIAS_ALERTA ? 'badge-warning' : 'badge-success';
                    return `<tr><td><strong>${o.id}</strong></td><td>${formatFecha(o.fecha)}</td><td>${o.items?.length || 0}</td><td>${calcUnidades(o)}</td><td><span class="badge ${diasBadge}">${dias} d√≠as</span></td><td>${badge}</td><td>
                        <button class="btn btn-outline btn-icon" onclick="verOrden('${o.id}')"><i data-lucide="eye" style="width:14px;height:14px"></i></button>
                        ${['Pendiente Picking', 'Expirada'].includes(o.estado) ? `<button class="btn btn-danger btn-icon" onclick="eliminarOrden('${o.id}')"><i data-lucide="trash-2" style="width:14px;height:14px"></i></button>` : ''}
                    </td></tr>`;
                }).join('');
            lucide.createIcons();
        }

        function renderizarPicking() {
            const items = ordenes.filter(o => ['Pendiente Picking', 'En Picking'].includes(o.estado));
            document.getElementById('tablaPicking').innerHTML = items.length === 0 ? '<tr><td colspan="6" class="empty-state">No hay √≥rdenes en picking</td></tr>' :
                items.map(o => `<tr><td><strong>${o.id}</strong></td><td>${formatFecha(o.fecha)}</td><td>${o.items?.length || 0}</td><td>${calcUnidades(o)}</td><td>${getBadge(o.estado)}</td><td>
                    <button class="btn btn-info" onclick="descargarHojaPicking('${o.id}')"><i data-lucide="download" style="width:14px;height:14px"></i> Hoja</button>
                    ${o.estado === 'Pendiente Picking' ? `<button class="btn btn-success" onclick="iniciarPicking('${o.id}')">Iniciar</button>` : `<button class="btn btn-warning" onclick="abrirSubirCantidades('${o.id}')">Subir Cant.</button>`}
                </td></tr>`).join('');
            lucide.createIcons();
        }

        function renderizarPacking() {
            const items = ordenes.filter(o => o.estado === 'Pendiente Packing');
            document.getElementById('tablaPacking').innerHTML = items.length === 0 ? '<tr><td colspan="6" class="empty-state">No hay √≥rdenes en packing</td></tr>' :
                items.map(o => {
                    const enc = Object.values(o.cantidadesEncontradas || {}).reduce((a, b) => a + b, 0);
                    return `<tr><td><strong>${o.id}</strong></td><td>${formatFecha(o.fecha)}</td><td>${Object.keys(o.cantidadesEncontradas || {}).length}</td><td>${enc}</td><td>${getBadge(o.estado)}</td><td>
                        <button class="btn btn-info" onclick="descargarHojaPacking('${o.id}')"><i data-lucide="download" style="width:14px;height:14px"></i> Sugerida</button>
                        <button class="btn btn-success" onclick="abrirSubirPacking('${o.id}')">Subir Real</button>
                    </td></tr>`;
                }).join('');
            lucide.createIcons();
        }

        async function procesarOrden() {
            const file = document.getElementById('fileOrden').files[0];
            if (!file) { toast('Selecciona archivo', 'error'); return; }
            mostrarLoading('Creando orden...');
            const data = await leerExcel(file);
            const items = [];
            data.forEach(r => {
                const v = String(r.Variante || '').trim().toUpperCase();
                const u = String(r.Ubicacion || '').trim().toUpperCase();
                if (!v || !u) return;
                let cant = 0;
                const dist = {};
                TIENDAS.forEach(t => { const c = parseInt(r[t]) || 0; dist[t] = c; cant += c; });
                if (cant > 0) items.push({ variante: v, ubicacion: u, cantidad: cant, distribucion: dist });
            });

            // Validar stock
            for (const item of items) {
                const inv = inventario.find(i => i.variante === item.variante && i.ubicacion === item.ubicacion);
                const disp = inv ? (inv.stock_fisico || 0) - (inv.stock_bloqueado || 0) : 0;
                if (disp < item.cantidad) {
                    ocultarLoading();
                    toast(`Stock insuficiente: ${item.variante} en ${item.ubicacion}`, 'error');
                    return;
                }
            }

            // Bloquear stock
            for (const item of items) {
                const inv = inventario.find(i => i.variante === item.variante && i.ubicacion === item.ubicacion);
                if (inv) await supabase.from('inventario').update({ stock_bloqueado: (inv.stock_bloqueado || 0) + item.cantidad }).eq('variante', item.variante).eq('ubicacion', item.ubicacion);
            }

            const orden = { id: 'ORD-' + Date.now().toString(36).toUpperCase(), fecha: new Date().toISOString(), estado: 'Pendiente Picking', items, cantidadesEncontradas: {}, hojaPacking: [], prendasRechazadas: 0 };
            await supabase.from('ordenes').insert(orden);
            ocultarLoading();
            toast('Orden creada', 'success');
            cerrarModal('modalCrearOrden');
            await cargarOrdenes();
            await cargarInventario();
            actualizarDashboard();
        }

        function verOrden(id) {
            const o = ordenes.find(x => x.id === id);
            if (!o) return;
            document.getElementById('ordenDetalleId').textContent = o.id;
            let html = `<div class="form-row" style="margin-bottom:1rem"><div><label style="font-size:0.75rem;color:var(--text-secondary)">Fecha</label><div style="font-weight:600">${formatFecha(o.fecha)}</div></div><div><label style="font-size:0.75rem;color:var(--text-secondary)">Estado</label><div>${getBadge(o.estado)}</div></div><div><label style="font-size:0.75rem;color:var(--text-secondary)">D√≠as</label><div style="font-weight:600">${diasTranscurridos(o.fecha)}</div></div></div>`;
            html += '<h4 style="margin:1rem 0 0.5rem">Productos</h4><table><thead><tr><th>Variante</th><th>Ubicaci√≥n</th><th>Solicitado</th><th>Encontrado</th></tr></thead><tbody>';
            o.items?.forEach(i => {
                const key = `${i.variante}|${i.ubicacion}`;
                html += `<tr><td>${i.variante}</td><td><span class="badge badge-info">${i.ubicacion}</span></td><td>${i.cantidad}</td><td>${o.cantidadesEncontradas[key] || '-'}</td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('ordenDetalleContenido').innerHTML = html;
            abrirModal('modalVerOrden');
        }

        async function eliminarOrden(id) {
            if (!confirm('¬øEliminar orden y liberar stock?')) return;
            mostrarLoading('Eliminando...');
            const o = ordenes.find(x => x.id === id);
            if (o?.items) {
                for (const item of o.items) {
                    const inv = inventario.find(i => i.variante === item.variante && i.ubicacion === item.ubicacion);
                    if (inv) await supabase.from('inventario').update({ stock_bloqueado: Math.max(0, (inv.stock_bloqueado || 0) - item.cantidad) }).eq('variante', item.variante).eq('ubicacion', item.ubicacion);
                }
            }
            await supabase.from('ordenes').delete().eq('id', id);
            ocultarLoading();
            toast('Orden eliminada', 'success');
            await cargarOrdenes();
            await cargarInventario();
            actualizarDashboard();
        }

        // ============================================
        // PICKING
        // ============================================
        async function iniciarPicking(id) {
            await supabase.from('ordenes').update({ estado: 'En Picking' }).eq('id', id);
            toast('Picking iniciado', 'success');
            await cargarOrdenes();
        }

        function descargarHojaPicking(id) {
            const o = ordenes.find(x => x.id === id);
            if (!o) return;
            const data = o.items.map(i => {
                const row = { Variante: i.variante, Ubicacion: i.ubicacion, Solicitado: i.cantidad, Encontrado: '' };
                TIENDAS.forEach(t => { row[t] = i.distribucion?.[t] || 0; });
                return row;
            });
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'HojaRuta');
            XLSX.writeFile(wb, `HojaPicking_${id}.xlsx`);
            toast('Descargado', 'success');
        }

        function abrirSubirCantidades(id) {
            ordenActualPicking = id;
            abrirModal('modalSubirCantidades');
        }

        async function confirmarSubirCantidades() {
            const file = document.getElementById('fileCantidades').files[0];
            if (!file) { toast('Selecciona archivo', 'error'); return; }
            mostrarLoading('Procesando...');
            const data = await leerExcel(file);
            const o = ordenes.find(x => x.id === ordenActualPicking);
            if (!o) { ocultarLoading(); return; }

            const cantidades = {};
            data.forEach(r => {
                const v = String(r.Variante || '').trim().toUpperCase();
                const u = String(r.Ubicacion || '').trim().toUpperCase();
                const e = parseInt(r.Encontrado || 0);
                if (v && u) cantidades[`${v}|${u}`] = e;
            });

            // Generar hoja packing sugerida
            const hojaPacking = o.items.map(i => {
                const key = `${i.variante}|${i.ubicacion}`;
                const enc = cantidades[key] || 0;
                const factor = i.cantidad > 0 ? enc / i.cantidad : 0;
                const dist = {};
                TIENDAS.forEach(t => { dist[t] = Math.floor((i.distribucion?.[t] || 0) * factor); });
                const prod = productos.find(p => p.variante === i.variante);
                return { variante: i.variante, ubicacion: i.ubicacion, kardex: prod?.kardex || 0, encontrado: enc, ...dist };
            });

            await supabase.from('ordenes').update({ cantidadesEncontradas: cantidades, hojaPacking, estado: 'Pendiente Packing' }).eq('id', ordenActualPicking);
            ocultarLoading();
            toast('Cantidades procesadas', 'success');
            cerrarModal('modalSubirCantidades');
            await cargarOrdenes();
        }

        // ============================================
        // PACKING
        // ============================================
        function descargarHojaPacking(id) {
            const o = ordenes.find(x => x.id === id);
            if (!o?.hojaPacking) return;
            const data = o.hojaPacking.map(f => {
                const row = { Variante: f.variante, Ubicacion: f.ubicacion, Kardex: f.kardex, Encontrado: f.encontrado };
                TIENDAS.forEach(t => { row[t] = f[t] || 0; });
                return row;
            });
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'PackingSugerido');
            XLSX.writeFile(wb, `HojaPacking_${id}.xlsx`);
            toast('Descargado', 'success');
        }

        function abrirSubirPacking(id) {
            ordenActualPacking = ordenes.find(x => x.id === id);
            abrirModal('modalSubirPacking');
        }

        async function confirmarSubirPacking() {
            const file = document.getElementById('filePackingReal').files[0];
            if (!file) { toast('Selecciona archivo', 'error'); return; }
            mostrarLoading('Procesando...');
            const data = await leerExcel(file);
            const o = ordenActualPacking;
            if (!o) { ocultarLoading(); return; }

            const empaquetadas = new Set();
            const hojaFinal = [];
            data.forEach(r => {
                const v = String(r.Variante || '').trim().toUpperCase();
                const u = String(r.Ubicacion || '').trim().toUpperCase();
                if (!v || !u) return;
                empaquetadas.add(v);
                let total = 0;
                const dist = {};
                TIENDAS.forEach(t => { const c = parseInt(r[t]) || 0; dist[t] = c; total += c; });
                const prod = productos.find(p => p.variante === v);
                hojaFinal.push({ variante: v, ubicacion: u, kardex: prod?.kardex || 0, encontrado: total, ...dist });
            });

            // Detectar no empaquetadas
            variantesNoEmpaquetadas = [];
            o.items.forEach(i => {
                const key = `${i.variante}|${i.ubicacion}`;
                const enc = o.cantidadesEncontradas[key] || 0;
                if (enc > 0 && !empaquetadas.has(i.variante)) {
                    variantesNoEmpaquetadas.push({ variante: i.variante, ubicacion: i.ubicacion, cantidad: enc });
                }
            });

            o.hojaPacking = hojaFinal;
            ocultarLoading();

            if (variantesNoEmpaquetadas.length > 0) {
                cerrarModal('modalSubirPacking');
                indiceReclas = 0;
                toast(`${variantesNoEmpaquetadas.length} producto(s) requieren reclasificaci√≥n`, 'warning');
                mostrarReclasificacion();
            } else {
                await cerrarOrden(o);
                cerrarModal('modalSubirPacking');
            }
        }

        async function cerrarOrden(o) {
            mostrarLoading('Cerrando orden...');
            // Desbloquear y descontar stock
            for (const i of o.items) {
                const key = `${i.variante}|${i.ubicacion}`;
                const enc = o.cantidadesEncontradas[key] || 0;
                const inv = inventario.find(x => x.variante === i.variante && x.ubicacion === i.ubicacion);
                if (inv) {
                    await supabase.from('inventario').update({
                        stock_fisico: Math.max(0, (inv.stock_fisico || 0) - enc),
                        stock_bloqueado: Math.max(0, (inv.stock_bloqueado || 0) - i.cantidad)
                    }).eq('variante', i.variante).eq('ubicacion', i.ubicacion);
                }
            }
            await supabase.from('ordenes').update({ estado: 'Completada', fechaCierre: new Date().toISOString(), hojaPacking: o.hojaPacking, prendasRechazadas: o.prendasRechazadas || 0 }).eq('id', o.id);
            ocultarLoading();
            toast('Orden completada', 'success');
            await cargarOrdenes();
            await cargarInventario();
            actualizarDashboard();
        }

        // ============================================
        // RECLASIFICACI√ìN
        // ============================================
        function renderizarReclasificacion() {
            const search = document.getElementById('searchReclasificacion')?.value.toLowerCase() || '';
            let filtrado = reclasificacion.filter(r => r.varianteOriginal.toLowerCase().includes(search) || (r.nuevaVariante || '').toLowerCase().includes(search));
            document.getElementById('tablaReclasificacion').innerHTML = filtrado.length === 0 ? '<tr><td colspan="8" class="empty-state">No hay reclasificaciones</td></tr>' :
                filtrado.map(r => {
                    const motivos = { mal_estado: 'Mal Estado', no_corresponde_linea: 'No Corresponde L√≠nea', no_corresponde_genero: 'No Corresponde G√©nero', no_corresponde_talla: 'No Corresponde Talla' };
                    return `<tr><td>#${r.id}</td><td>${r.varianteOriginal}</td><td>${r.nuevaVariante || '-'}</td><td><span class="badge badge-info">${r.ubicacion}</span></td><td>${r.cantidad}</td><td><span class="badge badge-purple">${motivos[r.motivo] || r.motivo}</span></td><td>${r.estado === 'Completada' ? '<span class="badge badge-success">Completada</span>' : '<span class="badge badge-warning">Pendiente</span>'}</td><td>${r.estado === 'Pendiente' ? `<button class="btn btn-success btn-icon" onclick="abrirCompletarReclas(${r.id})"><i data-lucide="check" style="width:14px;height:14px"></i></button>` : ''}</td></tr>`;
                }).join('');
            lucide.createIcons();
        }

        function filtrarReclasificacion() { renderizarReclasificacion(); }

        function mostrarReclasificacion() {
            if (indiceReclas >= variantesNoEmpaquetadas.length) {
                cerrarOrden(ordenActualPacking);
                return;
            }
            const item = variantesNoEmpaquetadas[indiceReclas];
            document.getElementById('reclasVariante').value = item.variante;
            document.getElementById('reclasUbicacion').value = item.ubicacion;
            document.getElementById('reclasCantidad').value = item.cantidad;
            document.getElementById('reclasMotivo').value = '';
            document.getElementById('reclasNuevaVariante').value = '';
            document.getElementById('reclasComentario').value = '';
            document.getElementById('grupoNuevaVariante').style.display = 'none';
            document.getElementById('grupoMalEstado').style.display = 'none';
            document.getElementById('progresoReclas').textContent = `${indiceReclas + 1}/${variantesNoEmpaquetadas.length}`;
            document.getElementById('btnReclasTexto').textContent = indiceReclas === variantesNoEmpaquetadas.length - 1 ? 'Finalizar' : 'Siguiente';
            abrirModal('modalReclasificacion');
        }

        function toggleNuevaVariante() {
            const m = document.getElementById('reclasMotivo').value;
            document.getElementById('grupoNuevaVariante').style.display = m && m !== 'mal_estado' ? 'block' : 'none';
            document.getElementById('grupoMalEstado').style.display = m === 'mal_estado' ? 'flex' : 'none';
        }

        async function procesarReclasificacionItem() {
            const motivo = document.getElementById('reclasMotivo').value;
            const comentario = document.getElementById('reclasComentario').value.trim();
            if (!motivo || !comentario) { toast('Completa los campos', 'error'); return; }

            const item = variantesNoEmpaquetadas[indiceReclas];
            let nuevaVar = item.variante, nuevaUbi = '191';
            if (motivo !== 'mal_estado') {
                nuevaVar = document.getElementById('reclasNuevaVariante').value.trim().toUpperCase();
                if (!nuevaVar) { toast('Ingresa la nueva variante', 'error'); return; }
                nuevaUbi = '999-PENDIENTE';
            }

            mostrarLoading('Procesando...');
            await supabase.from('inventario').upsert({ variante: nuevaVar, ubicacion: nuevaUbi, stock_fisico: item.cantidad, stock_bloqueado: 0 }, { onConflict: 'variante,ubicacion' });
            await supabase.from('reclasificacion').insert({ varianteOriginal: item.variante, nuevaVariante: nuevaVar, ubicacion: nuevaUbi, cantidad: item.cantidad, motivo, comentario, estado: 'Pendiente', fecha: new Date().toISOString(), ordenId: ordenActualPacking.id });

            const inv = inventario.find(i => i.variante === item.variante && i.ubicacion === item.ubicacion);
            if (inv) await supabase.from('inventario').update({ stock_fisico: Math.max(0, (inv.stock_fisico || 0) - item.cantidad) }).eq('variante', item.variante).eq('ubicacion', item.ubicacion);

            ordenActualPacking.prendasRechazadas = (ordenActualPacking.prendasRechazadas || 0) + item.cantidad;
            ocultarLoading();
            indiceReclas++;
            cerrarModal('modalReclasificacion');
            setTimeout(mostrarReclasificacion, 300);
        }

        function cancelarReclasificacion() {
            if (!confirm('¬øCancelar? La orden NO se cerrar√°.')) return;
            cerrarModal('modalReclasificacion');
            variantesNoEmpaquetadas = [];
            toast('Reclasificaci√≥n cancelada', 'info');
        }

        function abrirCompletarReclas(id) {
            reclasActual = reclasificacion.find(r => r.id === id);
            if (!reclasActual) return;
            document.getElementById('infoCompletarReclas').innerHTML = `<div style="background:var(--bg-hover);padding:1rem;border-radius:10px"><div class="form-row"><div><label style="font-size:0.75rem;color:var(--text-secondary)">Variante</label><div style="font-weight:600">${reclasActual.nuevaVariante}</div></div><div><label style="font-size:0.75rem;color:var(--text-secondary)">Cantidad</label><div style="font-weight:600">${reclasActual.cantidad}</div></div><div><label style="font-size:0.75rem;color:var(--text-secondary)">Ubicaci√≥n Actual</label><div><span class="badge badge-warning">${reclasActual.ubicacion}</span></div></div></div></div>`;
            document.getElementById('ubicacionFinalReclas').value = '';
            abrirModal('modalCompletarReclas');
        }

        async function confirmarCompletarReclas() {
            const ubi = document.getElementById('ubicacionFinalReclas').value.trim().toUpperCase();
            if (!ubi) { toast('Ingresa ubicaci√≥n', 'error'); return; }
            mostrarLoading('Completando...');
            await supabase.from('inventario').delete().eq('variante', reclasActual.nuevaVariante).eq('ubicacion', reclasActual.ubicacion);
            const inv = inventario.find(i => i.variante === reclasActual.nuevaVariante && i.ubicacion === ubi);
            if (inv) await supabase.from('inventario').update({ stock_fisico: (inv.stock_fisico || 0) + reclasActual.cantidad }).eq('variante', reclasActual.nuevaVariante).eq('ubicacion', ubi);
            else await supabase.from('inventario').insert({ variante: reclasActual.nuevaVariante, ubicacion: ubi, stock_fisico: reclasActual.cantidad, stock_bloqueado: 0 });
            await supabase.from('reclasificacion').update({ estado: 'Completada', ubicacion: ubi, fechaCompletado: new Date().toISOString() }).eq('id', reclasActual.id);
            ocultarLoading();
            toast('Reclasificaci√≥n completada', 'success');
            cerrarModal('modalCompletarReclas');
            await cargarReclasificacion();
            await cargarInventario();
        }

        // ============================================
        // UTILIDADES
        // ============================================
        function diasTranscurridos(fecha) { return Math.floor((new Date() - new Date(fecha)) / 86400000); }
        function formatFecha(iso) { return new Date(iso).toLocaleDateString('es-PE'); }
        function calcUnidades(o) { return o.items?.reduce((s, i) => s + (i.cantidad || 0), 0) || 0; }
        function getBadge(estado) {
            const badges = { 'Pendiente Picking': 'badge-warning', 'En Picking': 'badge-info', 'Pendiente Packing': 'badge-purple', 'Completada': 'badge-success', 'Expirada': 'badge-danger' };
            return `<span class="badge ${badges[estado] || 'badge-primary'}">${estado}</span>`;
        }

        function cambiarPagina(tipo, dir) {
            if (tipo === 'inventario') { paginaInv += dir; renderizarInventario(); }
            else if (tipo === 'productos') { paginaProd += dir; renderizarProductos(); }
        }

        async function leerExcel(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
                    resolve(XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]));
                };
                reader.readAsArrayBuffer(file);
            });
        }

        // ============================================
        // NAVEGACI√ìN
        // ============================================
        function cambiarVista(nombre) {
            document.querySelectorAll('.vista').forEach(v => v.classList.remove('active'));
            document.getElementById(`vista-${nombre}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => { n.classList.remove('active'); if (n.dataset.vista === nombre) n.classList.add('active'); });
            const titulos = { dashboard: 'Dashboard', inventario: 'Inventario', productos: 'Productos System', ordenes: '√ìrdenes', picking: 'Picking', packing: 'Packing', reclasificacion: 'Reclasificaci√≥n' };
            document.getElementById('headerTitle').textContent = titulos[nombre] || 'Sistema';
            document.getElementById('headerBreadcrumb').textContent = titulos[nombre] || 'Sistema';
            lucide.createIcons();
        }

        document.querySelectorAll('.nav-item').forEach(i => i.addEventListener('click', () => { if (i.dataset.vista) cambiarVista(i.dataset.vista); }));

        // ============================================
        // MODALES & UI
        // ============================================
        function abrirModal(id) { document.getElementById(id).classList.add('active'); lucide.createIcons(); }
        function cerrarModal(id) { document.getElementById(id).classList.remove('active'); }
        document.querySelectorAll('.modal').forEach(m => m.addEventListener('click', e => { if (e.target === m) cerrarModal(m.id); }));

        function toggleDropdown(id) { document.getElementById(id).classList.toggle('active'); }
        document.addEventListener('click', e => { if (!e.target.closest('.dropdown')) document.querySelectorAll('.dropdown-menu').forEach(d => d.classList.remove('active')); });

        function mostrarLoading(texto, sub = '') {
            document.getElementById('loadingText').textContent = texto;
            document.getElementById('loadingSubtext').textContent = sub;
            document.getElementById('loadingOverlay').classList.add('active');
        }
        function ocultarLoading() { document.getElementById('loadingOverlay').classList.remove('active'); document.getElementById('progressFill').style.width = '0%'; }
        function actualizarProgreso(p) { document.getElementById('progressFill').style.width = p + '%'; }

        function toast(msg, tipo = 'info') {
            const div = document.createElement('div');
            div.className = `toast ${tipo}`;
            div.innerHTML = msg;
            document.getElementById('toastContainer').appendChild(div);
            setTimeout(() => div.remove(), 4000);
        }

        // ============================================
        // INIT
        // ============================================
        window.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            await verificarSesion();
            document.getElementById('loginPassword')?.addEventListener('keypress', e => { if (e.key === 'Enter') iniciarSesion(); });
        });

        console.log('‚úÖ MAWI v6.0 COMPLETO - Sistema Lukers');
    </script>
</body>
</html>
