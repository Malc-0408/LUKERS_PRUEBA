<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAWI v6.0 - Sistema Lukers</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- SheetJS -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --purple: #a855f7;
            
            --bg-main: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #ffffff;
            --bg-hover: #f1f5f9;
            
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --text-light: #94a3b8;
            --text-white: #ffffff;
            
            --border: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-primary);
        }

        .app-container {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* SIDEBAR */
        .sidebar {
            width: 280px;
            background: var(--bg-main);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: linear-gradient(180deg, rgba(99, 102, 241, 0.1) 0%, transparent 100%);
            pointer-events: none;
        }

        .sidebar-header {
            padding: 2rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 1;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 1.25rem;
        }

        .logo-text {
            display: flex;
            flex-direction: column;
        }

        .logo-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-white);
            letter-spacing: -0.02em;
        }

        .logo-subtitle {
            font-size: 0.75rem;
            color: var(--text-light);
            font-weight: 500;
        }

        .nav-menu {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            position: relative;
            z-index: 1;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-section-title {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-light);
            padding: 0 1rem;
            margin-bottom: 0.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            margin-bottom: 0.25rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
            position: relative;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-white);
            transform: translateX(4px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            color: var(--text-white);
            box-shadow: 0 8px 16px -4px rgba(99, 102, 241, 0.4);
        }

        .nav-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 20px;
            background: white;
            border-radius: 0 4px 4px 0;
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            stroke-width: 2;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--danger);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.15rem 0.5rem;
            border-radius: 12px;
            min-width: 20px;
            text-align: center;
        }

        .user-profile {
            padding: 1rem 1.5rem;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 1;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .user-info:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1rem;
        }

        .user-details {
            flex: 1;
        }

        .user-name {
            font-weight: 600;
            color: var(--text-white);
            font-size: 0.875rem;
            margin-bottom: 0.15rem;
        }

        .user-role {
            font-size: 0.75rem;
            color: var(--text-light);
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: #f8fafc;
        }

        .header {
            background: white;
            padding: 1.25rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--shadow-sm);
            border-bottom: 1px solid var(--border);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .header-breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .search-box {
            position: relative;
            width: 320px;
        }

        .search-input {
            width: 100%;
            padding: 0.625rem 1rem 0.625rem 2.5rem;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 0.875rem;
            transition: all 0.2s;
            background: var(--bg-hover);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 0.875rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            width: 18px;
            height: 18px;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        .icon-button {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            border: none;
            background: var(--bg-hover);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .icon-button:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        .icon-button .notification-dot {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: var(--danger);
            border-radius: 50%;
            border: 2px solid white;
        }

        .sync-button {
            padding: 0.625rem 1.25rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .sync-button:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 16px -4px rgba(99, 102, 241, 0.4);
        }

        .content-area {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
        }

        .vista {
            display: none;
        }

        .vista.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* STATS CARDS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: var(--shadow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.1) 0%, transparent 70%);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-icon.blue { background: rgba(99, 102, 241, 0.1); color: var(--primary); }
        .stat-icon.green { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .stat-icon.orange { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .stat-icon.red { background: rgba(239, 68, 68, 0.1); color: var(--danger); }

        .stat-value {
            font-size: 2.25rem;
            font-weight: 800;
            color: var(--text-primary);
            line-height: 1;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .stat-footer {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
        }

        .stat-footer-label {
            color: var(--text-secondary);
        }

        .stat-footer-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* KPI CARDS */
        .kpi-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 2rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
        }

        .kpi-title {
            color: white;
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .kpi-item {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 1.25rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .kpi-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .kpi-value {
            color: white;
            font-size: 1.75rem;
            font-weight: 800;
            display: flex;
            align-items: baseline;
            gap: 0.25rem;
        }

        .kpi-unit {
            font-size: 0.875rem;
            font-weight: 600;
            opacity: 0.8;
        }

        /* CHARTS */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: white;
            padding: 1.5rem;
            border-radius: 16px;
            box-shadow: var(--shadow);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .chart-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .chart-wrapper {
            height: 300px;
            position: relative;
        }

        /* CARDS */
        .card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        /* BUTTONS */
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            text-decoration: none;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 16px -4px rgba(99, 102, 241, 0.4);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-2px);
        }

        .btn-outline {
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-outline:hover {
            background: var(--primary);
            color: white;
        }

        .btn-icon {
            width: 36px;
            height: 36px;
            padding: 0;
            justify-content: center;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* BADGES */
        .badge {
            padding: 0.375rem 0.75rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .badge-primary { background: rgba(99, 102, 241, 0.1); color: var(--primary); }
        .badge-success { background: rgba(16, 185, 129, 0.1); color: var(--success); }
        .badge-warning { background: rgba(245, 158, 11, 0.1); color: var(--warning); }
        .badge-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); }
        .badge-info { background: rgba(59, 130, 246, 0.1); color: var(--info); }
        .badge-purple { background: rgba(168, 85, 247, 0.1); color: var(--purple); }

        /* TABLE */
        .table-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .table-header-controls {
            padding: 1rem 1.5rem;
            background: var(--bg-hover);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table thead {
            background: var(--bg-hover);
        }

        .table th {
            padding: 1rem 1.5rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            border-bottom: 2px solid var(--border);
        }

        .table td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }

        .table tbody tr {
            transition: all 0.2s;
        }

        .table tbody tr:hover {
            background: var(--bg-hover);
        }

        /* PAGINATION */
        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem;
        }

        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            background: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .pagination button:hover:not(:disabled) {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination span {
            padding: 0.5rem 1rem;
            font-weight: 500;
        }

        /* ALERTS */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: start;
            gap: 1rem;
            border-left: 4px solid;
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--warning);
            color: #92400e;
        }

        .alert-danger {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--danger);
            color: #991b1b;
        }

        .alert-info {
            background: rgba(59, 130, 246, 0.1);
            border-color: var(--info);
            color: #1e3a8a;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--success);
            color: #065f46;
        }

        .alert-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        /* DROPDOWN */
        .dropdown-container {
            position: relative;
            display: inline-block;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 0.5rem;
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            min-width: 200px;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s;
        }

        .dropdown-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: background 0.2s;
            border-bottom: 1px solid var(--border);
        }

        .dropdown-item:first-child {
            border-radius: 12px 12px 0 0;
        }

        .dropdown-item:last-child {
            border-bottom: none;
            border-radius: 0 0 12px 12px;
        }

        .dropdown-item:hover {
            background: var(--bg-hover);
        }

        /* MODALS */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.2s ease-out;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-content.large {
            max-width: 900px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background: var(--bg-hover);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--danger);
            color: white;
        }

        .modal-body {
            margin-bottom: 1.5rem;
        }

        .modal-footer {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            padding-top: 1rem;
            border-top: 1px solid var(--border);
        }

        /* FORM CONTROLS */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .form-label.required::after {
            content: '*';
            color: var(--danger);
            margin-left: 0.25rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 0.875rem;
            font-family: inherit;
            transition: all 0.2s;
            background: white;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-file {
            display: none;
        }

        .file-upload-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--bg-hover);
            border: 2px dashed var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .file-upload-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .form-help {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 0.5rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        /* LOADING */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .loading-subtext {
            font-size: 0.875rem;
            opacity: 0.8;
        }

        .progress-bar {
            width: 250px;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin: 1rem auto 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-light));
            width: 0%;
            transition: width 0.3s;
        }

        /* TOAST */
        .toast-container {
            position: fixed;
            top: 2rem;
            right: 2rem;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .toast {
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-xl);
            display: flex;
            align-items: center;
            gap: 1rem;
            min-width: 300px;
            animation: slideInRight 0.3s ease-out;
            border-left: 4px solid;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--danger); }
        .toast.warning { border-color: var(--warning); }
        .toast.info { border-color: var(--info); }

        .toast-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        .toast-icon.success { color: var(--success); }
        .toast-icon.error { color: var(--danger); }
        .toast-icon.warning { color: var(--warning); }
        .toast-icon.info { color: var(--info); }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }

        .toast-message {
            font-size: 0.8125rem;
            color: var(--text-secondary);
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-hover);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--text-light);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        /* LOGIN PAGE */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .login-card {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: var(--shadow-xl);
            max-width: 450px;
            width: 100%;
        }

        .login-logo {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-logo-icon {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);
            border-radius: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .login-title {
            font-size: 2rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* RESPONSIVE */
        @media (max-width: 1024px) {
            .sidebar {
                width: 240px;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
            }

            .search-box {
                width: 100%;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .kpi-grid {
                grid-template-columns: 1fr;
            }
        }

        /* UTILITY CLASSES */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .flex { display: flex; }
        .flex-between { justify-content: space-between; }
        .flex-center { align-items: center; }
        .gap-1 { gap: 0.5rem; }
        .gap-2 { gap: 1rem; }
    </style>
</head>
<body>
    <!-- LOGIN PAGE -->
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <div class="login-logo">
                <div class="login-logo-icon">M</div>
                <h1 class="login-title">MAWI v6.0</h1>
                <p class="login-subtitle">Sistema de Gesti√≥n Lukers</p>
            </div>

            <form id="loginForm" onsubmit="return false;">
                <div class="form-group">
                    <label class="form-label required">Email</label>
                    <input type="email" id="loginEmail" class="form-input" placeholder="correo@ejemplo.com" required>
                </div>

                <div class="form-group">
                    <label class="form-label required">Contrase√±a</label>
                    <input type="password" id="loginPassword" class="form-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>

                <button type="button" onclick="iniciarSesion()" class="btn btn-primary" style="width: 100%; justify-content: center; margin-top: 1.5rem;">
                    <i data-lucide="log-in" style="width: 18px; height: 18px;"></i>
                    Iniciar Sesi√≥n
                </button>
            </form>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="mainApp" class="app-container" style="display: none;">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="logo-container">
                    <div class="logo-icon">M</div>
                    <div class="logo-text">
                        <div class="logo-title">MAWI</div>
                        <div class="logo-subtitle">v6.0 Sistema Lukers</div>
                    </div>
                </div>
            </div>

            <nav class="nav-menu">
                <div class="nav-section">
                    <div class="nav-section-title">Principal</div>
                    <div class="nav-item active" data-vista="dashboard">
                        <i data-lucide="layout-dashboard" class="nav-icon"></i>
                        <span>Dashboard</span>
                    </div>
                    <div class="nav-item" data-vista="inventario">
                        <i data-lucide="package" class="nav-icon"></i>
                        <span>Inventario</span>
                    </div>
                    <div class="nav-item" data-vista="productos-system">
                        <i data-lucide="database" class="nav-icon"></i>
                        <span>Productos System</span>
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Operaciones</div>
                    <div class="nav-item" data-vista="ordenes">
                        <i data-lucide="shopping-cart" class="nav-icon"></i>
                        <span>√ìrdenes</span>
                        <span class="nav-badge" id="badgeOrdenes">0</span>
                    </div>
                    <div class="nav-item" data-vista="picking">
                        <i data-lucide="scan" class="nav-icon"></i>
                        <span>Picking</span>
                    </div>
                    <div class="nav-item" data-vista="packing">
                        <i data-lucide="box" class="nav-icon"></i>
                        <span>Packing</span>
                    </div>
                    <div class="nav-item" data-vista="reclasificacion">
                        <i data-lucide="repeat" class="nav-icon"></i>
                        <span>Reclasificaci√≥n</span>
                    </div>
                </div>
            </nav>

            <div class="user-profile">
                <div class="user-info" onclick="toggleUserMenu()">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Usuario</div>
                        <div class="user-role">Supervisor</div>
                    </div>
                    <i data-lucide="chevron-down" style="width: 16px; height: 16px; color: var(--text-light);"></i>
                </div>
                
                <div class="dropdown-menu" id="userMenu">
                    <div class="dropdown-item" onclick="cerrarSesion()">
                        <i data-lucide="log-out" style="width: 18px; height: 18px; color: var(--danger);"></i>
                        <span style="color: var(--danger);">Cerrar Sesi√≥n</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <!-- HEADER -->
            <header class="header">
                <div class="header-left">
                    <div>
                        <div class="header-title" id="headerTitle">Dashboard</div>
                        <div class="header-breadcrumb">
                            <span>Principal</span>
                            <i data-lucide="chevron-right" style="width: 14px; height: 14px;"></i>
                            <span style="color: var(--primary); font-weight: 600;" id="headerBreadcrumb">Dashboard</span>
                        </div>
                    </div>
                </div>

                <div class="header-right">
                    <div class="search-box">
                        <i data-lucide="search" class="search-icon"></i>
                        <input type="text" class="search-input" id="searchGlobal" placeholder="Buscar en el sistema...">
                    </div>

                    <div class="header-actions">
                        <button class="icon-button" onclick="mostrarNotificaciones()">
                            <i data-lucide="bell" style="width: 20px; height: 20px;"></i>
                            <span class="notification-dot" id="notificationDot" style="display: none;"></span>
                        </button>
                    </div>

                    <button class="sync-button" onclick="sincronizarDatos()">
                        <i data-lucide="refresh-cw" style="width: 16px; height: 16px;"></i>
                        Sincronizar
                    </button>
                </div>
            </header>

            <!-- CONTENT AREA -->
            <div class="content-area">
                <!-- DASHBOARD -->
                <div id="vista-dashboard" class="vista active">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon blue">
                                    <i data-lucide="package" style="width: 24px; height: 24px;"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="statVariantes">0</div>
                            <div class="stat-label">Variantes en Inventario</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon green">
                                    <i data-lucide="trending-up" style="width: 24px; height: 24px;"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="statUnidadesTotales">0</div>
                            <div class="stat-label">Unidades Totales</div>
                            <div class="stat-footer">
                                <span class="stat-footer-label">Disponibles</span>
                                <span class="stat-footer-value" id="statDisponibles">0</span>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon orange">
                                    <i data-lucide="lock" style="width: 24px; height: 24px;"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="statBloqueadas">0</div>
                            <div class="stat-label">Unidades Bloqueadas</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon red">
                                    <i data-lucide="shopping-cart" style="width: 24px; height: 24px;"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="statOrdenesActivas">0</div>
                            <div class="stat-label">√ìrdenes Activas</div>
                        </div>
                    </div>

                    <!-- KPIs de Tiempo -->
                    <div class="kpi-container">
                        <div class="kpi-title">
                            <i data-lucide="clock" style="width: 24px; height: 24px;"></i>
                            KPIs de Tiempo y Eficiencia
                        </div>
                        <div class="kpi-grid">
                            <div class="kpi-item">
                                <div class="kpi-label">D√≠as Promedio Picking</div>
                                <div class="kpi-value"><span id="kpiPicking">0.0</span><span class="kpi-unit">d√≠as</span></div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-label">D√≠as Promedio Packing</div>
                                <div class="kpi-value"><span id="kpiPacking">0.0</span><span class="kpi-unit">d√≠as</span></div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-label">Tiempo Total Promedio</div>
                                <div class="kpi-value"><span id="kpiTotal">0.0</span><span class="kpi-unit">d√≠as</span></div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-label">Tasa de Cumplimiento</div>
                                <div class="kpi-value"><span id="kpiCumplimiento">0</span><span class="kpi-unit">%</span></div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-label">√ìrdenes a Tiempo</div>
                                <div class="kpi-value"><span id="kpiATiempo">0/0</span></div>
                            </div>
                            <div class="kpi-item">
                                <div class="kpi-label">Productos Rechazados</div>
                                <div class="kpi-value"><span id="kpiRechazados">0</span><span class="kpi-unit">%</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Gr√°ficas -->
                    <div class="charts-grid">
                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">üìä Monto por G√©nero del Mes</div>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="chartGeneros"></canvas>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">üìà Evoluci√≥n de √ìrdenes (7 d√≠as)</div>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="chartEvolucion"></canvas>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">üç© Estados de √ìrdenes</div>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="chartEstados"></canvas>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="chart-header">
                                <div class="chart-title">üè™ Rendimiento por Tienda</div>
                            </div>
                            <div class="chart-wrapper">
                                <canvas id="chartTiendas"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- INVENTARIO -->
                <div id="vista-inventario" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i data-lucide="package" style="width: 24px; height: 24px; color: var(--primary);"></i>
                                Gesti√≥n de Inventario
                            </h3>
                            <div class="card-actions">
                                <button class="btn btn-primary" onclick="abrirModal('modalSubirInventario')">
                                    <i data-lucide="upload" style="width: 16px; height: 16px;"></i>
                                    Subir Inventario
                                </button>
                                <button class="btn btn-success" onclick="abrirModal('modalAgregarProducto')">
                                    <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                                    Agregar Producto
                                </button>
                                <button class="btn btn-outline" onclick="exportarInventario()">
                                    <i data-lucide="download" style="width: 16px; height: 16px;"></i>
                                    Exportar B√°sico
                                </button>
                                
                                <div class="dropdown-container">
                                    <button class="btn btn-outline" onclick="toggleDropdownInventario()">
                                        <i data-lucide="settings" style="width: 16px; height: 16px;"></i>
                                        M√°s Acciones
                                    </button>
                                    <div class="dropdown-menu" id="dropdownInventario">
                                        <div class="dropdown-item" onclick="exportarInventarioCompleto()">
                                            <i data-lucide="file-text" style="width: 16px; height: 16px;"></i>
                                            Exportar Completo
                                        </div>
                                        <div class="dropdown-item" onclick="abrirModal('modalModificarMasivo')">
                                            <i data-lucide="edit" style="width: 16px; height: 16px;"></i>
                                            Modificar Masivo
                                        </div>
                                        <div class="dropdown-item" onclick="abrirModal('modalEliminarMasivo')">
                                            <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
                                            Eliminar Masivo
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="table-header-controls">
                            <div class="search-box" style="width: 300px;">
                                <i data-lucide="search" class="search-icon"></i>
                                <input type="text" class="search-input" id="searchInventario" placeholder="Buscar por variante o ubicaci√≥n...">
                            </div>
                            <div>
                                <span style="font-size: 0.875rem; color: var(--text-secondary);">
                                    Mostrando <strong id="inventarioCount">0</strong> registros
                                </span>
                            </div>
                        </div>

                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Variante</th>
                                        <th>Ubicaci√≥n</th>
                                        <th>Stock F√≠sico</th>
                                        <th>Stock Bloqueado</th>
                                        <th>Stock Disponible</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaInventario">
                                    <tr>
                                        <td colspan="6" class="text-center" style="padding: 3rem; color: var(--text-secondary);">
                                            <i data-lucide="inbox" style="width: 48px; height: 48px; margin: 0 auto 1rem; display: block; opacity: 0.5;"></i>
                                            No hay datos de inventario
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="pagination">
                            <button onclick="cambiarPaginaInventario(-1)" id="btnPrevInventario" disabled>
                                <i data-lucide="chevron-left" style="width: 16px; height: 16px;"></i>
                            </button>
                            <span>P√°gina <strong id="paginaActualInventario">1</strong> de <strong id="totalPaginasInventario">1</strong></span>
                            <button onclick="cambiarPaginaInventario(1)" id="btnNextInventario" disabled>
                                <i data-lucide="chevron-right" style="width: 16px; height: 16px;"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- PRODUCTOS SYSTEM -->
                <div id="vista-productos-system" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i data-lucide="database" style="width: 24px; height: 24px; color: var(--primary);"></i>
                                Cat√°logo de Productos System
                            </h3>
                            <div class="card-actions">
                                <button class="btn btn-primary" onclick="abrirModal('modalSubirProductos')">
                                    <i data-lucide="upload" style="width: 16px; height: 16px;"></i>
                                    Subir Cat√°logo
                                </button>
                                <button class="btn btn-outline" onclick="exportarProductosSystem()">
                                    <i data-lucide="download" style="width: 16px; height: 16px;"></i>
                                    Exportar
                                </button>
                            </div>
                        </div>

                        <div class="table-header-controls">
                            <div class="form-row" style="flex: 1;">
                                <select id="filtroGenero" class="form-select" onchange="actualizarFiltrosCascada()">
                                    <option value="">Todos los G√©neros</option>
                                </select>
                                <select id="filtroLinea" class="form-select" onchange="actualizarFiltrosCascada()">
                                    <option value="">Todas las L√≠neas</option>
                                </select>
                                <select id="filtroMarca" class="form-select" onchange="actualizarFiltrosCascada()">
                                    <option value="">Todas las Marcas</option>
                                </select>
                                <select id="filtroTalla" class="form-select" onchange="actualizarFiltrosCascada()">
                                    <option value="">Todas las Tallas</option>
                                </select>
                            </div>
                            <div class="search-box" style="width: 250px;">
                                <i data-lucide="search" class="search-icon"></i>
                                <input type="text" class="search-input" id="searchProductos" placeholder="Buscar variante...">
                            </div>
                        </div>

                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Variante</th>
                                        <th>G√©nero</th>
                                        <th>L√≠nea</th>
                                        <th>Marca</th>
                                        <th>Talla</th>
                                        <th>Kardex</th>
                                        <th>PVP</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaProductosSystem">
                                    <tr>
                                        <td colspan="7" class="text-center" style="padding: 3rem; color: var(--text-secondary);">
                                            <i data-lucide="inbox" style="width: 48px; height: 48px; margin: 0 auto 1rem; display: block; opacity: 0.5;"></i>
                                            No hay productos cargados
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="pagination">
                            <button onclick="cambiarPaginaProductos(-1)" id="btnPrevProductos" disabled>
                                <i data-lucide="chevron-left" style="width: 16px; height: 16px;"></i>
                            </button>
                            <span>P√°gina <strong id="paginaActualProductos">1</strong> de <strong id="totalPaginasProductos">1</strong></span>
                            <button onclick="cambiarPaginaProductos(1)" id="btnNextProductos" disabled>
                                <i data-lucide="chevron-right" style="width: 16px; height: 16px;"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- √ìRDENES -->
                <div id="vista-ordenes" class="vista">
                    <div id="alertaOrdenesProximas" class="alert alert-warning" style="display: none;">
                        <i data-lucide="alert-triangle" class="alert-icon" style="color: var(--warning);"></i>
                        <div>
                            <strong style="display: block; margin-bottom: 0.25rem;" id="alertaOrdenesTexto"></strong>
                            <span style="font-size: 0.875rem;">Revisa el listado para tomar acci√≥n</span>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i data-lucide="shopping-cart" style="width: 24px; height: 24px; color: var(--primary);"></i>
                                Gesti√≥n de √ìrdenes
                            </h3>
                            <div class="card-actions">
                                <button class="btn btn-primary" onclick="abrirModal('modalCrearOrden')">
                                    <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                                    Crear Orden Manual
                                </button>
                            </div>
                        </div>

                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ID Orden</th>
                                        <th>Fecha Creaci√≥n</th>
                                        <th>Variantes</th>
                                        <th>Unidades</th>
                                        <th>D√≠as Transcurridos</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaOrdenes">
                                    <tr>
                                        <td colspan="7" class="text-center" style="padding: 3rem; color: var(--text-secondary);">
                                            <i data-lucide="inbox" style="width: 48px; height: 48px; margin: 0 auto 1rem; display: block; opacity: 0.5;"></i>
                                            No hay √≥rdenes registradas
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- PICKING -->
                <div id="vista-picking" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i data-lucide="scan" style="width: 24px; height: 24px; color: var(--primary);"></i>
                                M√≥dulo de Picking
                            </h3>
                        </div>

                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ID Orden</th>
                                        <th>Fecha</th>
                                        <th>Variantes</th>
                                        <th>Unidades</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaPicking">
                                    <tr>
                                        <td colspan="6" class="text-center" style="padding: 3rem; color: var(--text-secondary);">
                                            <i data-lucide="inbox" style="width: 48px; height: 48px; margin: 0 auto 1rem; display: block; opacity: 0.5;"></i>
                                            No hay √≥rdenes pendientes de picking
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- PACKING -->
                <div id="vista-packing" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i data-lucide="box" style="width: 24px; height: 24px; color: var(--primary);"></i>
                                M√≥dulo de Packing
                            </h3>
                        </div>

                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ID Orden</th>
                                        <th>Fecha</th>
                                        <th>Variantes Encontradas</th>
                                        <th>Unidades Encontradas</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaPacking">
                                    <tr>
                                        <td colspan="6" class="text-center" style="padding: 3rem; color: var(--text-secondary);">
                                            <i data-lucide="inbox" style="width: 48px; height: 48px; margin: 0 auto 1rem; display: block; opacity: 0.5;"></i>
                                            No hay √≥rdenes pendientes de packing
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- RECLASIFICACI√ìN -->
                <div id="vista-reclasificacion" class="vista">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i data-lucide="repeat" style="width: 24px; height: 24px; color: var(--primary);"></i>
                                Productos en Reclasificaci√≥n
                            </h3>
                        </div>

                        <div class="table-header-controls">
                            <div class="search-box" style="width: 300px;">
                                <i data-lucide="search" class="search-icon"></i>
                                <input type="text" class="search-input" id="searchReclasificacion" placeholder="Buscar...">
                            </div>
                        </div>

                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Variante Original</th>
                                        <th>Nueva Variante</th>
                                        <th>Ubicaci√≥n</th>
                                        <th>Cantidad</th>
                                        <th>Motivo</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="tablaReclasificacion">
                                    <tr>
                                        <td colspan="8" class="text-center" style="padding: 3rem; color: var(--text-secondary);">
                                            <i data-lucide="inbox" style="width: 48px; height: 48px; margin: 0 auto 1rem; display: block; opacity: 0.5;"></i>
                                            No hay productos en reclasificaci√≥n
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALES -->
    
    <!-- Modal: Subir Inventario -->
    <div id="modalSubirInventario" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i data-lucide="upload" style="width: 24px; height: 24px;"></i>
                    Subir Inventario desde Excel
                </h3>
                <button class="modal-close" onclick="cerrarModal('modalSubirInventario')">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label required">Archivo Excel</label>
                    <input type="file" id="fileInventario" class="form-file" accept=".xlsx,.xls" onchange="procesarInventarioMasivo(event)">
                    <label for="fileInventario" class="file-upload-btn">
                        <i data-lucide="file-plus" style="width: 18px; height: 18px;"></i>
                        Seleccionar archivo Excel
                    </label>
                    <p class="form-help">Columnas requeridas: Variante, Ubicacion, StockFisico</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Agregar Producto Individual -->
    <div id="modalAgregarProducto" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i data-lucide="plus" style="width: 24px; height: 24px;"></i>
                    Agregar Producto al Inventario
                </h3>
                <button class="modal-close" onclick="cerrarModal('modalAgregarProducto')">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label required">Variante</label>
                    <input type="text" id="inputVariante" class="form-input" placeholder="Ej: 10001-01-M">
                </div>
                <div class="form-group">
                    <label class="form-label required">Ubicaci√≥n</label>
                    <input type="text" id="inputUbicacion" class="form-input" placeholder="Ej: A1, B2, etc.">
                </div>
                <div class="form-group">
                    <label class="form-label required">Stock F√≠sico</label>
                    <input type="number" id="inputStockFisico" class="form-input" placeholder="0" min="0">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="cerrarModal('modalAgregarProducto')">Cancelar</button>
                <button class="btn btn-primary" onclick="guardarInventarioItem()">
                    <i data-lucide="save" style="width: 16px; height: 16px;"></i>
                    Guardar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Modificar Masivo -->
    <div id="modalModificarMasivo" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i data-lucide="edit" style="width: 24px; height: 24px;"></i>
                    Modificar Stock Masivo
                </h3>
                <button class="modal-close" onclick="cerrarModal('modalModificarMasivo')">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label required">Archivo Excel</label>
                    <input type="file" id="fileModificar" class="form-file" accept=".xlsx,.xls" onchange="procesarModificarMasivo(event)">
                    <label for="fileModificar" class="file-upload-btn">
                        <i data-lucide="file-plus" style="width: 18px; height: 18px;"></i>
                        Seleccionar archivo Excel
                    </label>
                    <p class="form-help">Columnas: Variante, Ubicacion, StockFisico (nuevo valor)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Eliminar Masivo -->
    <div id="modalEliminarMasivo" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i data-lucide="trash-2" style="width: 24px; height: 24px;"></i>
                    Eliminar Productos Masivo
                </h3>
                <button class="modal-close" onclick="cerrarModal('modalEliminarMasivo')">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i data-lucide="alert-triangle" class="alert-icon" style="color: var(--danger);"></i>
                    <div>
                        <strong style="display: block; margin-bottom: 0.25rem;">Acci√≥n Irreversible</strong>
                        <span style="font-size: 0.875rem;">Esta acci√≥n eliminar√° permanentemente los registros</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label required">Archivo Excel</label>
                    <input type="file" id="fileEliminar" class="form-file" accept=".xlsx,.xls" onchange="procesarEliminarMasivo(event)">
                    <label for="fileEliminar" class="file-upload-btn">
                        <i data-lucide="file-plus" style="width: 18px; height: 18px;"></i>
                        Seleccionar archivo Excel
                    </label>
                    <p class="form-help">Columnas: Variante, Ubicacion</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Subir Productos System -->
    <div id="modalSubirProductos" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i data-lucide="database" style="width: 24px; height: 24px;"></i>
                    Cargar Cat√°logo de Productos
                </h3>
                <button class="modal-close" onclick="cerrarModal('modalSubirProductos')">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i data-lucide="info" class="alert-icon" style="color: var(--info);"></i>
                    <div>
                        <span style="font-size: 0.875rem;">Se eliminar√° el cat√°logo actual y se cargar√° el nuevo</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label required">Archivo Excel</label>
                    <input type="file" id="fileProductos" class="form-file" accept=".xlsx,.xls" onchange="procesarProductosSystem(event)">
                    <label for="fileProductos" class="file-upload-btn">
                        <i data-lucide="file-plus" style="width: 18px; height: 18px;"></i>
                        Seleccionar archivo Excel
                    </label>
                    <p class="form-help">Columnas: variante, kardex, pvp, genero, linea, marca, talla, etc.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Crear Orden -->
    <div id="modalCrearOrden" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i data-lucide="shopping-cart" style="width: 24px; height: 24px;"></i>
                    Crear Nueva Orden
                </h3>
                <button class="modal-close" onclick="cerrarModal('modalCrearOrden')">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label required">Archivo Excel con Hoja de Ruta</label>
                    <input type="file" id="fileOrden" class="form-file" accept=".xlsx,.xls" onchange="procesarOrdenManual(event)">
                    <label for="fileOrden" class="file-upload-btn">
                        <i data-lucide="file-plus" style="width: 18px; height: 18px;"></i>
                        Seleccionar archivo Excel
                    </label>
                    <p class="form-help">El archivo debe contener: Variante, Ubicaci√≥n y columnas por tienda con cantidades solicitadas</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Ver Orden Detalle -->
    <div id="modalVerOrden" class="modal">
        <div class="modal-content large">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i data-lucide="file-text" style="width: 24px; height: 24px;"></i>
                    Detalle de Orden <span id="ordenDetalleId"></span>
                </h3>
                <button class="modal-close" onclick="cerrarModal('modalVerOrden')">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="ordenDetalleContenido"></div>
            </div>
        </div>
    </div>

    <!-- Modal: Subir Cantidades Encontradas (Picking) -->
    <div id="modalSubirCantidades" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i data-lucide="scan" style="width: 24px; height: 24px;"></i>
                    Confirmar Cantidades Encontradas
                </h3>
                <button class="modal-close" onclick="cerrarModal('modalSubirCantidades')">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; color: var(--text-secondary);">
                    Sube el Excel con las cantidades realmente encontradas en bodega
                </p>
                <div class="form-group">
                    <label class="form-label required">Archivo Excel</label>
                    <input type="file" id="fileCantidades" class="form-file" accept=".xlsx,.xls">
                    <label for="fileCantidades" class="file-upload-btn">
                        <i data-lucide="file-plus" style="width: 18px; height: 18px;"></i>
                        Seleccionar archivo Excel
                    </label>
                    <p class="form-help">Columnas: Variante, Ubicacion, Encontrado</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="cerrarModal('modalSubirCantidades')">Cancelar</button>
                <button class="btn btn-success" onclick="confirmarSubirCantidades()">
                    <i data-lucide="check" style="width: 16px; height: 16px;"></i>
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Subir Excel Packing -->
    <div id="modalSubirExcelPacking" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i data-lucide="box" style="width: 24px; height: 24px;"></i>
                    Subir Distribuci√≥n Real de Packing
                </h3>
                <button class="modal-close" onclick="cerrarModal('modalSubirExcelPacking')">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i data-lucide="info" class="alert-icon" style="color: var(--info);"></i>
                    <div>
                        <span style="font-size: 0.875rem;">Sube el Excel con la distribuci√≥n REAL por tienda despu√©s de empaquetar</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label required">Archivo Excel</label>
                    <input type="file" id="filePackingReal" class="form-file" accept=".xlsx,.xls">
                    <label for="filePackingReal" class="file-upload-btn">
                        <i data-lucide="file-plus" style="width: 18px; height: 18px;"></i>
                        Seleccionar archivo Excel
                    </label>
                    <p class="form-help">Debe contener: Variante, Ubicacion, y columnas por tienda con cantidades empaquetadas</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="cerrarModal('modalSubirExcelPacking')">Cancelar</button>
                <button class="btn btn-success" onclick="confirmarSubirPacking()">
                    <i data-lucide="check" style="width: 16px; height: 16px;"></i>
                    Procesar Packing
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Reclasificaci√≥n Inmediata (CERRABLE AHORA) -->
    <div id="modalReclasificacionInmediata" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i data-lucide="alert-circle" style="width: 24px; height: 24px; color: var(--warning);"></i>
                    Reclasificaci√≥n Obligatoria
                </h3>
                <button class="modal-close" onclick="cancelarReclasificacionCompleta()">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i data-lucide="alert-triangle" class="alert-icon" style="color: var(--warning);"></i>
                    <div>
                        <span style="font-size: 0.875rem;">Debes clasificar todos los productos no empaquetados antes de cerrar la orden</span>
                    </div>
                </div>

                <div style="background: var(--bg-hover); padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 600; color: var(--text-secondary);">Progreso:</span>
                        <span style="font-weight: 700; color: var(--primary);" id="progresoReclasificacion">1 / 1</span>
                    </div>
                </div>

                <div id="formReclasificacionInmediata">
                    <div class="form-group">
                        <label class="form-label">Variante</label>
                        <input type="text" id="reclasVariante" class="form-input" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Ubicaci√≥n Original</label>
                        <input type="text" id="reclasUbicacion" class="form-input" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Cantidad</label>
                        <input type="text" id="reclasCantidad" class="form-input" readonly>
                    </div>

                    <div class="form-group">
                        <label class="form-label required">Motivo de Rechazo</label>
                        <select id="reclasMotivo" class="form-select" onchange="toggleVarianteNueva()">
                            <option value="">Seleccionar motivo...</option>
                            <option value="mal_estado">Mal Estado / Defectuoso</option>
                            <option value="no_corresponde_linea">No Corresponde a L√≠nea</option>
                            <option value="no_corresponde_genero">No Corresponde a G√©nero</option>
                            <option value="no_corresponde_talla">No Corresponde a Talla</option>
                        </select>
                    </div>

                    <div class="form-group" id="grupoNuevaVariante" style="display: none;">
                        <label class="form-label required">Nueva Variante Correcta</label>
                        <input type="text" id="reclasNuevaVariante" class="form-input" placeholder="Ingresa la variante correcta">
                        <p class="form-help">Se asignar√° a ubicaci√≥n temporal 999-PENDIENTE</p>
                    </div>

                    <div class="form-group" id="grupoMalEstado" style="display: none;">
                        <div class="alert alert-danger">
                            <i data-lucide="x-circle" class="alert-icon" style="color: var(--danger);"></i>
                            <div>
                                <span style="font-size: 0.875rem;">Se asignar√° a ubicaci√≥n <strong>191</strong> para productos defectuosos</span>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label required">Comentario</label>
                        <textarea id="reclasComentario" class="form-textarea" placeholder="Describe el motivo del rechazo..."></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="cancelarReclasificacionCompleta()">Cancelar Todo</button>
                <button class="btn btn-primary" onclick="procesarReclasificacionInmediata()">
                    <i data-lucide="arrow-right" style="width: 16px; height: 16px;"></i>
                    <span id="btnTextoReclasificar">Siguiente</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal: Ver Comentario Reclasificaci√≥n -->
    <div id="modalVerComentario" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i data-lucide="message-square" style="width: 24px; height: 24px;"></i>
                    Comentario de Reclasificaci√≥n
                </h3>
                <button class="modal-close" onclick="cerrarModal('modalVerComentario')">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="comentarioContenido" style="padding: 1rem; background: var(--bg-hover); border-radius: 12px; white-space: pre-wrap;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="cerrarModal('modalVerComentario')">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Modal: Completar Reclasificaci√≥n -->
    <div id="modalCompletarReclasificacion" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i data-lucide="check-circle" style="width: 24px; height: 24px;"></i>
                    Completar Reclasificaci√≥n
                </h3>
                <button class="modal-close" onclick="cerrarModal('modalCompletarReclasificacion')">
                    <i data-lucide="x" style="width: 20px; height: 20px;"></i>
                </button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem;">Informaci√≥n del producto reclasificado:</p>
                <div id="infoCompletarReclasificacion"></div>
                
                <div class="form-group" style="margin-top: 1.5rem;">
                    <label class="form-label required">Ubicaci√≥n Final</label>
                    <input type="text" id="ubicacionFinalReclas" class="form-input" placeholder="Ej: A1, B2, etc.">
                    <p class="form-help">Ingresa la ubicaci√≥n definitiva donde se almacenar√° el producto</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="cerrarModal('modalCompletarReclasificacion')">Cancelar</button>
                <button class="btn btn-success" onclick="confirmarCompletarReclasificacion()">
                    <i data-lucide="check" style="width: 16px; height: 16px;"></i>
                    Completar
                </button>
            </div>
        </div>
    </div>

    <!-- LOADING OVERLAY -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">Cargando...</div>
            <div class="loading-subtext" id="loadingSubtext">Por favor espera</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>
    </div>

    <!-- TOAST CONTAINER -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
        // ============================================
        // CONFIGURACI√ìN SUPABASE (ACTUALIZADA - CORREGIDA)
        // ============================================
        const SUPABASE_URL = 'https://dzxjzmlmmmwspemihhlv.supabase.co';
        // ‚ö†Ô∏è IMPORTANTE: Reemplaza esta key con tu key v√°lida de Supabase
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR6eGp6bWxtbW13c3BlbWloaGx2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM1NjI5MjAsImV4cCI6MjA3OTEzODkyMH0.uLXtsONi_c4myPbsvTIqV51pldRv6Wuff4adYWgVR6Q';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let inventario = [];
        let productosSystem = [];
        let ordenes = [];
        let itemsReclasificacion = [];
        
        let paginaInventario = 1;
        let paginaProductosSystem = 1;
        const ITEMS_POR_PAGINA = 100;
        const BATCH_SIZE = 500;

        let searchTimeout = null;
        let searchProductosTimeout = null;
        let searchReclasificacionTimeout = null;

        const TIENDAS_LUKERS = [
            'LUKERS EL SOL',
            'LUKERS TRU PIZARRO',
            'LUKERS LA MARINA',
            'LUKERS PROLONGACI√ìN IQUITOS',
            'LUKERS CHI P. RUIZ',
            'LUKERS TARAPOTO',
            'LUKERS MENDIOLA',
            'LUKERS ALFONSO UGARTE',
            'LUKERS IQT LORES',
            'LUKERS JIRON'
        ];

        const DIAS_EXPIRACION_ORDEN = 7;
        const DIAS_ALERTA_TEMPRANA = 3;

        let variantesNoEmpaquetadas = [];
        let ordenActualPacking = null;
        let indiceReclasificacionActual = 0;
        let itemReclasificacionActual = null;

        // Variables para gr√°ficas
        let chartGeneros, chartEvolucion, chartEstados, chartTiendas;
        // ============================================
        // AUTENTICACI√ìN
        // ============================================
        async function verificarSesion() {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mainApp').style.display = 'flex';
                
                const email = session.user.email;
                const nombre = email.split('@')[0];
                document.getElementById('userName').textContent = nombre;
                document.getElementById('userAvatar').textContent = nombre.charAt(0).toUpperCase();
                
                await cargarDatosIniciales();
            } else {
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('mainApp').style.display = 'none';
            }
        }

        async function iniciarSesion() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                mostrarToast('Por favor completa todos los campos', 'error');
                return;
            }

            mostrarLoading('Iniciando sesi√≥n...', 'Verificando credenciales');

            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password
            });

            ocultarLoading();

            if (error) {
                mostrarToast('Error al iniciar sesi√≥n: ' + error.message, 'error');
            } else {
                mostrarToast('Sesi√≥n iniciada correctamente', 'success');
                await verificarSesion();
            }
        }

        async function cerrarSesion() {
            const { error } = await supabase.auth.signOut();
            
            if (!error) {
                mostrarToast('Sesi√≥n cerrada', 'info');
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        }

        // ============================================
        // CARGA INICIAL DE DATOS
        // ============================================
        async function cargarDatosIniciales() {
            mostrarLoading('Cargando datos del sistema...', 'Esto puede tomar unos segundos');

            try {
                await Promise.all([
                    cargarInventario(),
                    cargarProductosSystem(),
                    cargarOrdenes(),
                    cargarReclasificacion()
                ]);

                actualizarDashboard();
                actualizarKPIs();
                generarGraficas();
                
                ocultarLoading();
                mostrarToast('Datos cargados correctamente', 'success');
            } catch (error) {
                ocultarLoading();
                mostrarToast('Error al cargar datos: ' + error.message, 'error');
            }
        }

        async function sincronizarDatos() {
            mostrarToast('Sincronizando datos...', 'info');
            await cargarDatosIniciales();
        }

        async function cargarInventario() {
            const { data, error } = await supabase
                .from('inventario')
                .select('*')
                .order('variante', { ascending: true });

            if (!error && data) {
                inventario = data;
                renderizarInventario();
            }
        }

        async function cargarProductosSystem() {
            const { data, error } = await supabase
                .from('productos_system')
                .select('*')
                .order('variante', { ascending: true });

            if (!error && data) {
                productosSystem = data;
                actualizarFiltrosCascada();
                renderizarProductosSystem();
            }
        }

        async function cargarOrdenes() {
            const { data, error } = await supabase
                .from('ordenes')
                .select('*')
                .order('fecha', { ascending: false });

            if (!error && data) {
                ordenes = data;
                renderizarOrdenes();
                renderizarPicking();
                renderizarPacking();
                verificarOrdenesProximas();
            }
        }

        async function cargarReclasificacion() {
            const { data, error } = await supabase
                .from('reclasificacion')
                .select('*')
                .order('fecha', { ascending: false });

            if (!error && data) {
                itemsReclasificacion = data;
                renderizarReclasificacion();
            }
        }

        // ============================================
        // NAVEGACI√ìN
        // ============================================
        function cambiarVista(nombreVista) {
            document.querySelectorAll('.vista').forEach(v => v.classList.remove('active'));
            document.getElementById(`vista-${nombreVista}`).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-vista') === nombreVista) {
                    item.classList.add('active');
                }
            });
            
            const titulos = {
                'dashboard': 'Dashboard',
                'inventario': 'Inventario',
                'productos-system': 'Productos System',
                'ordenes': '√ìrdenes',
                'picking': 'Picking',
                'packing': 'Packing',
                'reclasificacion': 'Reclasificaci√≥n'
            };
            
            document.getElementById('headerTitle').textContent = titulos[nombreVista] || 'Sistema';
            document.getElementById('headerBreadcrumb').textContent = titulos[nombreVista] || 'Sistema';
            
            setTimeout(() => lucide.createIcons(), 100);
        }

        // ============================================
        // DASHBOARD Y KPIs
        // ============================================
        function actualizarDashboard() {
            const variantesUnicas = new Set(inventario.map(i => i.variante)).size;
            const unidadesTotales = inventario.reduce((sum, i) => sum + (i.stock_fisico || 0), 0);
            const unidadesBloqueadas = inventario.reduce((sum, i) => sum + (i.stock_bloqueado || 0), 0);
            const unidadesDisponibles = unidadesTotales - unidadesBloqueadas;
            const ordenesActivas = ordenes.filter(o => ['Pendiente Picking', 'En Picking', 'Pendiente Packing'].includes(o.estado)).length;

            document.getElementById('statVariantes').textContent = variantesUnicas.toLocaleString();
            document.getElementById('statUnidadesTotales').textContent = unidadesTotales.toLocaleString();
            document.getElementById('statDisponibles').textContent = unidadesDisponibles.toLocaleString();
            document.getElementById('statBloqueadas').textContent = unidadesBloqueadas.toLocaleString();
            document.getElementById('statOrdenesActivas').textContent = ordenesActivas;
            document.getElementById('badgeOrdenes').textContent = ordenesActivas;
        }

        function actualizarKPIs() {
            const ordenesCompletadas = ordenes.filter(o => o.estado === 'Completada' && o.fechaCierre);
            
            if (ordenesCompletadas.length === 0) {
                document.getElementById('kpiPicking').textContent = '0.0';
                document.getElementById('kpiPacking').textContent = '0.0';
                document.getElementById('kpiTotal').textContent = '0.0';
                document.getElementById('kpiCumplimiento').textContent = '0';
                document.getElementById('kpiATiempo').textContent = '0/0';
                document.getElementById('kpiRechazados').textContent = '0';
                return;
            }

            let totalDiasPicking = 0;
            let totalDiasPacking = 0;
            let ordenesATiempo = 0;
            let totalRechazados = 0;
            let totalProductos = 0;

            ordenesCompletadas.forEach(orden => {
                const dias = diasTranscurridos(orden.fecha);
                totalDiasPicking += dias * 0.6;
                totalDiasPacking += dias * 0.4;
                
                if (dias <= DIAS_EXPIRACION_ORDEN) ordenesATiempo++;
                
                totalRechazados += orden.prendasRechazadas || 0;
                
                if (orden.hojaPacking && Array.isArray(orden.hojaPacking)) {
                    orden.hojaPacking.forEach(fila => {
                        let cantidadTotal = 0;
                        TIENDAS_LUKERS.forEach(tienda => {
                            cantidadTotal += fila[tienda] || 0;
                        });
                        totalProductos += cantidadTotal;
                    });
                }
            });

            const promedioPicking = (totalDiasPicking / ordenesCompletadas.length).toFixed(1);
            const promedioPacking = (totalDiasPacking / ordenesCompletadas.length).toFixed(1);
            const promedioTotal = ((totalDiasPicking + totalDiasPacking) / ordenesCompletadas.length).toFixed(1);
            const tasaCumplimiento = ((ordenesATiempo / ordenesCompletadas.length) * 100).toFixed(1);
            const tasaRechazos = totalProductos > 0 ? ((totalRechazados / totalProductos) * 100).toFixed(1) : '0';

            document.getElementById('kpiPicking').textContent = promedioPicking;
            document.getElementById('kpiPacking').textContent = promedioPacking;
            document.getElementById('kpiTotal').textContent = promedioTotal;
            document.getElementById('kpiCumplimiento').textContent = tasaCumplimiento;
            document.getElementById('kpiATiempo').textContent = `${ordenesATiempo}/${ordenesCompletadas.length}`;
            document.getElementById('kpiRechazados').textContent = tasaRechazos;
        }

        function generarGraficas() {
            generarGraficaGeneros();
            generarGraficaEvolucion();
            generarGraficaEstados();
            generarGraficaTiendas();
        }

        function generarGraficaGeneros() {
            const ctx = document.getElementById('chartGeneros');
            if (!ctx) return;

            if (chartGeneros) chartGeneros.destroy();

            const hoy = new Date();
            const mesActual = hoy.getMonth();
            const a√±oActual = hoy.getFullYear();

            const ordenesDelMes = ordenes.filter(orden => {
                if (orden.estado !== 'Completada' || !orden.fechaCierre) return false;
                const fechaCierre = new Date(orden.fechaCierre);
                return fechaCierre.getMonth() === mesActual && fechaCierre.getFullYear() === a√±oActual;
            });

            let montoH = 0, montoM = 0, montoInfantil = 0;

            for (const orden of ordenesDelMes) {
                if (!orden.hojaPacking || !Array.isArray(orden.hojaPacking)) continue;

                for (const fila of orden.hojaPacking) {
                    let cantidadTotal = 0;
                    TIENDAS_LUKERS.forEach(tienda => {
                        cantidadTotal += fila[tienda] || 0;
                    });

                    const producto = productosSystem.find(p => p.variante === fila.variante);
                    if (!producto) continue;

                    const genero = (producto.genero || '').toUpperCase();
                    const montoFila = cantidadTotal * (parseFloat(fila.kardex) || 0);

                    if (genero === 'H') {
                        montoH += montoFila;
                    } else if (genero === 'M' || genero === 'OTROS') {
                        montoM += montoFila;
                    } else if (['NI√ëAS', 'JOVENCITAS', 'JOVENCITOS', 'NI√ëOS'].includes(genero)) {
                        montoInfantil += montoFila;
                    }
                }
            }

            chartGeneros = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['G√©nero H', 'G√©nero M', 'Infantil'],
                    datasets: [{
                        label: 'Monto (S/)',
                        data: [montoH, montoM, montoInfantil],
                        backgroundColor: [
                            'rgba(99, 102, 241, 0.8)',
                            'rgba(236, 72, 153, 0.8)',
                            'rgba(245, 158, 11, 0.8)'
                        ],
                        borderRadius: 8
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function generarGraficaEvolucion() {
            const ctx = document.getElementById('chartEvolucion');
            if (!ctx) return;

            if (chartEvolucion) chartEvolucion.destroy();

            const hoy = new Date();
            const labels = [];
            const data = [];

            for (let i = 6; i >= 0; i--) {
                const fecha = new Date(hoy);
                fecha.setDate(fecha.getDate() - i);
                const fechaStr = fecha.toISOString().split('T')[0];
                
                labels.push(fecha.toLocaleDateString('es-PE', { day: '2-digit', month: 'short' }));
                
                const ordenesDelDia = ordenes.filter(o => {
                    const fechaOrden = o.fechaCierre || o.fecha;
                    return fechaOrden.startsWith(fechaStr);
                }).length;
                
                data.push(ordenesDelDia);
            }

            chartEvolucion = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '√ìrdenes',
                        data: data,
                        borderColor: 'rgba(99, 102, 241, 1)',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function generarGraficaEstados() {
            const ctx = document.getElementById('chartEstados');
            if (!ctx) return;

            if (chartEstados) chartEstados.destroy();

            const estados = {};
            ordenes.forEach(orden => {
                estados[orden.estado] = (estados[orden.estado] || 0) + 1;
            });

            const colores = {
                'Pendiente Picking': 'rgba(245, 158, 11, 0.8)',
                'En Picking': 'rgba(59, 130, 246, 0.8)',
                'Pendiente Packing': 'rgba(168, 85, 247, 0.8)',
                'Completada': 'rgba(16, 185, 129, 0.8)',
                'Expirada': 'rgba(239, 68, 68, 0.8)'
            };

            chartEstados = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(estados),
                    datasets: [{
                        data: Object.values(estados),
                        backgroundColor: Object.keys(estados).map(e => colores[e] || 'rgba(100, 100, 100, 0.8)')
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function generarGraficaTiendas() {
            const ctx = document.getElementById('chartTiendas');
            if (!ctx) return;

            if (chartTiendas) chartTiendas.destroy();

            const unidadesPorTienda = {};
            TIENDAS_LUKERS.forEach(tienda => { unidadesPorTienda[tienda] = 0; });

            ordenes.forEach(orden => {
                if (orden.estado === 'Completada' && orden.hojaPacking && Array.isArray(orden.hojaPacking)) {
                    orden.hojaPacking.forEach(fila => {
                        TIENDAS_LUKERS.forEach(tienda => {
                            unidadesPorTienda[tienda] += fila[tienda] || 0;
                        });
                    });
                }
            });

            const nombresCortos = TIENDAS_LUKERS.map(t => t.replace('LUKERS ', ''));

            chartTiendas = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: nombresCortos,
                    datasets: [{
                        label: 'Unidades',
                        data: Object.values(unidadesPorTienda),
                        backgroundColor: 'rgba(99, 102, 241, 0.8)',
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // ============================================
        // INVENTARIO
        // ============================================
        function renderizarInventario() {
            const searchTerm = document.getElementById('searchInventario').value.toLowerCase();
            let inventarioFiltrado = inventario.filter(item => {
                return item.variante.toLowerCase().includes(searchTerm) ||
                       item.ubicacion.toLowerCase().includes(searchTerm);
            });

            const totalPaginas = Math.ceil(inventarioFiltrado.length / ITEMS_POR_PAGINA);
            const inicio = (paginaInventario - 1) * ITEMS_POR_PAGINA;
            const fin = inicio + ITEMS_POR_PAGINA;
            const itemsPagina = inventarioFiltrado.slice(inicio, fin);

            const tbody = document.getElementById('tablaInventario');
            
            if (itemsPagina.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center" style="padding: 3rem; color: var(--text-secondary);">
                            <i data-lucide="inbox" style="width: 48px; height: 48px; margin: 0 auto 1rem; display: block; opacity: 0.5;"></i>
                            No hay resultados
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = itemsPagina.map(item => {
                    const disponible = (item.stock_fisico || 0) - (item.stock_bloqueado || 0);
                    return `
                        <tr>
                            <td><strong>${item.variante}</strong></td>
                            <td><span class="badge badge-info">${item.ubicacion}</span></td>
                            <td>${item.stock_fisico || 0}</td>
                            <td>${item.stock_bloqueado || 0}</td>
                            <td><strong style="color: var(--success);">${disponible}</strong></td>
                            <td>
                                <button class="btn btn-danger btn-icon" onclick="eliminarInventarioItem('${item.variante}', '${item.ubicacion}')" title="Eliminar">
                                    <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            document.getElementById('inventarioCount').textContent = inventarioFiltrado.length;
            document.getElementById('paginaActualInventario').textContent = paginaInventario;
            document.getElementById('totalPaginasInventario').textContent = totalPaginas || 1;
            
            document.getElementById('btnPrevInventario').disabled = paginaInventario === 1;
            document.getElementById('btnNextInventario').disabled = paginaInventario >= totalPaginas;

            lucide.createIcons();
        }

        function cambiarPaginaInventario(direccion) {
            paginaInventario += direccion;
            renderizarInventario();
        }

        document.getElementById('searchInventario').addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                paginaInventario = 1;
                renderizarInventario();
            }, 300);
        });

        async function guardarInventarioItem() {
            const variante = document.getElementById('inputVariante').value.trim().toUpperCase();
            const ubicacion = document.getElementById('inputUbicacion').value.trim().toUpperCase();
            const stockFisico = parseInt(document.getElementById('inputStockFisico').value) || 0;

            if (!variante || !ubicacion || stockFisico < 0) {
                mostrarToast('Por favor completa todos los campos correctamente', 'error');
                return;
            }

            mostrarLoading('Guardando producto...', 'Actualizando inventario');

            const { data, error } = await supabase
                .from('inventario')
                .upsert({
                    variante: variante,
                    ubicacion: ubicacion,
                    stock_fisico: stockFisico,
                    stock_bloqueado: 0
                }, { onConflict: ['variante', 'ubicacion'] });

            ocultarLoading();

            if (error) {
                mostrarToast('Error al guardar: ' + error.message, 'error');
            } else {
                mostrarToast('Producto guardado correctamente', 'success');
                cerrarModal('modalAgregarProducto');
                await cargarInventario();
                actualizarDashboard();
            }
        }

        async function eliminarInventarioItem(variante, ubicacion) {
            if (!confirm(`¬øEliminar el producto ${variante} de ${ubicacion}?`)) return;

            mostrarLoading('Eliminando...', 'Actualizando inventario');

            const { error } = await supabase
                .from('inventario')
                .delete()
                .eq('variante', variante)
                .eq('ubicacion', ubicacion);

            ocultarLoading();

            if (error) {
                mostrarToast('Error al eliminar: ' + error.message, 'error');
            } else {
                mostrarToast('Producto eliminado', 'success');
                await cargarInventario();
                actualizarDashboard();
            }
        }

        async function procesarInventarioMasivo(event) {
            const file = event.target.files[0];
            if (!file) return;

            mostrarLoading('Procesando Excel...', 'Leyendo archivo');

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    if (jsonData.length === 0) {
                        ocultarLoading();
                        mostrarToast('El archivo est√° vac√≠o', 'error');
                        return;
                    }

                    const productos = jsonData.map(row => ({
                        variante: String(row.Variante || row.variante || '').trim().toUpperCase(),
                        ubicacion: String(row.Ubicacion || row.ubicacion || '').trim().toUpperCase(),
                        stock_fisico: parseInt(row.StockFisico || row.stock_fisico || 0),
                        stock_bloqueado: 0
                    })).filter(p => p.variante && p.ubicacion && p.stock_fisico >= 0);

                    if (productos.length === 0) {
                        ocultarLoading();
                        mostrarToast('No se encontraron productos v√°lidos', 'error');
                        return;
                    }

                    actualizarProgreso(0);
                    const total = productos.length;
                    let procesados = 0;

                    for (let i = 0; i < productos.length; i += BATCH_SIZE) {
                        const batch = productos.slice(i, i + BATCH_SIZE);
                        
                        const { error } = await supabase
                            .from('inventario')
                            .upsert(batch, { onConflict: ['variante', 'ubicacion'] });

                        if (error) throw error;

                        procesados += batch.length;
                        const progreso = (procesados / total) * 100;
                        actualizarProgreso(progreso);
                    }

                    ocultarLoading();
                    mostrarToast(`${productos.length} productos cargados correctamente`, 'success');
                    cerrarModal('modalSubirInventario');
                    await cargarInventario();
                    actualizarDashboard();
                    
                    event.target.value = '';
                } catch (error) {
                    ocultarLoading();
                    mostrarToast('Error al procesar: ' + error.message, 'error');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        async function procesarModificarMasivo(event) {
            const file = event.target.files[0];
            if (!file) return;

            mostrarLoading('Procesando modificaci√≥n masiva...', 'Leyendo archivo');

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    const productos = jsonData.map(row => ({
                        variante: String(row.Variante || '').trim().toUpperCase(),
                        ubicacion: String(row.Ubicacion || '').trim().toUpperCase(),
                        stock_fisico: parseInt(row.StockFisico || 0)
                    })).filter(p => p.variante && p.ubicacion && p.stock_fisico >= 0);

                    // CORRECCI√ìN: Usar Promise.all para paralelizar
                    const updates = productos.map(prod => 
                        supabase
                            .from('inventario')
                            .update({ stock_fisico: prod.stock_fisico })
                            .eq('variante', prod.variante)
                            .eq('ubicacion', prod.ubicacion)
                    );

                    await Promise.all(updates);

                    ocultarLoading();
                    mostrarToast('Stock actualizado correctamente', 'success');
                    cerrarModal('modalModificarMasivo');
                    await cargarInventario();
                    
                    event.target.value = '';
                } catch (error) {
                    ocultarLoading();
                    mostrarToast('Error al modificar: ' + error.message, 'error');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        async function procesarEliminarMasivo(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!confirm('¬øEst√°s seguro de eliminar estos productos? Esta acci√≥n es irreversible.')) {
                event.target.value = '';
                return;
            }

            mostrarLoading('Eliminando productos...', 'Procesando');

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    const productos = jsonData.map(row => ({
                        variante: String(row.Variante || '').trim().toUpperCase(),
                        ubicacion: String(row.Ubicacion || '').trim().toUpperCase()
                    })).filter(p => p.variante && p.ubicacion);

                    // CORRECCI√ìN: Agregar progreso
                    const total = productos.length;
                    let procesados = 0;
                    actualizarProgreso(0);

                    // CORRECCI√ìN: Usar Promise.all para paralelizar
                    const deletes = productos.map(async (prod) => {
                        const result = await supabase
                            .from('inventario')
                            .delete()
                            .eq('variante', prod.variante)
                            .eq('ubicacion', prod.ubicacion);
                        
                        procesados++;
                        actualizarProgreso((procesados / total) * 100);
                        return result;
                    });

                    await Promise.all(deletes);

                    ocultarLoading();
                    mostrarToast(`${productos.length} productos eliminados`, 'success');
                    cerrarModal('modalEliminarMasivo');
                    await cargarInventario();
                    
                    event.target.value = '';
                } catch (error) {
                    ocultarLoading();
                    mostrarToast('Error al eliminar: ' + error.message, 'error');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function exportarInventario() {
            if (inventario.length === 0) {
                mostrarToast('No hay datos para exportar', 'warning');
                return;
            }

            const data = inventario.map(item => ({
                'Variante': item.variante,
                'Ubicacion': item.ubicacion,
                'StockFisico': item.stock_fisico,
                'StockBloqueado': item.stock_bloqueado,
                'Disponible': (item.stock_fisico || 0) - (item.stock_bloqueado || 0)
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Inventario');
            XLSX.writeFile(wb, `Inventario_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            mostrarToast('Inventario exportado correctamente', 'success');
        }

        function exportarInventarioCompleto() {
            exportarInventario();
            toggleDropdownInventario();
        }

        function toggleDropdownInventario() {
            const dropdown = document.getElementById('dropdownInventario');
            dropdown.classList.toggle('active');
        }

        // ============================================
        // PRODUCTOS SYSTEM
        // ============================================
        function actualizarFiltrosCascada() {
            const generoSeleccionado = document.getElementById('filtroGenero')?.value || '';
            const lineaSeleccionada = document.getElementById('filtroLinea')?.value || '';
            const marcaSeleccionada = document.getElementById('filtroMarca')?.value || '';
            const tallaSeleccionada = document.getElementById('filtroTalla')?.value || '';

            let productosFiltrados = [...productosSystem];

            if (generoSeleccionado) {
                productosFiltrados = productosFiltrados.filter(p => (p.genero || '').toUpperCase() === generoSeleccionado.toUpperCase());
            }

            if (lineaSeleccionada) {
                productosFiltrados = productosFiltrados.filter(p => (p.linea || '').toUpperCase() === lineaSeleccionada.toUpperCase());
            }

            if (marcaSeleccionada) {
                productosFiltrados = productosFiltrados.filter(p => (p.marca || '').toUpperCase() === marcaSeleccionada.toUpperCase());
            }

            if (tallaSeleccionada) {
                productosFiltrados = productosFiltrados.filter(p => (p.talla || '').toString().toUpperCase() === tallaSeleccionada.toUpperCase());
            }

            const generos = [...new Set(productosSystem.map(p => p.genero).filter(Boolean))].sort();
            const lineas = [...new Set(productosFiltrados.map(p => p.linea).filter(Boolean))].sort();
            const marcas = [...new Set(productosFiltrados.map(p => p.marca).filter(Boolean))].sort();
            const tallas = [...new Set(productosFiltrados.map(p => p.talla).filter(Boolean))].sort();

            const selectGenero = document.getElementById('filtroGenero');
            const selectLinea = document.getElementById('filtroLinea');
            const selectMarca = document.getElementById('filtroMarca');
            const selectTalla = document.getElementById('filtroTalla');

            if (selectGenero && !generoSeleccionado) {
                selectGenero.innerHTML = '<option value="">Todos los G√©neros</option>' + 
                    generos.map(g => `<option value="${g}">${g}</option>`).join('');
            }

            if (selectLinea) {
                selectLinea.innerHTML = '<option value="">Todas las L√≠neas</option>' + 
                    lineas.map(l => `<option value="${l}">${l}</option>`).join('');
                if (lineaSeleccionada && lineas.includes(lineaSeleccionada)) {
                    selectLinea.value = lineaSeleccionada;
                }
            }

            if (selectMarca) {
                selectMarca.innerHTML = '<option value="">Todas las Marcas</option>' + 
                    marcas.map(m => `<option value="${m}">${m}</option>`).join('');
                if (marcaSeleccionada && marcas.includes(marcaSeleccionada)) {
                    selectMarca.value = marcaSeleccionada;
                }
            }

            if (selectTalla) {
                selectTalla.innerHTML = '<option value="">Todas las Tallas</option>' + 
                    tallas.map(t => `<option value="${t}">${t}</option>`).join('');
                if (tallaSeleccionada && tallas.includes(tallaSeleccionada)) {
                    selectTalla.value = tallaSeleccionada;
                }
            }

            renderizarProductosSystem();
        }

        function renderizarProductosSystem() {
            const searchTerm = document.getElementById('searchProductos').value.toLowerCase();
            const genero = document.getElementById('filtroGenero')?.value || '';
            const linea = document.getElementById('filtroLinea')?.value || '';
            const marca = document.getElementById('filtroMarca')?.value || '';
            const talla = document.getElementById('filtroTalla')?.value || '';

            let productosFiltrados = productosSystem.filter(producto => {
                const matchSearch = producto.variante.toLowerCase().includes(searchTerm);
                const matchGenero = !genero || (producto.genero || '').toUpperCase() === genero.toUpperCase();
                const matchLinea = !linea || (producto.linea || '').toUpperCase() === linea.toUpperCase();
                const matchMarca = !marca || (producto.marca || '').toUpperCase() === marca.toUpperCase();
                const matchTalla = !talla || (producto.talla || '').toString().toUpperCase() === talla.toUpperCase();
                
                return matchSearch && matchGenero && matchLinea && matchMarca && matchTalla;
            });

            const totalPaginas = Math.ceil(productosFiltrados.length / ITEMS_POR_PAGINA);
            const inicio = (paginaProductosSystem - 1) * ITEMS_POR_PAGINA;
            const fin = inicio + ITEMS_POR_PAGINA;
            const itemsPagina = productosFiltrados.slice(inicio, fin);

            const tbody = document.getElementById('tablaProductosSystem');
            
            if (itemsPagina.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center" style="padding: 3rem; color: var(--text-secondary);">
                            <i data-lucide="inbox" style="width: 48px; height: 48px; margin: 0 auto 1rem; display: block; opacity: 0.5;"></i>
                            No hay productos que coincidan con los filtros
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = itemsPagina.map(producto => `
                    <tr>
                        <td><strong>${producto.variante}</strong></td>
                        <td>${producto.genero || '-'}</td>
                        <td>${producto.linea || '-'}</td>
                        <td>${producto.marca || '-'}</td>
                        <td>${producto.talla || '-'}</td>
                        <td><strong style="color: var(--primary);">S/ ${parseFloat(producto.kardex || 0).toFixed(2)}</strong></td>
                        <td><strong style="color: var(--success);">S/ ${parseFloat(producto.pvp || 0).toFixed(2)}</strong></td>
                    </tr>
                `).join('');
            }

            document.getElementById('paginaActualProductos').textContent = paginaProductosSystem;
            document.getElementById('totalPaginasProductos').textContent = totalPaginas || 1;
            
            document.getElementById('btnPrevProductos').disabled = paginaProductosSystem === 1;
            document.getElementById('btnNextProductos').disabled = paginaProductosSystem >= totalPaginas;

            lucide.createIcons();
        }

        function cambiarPaginaProductos(direccion) {
            paginaProductosSystem += direccion;
            renderizarProductosSystem();
        }

        document.getElementById('searchProductos').addEventListener('input', () => {
            clearTimeout(searchProductosTimeout);
            searchProductosTimeout = setTimeout(() => {
                paginaProductosSystem = 1;
                renderizarProductosSystem();
            }, 300);
        });

        async function procesarProductosSystem(event) {
            const file = event.target.files[0];
            if (!file) return;

            mostrarLoading('Procesando cat√°logo...', 'Limpiando datos existentes');

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    const { error: deleteError } = await supabase
                        .from('productos_system')
                        .delete()
                        .neq('variante', '');

                    if (deleteError) throw deleteError;

                    const productos = jsonData.map(row => ({
                        variante: String(row.variante || row.Variante || '').trim().toUpperCase(),
                        kardex: parseFloat(row.kardex || row.Kardex || 0),
                        pvp: parseFloat(row.pvp || row.PVP || row.Pvp || 0),
                        genero: String(row.genero || row.Genero || '').trim(),
                        linea: String(row.linea || row.Linea || '').trim(),
                        marca: String(row.marca || row.Marca || '').trim(),
                        talla: String(row.talla || row.Talla || '').trim(),
                        color: String(row.color || row.Color || '').trim(),
                        modelo: String(row.modelo || row.Modelo || '').trim(),
                        temporada: String(row.temporada || row.Temporada || '').trim(),
                        categoria: String(row.categoria || row.Categoria || '').trim(),
                        subcategoria: String(row.subcategoria || row.Subcategoria || '').trim(),
                        proveedor: String(row.proveedor || row.Proveedor || '').trim()
                    })).filter(p => p.variante);

                    mostrarLoading('Cargando productos...', `Insertando ${productos.length} productos`);

                    actualizarProgreso(0);
                    const total = productos.length;
                    let procesados = 0;

                    for (let i = 0; i < productos.length; i += BATCH_SIZE) {
                        const batch = productos.slice(i, i + BATCH_SIZE);
                        
                        const { error } = await supabase
                            .from('productos_system')
                            .insert(batch);

                        if (error) throw error;

                        procesados += batch.length;
                        const progreso = (procesados / total) * 100;
                        actualizarProgreso(progreso);
                    }

                    ocultarLoading();
                    mostrarToast(`Cat√°logo actualizado: ${productos.length} productos`, 'success');
                    cerrarModal('modalSubirProductos');
                    await cargarProductosSystem();
                    
                    event.target.value = '';
                } catch (error) {
                    ocultarLoading();
                    mostrarToast('Error al cargar cat√°logo: ' + error.message, 'error');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function exportarProductosSystem() {
            if (productosSystem.length === 0) {
                mostrarToast('No hay productos para exportar', 'warning');
                return;
            }

            const ws = XLSX.utils.json_to_sheet(productosSystem);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Productos');
            XLSX.writeFile(wb, `ProductosSystem_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            mostrarToast('Cat√°logo exportado correctamente', 'success');
        }

        // ============================================
        // √ìRDENES (CORREGIDO: bloqueo con validaci√≥n DB)
        // ============================================
        function renderizarOrdenes() {
            const tbody = document.getElementById('tablaOrdenes');
            
            if (ordenes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center" style="padding: 3rem; color: var(--text-secondary);">
                            <i data-lucide="inbox" style="width: 48px; height: 48px; margin: 0 auto 1rem; display: block; opacity: 0.5;"></i>
                            No hay √≥rdenes registradas
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = ordenes.map(orden => {
                    const dias = diasTranscurridos(orden.fecha);
                    const badge = obtenerBadgeEstado(orden.estado);
                    const variantesCount = orden.items ? orden.items.length : 0;
                    const unidadesTotal = calcularUnidadesOrden(orden);
                    
                    return `
                        <tr>
                            <td><strong>${orden.id}</strong></td>
                            <td>${formatearFechaPeru(orden.fecha)}</td>
                            <td>${variantesCount}</td>
                            <td><strong>${unidadesTotal}</strong></td>
                            <td>
                                <span class="badge ${dias > DIAS_EXPIRACION_ORDEN ? 'badge-danger' : dias > DIAS_ALERTA_TEMPRANA ? 'badge-warning' : 'badge-success'}">
                                    ${dias} d√≠a${dias !== 1 ? 's' : ''}
                                </span>
                            </td>
                            <td>${badge}</td>
                            <td>
                                <button class="btn btn-outline btn-icon" onclick="verOrdenDetalle('${orden.id}')" title="Ver detalle">
                                    <i data-lucide="eye" style="width: 14px; height: 14px;"></i>
                                </button>
                                ${orden.estado === 'Pendiente Picking' || orden.estado === 'Expirada' ? `
                                    <button class="btn btn-danger btn-icon" onclick="eliminarOrden('${orden.id}')" title="Eliminar">
                                        <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            lucide.createIcons();
        }

        function verificarOrdenesProximas() {
            const ordenesProximas = ordenes.filter(orden => {
                const dias = diasTranscurridos(orden.fecha);
                return ['Pendiente Picking', 'En Picking', 'Pendiente Packing'].includes(orden.estado) && 
                       dias >= DIAS_ALERTA_TEMPRANA;
            });

            const alerta = document.getElementById('alertaOrdenesProximas');
            if (ordenesProximas.length > 0) {
                alerta.style.display = 'flex';
                document.getElementById('alertaOrdenesTexto').textContent = 
                    `${ordenesProximas.length} orden${ordenesProximas.length !== 1 ? 'es' : ''} pr√≥xima${ordenesProximas.length !== 1 ? 's' : ''} a expirar`;
                
                const notificationDot = document.getElementById('notificationDot');
                if (notificationDot) notificationDot.style.display = 'block';
            } else {
                alerta.style.display = 'none';
            }
        }

        async function procesarOrdenManual(event) {
            const file = event.target.files[0];
            if (!file) return;

            mostrarLoading('Procesando orden...', 'Leyendo hoja de ruta');

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    if (jsonData.length === 0) {
                        ocultarLoading();
                        mostrarToast('El archivo est√° vac√≠o', 'error');
                        return;
                    }

                    const hojaRuta = consolidarHojaRuta(jsonData);
                    
                    // CORRECCI√ìN: Verificar y bloquear con validaci√≥n DB
                    const resultadoBloqueo = await bloquearStockOrdenConValidacion(hojaRuta);
                    
                    if (!resultadoBloqueo.exito) {
                        ocultarLoading();
                        mostrarToast(resultadoBloqueo.mensaje, 'error');
                        return;
                    }

                    const nuevaOrden = {
                        id: generarIdOrden(),
                        fecha: new Date().toISOString(),
                        estado: 'Pendiente Picking',
                        items: hojaRuta,
                        cantidadesEncontradas: {},
                        hojaPacking: [],
                        prendasRechazadas: 0
                    };

                    const { error } = await supabase
                        .from('ordenes')
                        .insert(nuevaOrden);

                    if (error) throw error;

                    ocultarLoading();
                    mostrarToast('Orden creada correctamente', 'success');
                    cerrarModal('modalCrearOrden');
                    await cargarOrdenes();
                    await cargarInventario();
                    actualizarDashboard();
                    
                    event.target.value = '';
                } catch (error) {
                    ocultarLoading();
                    mostrarToast('Error al crear orden: ' + error.message, 'error');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function consolidarHojaRuta(jsonData) {
            const consolidado = {};

            for (const row of jsonData) {
                const variante = String(row.Variante || '').trim().toUpperCase();
                const ubicacion = String(row.Ubicacion || row.ubicacion || '').trim().toUpperCase();
                
                if (!variante || !ubicacion) continue;

                const key = `${variante}|${ubicacion}`;

                if (!consolidado[key]) {
                    consolidado[key] = {
                        variante: variante,
                        ubicaciones: []
                    };
                }

                let cantidadTotal = 0;
                const distribucion = {};

                TIENDAS_LUKERS.forEach(tienda => {
                    const cantidad = parseInt(row[tienda] || 0);
                    distribucion[tienda] = cantidad;
                    cantidadTotal += cantidad;
                });

                if (cantidadTotal > 0) {
                    consolidado[key].ubicaciones.push({
                        ubicacion: ubicacion,
                        cantidadSolicitada: cantidadTotal,
                        distribucion: distribucion
                    });
                }
            }

            return Object.values(consolidado);
        }

        // CORRECCI√ìN: Bloqueo con validaci√≥n en DB
        async function bloquearStockOrdenConValidacion(hojaRuta) {
            try {
                for (const item of hojaRuta) {
                    for (const ub of item.ubicaciones) {
                        // Obtener stock actual directamente de DB
                        const { data: itemDB, error } = await supabase
                            .from('inventario')
                            .select('*')
                            .eq('variante', item.variante)
                            .eq('ubicacion', ub.ubicacion)
                            .single();

                        if (error || !itemDB) {
                            return { 
                                exito: false, 
                                mensaje: `No existe ${item.variante} en ${ub.ubicacion}` 
                            };
                        }

                        const disponible = (itemDB.stock_fisico || 0) - (itemDB.stock_bloqueado || 0);
                        
                        if (disponible < ub.cantidadSolicitada) {
                            return { 
                                exito: false, 
                                mensaje: `Stock insuficiente para ${item.variante} en ${ub.ubicacion}. Disponible: ${disponible}, Solicitado: ${ub.cantidadSolicitada}` 
                            };
                        }

                        // Actualizar con el nuevo stock bloqueado
                        const nuevoStockBloqueado = (itemDB.stock_bloqueado || 0) + ub.cantidadSolicitada;
                        
                        const { error: updateError } = await supabase
                            .from('inventario')
                            .update({ stock_bloqueado: nuevoStockBloqueado })
                            .eq('variante', item.variante)
                            .eq('ubicacion', ub.ubicacion);

                        if (updateError) throw updateError;
                    }
                }

                return { exito: true };
            } catch (error) {
                return { exito: false, mensaje: error.message };
            }
        }

        // CORRECCI√ìN: Liberar stock correctamente al eliminar
        async function eliminarOrden(ordenId) {
            if (!confirm('¬øEliminar esta orden? Se liberar√° el stock bloqueado.')) return;

            mostrarLoading('Eliminando orden...', 'Liberando stock');

            try {
                const orden = ordenes.find(o => o.id === ordenId);
                if (!orden) return;

                // Liberar stock bloqueado
                for (const item of orden.items) {
                    for (const ub of item.ubicaciones) {
                        // CORRECCI√ìN: Obtener stock actual de DB
                        const { data: itemDB } = await supabase
                            .from('inventario')
                            .select('*')
                            .eq('variante', item.variante)
                            .eq('ubicacion', ub.ubicacion)
                            .single();

                        if (itemDB) {
                            const nuevoStockBloqueado = Math.max(0, (itemDB.stock_bloqueado || 0) - ub.cantidadSolicitada);
                            
                            await supabase
                                .from('inventario')
                                .update({ stock_bloqueado: nuevoStockBloqueado })
                                .eq('variante', item.variante)
                                .eq('ubicacion', ub.ubicacion);
                        }
                    }
                }

                await supabase
                    .from('ordenes')
                    .delete()
                    .eq('id', ordenId);

                ocultarLoading();
                mostrarToast('Orden eliminada', 'success');
                await cargarOrdenes();
                await cargarInventario();
                actualizarDashboard();
            } catch (error) {
                ocultarLoading();
                mostrarToast('Error: ' + error.message, 'error');
            }
        }

        function verOrdenDetalle(ordenId) {
            const orden = ordenes.find(o => o.id === ordenId);
            if (!orden) return;

            document.getElementById('ordenDetalleId').textContent = orden.id;
            
            let html = `
                <div style="margin-bottom: 1.5rem;">
                    <div class="form-row">
                        <div>
                            <label style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem;">Fecha Creaci√≥n</label>
                            <div style="font-weight: 600;">${formatearFechaPeru(orden.fecha)}</div>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem;">Estado</label>
                            <div>${obtenerBadgeEstado(orden.estado)}</div>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem;">D√≠as Transcurridos</label>
                            <div style="font-weight: 600;">${diasTranscurridos(orden.fecha)} d√≠as</div>
                        </div>
                    </div>
                </div>

                <h4 style="margin-bottom: 1rem; font-size: 1rem;">Productos Solicitados</h4>
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Variante</th>
                                <th>Ubicaci√≥n</th>
                                <th>Solicitado</th>
                                <th>Encontrado</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            for (const item of orden.items) {
                for (const ub of item.ubicaciones) {
                    const key = `${item.variante}|${ub.ubicacion}`;
                    const encontrado = orden.cantidadesEncontradas[key] || '-';
                    
                    html += `
                        <tr>
                            <td><strong>${item.variante}</strong></td>
                            <td><span class="badge badge-info">${ub.ubicacion}</span></td>
                            <td>${ub.cantidadSolicitada}</td>
                            <td><strong>${encontrado}</strong></td>
                        </tr>
                    `;
                }
            }

            html += `
                        </tbody>
                    </table>
                </div>
            `;

            if (orden.hojaPacking && orden.hojaPacking.length > 0) {
                html += `
                    <h4 style="margin-top: 2rem; margin-bottom: 1rem; font-size: 1rem;">Distribuci√≥n por Tienda</h4>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Variante</th>
                                    ${TIENDAS_LUKERS.map(t => `<th>${t.replace('LUKERS ', '')}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                `;

                for (const fila of orden.hojaPacking) {
                    html += `<tr><td><strong>${fila.variante}</strong></td>`;
                    TIENDAS_LUKERS.forEach(tienda => {
                        html += `<td>${fila[tienda] || 0}</td>`;
                    });
                    html += `</tr>`;
                }

                html += `
                            </tbody>
                        </table>
                    </div>
                `;
            }

            document.getElementById('ordenDetalleContenido').innerHTML = html;
            abrirModal('modalVerOrden');
            lucide.createIcons();
        }

        // ============================================
        // PICKING
        // ============================================
        function renderizarPicking() {
            const ordenesPicking = ordenes.filter(o => 
                o.estado === 'Pendiente Picking' || o.estado === 'En Picking'
            );

            const tbody = document.getElementById('tablaPicking');
            
            if (ordenesPicking.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center" style="padding: 3rem; color: var(--text-secondary);">
                            <i data-lucide="inbox" style="width: 48px; height: 48px; margin: 0 auto 1rem; display: block; opacity: 0.5;"></i>
                            No hay √≥rdenes pendientes de picking
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = ordenesPicking.map(orden => {
                    const variantesCount = orden.items ? orden.items.length : 0;
                    const unidadesTotal = calcularUnidadesOrden(orden);
                    
                    return `
                        <tr>
                            <td><strong>${orden.id}</strong></td>
                            <td>${formatearFechaPeru(orden.fecha)}</td>
                            <td>${variantesCount}</td>
                            <td><strong>${unidadesTotal}</strong></td>
                            <td>${obtenerBadgeEstado(orden.estado)}</td>
                            <td>
                                ${orden.estado === 'Pendiente Picking' ? `
                                    <button class="btn btn-primary" onclick="descargarHojaPicking('${orden.id}')">
                                        <i data-lucide="download" style="width: 14px; height: 14px;"></i>
                                        Descargar Hoja Ruta
                                    </button>
                                    <button class="btn btn-success" onclick="iniciarPicking('${orden.id}')">
                                        <i data-lucide="play" style="width: 14px; height: 14px;"></i>
                                        Iniciar
                                    </button>
                                ` : ''}
                                ${orden.estado === 'En Picking' ? `
                                    <button class="btn btn-warning" onclick="abrirModalSubirCantidades('${orden.id}')">
                                        <i data-lucide="upload" style="width: 14px; height: 14px;"></i>
                                        Subir Cantidades
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            lucide.createIcons();
        }

        async function iniciarPicking(ordenId) {
            mostrarLoading('Iniciando picking...', 'Actualizando estado');

            await supabase
                .from('ordenes')
                .update({ estado: 'En Picking' })
                .eq('id', ordenId);

            ocultarLoading();
            mostrarToast('Picking iniciado', 'success');
            await cargarOrdenes();
        }

        function descargarHojaPicking(ordenId) {
            const orden = ordenes.find(o => o.id === ordenId);
            if (!orden) return;

            const data = [];

            for (const item of orden.items) {
                for (const ub of item.ubicaciones) {
                    const row = {
                        'Variante': item.variante,
                        'Ubicacion': ub.ubicacion,
                        'Solicitado': ub.cantidadSolicitada,
                        'Encontrado': ''
                    };

                    TIENDAS_LUKERS.forEach(tienda => {
                        row[tienda] = ub.distribucion[tienda] || 0;
                    });

                    data.push(row);
                }
            }

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'HojaRuta');
            XLSX.writeFile(wb, `HojaPicking_${ordenId}.xlsx`);
            
            mostrarToast('Hoja de picking descargada', 'success');
        }

        let ordenIdActualPicking = null;

        function abrirModalSubirCantidades(ordenId) {
            ordenIdActualPicking = ordenId;
            abrirModal('modalSubirCantidades');
        }

        function confirmarSubirCantidades() {
            const fileInput = document.getElementById('fileCantidades');
            const file = fileInput.files[0];
            
            if (!file) {
                mostrarToast('Selecciona un archivo Excel', 'error');
                return;
            }

            procesarCantidadesEncontradas(file, ordenIdActualPicking);
        }

        async function procesarCantidadesEncontradas(file, ordenId) {
            mostrarLoading('Procesando cantidades encontradas...', 'Leyendo archivo');

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    const orden = ordenes.find(o => o.id === ordenId);
                    if (!orden) throw new Error('Orden no encontrada');

                    const cantidadesEncontradas = {};

                    for (const row of jsonData) {
                        const variante = String(row.Variante || '').trim().toUpperCase();
                        const ubicacion = String(row.Ubicacion || '').trim().toUpperCase();
                        const encontrado = parseInt(row.Encontrado || 0);

                        if (variante && ubicacion) {
                            const key = `${variante}|${ubicacion}`;
                            cantidadesEncontradas[key] = encontrado;
                        }
                    }

                    const hojaPacking = generarHojaPacking(orden, cantidadesEncontradas);

                    await supabase
                        .from('ordenes')
                        .update({
                            cantidadesEncontradas: cantidadesEncontradas,
                            hojaPacking: hojaPacking,
                            estado: 'Pendiente Packing'
                        })
                        .eq('id', ordenId);

                    ocultarLoading();
                    mostrarToast('Cantidades procesadas. Hoja de packing generada.', 'success');
                    cerrarModal('modalSubirCantidades');
                    document.getElementById('fileCantidades').value = '';
                    await cargarOrdenes();
                } catch (error) {
                    ocultarLoading();
                    mostrarToast('Error al procesar: ' + error.message, 'error');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function generarHojaPacking(orden, cantidadesEncontradas) {
            const hojaPacking = [];

            for (const item of orden.items) {
                const variante = item.variante;
                
                let totalSolicitado = 0;
                let totalEncontrado = 0;
                const distribucionOriginal = {};

                for (const ub of item.ubicaciones) {
                    const key = `${variante}|${ub.ubicacion}`;
                    const encontrado = cantidadesEncontradas[key] || 0;
                    
                    totalSolicitado += ub.cantidadSolicitada;
                    totalEncontrado += encontrado;

                    TIENDAS_LUKERS.forEach(tienda => {
                        distribucionOriginal[tienda] = (distribucionOriginal[tienda] || 0) + (ub.distribucion[tienda] || 0);
                    });
                }

                const distribucionAjustada = {};
                
                if (totalEncontrado > 0 && totalSolicitado > 0) {
                    const factor = totalEncontrado / totalSolicitado;
                    
                    TIENDAS_LUKERS.forEach(tienda => {
                        distribucionAjustada[tienda] = Math.floor((distribucionOriginal[tienda] || 0) * factor);
                    });

                    let sumaAjustada = Object.values(distribucionAjustada).reduce((a, b) => a + b, 0);
                    const diferencia = totalEncontrado - sumaAjustada;
                    
                    if (diferencia > 0) {
                        const tiendaMayor = TIENDAS_LUKERS.reduce((prev, curr) => 
                            distribucionOriginal[curr] > distribucionOriginal[prev] ? curr : prev
                        );
                        distribucionAjustada[tiendaMayor] += diferencia;
                    }
                }

                const producto = productosSystem.find(p => p.variante === variante);
                const kardex = producto ? parseFloat(producto.kardex || 0) : 0;
                const primeraUbicacion = item.ubicaciones[0]?.ubicacion || '';

                hojaPacking.push({
                    variante: variante,
                    ubicacion: primeraUbicacion,
                    kardex: kardex,
                    encontrado: totalEncontrado,
                    ...distribucionAjustada
                });
            }

            return hojaPacking;
        }

// CONTIN√öA EN MENSAJE SIGUIENTE (Packing, Reclasificaci√≥n y Utilidades)...
        // ============================================
        // PACKING
        // ============================================
        function renderizarPacking() {
            const ordenesPacking = ordenes.filter(o => o.estado === 'Pendiente Packing');

            const tbody = document.getElementById('tablaPacking');
            
            if (ordenesPacking.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center" style="padding: 3rem; color: var(--text-secondary);">
                            <i data-lucide="inbox" style="width: 48px; height: 48px; margin: 0 auto 1rem; display: block; opacity: 0.5;"></i>
                            No hay √≥rdenes pendientes de packing
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = ordenesPacking.map(orden => {
                    const variantesEncontradas = Object.keys(orden.cantidadesEncontradas || {}).length;
                    const unidadesEncontradas = Object.values(orden.cantidadesEncontradas || {}).reduce((sum, val) => sum + val, 0);
                    
                    return `
                        <tr>
                            <td><strong>${orden.id}</strong></td>
                            <td>${formatearFechaPeru(orden.fecha)}</td>
                            <td>${variantesEncontradas}</td>
                            <td><strong>${unidadesEncontradas}</strong></td>
                            <td>${obtenerBadgeEstado(orden.estado)}</td>
                            <td>
                                <button class="btn btn-primary" onclick="descargarHojaPackingSugerida('${orden.id}')">
                                    <i data-lucide="download" style="width: 14px; height: 14px;"></i>
                                    Descargar Sugerencia
                                </button>
                                <button class="btn btn-success" onclick="abrirModalSubirPacking('${orden.id}')">
                                    <i data-lucide="upload" style="width: 14px; height: 14px;"></i>
                                    Subir Packing Real
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            lucide.createIcons();
        }

        function descargarHojaPackingSugerida(ordenId) {
            const orden = ordenes.find(o => o.id === ordenId);
            if (!orden || !orden.hojaPacking) return;

            const data = orden.hojaPacking.map(fila => {
                const row = {
                    'Variante': fila.variante,
                    'Ubicacion': fila.ubicacion,
                    'Kardex': fila.kardex,
                    'Encontrado': fila.encontrado
                };

                TIENDAS_LUKERS.forEach(tienda => {
                    row[tienda] = fila[tienda] || 0;
                });

                return row;
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'PackingSugerido');
            XLSX.writeFile(wb, `HojaPackingSugerida_${ordenId}.xlsx`);
            
            mostrarToast('Hoja de packing sugerida descargada', 'success');
        }

        let ordenIdActualPacking = null;

        function abrirModalSubirPacking(ordenId) {
            ordenIdActualPacking = ordenId;
            abrirModal('modalSubirExcelPacking');
        }

        function confirmarSubirPacking() {
            const fileInput = document.getElementById('filePackingReal');
            const file = fileInput.files[0];
            
            if (!file) {
                mostrarToast('Selecciona un archivo Excel', 'error');
                return;
            }

            procesarExcelPacking(file, ordenIdActualPacking);
        }

        async function procesarExcelPacking(file, ordenId) {
            mostrarLoading('Procesando packing real...', 'Leyendo distribuci√≥n');

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    const orden = ordenes.find(o => o.id === ordenId);
                    if (!orden) throw new Error('Orden no encontrada');

                    const variantesEmpaquetadas = new Set();
                    const hojaPackingFinal = [];

                    for (const row of jsonData) {
                        const variante = String(row.Variante || '').trim().toUpperCase();
                        const ubicacion = String(row.Ubicacion || '').trim().toUpperCase();
                        
                        if (!variante || !ubicacion) continue;

                        variantesEmpaquetadas.add(variante);

                        const distribucion = {};
                        let total = 0;

                        TIENDAS_LUKERS.forEach(tienda => {
                            const cantidad = parseInt(row[tienda] || 0);
                            distribucion[tienda] = cantidad;
                            total += cantidad;
                        });

                        const producto = productosSystem.find(p => p.variante === variante);
                        const kardex = producto ? parseFloat(producto.kardex || 0) : 0;

                        hojaPackingFinal.push({
                            variante: variante,
                            ubicacion: ubicacion,
                            kardex: kardex,
                            encontrado: total,
                            ...distribucion
                        });
                    }

                    // Detectar variantes NO empaquetadas
                    variantesNoEmpaquetadas = [];
                    
                    for (const item of orden.items) {
                        for (const ub of item.ubicaciones) {
                            const key = `${item.variante}|${ub.ubicacion}`;
                            const encontrado = orden.cantidadesEncontradas[key] || 0;
                            
                            if (encontrado > 0 && !variantesEmpaquetadas.has(item.variante)) {
                                variantesNoEmpaquetadas.push({
                                    variante: item.variante,
                                    ubicacion: ub.ubicacion,
                                    cantidad: encontrado,
                                    ordenId: ordenId
                                });
                            }
                        }
                    }

                    ocultarLoading();

                    if (variantesNoEmpaquetadas.length > 0) {
                        ordenActualPacking = orden;
                        orden.hojaPacking = hojaPackingFinal;
                        indiceReclasificacionActual = 0;
                        
                        cerrarModal('modalSubirExcelPacking');
                        document.getElementById('filePackingReal').value = '';
                        
                        mostrarToast(`${variantesNoEmpaquetadas.length} producto(s) requieren reclasificaci√≥n`, 'warning');
                        mostrarModalReclasificacionInmediata();
                    } else {
                        await cerrarOrdenDirectamente(orden, hojaPackingFinal);
                        cerrarModal('modalSubirExcelPacking');
                        document.getElementById('filePackingReal').value = '';
                    }
                } catch (error) {
                    ocultarLoading();
                    mostrarToast('Error al procesar packing: ' + error.message, 'error');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        // CORRECCI√ìN: Desbloquear y descontar correctamente
        async function cerrarOrdenDirectamente(orden, hojaPackingFinal) {
            mostrarLoading('Cerrando orden...', 'Finalizando proceso');

            try {
                let montoTotal = 0;
                for (const fila of hojaPackingFinal) {
                    let cantidadTotal = 0;
                    TIENDAS_LUKERS.forEach(tienda => {
                        cantidadTotal += fila[tienda] || 0;
                    });
                    montoTotal += cantidadTotal * (fila.kardex || 0);
                }

                // CORRECCI√ìN: Desbloquear correctamente seg√∫n lo encontrado
                for (const item of orden.items) {
                    for (const ub of item.ubicaciones) {
                        const key = `${item.variante}|${ub.ubicacion}`;
                        const encontrado = orden.cantidadesEncontradas[key] || 0;

                        // Obtener stock actual de DB
                        const { data: itemDB } = await supabase
                            .from('inventario')
                            .select('*')
                            .eq('variante', item.variante)
                            .eq('ubicacion', ub.ubicacion)
                            .single();

                        if (itemDB) {
                            // Descontar lo encontrado del f√≠sico
                            const nuevoStockFisico = Math.max(0, (itemDB.stock_fisico || 0) - encontrado);
                            
                            // Desbloquear lo solicitado
                            const nuevoStockBloqueado = Math.max(0, (itemDB.stock_bloqueado || 0) - ub.cantidadSolicitada);

                            await supabase
                                .from('inventario')
                                .update({
                                    stock_fisico: nuevoStockFisico,
                                    stock_bloqueado: nuevoStockBloqueado
                                })
                                .eq('variante', item.variante)
                                .eq('ubicacion', ub.ubicacion);
                        }
                    }
                }

                await supabase
                    .from('ordenes')
                    .update({
                        estado: 'Completada',
                        fechaCierre: new Date().toISOString(),
                        hojaPacking: hojaPackingFinal,
                        montoTotal: montoTotal,
                        prendasRechazadas: orden.prendasRechazadas || 0
                    })
                    .eq('id', orden.id);

                ocultarLoading();
                mostrarToast('Orden completada correctamente', 'success');
                await cargarOrdenes();
                await cargarInventario();
                actualizarDashboard();
                actualizarKPIs();
                generarGraficas();
            } catch (error) {
                ocultarLoading();
                mostrarToast('Error al cerrar orden: ' + error.message, 'error');
            }
        }

        // ============================================
        // RECLASIFICACI√ìN INMEDIATA (PASO A PASO)
        // ============================================
        function mostrarModalReclasificacionInmediata() {
            if (indiceReclasificacionActual >= variantesNoEmpaquetadas.length) {
                finalizarReclasificacionesYCerrarOrden();
                return;
            }

            const item = variantesNoEmpaquetadas[indiceReclasificacionActual];
            
            document.getElementById('reclasVariante').value = item.variante;
            document.getElementById('reclasUbicacion').value = item.ubicacion;
            document.getElementById('reclasCantidad').value = item.cantidad;
            document.getElementById('reclasMotivo').value = '';
            document.getElementById('reclasNuevaVariante').value = '';
            document.getElementById('reclasComentario').value = '';
            
            document.getElementById('grupoNuevaVariante').style.display = 'none';
            document.getElementById('grupoMalEstado').style.display = 'none';
            
            document.getElementById('progresoReclasificacion').textContent = 
                `${indiceReclasificacionActual + 1} / ${variantesNoEmpaquetadas.length}`;
            
            const esUltimo = indiceReclasificacionActual === variantesNoEmpaquetadas.length - 1;
            document.getElementById('btnTextoReclasificar').textContent = esUltimo ? 'Finalizar y Cerrar Orden' : 'Siguiente';
            
            abrirModal('modalReclasificacionInmediata');
        }

        function toggleVarianteNueva() {
            const motivo = document.getElementById('reclasMotivo').value;
            const grupoNuevaVariante = document.getElementById('grupoNuevaVariante');
            const grupoMalEstado = document.getElementById('grupoMalEstado');

            if (motivo === 'mal_estado') {
                grupoNuevaVariante.style.display = 'none';
                grupoMalEstado.style.display = 'block';
            } else if (motivo) {
                grupoNuevaVariante.style.display = 'block';
                grupoMalEstado.style.display = 'none';
            } else {
                grupoNuevaVariante.style.display = 'none';
                grupoMalEstado.style.display = 'none';
            }
        }

        async function procesarReclasificacionInmediata() {
            const motivo = document.getElementById('reclasMotivo').value;
            const comentario = document.getElementById('reclasComentario').value.trim();

            if (!motivo || !comentario) {
                mostrarToast('Completa todos los campos obligatorios', 'error');
                return;
            }

            const item = variantesNoEmpaquetadas[indiceReclasificacionActual];
            let nuevaVariante = '';
            let nuevaUbicacion = '';

            if (motivo === 'mal_estado') {
                nuevaVariante = item.variante;
                nuevaUbicacion = '191';
            } else {
                nuevaVariante = document.getElementById('reclasNuevaVariante').value.trim().toUpperCase();
                if (!nuevaVariante) {
                    mostrarToast('Ingresa la nueva variante correcta', 'error');
                    return;
                }
                nuevaUbicacion = '999-PENDIENTE';
            }

            mostrarLoading('Procesando reclasificaci√≥n...', 'Guardando cambios');

            try {
                // Crear/actualizar registro en inventario temporal
                await supabase
                    .from('inventario')
                    .upsert({
                        variante: nuevaVariante,
                        ubicacion: nuevaUbicacion,
                        stock_fisico: item.cantidad,
                        stock_bloqueado: 0
                    }, { onConflict: ['variante', 'ubicacion'] });

                // Crear registro en tabla reclasificacion
                await supabase
                    .from('reclasificacion')
                    .insert({
                        varianteOriginal: item.variante,
                        nuevaVariante: nuevaVariante,
                        ubicacion: nuevaUbicacion,
                        cantidad: item.cantidad,
                        motivo: motivo,
                        comentario: comentario,
                        estado: 'Pendiente',
                        fecha: new Date().toISOString(),
                        ordenId: item.ordenId
                    });

                // CORRECCI√ìN: Descontar del stock original de forma segura
                const { data: itemInventarioOriginal } = await supabase
                    .from('inventario')
                    .select('*')
                    .eq('variante', item.variante)
                    .eq('ubicacion', item.ubicacion)
                    .single();

                if (itemInventarioOriginal) {
                    const nuevoStockFisico = Math.max(0, (itemInventarioOriginal.stock_fisico || 0) - item.cantidad);
                    
                    await supabase
                        .from('inventario')
                        .update({ stock_fisico: nuevoStockFisico })
                        .eq('variante', item.variante)
                        .eq('ubicacion', item.ubicacion);
                }

                // Incrementar contador de prendas rechazadas en la orden
                if (ordenActualPacking) {
                    const prendasRechazadas = (ordenActualPacking.prendasRechazadas || 0) + item.cantidad;
                    ordenActualPacking.prendasRechazadas = prendasRechazadas;
                }

                ocultarLoading();
                indiceReclasificacionActual++;
                
                cerrarModal('modalReclasificacionInmediata');
                
                setTimeout(() => {
                    mostrarModalReclasificacionInmediata();
                }, 300);

            } catch (error) {
                ocultarLoading();
                mostrarToast('Error al reclasificar: ' + error.message, 'error');
            }
        }

        // CORRECCI√ìN: Nueva funci√≥n para cancelar reclasificaci√≥n
        async function cancelarReclasificacionCompleta() {
            if (!confirm('¬øCancelar todas las reclasificaciones? La orden NO se cerrar√°.')) return;

            cerrarModal('modalReclasificacionInmediata');
            
            ordenActualPacking = null;
            variantesNoEmpaquetadas = [];
            indiceReclasificacionActual = 0;
            
            mostrarToast('Reclasificaci√≥n cancelada. Completa el proceso m√°s tarde.', 'info');
        }

        async function finalizarReclasificacionesYCerrarOrden() {
            if (!ordenActualPacking) return;

            await cerrarOrdenDirectamente(ordenActualPacking, ordenActualPacking.hojaPacking);
            
            ordenActualPacking = null;
            variantesNoEmpaquetadas = [];
            indiceReclasificacionActual = 0;
        }

        // ============================================
        // RECLASIFICACI√ìN (VISTA)
        // ============================================
        function renderizarReclasificacion() {
            const tbody = document.getElementById('tablaReclasificacion');
            const searchTerm = document.getElementById('searchReclasificacion')?.value.toLowerCase() || '';
            
            let itemsFiltrados = itemsReclasificacion.filter(item => {
                return item.varianteOriginal.toLowerCase().includes(searchTerm) ||
                       (item.nuevaVariante || '').toLowerCase().includes(searchTerm) ||
                       item.ubicacion.toLowerCase().includes(searchTerm);
            });

            if (itemsFiltrados.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center" style="padding: 3rem; color: var(--text-secondary);">
                            <i data-lucide="inbox" style="width: 48px; height: 48px; margin: 0 auto 1rem; display: block; opacity: 0.5;"></i>
                            No hay productos en reclasificaci√≥n
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = itemsFiltrados.map(item => {
                    const motivoTexto = {
                        'mal_estado': 'Mal Estado',
                        'no_corresponde_linea': 'No Corresponde L√≠nea',
                        'no_corresponde_genero': 'No Corresponde G√©nero',
                        'no_corresponde_talla': 'No Corresponde Talla'
                    }[item.motivo] || item.motivo;

                    const badgeEstado = item.estado === 'Completada' 
                        ? '<span class="badge badge-success">Completada</span>'
                        : '<span class="badge badge-warning">Pendiente</span>';

                    return `
                        <tr>
                            <td><strong>#${item.id}</strong></td>
                            <td>${item.varianteOriginal}</td>
                            <td>${item.nuevaVariante || '-'}</td>
                            <td><span class="badge badge-info">${item.ubicacion}</span></td>
                            <td>${item.cantidad}</td>
                            <td><span class="badge badge-purple">${motivoTexto}</span></td>
                            <td>${badgeEstado}</td>
                            <td>
                                <button class="btn btn-outline btn-icon" onclick="verComentarioReclasificacion(${item.id})" title="Ver comentario">
                                    <i data-lucide="message-square" style="width: 14px; height: 14px;"></i>
                                </button>
                                ${item.estado === 'Pendiente' ? `
                                    <button class="btn btn-success btn-icon" onclick="abrirCompletarReclasificacion(${item.id})" title="Completar">
                                        <i data-lucide="check" style="width: 14px; height: 14px;"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            lucide.createIcons();
        }

        document.getElementById('searchReclasificacion')?.addEventListener('input', () => {
            clearTimeout(searchReclasificacionTimeout);
            searchReclasificacionTimeout = setTimeout(() => {
                renderizarReclasificacion();
            }, 300);
        });

        function verComentarioReclasificacion(itemId) {
            const item = itemsReclasificacion.find(i => i.id === itemId);
            if (!item) return;

            document.getElementById('comentarioContenido').textContent = item.comentario || 'Sin comentario';
            abrirModal('modalVerComentario');
        }

        function abrirCompletarReclasificacion(itemId) {
            const item = itemsReclasificacion.find(i => i.id === itemId);
            if (!item) return;

            itemReclasificacionActual = item;

            const html = `
                <div style="background: var(--bg-hover); padding: 1rem; border-radius: 12px; margin-bottom: 1rem;">
                    <div class="form-row">
                        <div>
                            <label style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem;">Variante</label>
                            <div style="font-weight: 600;">${item.nuevaVariante}</div>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem;">Cantidad</label>
                            <div style="font-weight: 600;">${item.cantidad}</div>
                        </div>
                        <div>
                            <label style="font-weight: 600; color: var(--text-secondary); font-size: 0.75rem;">Ubicaci√≥n Actual</label>
                            <div><span class="badge badge-warning">${item.ubicacion}</span></div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('infoCompletarReclasificacion').innerHTML = html;
            document.getElementById('ubicacionFinalReclas').value = '';
            
            abrirModal('modalCompletarReclasificacion');
            lucide.createIcons();
        }

        async function confirmarCompletarReclasificacion() {
            if (!itemReclasificacionActual) return;

            const ubicacionFinal = document.getElementById('ubicacionFinalReclas').value.trim().toUpperCase();
            
            if (!ubicacionFinal) {
                mostrarToast('Ingresa la ubicaci√≥n final', 'error');
                return;
            }

            mostrarLoading('Completando reclasificaci√≥n...', 'Actualizando inventario');

            try {
                const ubicacionTemporal = itemReclasificacionActual.ubicacion;
                const variante = itemReclasificacionActual.nuevaVariante;
                const cantidad = itemReclasificacionActual.cantidad;

                // Eliminar de ubicaci√≥n temporal
                await supabase
                    .from('inventario')
                    .delete()
                    .eq('variante', variante)
                    .eq('ubicacion', ubicacionTemporal);

                // Obtener item en ubicaci√≥n final
                const { data: itemFinal } = await supabase
                    .from('inventario')
                    .select('*')
                    .eq('variante', variante)
                    .eq('ubicacion', ubicacionFinal)
                    .single();
                
                if (itemFinal) {
                    await supabase
                        .from('inventario')
                        .update({ 
                            stock_fisico: (itemFinal.stock_fisico || 0) + cantidad 
                        })
                        .eq('variante', variante)
                        .eq('ubicacion', ubicacionFinal);
                } else {
                    await supabase
                        .from('inventario')
                        .insert({
                            variante: variante,
                            ubicacion: ubicacionFinal,
                            stock_fisico: cantidad,
                            stock_bloqueado: 0
                        });
                }

                // Actualizar estado en reclasificacion
                await supabase
                    .from('reclasificacion')
                    .update({
                        estado: 'Completada',
                        ubicacion: ubicacionFinal,
                        fechaCompletado: new Date().toISOString()
                    })
                    .eq('id', itemReclasificacionActual.id);

                ocultarLoading();
                mostrarToast('Reclasificaci√≥n completada', 'success');
                cerrarModal('modalCompletarReclasificacion');
                await cargarReclasificacion();
                await cargarInventario();
                itemReclasificacionActual = null;
            } catch (error) {
                ocultarLoading();
                mostrarToast('Error al completar: ' + error.message, 'error');
            }
        }

        // ============================================
        // UTILIDADES
        // ============================================
        function formatearFechaPeru(fechaISO) {
            const fecha = new Date(fechaISO);
            return fecha.toLocaleDateString('es-PE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function diasTranscurridos(fechaISO) {
            const fecha = new Date(fechaISO);
            const hoy = new Date();
            const diff = hoy - fecha;
            return Math.floor(diff / (1000 * 60 * 60 * 24));
        }

        function generarIdOrden() {
            const timestamp = Date.now().toString(36);
            const random = Math.random().toString(36).substring(2, 7);
            return `ORD-${timestamp}-${random}`.toUpperCase();
        }

        function calcularUnidadesOrden(orden) {
            let total = 0;
            if (orden.items) {
                for (const item of orden.items) {
                    for (const ub of item.ubicaciones) {
                        total += ub.cantidadSolicitada;
                    }
                }
            }
            return total;
        }

        function obtenerBadgeEstado(estado) {
            const badges = {
                'Pendiente Picking': '<span class="badge badge-warning">Pendiente Picking</span>',
                'En Picking': '<span class="badge badge-info">En Picking</span>',
                'Pendiente Packing': '<span class="badge badge-purple">Pendiente Packing</span>',
                'Completada': '<span class="badge badge-success">Completada</span>',
                'Expirada': '<span class="badge badge-danger">Expirada</span>'
            };
            return badges[estado] || `<span class="badge badge-primary">${estado}</span>`;
        }

        // ============================================
        // MODALES
        // ============================================
        function abrirModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            document.body.style.overflow = 'hidden';
            setTimeout(() => lucide.createIcons(), 100);
        }

        function cerrarModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        // Cerrar modal al hacer clic fuera (excepto reclasificaci√≥n que ahora s√≠ se puede cerrar)
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    cerrarModal(this.id);
                }
            });
        });

        // ============================================
        // LOADING Y TOAST
        // ============================================
        function mostrarLoading(texto = 'Cargando...', subtexto = 'Por favor espera') {
            document.getElementById('loadingText').textContent = texto;
            document.getElementById('loadingSubtext').textContent = subtexto;
            document.getElementById('loadingOverlay').classList.add('active');
        }

        function ocultarLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
            actualizarProgreso(0);
        }

        function actualizarProgreso(porcentaje) {
            document.getElementById('progressFill').style.width = porcentaje + '%';
        }

        function mostrarToast(mensaje, tipo = 'info') {
            const container = document.getElementById('toastContainer');
            
            const iconos = {
                'success': 'check-circle',
                'error': 'x-circle',
                'warning': 'alert-triangle',
                'info': 'info'
            };

            const titulos = {
                'success': '√âxito',
                'error': 'Error',
                'warning': 'Advertencia',
                'info': 'Informaci√≥n'
            };

            const toast = document.createElement('div');
            toast.className = `toast ${tipo}`;
            toast.innerHTML = `
                <i data-lucide="${iconos[tipo]}" class="toast-icon ${tipo}"></i>
                <div class="toast-content">
                    <div class="toast-title">${titulos[tipo]}</div>
                    <div class="toast-message">${mensaje}</div>
                </div>
            `;

            container.appendChild(toast);
            lucide.createIcons();

            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        function mostrarNotificaciones() {
            const ordenesProximas = ordenes.filter(orden => {
                const dias = diasTranscurridos(orden.fecha);
                return ['Pendiente Picking', 'En Picking', 'Pendiente Packing'].includes(orden.estado) && 
                       dias >= DIAS_ALERTA_TEMPRANA;
            });

            if (ordenesProximas.length === 0) {
                mostrarToast('No hay notificaciones pendientes', 'info');
                return;
            }

            let mensaje = `Tienes ${ordenesProximas.length} orden${ordenesProximas.length !== 1 ? 'es' : ''} pr√≥xima${ordenesProximas.length !== 1 ? 's' : ''} a expirar:\n\n`;
            ordenesProximas.forEach(orden => {
                mensaje += `‚Ä¢ ${orden.id} (${diasTranscurridos(orden.fecha)} d√≠as)\n`;
            });

            alert(mensaje);
        }

        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            menu.classList.toggle('active');
        }

        // ============================================
        // B√öSQUEDA GLOBAL (MEJORADA)
        // ============================================
        document.getElementById('searchGlobal')?.addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            
            if (searchTerm.length < 3) return;

            // Buscar en inventario
            const resultadosInventario = inventario.filter(item => 
                item.variante.toLowerCase().includes(searchTerm) ||
                item.ubicacion.toLowerCase().includes(searchTerm)
            );

            // Buscar en productos
            const resultadosProductos = productosSystem.filter(producto =>
                producto.variante.toLowerCase().includes(searchTerm)
            );

            // Buscar en √≥rdenes
            const resultadosOrdenes = ordenes.filter(orden =>
                orden.id.toLowerCase().includes(searchTerm)
            );

            console.log('B√∫squeda:', {
                inventario: resultadosInventario.length,
                productos: resultadosProductos.length,
                ordenes: resultadosOrdenes.length
            });

            // Mostrar toast con resultados
            if (resultadosInventario.length > 0 || resultadosProductos.length > 0 || resultadosOrdenes.length > 0) {
                mostrarToast(
                    `${resultadosInventario.length} en inventario, ${resultadosProductos.length} productos, ${resultadosOrdenes.length} √≥rdenes`,
                    'info'
                );
            }
        });

        // ============================================
        // CERRAR DROPDOWN AL HACER CLIC FUERA
        // ============================================
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.dropdown-container')) {
                document.querySelectorAll('.dropdown-menu').forEach(dropdown => {
                    dropdown.classList.remove('active');
                });
            }
        });

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        window.addEventListener('DOMContentLoaded', async () => {
            // Inicializar iconos
            lucide.createIcons();
            
            // Verificar sesi√≥n
            await verificarSesion();
            
            // Event listeners de Enter en login
            document.getElementById('loginPassword')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') iniciarSesion();
            });

            // Event listeners para navegaci√≥n
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const vista = item.getAttribute('data-vista');
                    if (vista) cambiarVista(vista);
                });
            });
        });

        // Recargar iconos cuando cambie de vista (Observer mejorado)
        const observer = new MutationObserver((mutations) => {
            // Solo recargar si hay cambios en el DOM
            let shouldReload = false;
            mutations.forEach(mutation => {
                if (mutation.addedNodes.length > 0) {
                    shouldReload = true;
                }
            });
            
            if (shouldReload) {
                lucide.createIcons();
            }
        });

        observer.observe(document.body, {
            childList: true,
            subtree: true
        });

        // ============================================
        // MANEJO DE ERRORES GLOBALES
        // ============================================
        window.addEventListener('error', function(event) {
            console.error('Error global capturado:', event.error);
            mostrarToast('Ocurri√≥ un error inesperado. Por favor recarga la p√°gina.', 'error');
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('Promise rechazada no manejada:', event.reason);
            mostrarToast('Error de conexi√≥n. Verifica tu conexi√≥n a internet.', 'error');
        });

        // ============================================
        // PREVENIR P√âRDIDA DE DATOS
        // ============================================
        window.addEventListener('beforeunload', function(e) {
            // Solo advertir si hay una orden en proceso de reclasificaci√≥n
            if (ordenActualPacking && variantesNoEmpaquetadas.length > 0) {
                e.preventDefault();
                e.returnValue = 'Tienes una reclasificaci√≥n en proceso. ¬øEst√°s seguro de salir?';
                return e.returnValue;
            }
        });

        // ============================================
        // INFORMACI√ìN DEL SISTEMA (CONSOLA)
        // ============================================
        console.log(`
        ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
        ‚ïë      MAWI v6.0 - Sistema Lukers      ‚ïë
        ‚ïë     Warehouse Management System       ‚ïë
        ‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
        ‚ïë  ‚úì Gesti√≥n de Inventario             ‚ïë
        ‚ïë  ‚úì Control de √ìrdenes                ‚ïë
        ‚ïë  ‚úì M√≥dulo de Picking & Packing       ‚ïë
        ‚ïë  ‚úì Sistema de Reclasificaci√≥n        ‚ïë
        ‚ïë  ‚úì Analytics & KPIs                  ‚ïë
        ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
        
        ‚öôÔ∏è  Estado: Inicializando...
        üìä Base de datos: Supabase
        üîê Autenticaci√≥n: Activa
        
        Desarrollado por: GENIUS
        Versi√≥n: 6.0 (Corregida y Optimizada)
        `);

    </script>
</body>
</html>
